# 財務指標分析レポート（CVP損益分岐分析）- 仕様概要

## 1. 概要

EPMの財務指標分析レポート機能の一部として、CVP（Cost-Volume-Profit）損益分岐分析を提供する。
全社/事業部/部門単位で損益構造を把握し、固定費・変動費の影響を可視化する。
MVPでは数量/単価の概念は扱わず、金額ベースで分析する。

### 対象ユーザー
- 経営層、経営企画、事業部長、部門責任者、経理/管理会計担当

---

## 2. 前提・スコープ

- **数量/単価は扱わない**（金額ベースCVP）
- **分析軸は組織のみ**（全社/事業部/部門）
- **シミュレーションはUI内のみ**（保存しない/リロードでリセット）
- **当年度の実績は「実績+見込」で表示**、実績単独は過去年度のみ
- **月範囲は年度内のみ**

---

## 3. 参照データとマスタ前提

### 3.1 対象エンティティ
- `fact_amounts`（予算/見込/実績）
- `plan_events` / `plan_versions`（イベント/バージョン）
- `accounting_periods`（締め状態）
- `report_layouts` / `report_layout_lines`（PLレイアウト）
- `subjects` / `subject_rollup_items`（科目/集計）
- `companies`（主要科目とCVPレイアウト指定）

### 3.2 CVPレイアウト
- **会社マスタにCVPレイアウトを指定する**
  - `companies.cvp_report_layout_id`（新規追加予定）
  - `report_layouts.layout_type='PL'` のレイアウトを指定
- CVPレイアウトは**直接原価計算レベルのPL**を想定
  - 変動費/固定費の集計科目と配下科目を含む
- 未設定の場合はCVP画面を表示しない（案内メッセージのみ）

---

## 4. 画面構成（1画面完結）

```
┌──────────────────────────────────────────────────────────────┐
│ 年度: [▼]  Primary: [▼]  Compare: [なし/▼]                  │
├──────────────────────────────────────────────────────────────┤
│ 期間: [▼] 〜 [▼]   表示粒度: [月次/四半期/半期/年度 ▼]      │
├──────────────────────────────────────────────────────────────┤
│ 部門ツリー（単独/配下集約） │  KPIカード（シミュ結果/差分）  │
│                             │                                │
│                             │  CVPツリー（元値/シミュ後）     │
└──────────────────────────────────────────────────────────────┘
```

- 上段: 年度 / Primary / Compare
- 次段: 期間レンジ / 表示粒度
- 左: 部門ツリー（単独/配下集約切替）
- 右: KPIカード＋CVPツリー（シミュレーション）

### 4.1 ダッシュボードグラフ
- 右ペインに **KPIカード → グラフ → CVPツリー** の順で配置
- **グラフ1: 損益分岐チャート（推奨）**
  - 横軸: 売上高、縦軸: 金額（売上/総費用）
  - 売上線 / 総費用線 / 固定費線を表示
  - 損益分岐点を強調表示
  - シミュ後は太線、元値は細線、Compareは点線（選択時のみ）
  - 限界利益率=0 または売上=0 の場合は「計算不可」表示
- **グラフ2: 損益構造ウォーターフォール**
  - 売上 → 変動費 → 固定費 → 利益
  - 元値/シミュ後を左右に並列表示
  - Compareは表示のみ（必要時は薄色で追加）

---

## 5. 選択項目・フィルター

### 5.1 Primary / Compare
- **Primary**: 予算 / 見込 / 実績
- **Compare**: 任意年度・任意イベントを選択（比較対象、**比較なし可**）
- **前回見込**の概念は持たない
- CompareはPrimaryと独立して選択する（予算=イベント+バージョン、見込=イベント、実績=年度）
- 初期状態は**未選択**（必須項目が揃うまで表示しない）

### 5.2 イベント/バージョン
- **予算**: イベント選択 + バージョン選択
- **見込**: イベント選択のみ
  - バージョンは **FIXED優先 + version_no最大** を自動採用
  - FIXEDが無いイベントは選択不可（DDLは空）
- **実績**: 年度のみ選択（イベント/バージョン選択なし）
  - 実績イベントは年度に1つ（複数なし、バージョン概念なし）

### 5.3 期間レンジ/粒度
- 月範囲指定（年度内のみ）
- 表示粒度: 月次 / 四半期 / 半期 / 年度
- 粒度に応じてレンジをスナップする（例: 四半期/半期/年度は境界固定）
- 四半期は `accounting_periods.quarter_no` を使用
- 半期は `period_no` の 1-6 / 7-12 を使用（`period_kind='MONTH'` のみ）
- 年度は選択年度の `period_kind='MONTH'` を全て使用
- 調整期（`period_kind='ADJ'`）は含めない
- **CVPツリーは範囲合計のみ**を表示

### 5.4 部門
- 部門ツリーから選択
- 単独 / 配下集約の切替

---

## 6. データ合成ルール

### 6.1 予算
- 選択した予算イベント + バージョンの値を使用

### 6.2 見込（実績+見込）
- 選択した見込イベントの **最新FIXEDバージョン** を使用
- 各月の値は以下:
  - `HARD_CLOSED` かつ実績が存在 → 実績値を使用
  - 実績が無い月 → 見込値を使用（最新FIXEDの対象月）

### 6.3 実績
- **過去年度のみ選択可**
- 実績データが存在する月のみ集計

### 6.4 Compare
- Primaryと同じ月範囲を、Compareで選んだ年度/イベントに適用
- Compare未選択時は差分表示を行わない

---

## 7. CVPツリーと編集

### 7.1 表示
- CVPレイアウトのPL行をツリー表示
- 2列構成: **元値 / シミュ後**
- 費用は**正値表示/入力**で統一
- 編集可能: `line_type='account'` の行のみ（集計/配下両方）

### 7.2 調整差分行
- 集計科目を上書きした場合、配下末尾に **「調整差分」** を自動生成
- 調整差分 = 集計値 − 配下合計
- 調整差分は**読み取り専用**
- 親は **配下 + 調整差分の合計**で再計算

### 7.3 シミュレーション
- UI内のみの一時値
- リロードでリセット
- Compareは表示のみ（編集不可）
- 変更行はハイライト表示（薄いアクセント色）
- **全体リセット**ボタンを用意（行単位のリセットは無し）

---

## 8. KPI指標（全て必須）

### 8.1 指標一覧（会計順）
1. 売上
2. 変動費
3. 限界利益（売上 − 変動費）
4. 限界利益率（限界利益 / 売上）
5. 固定費
6. 損益分岐売上（固定費 / 限界利益率）
7. 安全余裕額（売上 − 損益分岐売上）
8. 安全余裕率（安全余裕額 / 売上）

### 8.2 計算ルール
- 費用系は**正値として正規化**して計算
- 売上=0 または 限界利益率=0 の場合は **損益分岐売上を "-" 表示**

### 8.3 KPIカード表示
- **シミュ後を主表示**
- 併記: 元値・差分
- Compareとの差分はシミュ後基準で表示
- Compare未選択時は差分表示を非表示

---

## 9. データ不足時の表示

- CVPレイアウト未設定
- 必須項目未選択（年度/Primary/部門/期間/粒度）
- Primaryデータが0件

上記いずれかの場合は**画面全体をブロック**し、案内メッセージのみ表示する。

---

## 10. 権限・可視範囲（注記）

- 権限は**機能単位のロール権限**で制御（閲覧/編集）
- 可視範囲は**社員マスタのコントロール部門**で制御
- 詳細は全体仕様で定義（本仕様では前提コメントのみ）

---

## 11. 非対象（MVP外）

- 数量/単価ベースのCVP
- 他ディメンション（IRセグメント、プロジェクト等）のフィルター
- シミュレーションの保存/共有
- 年度跨ぎの期間指定
- 部門横断サマリー一覧画面
- 他レポートへの導線
