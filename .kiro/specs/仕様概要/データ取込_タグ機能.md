# データ取込・タグ機能 仕様概要

## 概要

予算・実績データの取込アーキテクチャと、仕訳明細に対する軽量タグ機能。取込パフォーマンスを考慮してステージングテーブルを分離し、仕訳明細には検索用の軽量タグを持たせる。

## 対象エンティティ

| エンティティ | 定義ファイル | 役割 |
|-------------|-------------|------|
| companies | `entities/01_各種マスタ.md` | タグラベル定義（tag1_label〜tag5_label） |
| budget_import_staging | `entities/01_各種マスタ.md` | 予算取込ステージング |
| actual_import_staging | `entities/01_各種マスタ.md` | 実績取込ステージング |
| fact_journal_lines | `entities/01_各種マスタ.md` | 仕訳明細ファクト |
| fact_amounts | `entities/01_各種マスタ.md` | 月次集約ファクト（取込先） |

## 主要な仕様

### データ取込フロー

```
【予算取込】
CSV/Excel → budget_import_staging → バリデーション → fact_amounts
                                          ↓
                                    validation_status: VALID/ERROR

【実績取込（集約）】
ERP集約データ → actual_import_staging → バリデーション → fact_amounts

【実績取込（仕訳明細）】
ERP仕訳 → fact_journal_lines（詳細保持）
                ↓
        別途バッチで集約 → fact_amounts
```

### ステージングテーブル分離

| テーブル | 用途 | 特徴 |
|---------|------|------|
| budget_import_staging | 予算取込 | plan_event/version必須 |
| actual_import_staging | 実績取込（集約後） | plan_event不要 |

- パフォーマンス確保のため分離
- バッチ単位（import_batch_id）で管理
- バリデーション後にfact_amountsへ反映

### 仕訳明細の2形式対応

| 形式 | 使用カラム | 例 |
|------|-----------|-----|
| SINGLE | debit_amount, credit_amount | 借方: 10000, 貸方: 0 |
| DOUBLE | debit_credit, amount | D, 10000 |

- ERPの出力形式に応じて選択
- line_format カラムで判別
- 集計時は統一的に処理

### 軽量タグ機能

```
【ラベル定義】
companies.tag1_label = "顧客名"
companies.tag2_label = "案件番号"
companies.tag3_label = "担当者"
...

【値保持】
fact_journal_lines.tag1 = "株式会社ABC"
fact_journal_lines.tag2 = "PJ-2026-001"
fact_journal_lines.tag3 = "山田太郎"
...
```

- **5個固定**（tag1〜tag5）
- **値のみ保持**（コード・マスタ参照なし）
- **ラベルは会社別**に定義
- 用途: 検索・参照・ドリルダウン

### ディメンションとの違い

| 観点 | ディメンション | 軽量タグ |
|------|--------------|---------|
| 用途 | 経営粒度の分析軸 | 検索・参照用 |
| マスタ | dimension_values（Group） | なし |
| 値の正規化 | 必須 | ゆらぎ許容 |
| ファクトとの関係 | fact_dimension_links でリンク | 直接カラム保持 |
| 集計 | 軸として使用可能 | 集計には使わない |

## 関連 Feature

- `.kiro/specs/data-import/` - データ取込機能（将来）
- `.kiro/specs/planning/budget-entry/` - 予算入力機能

## 検討経緯

- `.kiro/specs/仕様検討/データ取込_タグ機能_20260109.md` - 設計方針の決定

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-09 | 初版作成 | Claude Code |
