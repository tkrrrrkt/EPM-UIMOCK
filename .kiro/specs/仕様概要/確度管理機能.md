# 確度管理機能 仕様概要

## 概要

予算・見込入力において、売上等の特定科目に対して確度ランク（S/A/B/C/D/Z等）別に金額を入力・管理する機能。案件の成約確度を数値化し、期待値（確度加味した着地予測）を算出する。

## 基本方針

- **確度ランク別入力**: 科目の金額を確度ランクごとに分けて入力
- **期待値の自動計算**: 確度（掛け率）×金額で期待値を算出
- **予算差の可視化**: 予算との差をZランク等で埋める運用を支援

## 運用イメージ

### 期初（予算と同額にする）

```
売上見込（5月）
├── S（受注 100%）:     500万
├── A（80%受注）:       300万
├── B（50%受注）:       200万
├── C（20%受注）:       100万
├── D（0% 案件化）:      50万
├── Z（目安なし 0%）:   350万  ← 予算との差を埋める
─────────────────────────────────
合計:                 1,500万 = 予算と同額
期待値:                 880万 = 確度加味した着地
```

### 期末近く（着地が見えてくる）

```
売上見込（5月）
├── S（受注 100%）:     800万  ← 商談が進み受注増
├── A（80%受注）:       400万
├── B（50%受注）:       150万
├── C（20%受注）:        50万
├── D（0% 案件化）:       0万  ← 消滅
├── Z（目安なし 0%）:     0万  ← 消滅
─────────────────────────────────
合計:                 1,400万
期待値:               1,195万
予算差:               ▲100万  ← ショートが明確に
```

## 確度マスタ

### エンティティ: confidence_levels

```sql
CREATE TABLE confidence_levels (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,  -- 会社ごとに設定
  level_code varchar(20) NOT NULL,  -- 'S', 'A', 'B', 'C', 'D', 'Z'
  level_name varchar(100) NOT NULL,  -- '受注', '80%受注', ...
  level_name_short varchar(20),  -- 'S', 'A', ...
  probability_rate numeric(5,2) NOT NULL,  -- 1.00, 0.80, 0.50, 0.20, 0.00
  color_code varchar(7),  -- '#22C55E', '#84CC16', ...
  sort_order int NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamptz NOT NULL,
  updated_at timestamptz NOT NULL,

  UNIQUE(tenant_id, company_id, level_code),
  FOREIGN KEY (tenant_id, company_id) REFERENCES companies(tenant_id, id)
);
```

### 初期データ例

| level_code | level_name | probability_rate | color_code |
|------------|------------|------------------|------------|
| S | 受注 | 100% | #22C55E (緑) |
| A | 80%受注 | 80% | #84CC16 (黄緑) |
| B | 50%受注 | 50% | #EAB308 (黄) |
| C | 20%受注 | 20% | #F97316 (橙) |
| D | 0%（案件化） | 0% | #EF4444 (赤) |
| Z | 目安なし | 0% | #6B7280 (灰) |

## 対象科目の設定

### 予算レイアウトで設定

```
予算レイアウト設定
─────────────────────────────────────────────
科目        │ディメンション│ 確度管理 │ W/N/B
─────────────────────────────────────────────
売上高      │ なし        │ ☑ ON    │ ☑ ON
売上原価    │ なし        │ ☑ ON    │ ☑ ON
売上総利益  │ -（集計）   │ ☐ OFF   │ ☐ OFF
販管費      │ なし        │ ☐ OFF   │ ☐ OFF
広告宣伝費  │ 媒体DIM     │ ☐ OFF   │ ☐ OFF（ディメンション）
```

**制約**:
- ディメンション設定科目と確度管理は **併用不可**
- 集計科目（AGGREGATE）は子科目から自動集計

### report_layout_items への追加

```sql
ALTER TABLE report_layout_items
  ADD COLUMN confidence_enabled boolean DEFAULT false;
```

## 入力UI

### グリッド展開形式

確度管理対象科目は、ディメンション展開と同様に行を展開して入力。

```
見込入力グリッド
─────────────────────────────────────────────────────────────────────────
科目         │ 10月      │ 11月      │ 12月      │ 通期      │
─────────────────────────────────────────────────────────────────────────
▶ 売上高    │   1,500   │   1,600   │   1,700   │  18,000   │ ← 折りたたみ時
─────────────────────────────────────────────────────────────────────────

↓ 展開時

─────────────────────────────────────────────────────────────────────────
▼ 売上高    │ 10月      │ 11月      │ 12月      │ 通期      │
   S(100%)  │ [  500]   │ [  550]   │ [  600]   │   6,200   │
   A(80%)   │ [  300]   │ [  320]   │ [  340]   │   3,600   │
   B(50%)   │ [  200]   │ [  210]   │ [  220]   │   2,400   │
   C(20%)   │ [  100]   │ [  110]   │ [  120]   │   1,200   │
   D(0%)    │ [   50]   │ [   60]   │ [   70]   │     700   │
   Z(0%)    │ [  350]   │ [  350]   │ [  350]   │   3,900   │
─────────────┼───────────┼───────────┼───────────┼───────────┤
   合計     │   1,500   │   1,600   │   1,700   │  18,000   │ ← 自動計算
   期待値   │     880   │     948   │   1,016   │  10,500   │ ← 確度×金額
   予算     │   1,500   │   1,600   │   1,700   │  18,000   │ ← 参考表示
─────────────────────────────────────────────────────────────────────────
```

### 表示行の説明

| 行 | 説明 | 編集 |
|----|------|------|
| S〜Zランク | 確度別の入力行 | 可 |
| 合計 | 確度別金額の合計（見込金額） | 不可（自動計算） |
| 期待値 | Σ(確度×金額)（確度加味した着地） | 不可（自動計算） |
| 予算 | 予算の該当科目金額（参考表示） | 不可 |

## データ構造

### fact_amounts への確度追加

```sql
-- confidence_level_id カラムを追加
ALTER TABLE fact_amounts ADD COLUMN confidence_level_id uuid;

-- 外部キー制約
ALTER TABLE fact_amounts ADD CONSTRAINT fk_fact_amounts_confidence
  FOREIGN KEY (tenant_id, company_id, confidence_level_id)
  REFERENCES confidence_levels(tenant_id, company_id, id);

-- 一意制約の更新（confidence_level_id を含める）
-- 既存: (tenant_id, company_id, accounting_period_id, subject_id, ...)
-- 新規: (tenant_id, company_id, accounting_period_id, subject_id, ..., confidence_level_id)
```

### confidence_level_id の値

| confidence_level_id | 説明 |
|---------------------|------|
| NULL | 確度管理しない科目の通常入力 |
| 確度マスタのID | 確度管理科目の確度別入力 |

## 使用タイミング

| 入力種別 | 確度管理 | 備考 |
|---------|---------|------|
| 予算入力 | 使用可能 | レイアウト設定でONの科目 |
| 見込入力 | 使用可能 | レイアウト設定でONの科目 |
| 実績入力 | 使用不可 | 実績は確定値のため |

## 期待値の計算

```
期待値 = Σ(確度ランクの金額 × 確度ランクの掛け率)

例:
S: 500万 × 100% = 500万
A: 300万 ×  80% = 240万
B: 200万 ×  50% = 100万
C: 100万 ×  20% =  20万
D:  50万 ×   0% =   0万
Z: 350万 ×   0% =   0万
────────────────────────
期待値合計:       860万
```

## BFF Contracts

```typescript
// 確度マスタ取得
interface BffConfidenceLevelListRequest {
  companyId: string;
}

interface BffConfidenceLevelListResponse {
  levels: BffConfidenceLevel[];
}

interface BffConfidenceLevel {
  id: string;
  levelCode: string;
  levelName: string;
  levelNameShort: string;
  probabilityRate: number;  // 0.0 - 1.0
  colorCode: string;
  sortOrder: number;
}

// 確度管理対象科目の見込グリッド
interface BffConfidenceGridRow {
  subjectId: string;
  subjectCode: string;
  subjectName: string;
  isConfidenceEnabled: boolean;
  confidenceRows?: BffConfidenceLevelRow[];  // 確度別行
  summaryRow: BffConfidenceSummaryRow;  // 合計・期待値・予算
}

interface BffConfidenceLevelRow {
  confidenceLevelId: string;
  levelCode: string;
  levelName: string;
  probabilityRate: number;
  values: BffCellValue[];  // 月別金額
}

interface BffConfidenceSummaryRow {
  totalValues: BffCellValue[];      // 合計（自動計算）
  expectedValues: BffCellValue[];   // 期待値（自動計算）
  budgetValues: BffCellValue[];     // 予算（参考）
}

// 確度別金額の保存
interface BffConfidenceValueSaveRequest {
  eventId: string;
  versionId: string;
  departmentId: string;
  subjectId: string;
  periodNo: number;
  confidenceLevelId: string;
  amount: string;
}

// 確度マスタの保存（管理画面用）
interface BffConfidenceLevelSaveRequest {
  companyId: string;
  levels: BffConfidenceLevelInput[];
}

interface BffConfidenceLevelInput {
  id?: string;  // 新規はnull
  levelCode: string;
  levelName: string;
  levelNameShort: string;
  probabilityRate: number;
  colorCode: string;
  sortOrder: number;
  isActive: boolean;
}
```

## 確度マスタ管理画面

```
┌────────────────────────────────────────────────────────────────────────┐
│ 確度マスタ設定                   会社: [ABC株式会社 ▼]                │
├────────────────────────────────────────────────────────────────────────┤
│                                              [+ 新規追加] [保存]      │
├────────────────────────────────────────────────────────────────────────┤
│ コード │ 名称              │ 掛け率  │ 色     │ 順序 │ 有効 │        │
├────────┼───────────────────┼─────────┼────────┼──────┼──────┼────────┤
│ S      │ 受注              │ [100]%  │ ■緑   │  1   │ ☑   │ [削除] │
│ A      │ 80%受注           │ [ 80]%  │ ■黄緑 │  2   │ ☑   │ [削除] │
│ B      │ 50%受注           │ [ 50]%  │ ■黄   │  3   │ ☑   │ [削除] │
│ C      │ 20%受注           │ [ 20]%  │ ■橙   │  4   │ ☑   │ [削除] │
│ D      │ 0%（案件化）      │ [  0]%  │ ■赤   │  5   │ ☑   │ [削除] │
│ Z      │ 目安なし          │ [  0]%  │ ■灰   │  6   │ ☑   │ [削除] │
└────────────────────────────────────────────────────────────────────────┘
```

## Phase分け

### Phase 1

- [x] 確度マスタ（confidence_levels）テーブル
- [x] 確度マスタ管理画面
- [x] 予算レイアウトでの確度管理対象設定
- [x] fact_amounts への confidence_level_id 追加
- [x] 見込入力グリッドでの確度展開表示
- [x] 確度別金額の入力・保存
- [x] 合計・期待値の自動計算

### Phase 2（将来検討）

- [ ] 確度サマリーレポート（会社全体の確度別構成）
- [ ] 確度推移グラフ（月次での確度変化）
- [ ] 確度×W/N/Bの組み合わせ分析

## 関連機能

- `.kiro/specs/仕様概要/見込入力機能.md` - 見込入力の基本仕様
- `.kiro/specs/仕様概要/見込シナリオ機能.md` - W/N/B機能（別機能）
- `.kiro/specs/仕様概要/予算入力機能.md` - 予算レイアウト設定

## 未確定事項

| 項目 | 状態 |
|------|------|
| 確度サマリーレポートの詳細 | 後日検討 |
| 集計科目の期待値計算 | 子科目の期待値を集計 |

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-12 | 初版作成（QA壁打ちに基づく） | Claude Code |
