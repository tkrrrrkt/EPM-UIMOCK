# 月次締処理・配賦処理 統合仕様

## 概要

月次締め処理と配賦処理を統合的に管理する機能。従来の3段階ステータス（OPEN/SOFT_CLOSED/HARD_CLOSED）を維持しつつ、入力ロック（input_locked）を導入して配賦実行との連携を実現する。

## 設計方針

### 基本コンセプト

1. **2軸制御**: close_status（締めステータス）と input_locked（入力ロック）の組み合わせ
2. **配賦→ロック連動**: 配賦実行時に自動で input_locked = true
3. **柔軟な運用**: 入力ロック解除は権限者が任意に可能（警告表示）
4. **配賦結果の可視化**: AG Grid Tree Data + Excel Export による階層表示

### close_status と input_locked の関係

| close_status | input_locked | 状態 | 入力 | 配賦結果 |
|--------------|--------------|------|------|---------|
| OPEN | false | 入力可能 | ○ | - |
| OPEN | true | ロック中 | × | 保持 |
| SOFT_CLOSED | - | 仮締め | △権限者 | 確定 |
| HARD_CLOSED | - | 本締め | × | 確定 |

### 運用フロー

```
【月次実績処理フロー】

OPEN / input_locked=false（入力期間）
  ↓ 実績入力完了
  ↓
[配賦処理実行ダイアログ] ← 月次締め画面から起動
  ↓
  ├─ 配賦イベント選択（execution_order順）
  ├─ 配賦実行（前回結果を全削除→再計算）
  ├─ → input_locked = true に自動更新
  └─ → 配賦結果VIEW画面へ遷移
  ↓
OPEN / input_locked=true（配賦済み）
  ↓
  ├─ [入力ロック解除] ※警告あり、権限者のみ
  │     → input_locked = false、配賦結果は削除
  └─ [仮締め実行]
        → SOFT_CLOSED に遷移
  ↓
SOFT_CLOSED（仮締め）
  ↓
  ├─ [戻す] 権限者のみ → OPEN に戻る
  └─ [本締め実行] → HARD_CLOSED
  ↓
HARD_CLOSED（本締め・不可逆）
```

---

## エンティティ変更

### accounting_periods（既存テーブル拡張）

| カラム | 型 | NULL | 補足 |
|--------|---|------|------|
| input_locked | boolean | NO DEFAULT false | 入力ロック状態 |
| input_locked_at | timestamptz | YES | ロック日時 |
| input_locked_by | uuid | YES | ロック操作者 |

### allocation_events（既存テーブル拡張）

| カラム | 型 | NULL | 補足 |
|--------|---|------|------|
| execution_order | int | NO DEFAULT 0 | イベント実行順序（同一会社内） |

### allocation_executions（新規）

配賦処理の実行履歴を管理。

| カラム | 型 | NULL | 補足 |
|--------|---|------|------|
| id | uuid | NO | PK |
| tenant_id | uuid | NO | RLS |
| company_id | uuid | NO | |
| event_id | uuid | NO | allocation_events参照 |
| accounting_period_id | uuid | NO | 対象会計期間 |
| org_version_id | uuid | NO | 使用した組織バージョン |
| executed_at | timestamptz | NO | 実行日時 |
| executed_by | uuid | NO | 実行者 |
| status | varchar(20) | NO | RUNNING/SUCCESS/FAILED |
| error_message | text | YES | エラー時メッセージ |
| summary_json | jsonb | YES | 実行サマリ（件数等） |
| created_at | timestamptz | NO | |

### allocation_execution_details（新規）

配賦結果の明細を保存。fact_amounts への反映とは別に結果を保持。

| カラム | 型 | NULL | 補足 |
|--------|---|------|------|
| id | uuid | NO | PK |
| tenant_id | uuid | NO | RLS |
| execution_id | uuid | NO | allocation_executions参照 |
| step_id | uuid | NO | 実行ステップ |
| step_no | int | NO | ステップ番号（実行時スナップショット） |
| from_department_stable_id | uuid | NO | 配賦元部門 |
| from_subject_id | uuid | NO | 配賦元科目 |
| source_amount | numeric(18,2) | NO | 配賦元金額 |
| to_department_stable_id | uuid | YES | 配賦先部門（DEPARTMENT時） |
| to_dimension_value_id | uuid | YES | 配賦先ディメンション値（DIMENSION_VALUE時） |
| to_subject_id | uuid | NO | 配賦先科目 |
| driver_type | varchar(30) | NO | 使用ドライバ種別 |
| driver_value | numeric(18,6) | YES | ドライバ値 |
| ratio | numeric(8,6) | NO | 配賦比率 |
| allocated_amount | numeric(18,2) | NO | 配賦金額 |
| created_at | timestamptz | NO | |

---

## 画面設計

### 月次締め処理画面（拡張）

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 月次締処理状況                              [会社: ABC株式会社 ▼]            │
├──────────────────────────────────────────────────────────────────────────────┤
│ 年度: [2026 ▼]                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│ 期間 │ ステータス │ 入力ロック │ 締め日時         │ 操作                     │
├──────┼───────────┼───────────┼─────────────────┼─────────────────────────┤
│ 4月  │ ● 本締め  │ -          │ 2026-05-10      │ -                        │
│ 5月  │ ● 本締め  │ -          │ 2026-06-08      │ -                        │
│ 6月  │ ● 本締め  │ -          │ 2026-07-09      │ -                        │
│ 7月  │ ◐ 仮締め  │ ロック済   │ 2026-08-07      │ [本締め] [戻す]          │
│ 8月  │ 🔒 ロック  │ ロック済   │ -               │ [仮締め] [結果] [解除]   │
│ 9月  │ ○ 未締め  │ -          │ -               │ [配賦設定] [配賦実行]    │
│ 10月 │ ○ 未締め  │ -          │ -               │ -                        │
│ ...  │           │            │                 │                          │
└──────────────────────────────────────────────────────────────────────────────┘

凡例: ● 本締め(HARD)  ◐ 仮締め(SOFT)  ○ 未締め(OPEN)  🔒 ロック(input_locked)
```

### 操作ボタン条件

| 状態 | [配賦設定] | [配賦実行] | [結果] | [解除] | [仮締め] | [本締め] | [戻す] |
|------|-----------|-----------|--------|--------|---------|---------|--------|
| OPEN/unlocked | ○ Link | ○ | - | - | - | - | - |
| OPEN/locked | ○ Link | ○ | ○ | ○権限者 | ○ | - | - |
| SOFT_CLOSED | - | - | ○ | - | - | ○ | ○権限者 |
| HARD_CLOSED | - | - | ○ | - | - | - | - |

### 配賦処理実行ダイアログ

```
┌─────────────────────────────────────────────────────────────┐
│ 配賦処理実行                                     [×]        │
├─────────────────────────────────────────────────────────────┤
│ 対象期間: 2026年9月                                         │
│                                                             │
│ 実行する配賦イベント:                                       │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ □ [1] 本社共通費配賦（ACTUAL）                        │   │
│ │ □ [2] 事業部共通費配賦（ACTUAL）                      │   │
│ │ □ [3] 製造間接費配賦（ACTUAL）                        │   │
│ └─────────────────────────────────────────────────────┘   │
│ ※ 番号順に実行されます                                     │
│                                                             │
│ ⚠️ 前回の配賦結果がある場合、削除して再計算します           │
│ ⚠️ 配賦完了後、入力がロックされます                         │
│                                                             │
│              [キャンセル]  [配賦を実行]                      │
└─────────────────────────────────────────────────────────────┘
```

### 配賦結果VIEW画面

AG Grid Enterprise の Tree Data 機能 + Excel Export を使用した階層表示。

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 配賦結果                                    [Excel出力] [CSV出力] [戻る]     │
├──────────────────────────────────────────────────────────────────────────────┤
│ 会社: ABC株式会社  期間: 2026年9月  実行日時: 2026-10-05 10:30              │
├──────────────────────────────────────────────────────────────────────────────┤
│ 配賦元科目         │ 配賦元部門 │ 配賦先     │ ドライバ │ 比率  │ 金額     │
├───────────────────┼───────────┼───────────┼─────────┼──────┼─────────┤
│ ▼ 本社共通費配賦                                                            │
│   ├ Step1: 本社費→事業部                                                   │
│   │  ├ 人件費-本社   │ 本社      │ 営業部    │ 人員比  │ 40%  │ 4,000万 │
│   │  ├              │           │ 製造部    │ 人員比  │ 35%  │ 3,500万 │
│   │  └              │           │ 管理部    │ 人員比  │ 25%  │ 2,500万 │
│   └ Step2: 間接費→製品                                                     │
│      ├ 間接費-製造   │ 製造部    │ 製品A     │ 売上比  │ 60%  │ 6,000万 │
│      └              │           │ 製品B     │ 売上比  │ 40%  │ 4,000万 │
│ ▼ 事業部共通費配賦                                                          │
│   └ Step1: ...                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

**表示項目**:
- 配賦イベント名（第1階層）
- ステップ名（第2階層）
- 配賦明細（第3階層）
  - 配賦元科目・部門
  - 配賦先（部門 or ディメンション値）
  - ドライバ種別・値
  - 配賦比率
  - 配賦金額

---

## BFF Contracts

### 配賦実行関連

```typescript
// 配賦実行リクエスト
interface BffAllocationExecuteRequest {
  companyId: string;
  accountingPeriodId: string;
  eventIds: string[];  // 実行するイベントID（execution_order順）
}

// 配賦実行レスポンス
interface BffAllocationExecuteResponse {
  success: boolean;
  executionId: string;
  results: BffAllocationEventResult[];
  errorMessage?: string;
}

interface BffAllocationEventResult {
  eventId: string;
  eventName: string;
  status: 'SUCCESS' | 'FAILED';
  stepCount: number;
  totalAllocatedAmount: number;
}

// 配賦結果取得
interface BffAllocationResultRequest {
  companyId: string;
  accountingPeriodId: string;
}

interface BffAllocationResultResponse {
  executions: BffAllocationExecution[];
}

interface BffAllocationExecution {
  executionId: string;
  eventId: string;
  eventName: string;
  executedAt: string;
  executedBy: string;
  steps: BffAllocationStepResult[];
}

interface BffAllocationStepResult {
  stepId: string;
  stepNo: number;
  stepName: string;
  fromSubjectName: string;
  fromDepartmentName: string;
  sourceAmount: number;
  details: BffAllocationDetail[];
}

interface BffAllocationDetail {
  targetName: string;         // 部門名 or ディメンション値名
  targetType: 'DEPARTMENT' | 'DIMENSION_VALUE';
  toSubjectName: string;
  driverType: string;
  driverValue: number | null;
  ratio: number;
  allocatedAmount: number;
}

// 入力ロック解除
interface BffUnlockInputRequest {
  accountingPeriodId: string;
}

interface BffUnlockInputResponse {
  success: boolean;
  newInputLocked: boolean;
  errorMessage?: string;
}
```

---

## 配賦処理ロジック

### 実行順序

1. **イベント単位**: `allocation_events.execution_order` の昇順
2. **ステップ単位**: `allocation_steps.step_no` の昇順
3. **配賦先単位**: `allocation_step_targets.sort_order` の昇順

### 再配賦時の処理

1. 対象期間の `allocation_execution_details` を全削除
2. 対象期間の `fact_amounts` から `source_type = 'ALLOC'` のレコードを全削除
3. 選択されたイベントを execution_order 順に再実行
4. 結果を `fact_amounts` に INSERT（source_type = 'ALLOC'）
5. `allocation_executions` / `allocation_execution_details` に記録
6. `accounting_periods.input_locked = true` に更新

### ドライバ計算

| driver_type | 計算方法 |
|------------|---------|
| FIXED | allocation_step_targets.fixed_ratio をそのまま使用 |
| HEADCOUNT | 各配賦先部門の人員数の比率 |
| SUBJECT_AMOUNT | 各配賦先の特定科目金額の比率 |
| MEASURE | measure_key で指定した数値の比率 |
| KPI | kpi_fact_amounts の値の比率 |

---

## 権限設計

| 操作 | 必要権限 |
|------|---------|
| 配賦設定画面へのリンク | 経理担当者以上 |
| 配賦処理実行 | 配賦操作権限 |
| 配賦結果閲覧 | 経理担当者以上 |
| 入力ロック解除 | 締め操作権限（警告表示） |
| 仮締め/本締め実行 | 締め操作権限 |

---

## AG Grid 実装方針

### Tree Data 設定

```typescript
// AG Grid columnDefs
const columnDefs = [
  {
    field: 'hierarchy',
    headerName: '配賦内容',
    cellRenderer: 'agGroupCellRenderer',
    showRowGroup: true,
  },
  { field: 'fromSubject', headerName: '配賦元科目' },
  { field: 'fromDepartment', headerName: '配賦元部門' },
  { field: 'targetName', headerName: '配賦先' },
  { field: 'driverType', headerName: 'ドライバ' },
  { field: 'ratio', headerName: '比率', valueFormatter: percentFormatter },
  { field: 'amount', headerName: '金額', valueFormatter: currencyFormatter },
];

// Tree Data path
const getDataPath = (data) => data.orgHierarchy;

// Excel Export
const exportParams = {
  fileName: `配賦結果_${companyName}_${periodLabel}.xlsx`,
  sheetName: '配賦結果',
};
```

### 階層構造

```typescript
interface AllocationTreeNode {
  orgHierarchy: string[];  // ['イベント名', 'ステップ名', '明細']
  // ... 各カラムのデータ
}
```

---

## Phase 分け

### Phase 1（本リリース）

- [x] accounting_periods.input_locked カラム追加
- [x] allocation_events.execution_order カラム追加
- [x] allocation_executions / allocation_execution_details テーブル追加
- [x] 月次締め画面への配賦関連ボタン追加
- [x] 配賦処理実行ダイアログ
- [x] 配賦結果VIEW画面（AG Grid Tree Data）
- [x] 入力ロック解除機能

### Phase 2（将来検討）

- [ ] 配賦シミュレーション機能（本番反映前のプレビュー）
- [ ] 配賦結果のアーカイブ機能
- [ ] 部門単位の配賦進捗管理

---

## 関連仕様

- [月次締処理状況管理](./月次締処理状況管理.md) - 既存締めステータス仕様
- [.kiro/specs/master-data/allocation-master/](../master-data/allocation-master/) - 配賦マスタ設定
- [entities/01_各種マスタ.md](../entities/01_各種マスタ.md) - エンティティ定義

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-02-05 | 初版作成（QA壁打ちに基づく統合仕様） | Claude Code |
