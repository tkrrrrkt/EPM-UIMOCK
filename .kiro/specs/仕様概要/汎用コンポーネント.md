# 汎用コンポーネント 仕様概要

## 概要

EPM SaaS で複数画面から共通利用されるカスタムUIコンポーネントの仕様を定義する。
shadcn/uiを基盤とし、デザインシステム（`.kiro/steering/epm-design-system.md`）に準拠する。

## 配置場所

```
apps/web/src/shared/ui/components/
├── (shadcn/ui 標準コンポーネント)
└── (EPM カスタムコンポーネント) ← 本仕様で定義
```

---

# 1. DepartmentTreeSelector（部門階層セレクター）

## 1.1 概要

部門マスタの階層構造を表示し、複数選択（チェックボックス）できるコンポーネント。
予算入力、見込入力、実績入力、レポート機能など、部門選択が必要な画面で共通利用する。

### ユースケース

1. **単一部門選択**: 自分の担当部門のみを選択
2. **配下部門集約**: 自部門 + 配下部門をまとめて選択（集計表示用）
3. **複数部門選択**: 任意の複数部門を選択
4. **全選択/全解除**: 一括操作

## 1.2 機能要件

### 基本機能

| 機能 | 説明 |
|------|------|
| 階層表示 | 部門の親子関係をツリー構造で表示 |
| 展開/折りたたみ | ノードごとに子要素の表示/非表示を切り替え |
| 複数選択 | チェックボックスで複数部門を選択可能 |
| **配下含むトグル** | 親選択時に「配下を含める」ON/OFFを切り替え可能 |
| 検索/フィルター | 部門名での絞り込み |
| 選択数表示 | 現在の選択数を表示 |

### 選択モード

| モード | 説明 | 用途 |
|--------|------|------|
| `single` | 単一選択（ラジオボタン風） | 予算入力時の部門選択 |
| `multiple` | 複数選択（チェックボックス） | レポートフィルター |

### 「配下を含める」トグル機能（案A採用）

**核心機能**: 親部門を選択した際に、「自部門のみ」か「配下部門も含める」かを選択できる。

#### 動作仕様

| 操作 | 動作 |
|------|------|
| 親部門をチェック | 親部門が選択され、「配下を含める」トグルが表示される |
| 「配下を含める」ON | 配下部門が自動的に全選択される（グレーアウト表示） |
| 「配下を含める」OFF | 配下部門のチェックが外れ、親部門のみ選択状態になる |
| 配下部門を個別チェック | 「配下を含める」はOFFのまま、個別選択として扱う |

#### UIイメージ

```
▼ ☑ 営業本部  [✓ 配下を含める]
   ├─ ☑ 営業1課  (自動ON・グレーアウト)
   ├─ ☑ 営業2課  (自動ON・グレーアウト)
   └─ ☑ 営業3課  (自動ON・グレーアウト)

↓ 「配下を含める」をOFFにすると

▼ ☑ 営業本部  [☐ 配下を含める]
   ├─ ☐ 営業1課  (チェック外れる)
   ├─ ☐ 営業2課  (チェック外れる)
   └─ ☐ 営業3課  (チェック外れる)
```

### オプション機能

| オプション | 説明 |
|-----------|------|
| `showIncludeDescendantsToggle` | 「配下を含める」トグルを表示（デフォルト: true） |
| `showSelectAll` | 全選択/全解除ボタンを表示 |
| `showSelectedCount` | 選択数を表示 |
| `expandLevel` | 初期展開レベル（0=全て閉じる、-1=全て開く） |
| `searchable` | 検索ボックスを表示 |
| `maxHeight` | 最大高さ（スクロール） |

## 1.3 コンポーネントAPI

### Props

```typescript
interface DepartmentTreeSelectorProps {
  // データ
  departments: DepartmentNode[];

  // 選択状態
  value: DepartmentSelection[];
  onChange: (value: DepartmentSelection[]) => void;

  // 選択モード
  selectionMode?: "single" | "multiple";

  // オプション
  showIncludeDescendantsToggle?: boolean;  // 「配下を含める」トグル表示（デフォルト: true）
  showSelectAll?: boolean;       // 全選択/全解除ボタン
  showSelectedCount?: boolean;   // 選択数表示
  expandLevel?: number;          // 初期展開レベル（デフォルト: 1）
  searchable?: boolean;          // 検索ボックス表示

  // スタイル
  maxHeight?: string;            // 最大高さ（例: "400px"）
  className?: string;            // 追加CSSクラス

  // 無効化
  disabled?: boolean;
  disabledIds?: string[];        // 特定部門を無効化

  // アクセシビリティ
  "aria-label"?: string;
}

// 選択状態の型（配下含むフラグを持つ）
interface DepartmentSelection {
  departmentId: string;
  includeDescendants: boolean;  // 配下を含めるかどうか
}

interface DepartmentNode {
  id: string;
  code: string;
  name: string;
  parentId: string | null;
  level: number;                  // 階層レベル（0=ルート）
  children?: DepartmentNode[];
  isLeaf?: boolean;               // 子がないノード
  metadata?: {
    headcount?: number;           // 所属人数
    managerId?: string;           // 部門長ID
    managerName?: string;         // 部門長名
  };
}
```

### 出力形式

```typescript
// value の形式
// 営業本部のみ選択（配下含まない）:
// [{ departmentId: "dept-sales-hq", includeDescendants: false }]

// 営業本部 + 配下全部門を選択:
// [{ departmentId: "dept-sales-hq", includeDescendants: true }]

// 複数選択（個別）:
// [
//   { departmentId: "dept-sales-1", includeDescendants: false },
//   { departmentId: "dept-sales-2", includeDescendants: false },
// ]

// 展開後の実ID一覧を取得するユーティリティ関数を提供:
// expandSelection(value, departments) => string[]
```

## 1.4 UIデザイン

### 基本レイアウト

```
┌──────────────────────────────────────────────────────────────┐
│ 部門を選択                                         [3件選択] │
├──────────────────────────────────────────────────────────────┤
│ 🔍 部門名で検索...                                           │
├──────────────────────────────────────────────────────────────┤
│ [全選択] [全解除]                                             │
├──────────────────────────────────────────────────────────────┤
│ ▼ ☑ 本社                          [✓ 配下を含める]           │
│   ├─ ▼ ☑ 営業本部 (自動)          [✓ 配下を含める]           │
│   │    ├─ ☑ 営業1課 (自動)                                   │
│   │    ├─ ☑ 営業2課 (自動)                                   │
│   │    └─ ☑ 営業3課 (自動)                                   │
│   ├─ ▶ ☑ 開発本部 (自動)                                     │
│   └─ ▶ ☑ 管理本部 (自動)                                     │
└──────────────────────────────────────────────────────────────┘

※ 「配下を含める」がONの親の配下は自動選択され、グレーアウト表示
※ 「配下を含める」トグルは子を持つノード（isLeaf=false）のみに表示
```

### 状態表現

| 状態 | チェックボックス | 説明 |
|------|-----------------|------|
| 未選択 | `☐` | 選択されていない |
| 選択済み | `☑` | 選択されている |
| 一部選択 | `☐▪` (indeterminate) | 配下の一部のみ選択 |
| 無効 | グレーアウト | 選択不可 |

### アイコン

| アイコン | 用途 |
|---------|------|
| `ChevronRight` | 折りたたみ状態 |
| `ChevronDown` | 展開状態 |
| `Building2` | 部門アイコン（オプション） |
| `Search` | 検索ボックス |

## 1.5 インタラクション

### チェックボックス操作

| 操作 | 動作 |
|------|------|
| 親ノードをチェック | `cascade`モードかつ`includeDescendants=true`の場合、配下も全選択 |
| 親ノードのチェック解除 | 配下も全解除 |
| 子ノードをチェック | 親がindeterminate状態になる |
| 全ての子をチェック | 親が選択済みになる |

### 展開/折りたたみ

| 操作 | 動作 |
|------|------|
| 展開アイコンクリック | 子ノードの表示/非表示を切り替え |
| ダブルクリック | 展開/折りたたみ（オプション） |
| 矢印キー（上下） | フォーカス移動 |
| 矢印キー（左右） | 折りたたみ/展開 |
| Enter/Space | チェック状態の切り替え |

### 検索

| 操作 | 動作 |
|------|------|
| 検索文字入力 | 部門名/コードでフィルタリング |
| マッチした部門をハイライト | 検索結果を強調表示 |
| 親ノードも表示 | マッチした部門の親も表示（経路を維持） |

## 1.6 使用例

### 基本的な使用（単一選択）

```tsx
import { DepartmentTreeSelector } from "@/shared/ui/components/department-tree-selector"

function BudgetEntryPage() {
  const [selectedDepartmentId, setSelectedDepartmentId] = useState<string>("")

  return (
    <DepartmentTreeSelector
      departments={departments}
      selectedIds={selectedDepartmentId ? [selectedDepartmentId] : []}
      onSelectionChange={(ids) => setSelectedDepartmentId(ids[0] ?? "")}
      selectionMode="single"
      searchable
      maxHeight="300px"
    />
  )
}
```

### 複数選択（レポートフィルター）

```tsx
function ReportFilterPanel() {
  const [selectedDepartments, setSelectedDepartments] = useState<string[]>([])

  return (
    <DepartmentTreeSelector
      departments={departments}
      selectedIds={selectedDepartments}
      onSelectionChange={setSelectedDepartments}
      selectionMode="multiple"
      showSelectAll
      showSelectedCount
      searchable
      maxHeight="400px"
    />
  )
}
```

### 配下集約モード（集計レポート）

```tsx
function AggregationSettings() {
  const [selectedDepartments, setSelectedDepartments] = useState<string[]>([])

  return (
    <DepartmentTreeSelector
      departments={departments}
      selectedIds={selectedDepartments}
      onSelectionChange={setSelectedDepartments}
      selectionMode="cascade"
      includeDescendants
      expandLevel={2}
    />
  )
}
```

### Popover/Dialog内での使用

```tsx
function DepartmentSelector() {
  const [open, setOpen] = useState(false)
  const [selected, setSelected] = useState<string[]>([])

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button variant="outline" className="w-full justify-between">
          {selected.length > 0
            ? `${selected.length}件の部門を選択中`
            : "部門を選択"
          }
          <ChevronDown className="h-4 w-4 opacity-50" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-[400px] p-0">
        <DepartmentTreeSelector
          departments={departments}
          selectedIds={selected}
          onSelectionChange={setSelected}
          selectionMode="multiple"
          showSelectAll
          searchable
          maxHeight="300px"
        />
      </PopoverContent>
    </Popover>
  )
}
```

## 1.7 デザインシステム準拠

### カラー

| 要素 | カラートークン |
|------|---------------|
| チェックボックス（選択時） | `bg-primary` |
| ホバー背景 | `hover:bg-muted/50` |
| 選択行背景 | `bg-primary/10` |
| 検索ボックス枠線 | `border-input` |
| アイコン | `text-muted-foreground` |
| 無効テキスト | `text-muted-foreground/50` |

### スペーシング

| 要素 | サイズ |
|------|--------|
| 行の高さ | `h-8` (32px) |
| インデント | 階層レベル × `ml-4` (16px) |
| アイコンサイズ | `h-4 w-4` |
| 内部パディング | `p-2` |
| 検索ボックス | `p-2` |

### アクセシビリティ

- `role="tree"` および `role="treeitem"` を使用
- `aria-expanded` で展開状態を伝達
- `aria-selected` で選択状態を伝達
- キーボード操作完全対応
- フォーカス可視化（`focus-visible:ring-2`）

## 1.8 実装時の注意点

1. **パフォーマンス**: 大量の部門データ（1000+）でも軽快に動作するよう仮想スクロールを検討
2. **状態管理**: 選択状態は親コンポーネントで管理（制御コンポーネント方式）
3. **indeterminate状態**: 一部子選択時の親チェックボックスはHTML標準のindeterminate属性を使用
4. **検索時の親表示**: マッチした部門の親も表示し、ツリー構造を維持

## 1.9 Phase 1 スコープ

- [x] 基本ツリー表示
- [x] 単一選択モード
- [x] 複数選択モード
- [x] 展開/折りたたみ
- [x] 検索機能
- [ ] cascade モード（配下自動選択）
- [ ] 仮想スクロール
- [ ] ドラッグ&ドロップ（並び替え）

---

# 2. （予約）その他の汎用コンポーネント

今後追加予定:
- PeriodSelector（期間セレクター）
- AmountInput（金額入力）
- VersionSelector（バージョン選択）

---

## 関連ドキュメント

- `.kiro/steering/epm-design-system.md` - デザインシステム定義
- `.kiro/steering/structure.md` - プロジェクト構造
- `apps/web/src/shared/ui/components/` - UIコンポーネント配置

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-12 | 初版作成（DepartmentTreeSelector仕様） | Claude Code |
