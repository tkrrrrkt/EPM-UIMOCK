# 見込入力機能 仕様概要

## 概要

月次ローリングで見込（Forecast）を入力・管理する機能。予算に対する着地見通しを部門担当者が入力し、通期の達成見込みを可視化する。

## 基本方針

- **予算入力画面をベース**: UIは予算入力とほぼ同じ
- **入力画面はシンプル**: 詳細分析はレポート機能に委ねる
- **比較表示で判断支援**: 予算・前回見込との差異を参考表示

## 対象エンティティ

| エンティティ | 役割 |
|-------------|------|
| fact_amounts | 見込ファクト（scenario_type='FORECAST'） |
| plan_events | 見込イベント（scenario_type='FORECAST'） |
| plan_versions | 見込バージョン（月次＋回数で管理） |
| accounting_periods | 会計期間（締め状態により実績表示切替） |

## 主要な仕様

### 画面構成

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│ [年度: 2026 ▼] [部門: 営業1課 ▼] [見込イベント: 2026年度見込 ▼] [バージョン: 5月第1回 ▼]            │
│                                               [モード: 部門全体 / PJ別]  [達成率: 98.5%]          │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 比較モード: [比較しない] [予算対比] [前回見込対比]                                                │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 科目フィルター: [売上高] [売上原価] [販管費] ...                                                  │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 見込 (2026年度) - 5月見込第1回                                                                    │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 科目           │4月  │5月  │6月  │1Q   │7月  │8月  │9月  │2Q  │上期 │10月│...│通期│
│                │実績 │締中 │見込 │     │見込 │見込 │見込 │    │     │見込│   │    │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 売上高         │1,000│1,150│1,200│3,350│1,100│1,100│1,100│3,300│6,650│... │   │    │
│ 売上原価       │  600│  680│  700│1,980│  650│  650│  650│1,950│3,930│... │   │    │
│ 【売上総利益】 │  400│  470│  500│1,370│  450│  450│  450│1,350│2,720│... │   │    │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘

凡例:
- 実績: 締め済み月（グレー背景、編集不可、実績値を表示）
- 締中: 締め処理中の月（黄色背景、状況に応じて編集可/不可）
- 見込: 未来月（白背景、編集可能）
```

### 月の状態と表示

| 月の状態 | close_status | 表示 | 編集 | 値の出所 |
|---------|-------------|------|------|----------|
| 実績確定 | HARD_CLOSED | グレー背景 | 不可 | 実績値（自動置換済み） |
| 仮締め | SOFT_CLOSED | 黄色背景 | 権限者のみ | 見込値または実績値 |
| 未締め | OPEN | 白背景 | 可能 | 見込入力値 |

### 見込イベント・バージョン管理

```
見込イベント: 2026年度見込
├── バージョン: 5月第1回  ← 5月見込の1回目
├── バージョン: 5月第2回  ← 5月見込の修正
├── バージョン: 6月第1回  ← 6月見込の1回目
└── ...
```

**管理単位**: 月次＋回数
- 「N月見込第M回」の形式でバージョン管理
- 同月内で複数回の見込作成が可能
- 前回見込 = 前月の最新バージョン or 同月の前バージョン

### 起点データと実績置換

**新規見込作成時**
1. 前回見込を自動コピーして開始
2. 締め済み月は実績値で自動置換

**月次締め時の自動処理**
1. 該当月の見込値を実績値で自動置換
2. 置換後は編集不可（HARD_CLOSED）

### 比較表示

| 比較モード | 表示内容 |
|-----------|---------|
| 比較しない | 見込グリッドのみ |
| 予算対比 | 各期間: 見込/予算/差異 の3列 |
| 前回見込対比 | 各期間: 今回見込/前回見込/差異 の3列 |

**通期見通し（ヘッダーに表示）**
- 累計実績 + 見込 = 通期見通し
- 通期達成率 = 通期見通し / 通期予算

### 調整行機能（削除）

> **決定事項（2026-01-12）**: 見込入力では調整行機能は不要とする。
> 見込入力は予算入力と同様に、セル値を直接入力する方式とする。
> 調整行（INPUT/ADJUST分離）は実績入力のみの機能とする。

### モード切替

| モード | 用途 |
|--------|------|
| 部門全体 | 部門の見込を入力 |
| PJ別 | PJ選択後、PJの見込を入力 |

### 入力頻度・タイミング

- **基本**: 月次ローリング（月次決算後に翌月以降の見込を更新）
- **随時更新**: 事業部会議等で必要に応じて随時更新可能
- **部門担当者**: 各部門の担当者がそれぞれ入力

## BFF Contracts（予定）

```typescript
// 見込グリッド取得
interface BffForecastGridRequest {
  fiscalYear: number;
  departmentId: string;
  forecastEventId: string;    // 見込イベントID
  forecastVersionId: string;  // 見込バージョンID
  projectId?: string;         // PJ別モード時
}

interface BffForecastGridResponse {
  context: BffForecastContext;
  periods: BffForecastPeriodColumn[];  // 月の状態（実績/締中/見込）を含む
  rows: BffForecastRow[];
  summary: BffForecastSummary;  // 通期見通し、達成率
}

// 期間列（見込用拡張）
interface BffForecastPeriodColumn extends BffPeriodColumn {
  monthStatus: 'ACTUAL' | 'CLOSING' | 'FORECAST';  // 月の状態
  actualValue?: string;  // 実績値（締め済み月のみ）
}

// 見込サマリー
interface BffForecastSummary {
  ytdActual: string;        // 年初来実績
  remainingForecast: string; // 残期間見込
  fullYearForecast: string;  // 通期見通し
  fullYearBudget: string;    // 通期予算
  achievementRate: number;   // 達成率（%）
}

// 比較用
interface BffForecastCompareRequest {
  fiscalYear: number;
  departmentId: string;
  forecastEventId: string;
  forecastVersionId: string;
  compareType: 'BUDGET' | 'PREVIOUS_FORECAST';
  compareBudgetVersionId?: string;    // 予算対比時
  compareForecastVersionId?: string;  // 前回見込対比時
}
```

## 画面フロー

```
1. コンテキスト選択
   └─ 年度、部門、見込イベント、バージョンを選択

2. グリッド表示
   ├─ 締め済み月 → 実績値を表示（編集不可）
   └─ 未来月 → 見込値を表示（編集可能）

3. 見込入力
   ├─ セル編集 → 自動保存（debounce 500ms）
   └─ 集計科目は自動計算

4. 比較モード切替
   ├─ 予算対比 → 見込/予算/差異を表示
   └─ 前回見込対比 → 今回/前回/差異を表示

5. 保存・確定
   └─ バージョンをFIXEDにすると編集不可
```

## 予算入力との差異

| 項目 | 予算入力 | 見込入力 |
|------|---------|---------|
| scenario_type | BUDGET | FORECAST |
| イベント管理 | 当初予算、修正予算等 | 月次＋回数（5月第1回等） |
| 全期間入力 | 可能 | 締め済み月は実績表示 |
| 起点データ | なし（新規作成） | 前回見込を自動コピー |
| 実績置換 | なし | 締め時に自動置換 |
| 比較対象 | バージョン比較 | 予算・前回見込対比 |
| 達成率表示 | なし | あり（ヘッダー） |

## Phase 1 スコープ

- [x] 見込グリッド表示（19期間列）
- [x] 月の状態による表示切替（実績/締中/見込）
- [x] セル編集・自動保存
- [x] 予算対比表示
- [x] 前回見込対比表示
- [x] 通期見通し・達成率表示
- [x] 科目フィルター
- [ ] ~~調整行の表示切替~~ → 見込入力では不要（実績入力のみ）
- [ ] PJ別モード（Phase 2）
- [ ] 過去実績パネル（Phase 2）

## 関連機能

- `.kiro/specs/仕様概要/予算入力機能.md` - 予算入力（ベース機能）
- `.kiro/specs/仕様概要/実績入力機能.md` - 実績入力（姉妹機能）

## 検討経緯

- QA壁打ち（2026-01-12）: 見込入力機能の要件整理

## 未確定事項

| 項目 | 状態 |
|------|------|
| 見込バージョンの命名規則 | 「N月第M回」で仮決定 |
| 実績置換のタイミング詳細 | 月次締め処理フローと連携 |
| PJ別モードの詳細UI | 予算入力と同様（Phase 1で実装予定） |

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-12 | 初版作成（QA壁打ちに基づく） | Claude Code |
| 2026-01-12 | 調整行機能を削除（実績入力のみに限定） | Claude Code |
