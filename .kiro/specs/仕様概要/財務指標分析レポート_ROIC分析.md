# 財務指標分析レポート（ROIC分析）- 仕様概要

## 1. 概要

EPMの財務指標分析レポート機能の一部として、ROIC（投下資本利益率）を提供する。
全社/事業部/部門単位で資本効率を把握し、収益性と資本回転の要因分解を行う。

### 対象ユーザー
- 経営層、経営企画、事業部長、部門責任者、経理/管理会計担当

---

## 2. 前提・スコープ

- **UI/選択項目はCVPと共通**（年度/Primary/Compare/期間レンジ/粒度/部門）
- **ROICは金額ベース（NOPAT/投下資本）で算出**
- **シミュレーションはUI内のみ**（保存しない/リロードでリセット）
- **BSが無い会社は簡易モード**（半期・通期のみ、実績のみ）
- **WACCは会社マスタ固定値**、ROICスプレッドを表示

---

## 3. 参照データとマスタ前提

### 3.1 対象エンティティ
- `fact_amounts`（予算/見込/実績）
- `plan_events` / `plan_versions`（イベント/バージョン）
- `accounting_periods`（期間・締め状態）
- `report_layouts` / `report_layout_lines`（PL/BSレイアウト）
- `subjects` / `subject_rollup_items`（科目/集計）
- `companies`（ROIC用設定）

### 3.2 会社マスタ設定（必須）
- `companies.roic_pl_layout_id`（ROIC用PLレイアウト）
- `companies.roic_bs_layout_id`（ROIC用BSレイアウト）
- `companies.roic_ebit_subject_id`（EBIT科目）
- `companies.roic_operating_assets_subject_id`（営業資産集計科目）
- `companies.roic_operating_liabilities_subject_id`（営業負債集計科目）
- `companies.effective_tax_rate`（実効税率, %）
- `companies.wacc_rate`（WACC, %）

---

## 4. 画面構成（1画面完結）

### 4.1 画面数・構成・リンク

```
[財務指標分析レポート]
  ├─ CVP損益分岐分析   (/reports/cvp-analysis)
  └─ ROIC分析          (/reports/roic-analysis)
        ├─ 分析ビュー（デフォルト）
        └─ 簡易入力パネル（右スライド、簡易モード時のみ）
```

### 4.2 ROIC画面レイアウト

```
┌──────────────────────────────────────────────────────────────┐
│ 年度: [▼]  Primary: [▼]  Compare: [なし/▼]                  │
├──────────────────────────────────────────────────────────────┤
│ 期間: [▼] 〜 [▼]   表示粒度: [月次/四半期/半期/年度 ▼]      │
├──────────────────────────────────────────────────────────────┤
│ 部門ツリー（単独/配下集約） │  KPIカード（ROIC/差分/WACC）    │
│                             │                                │
│                             │  ROICツリー（元値/シミュ後）    │
└──────────────────────────────────────────────────────────────┘
```

### 4.3 簡易入力パネル（右スライド）
- **表示条件**: 簡易モード対象 + 編集権限あり
- **起動**: 画面右上の「簡易入力」ボタンで開く
- **内容**:
  - 対象: 営業資産/営業負債の配下科目（集計行は読取）
  - 期間: 半期/通期のみ（固定、月次/四半期は表示しない）
  - 入力: 数値入力 + 保存/取消
  - 保存先: 固定イベント/固定バージョン（UI非表示）

### 4.4 簡易入力パネルの項目定義
- **表示ツリー**:
  - `roic_operating_assets_subject_id` 配下
  - `roic_operating_liabilities_subject_id` 配下
  - 集計科目は見出しとして表示（読取のみ）
- **編集可能行**:
  - `subject_class='BASE'` かつ `posting_allowed=true` の科目
  - 集計科目は編集不可
- **表示順**:
  1) `roic_bs_layout_id` の `report_layout_lines.line_no` 順
  2) 上記に無い場合は `subject_rollup_items.sort_order` 順
  3) それでも無い場合は `subject_code` 昇順
- **入力列**:
  - 上期（period_no=6）
  - 下期（period_no=12）
  - 通期は表示のみ（上期・下期の平均）
- **部門の扱い**:
  - 入力は **選択部門のみ**（配下集約ONの場合は入力不可とし案内表示）

### 4.5 ダッシュボードグラフ
- 右ペインに **KPIカード → グラフ → ROICツリー** の順で配置
- **グラフ1: ROIC vs WACC**
  - 複数期間がある場合: 折れ線（ROIC/WACC）
  - 単一点の場合: バレット（ROIC値 + WACC基準線）
  - シミュ後は太線、元値は細線、Compareは点線（選択時のみ）
- **グラフ2: ROIC分解バー**
  - NOPAT率と資本回転率を横並びで表示
  - ROICをラベルで併記（計算結果を明示）
  - 元値/シミュ後を並列表示

---

## 5. 選択項目・フィルター

### 5.1 Primary / Compare
- **Primary**: 予算 / 見込 / 実績
- **Compare**: 任意年度・任意イベント（比較対象、比較なし可）
- **前回見込**の概念は持たない
- CompareはPrimaryと独立して選択する

### 5.2 イベント/バージョン
- **予算**: イベント選択 + バージョン選択
- **見込**: イベント選択のみ（最新FIXEDバージョンを自動採用）
- **実績**: 年度のみ選択（イベント/バージョン選択なし）

### 5.3 期間レンジ/粒度
- 月範囲指定（年度内のみ）
- 表示粒度: 月次 / 四半期 / 半期 / 年度
- 四半期は `accounting_periods.quarter_no`、半期は `period_no` の 1-6 / 7-12
- 調整期（`period_kind='ADJ'`）は含めない

### 5.4 部門
- 部門ツリーから選択
- 単独 / 配下集約の切替

---

## 6. モード（標準 / 簡易）

### 6.1 標準モード（BS実績あり）
- 月次BS実績が存在する場合
- 粒度: 月次/四半期/半期/年度
- Primaryは予算/見込/実績すべて可（BSが無い場合は実績BSで代替）

### 6.2 簡易モード（BS未整備）
- 半期/通期のみ入力
- Primaryは実績のみ
- 営業資産/営業負債の**配下科目のみ**入力
- 配下が無い場合は画面ブロック

---

## 7. データ合成ルール

### 7.1 PL（NOPAT側）
- **EBIT**: `roic_ebit_subject_id` のPL値
- **NOPAT**: `EBIT × (1 - effective_tax_rate)`
- **売上高**: `companies.revenue_subject_id`

### 7.2 BS（投下資本側）
- **投下資本** = 営業資産 − 営業負債
- 営業資産/営業負債は `roic_operating_assets_subject_id` / `roic_operating_liabilities_subject_id`
- 標準モードは**月末残高の平均**を使用

### 7.3 予算/見込時のBS代替
- BS予算/見込が無い場合、**実績BSで代替**し、警告を表示
- 実績BS自体が無い場合はブロック

### 7.4 簡易モードの入力
- `fact_amounts` に **固定イベント/固定バージョン**（UI非表示）で保存
- 固定イベント例: `event_code=ROIC_SIMPLE_ACTUAL`（scenario_type=ACTUAL）
- 固定バージョン例: `version_code=FIXED`
- 入力は `period_no=6/12` に限定
- 期中は半期値を平均投下資本として扱う

#### 固定イベント/バージョンの作成方針
- 会社×年度の初回入力時に自動生成する
- 自動生成対象:
  - `plan_events`: `scenario_type=ACTUAL` / `event_code=ROIC_SIMPLE_ACTUAL` / `event_name=ROIC簡易実績`
  - `plan_versions`: `version_code=FIXED` / `status=FIXED`
- UIではイベント/バージョン選択を表示しない

---

## 8. ROICツリーと編集

### 8.1 ツリー構成（基本）
- ROIC
  - NOPAT
    - EBIT
  - 投下資本
    - 営業資産
    - 営業負債
- 収益率 × 回転率
  - NOPAT率 = NOPAT / 売上高
  - 資本回転率 = 売上高 / 投下資本

### 8.2 編集ルール（分析ビュー）
- **編集対象**: `line_type='account'` の行（集計/配下とも編集可）
- 親編集時は「調整差分」行を自動生成（CVPと同方式）
- 変更はUI内のみで保存しない

### 8.3 編集ルール（簡易入力パネル）
- **配下の通常科目のみ編集可能**（集計行は読取）
- 入力値は `fact_amounts` に保存（固定イベント/固定バージョン）
- 期間は半期/通期のみ

---

## 9. KPI指標（表示）

### 9.1 指標一覧
1. ROIC
2. NOPAT
3. EBIT
4. 税率
5. 投下資本
6. 営業資産
7. 営業負債
8. NOPAT率
9. 資本回転率
10. WACC
11. ROICスプレッド（ROIC - WACC）

### 9.2 計算不可条件
- 投下資本 = 0 の場合は「-」表示
- WACC未設定の場合は WACC / スプレッドを「-」表示

### 9.3 KPIカード配置（表示優先順）
- **第1列**: ROIC / WACC / ROICスプレッド / NOPAT
- **第2列**: NOPAT率 / 資本回転率 / 投下資本 / EBIT
- **第3列**: 営業資産 / 営業負債 / 税率
- 画面幅に応じて折り返し（順序は維持）

---

## 10. 警告・ブロック条件

### ブロック
- 会社マスタ設定が未設定（PL/BSレイアウト、EBIT/営業資産/営業負債、税率）
- 必須項目未選択（年度/Primary/部門/期間/粒度）
- PLまたはBSの実績データが0件
- 簡易モードで配下科目が存在しない

### 警告
- Primaryが予算/見込で、BSが実績代替となる場合

### 表示仕様
- **ブロック**: 画面全体を遮蔽し、案内メッセージのみ表示
- **警告**: KPIカードの直上にバナー表示（閉じない）

---

## 11. 権限・可視範囲（注記）

- 権限は**機能単位のロール権限**で制御（閲覧/編集）
- 可視範囲は**社員マスタのコントロール部門**で制御

---

## 12. 非対象（MVP外）

- ROICのシナリオ保存/共有
- 年度跨ぎの期間指定
- 他ディメンション（IRセグメント、プロジェクト等）のフィルター
- レポート出力/配信

---
