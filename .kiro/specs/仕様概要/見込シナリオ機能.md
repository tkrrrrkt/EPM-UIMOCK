# 見込シナリオ機能（ワースト/ノーマル/ベスト） 仕様概要

## 概要

見込入力において、特定科目に対してワースト/ノーマル/ベストの3シナリオを入力・管理する機能。期末が近づいた時に、会社全体の着地シナリオの幅を把握し、経営判断を支援する。

## 基本方針

- **経営視点の機能**: 部門の積み上げ見込に加え、シナリオの幅を持った予測を提供
- **ノーマル = 通常見込**: グリッドの値とノーマルは連動（同期）
- **任意入力**: W/Bの入力は任意、未入力時はノーマル値を使用
- **ディメンション科目は対象外**: 既に詳細展開している科目はW/N/B不要

## 確度管理との関係

| 機能 | 目的 | 対象 | 入力タイミング |
|------|------|------|--------------|
| 確度管理 | 確実な着地を把握（S/A/B/C/D/Z） | 特定科目（売上・粗利等） | 通年 |
| W/N/B管理 | 経営向け幅のある予測 | 特定科目 | 期末近く |

※ 両機能は別々に動作し、同じ科目に両方適用することも可能

## 設定方法

### 1. 対象科目の設定（予算レイアウト）

予算レイアウトで、W/N/B入力対象の科目を設定する。

```
予算レイアウト設定
─────────────────────────────────────
科目        │ディメンション│ W/N/B対象
─────────────────────────────────────
売上高      │ なし        │ ☑ ON
売上原価    │ なし        │ ☑ ON
売上総利益  │ -（集計）   │ ☐ OFF（集計科目）
販管費      │ なし        │ ☐ OFF
営業利益    │ -（集計）   │ ☐ OFF（集計科目）
広告宣伝費  │ 媒体DIM     │ ☐ OFF（ディメンション展開）
```

**制約**:
- ディメンション設定科目は W/N/B 対象にできない
- 集計科目（AGGREGATE）は子科目から自動集計

### 2. 開始月の設定（見込イベント）

見込イベント作成時に、W/N/B入力を有効にする開始月を設定する。

```
見込イベント作成
─────────────────────────────────────
イベント名: 2026年度見込
対象年度: 2026
W/N/B入力開始月: [10月 ▼]
─────────────────────────────────────
```

- 開始月より前の月: W/N/B入力不可（ノーマルのみ）
- 開始月以降: W/N/B入力可能（アイコン表示）

## 入力UI

### 見込入力画面（グリッド）

W/N/B対象科目・対象月には、セルにアイコンを表示。

```
科目      │ 9月        │ 10月       │ 11月       │ 12月
──────────┼────────────┼────────────┼────────────┼────────────
売上高    │ [1,000]    │ [1,100] 📊 │ [1,200] 📊 │ [1,300] 📊
売上原価  │ [  600]    │ [  650] 📊 │ [  700] 📊 │ [  750] 📊
販管費    │ [  300]    │ [  320]    │ [  340]    │ [  360]

凡例:
- 📊: W/N/B入力可能（クリックでダイアログを開く）
- 9月: W/N/B開始月より前のため対象外
```

### W/N/B入力ダイアログ

アイコンクリックで開くダイアログ。科目単位で対象月を横並び表示。

```
┌─────────────────────────────────────────────────────────────┐
│ 売上高 - シナリオ入力                              [×]     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│            │ 10月      │ 11月      │ 12月      │ 通期     │
│ ───────────┼───────────┼───────────┼───────────┼──────────│
│ ワースト   │ [  950]   │ [1,050]   │ [1,150]   │  3,150   │
│ ノーマル   │ [1,100]   │ [1,200]   │ [1,300]   │  3,600   │
│ ベスト     │ [1,250]   │ [1,350]   │ [1,450]   │  4,050   │
│ ───────────┼───────────┼───────────┼───────────┼──────────│
│ 予算       │  1,150    │  1,250    │  1,350    │  3,750   │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                              [キャンセル] [保存]            │
└─────────────────────────────────────────────────────────────┘
```

**ポイント**:
- ノーマル行はグリッドの値と連動（編集するとグリッドも更新）
- 通期列は自動計算（編集不可）
- 予算行は参考表示（編集不可）
- ワースト/ベストは任意入力

## データ構造

### エンティティ設計

既存の `fact_amounts` に `scenario_case` カラムを追加。

```sql
-- fact_amounts への追加カラム
ALTER TABLE fact_amounts ADD COLUMN scenario_case varchar(20);
-- NULL: 通常（ノーマル）, 'WORST', 'BEST'

-- 一意制約の更新（scenario_case を含める）
-- 既存: (tenant_id, company_id, accounting_period_id, subject_id, ...)
-- 新規: (tenant_id, company_id, accounting_period_id, subject_id, ..., scenario_case)
```

### scenario_case の値

| scenario_case | 説明 |
|---------------|------|
| NULL | 通常値（ノーマル）= グリッドの値 |
| 'WORST' | ワーストケース |
| 'BEST' | ベストケース |

### 予算レイアウトへの追加

```sql
-- report_layout_items への追加カラム
ALTER TABLE report_layout_items ADD COLUMN wnb_enabled boolean DEFAULT false;
```

### 見込イベントへの追加

```sql
-- plan_events への追加カラム
ALTER TABLE plan_events ADD COLUMN wnb_start_period_no smallint;
-- NULL: W/N/B機能を使用しない
-- 1-12: W/N/B入力開始月（period_no）
```

## 入力単位と集計

### 入力単位

- **部門単位**: 各部門がそれぞれW/N/Bを入力
- **会社は集計**: 部門の合計値を表示

### 未入力時の扱い

- W/Bが未入力の場合、**ノーマル値を使用**（W=N=B扱い）
- 集計時も同様（部門Aが未入力ならノーマル値で集計）

```
部門別入力状況
─────────────────────────────────────────
部門      │ ワースト │ ノーマル │ ベスト
─────────────────────────────────────────
営業1課   │   900    │  1,000   │  1,100   ← 全入力
営業2課   │  (800)   │    800   │  (800)   ← W/B未入力（ノーマル値）
─────────────────────────────────────────
会社計    │  1,700   │  1,800   │  1,900
```

## BFF Contracts

```typescript
// W/N/B入力ダイアログ用データ取得
interface BffWnbDialogRequest {
  forecastEventId: string;
  forecastVersionId: string;
  departmentId: string;
  subjectId: string;
}

interface BffWnbDialogResponse {
  subjectId: string;
  subjectCode: string;
  subjectName: string;
  wnbStartPeriodNo: number;  // W/N/B開始月
  periods: BffWnbPeriod[];
  annualSummary: BffWnbAnnualSummary;
}

interface BffWnbPeriod {
  periodNo: number;
  periodLabel: string;  // "10月"
  isWnbEnabled: boolean;  // W/N/B入力可能か
  worst: string | null;
  normal: string;  // グリッドの値
  best: string | null;
  budget: string;  // 参考表示
}

interface BffWnbAnnualSummary {
  worst: string;
  normal: string;
  best: string;
  budget: string;
}

// W/N/B保存
interface BffWnbSaveRequest {
  forecastEventId: string;
  forecastVersionId: string;
  departmentId: string;
  subjectId: string;
  values: BffWnbValue[];
}

interface BffWnbValue {
  periodNo: number;
  worst: string | null;  // null = 未入力（ノーマル値を使用）
  normal: string;
  best: string | null;
}

// 見込イベント作成（W/N/B設定追加）
interface BffCreateForecastEventRequest {
  eventCode: string;
  eventName: string;
  fiscalYear: number;
  wnbStartPeriodNo?: number;  // W/N/B開始月（null = 使用しない）
}
```

## Phase分け

### Phase 1

- [x] 予算レイアウトでのW/N/B対象科目設定
- [x] 見込イベントでのW/N/B開始月設定
- [x] 見込入力グリッドへのアイコン表示
- [x] W/N/B入力ダイアログ
- [x] 部門単位での入力・保存
- [x] 未入力時のノーマル値フォールバック

### Phase 2（将来検討）

- [ ] W/N/Bサマリーパネル（見込入力画面）
- [ ] W/N/B専用レポート画面
- [ ] シナリオ比較グラフ
- [ ] 確度管理との連携分析

## 関連機能

- `.kiro/specs/仕様概要/見込入力機能.md` - 見込入力の基本仕様
- `.kiro/specs/仕様概要/確度管理機能.md` - 確度管理（別機能）
- `.kiro/specs/仕様概要/予算入力機能.md` - 予算レイアウト設定

## 未確定事項

| 項目 | 状態 |
|------|------|
| W/N/B専用レポートの詳細 | 後日検討 |
| 集計科目のW/N/B自動計算ロジック | 子科目の集計で算出 |

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-12 | 初版作成（QA壁打ちに基づく） | Claude Code |
