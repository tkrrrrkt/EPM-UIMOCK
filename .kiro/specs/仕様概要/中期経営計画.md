# 中期経営計画 仕様概要

## 概要

中期経営計画（MTP: Mid-Term Plan）は、3〜5年スパンの経営目標と戦略テーマを管理する機能。予算ガイドライン・年度予算の上位概念として位置づけ、PL科目の目標値と事業部別の戦略方針を一元管理する。

## 対象エンティティ

| エンティティ | 定義ファイル | 役割 |
|-------------|-------------|------|
| mtp_events | `.kiro/specs/entities/01_各種マスタ.md` (15.1) | 中計イベント（2024年中計、2026年中計等） |
| mtp_strategy_themes | `.kiro/specs/entities/01_各種マスタ.md` (15.2) | 戦略テーマ（カスケード構造） |
| mtp_theme_kpis | `.kiro/specs/entities/01_各種マスタ.md` (15.3) | テーマ-KPI紐付け |
| fact_amounts | `.kiro/specs/entities/02_トランザクション・残高.md` | 中計数値（scenario_type = 'MTP'） |
| dimensions | `.kiro/specs/entities/01_各種マスタ.md` (4.1) | 組織ディメンション（org_purpose='MTP'） |
| dimension_values | `.kiro/specs/entities/01_各種マスタ.md` (4.2) | 組織ディメンション値（A事業部等） |
| department_dimension_links | `.kiro/specs/entities/01_各種マスタ.md` (4.6) | 部門→組織ディメンション紐付け |

## 主要な仕様

### 基本構造

```
【中期経営計画】
├── 対象: PL科目（売上・費用・利益）
├── 計画期間: 3年 or 5年（選択可能）
├── 時間粒度: 年度単位
├── 組織粒度: 組織ディメンション単位（全社、事業部等）
├── 入力単位: dimension_values（組織ディメンション値）
└── 管理単位: イベント単位（履歴管理なし、上書き更新）
```

### 組織ディメンションとの関係

```
【入力粒度】
中計入力 → 組織ディメンション（dimension_values）単位
         ├── 全社
         ├── A事業部
         ├── B事業部
         └── ...

【予算との接続】
予算入力 → 部門（departments）単位
         ├── 営業1課、営業2課、製造部...
         └── department_dimension_links で組織ディメンションに紐付け

【比較・集計】
予算データを department_dimension_links 経由で組織ディメンション単位に集計
→ 中計（事業部別）vs 予算集計（事業部別）の比較が可能
```

### 中計イベント

| 項目 | 説明 |
|------|------|
| event_code | イベントコード（例: MTP2026） |
| event_name | イベント名（例: 2026年中期経営計画） |
| plan_years | 計画年数（3 or 5） |
| start/end_fiscal_year | 開始〜終了年度 |
| dimension_id | 使用する組織ディメンション（org_purpose='MTP'） |
| status | DRAFT / CONFIRMED |

- 複数の中計イベントを並存可能
- イベント単位で使用する組織ディメンションを指定
- ステータス管理のみ（承認フローは別途設計）

### 戦略テーマ（カスケード構造）

```
【全社戦略テーマ】
├── テーマ: 海外事業拡大
├── 戦略種別: 売上拡大（自由入力）
├── 責任者: 経営企画部長
├── 関連KPI: 海外売上比率
│
└── 【事業部戦略テーマ】（子テーマ）
    ├── 親テーマ: [海外事業拡大]
    ├── ディメンション: A事業部
    ├── テーマ: 北米市場新規開拓
    ├── 戦略種別: 売上拡大
    └── 関連KPI: 北米新規顧客数
```

**構造:**
- ハイブリッド型（フリーテキスト + 定型属性）
- 全社テーマ（親）↔ 事業部テーマ（子）の階層
- 戦略種別は自由入力（将来マスタ化可能）

**項目:**
- テーマ名（必須）
- 概要（フリーテキスト）
- 戦略種別（売上拡大/コスト削減/基盤強化等）
- 責任者・期限
- 関連KPI紐付け

### 数値格納

- **格納先**: fact_amounts を共用
- **scenario_type**: 'MTP' を追加
- **入力単位**: dimension_values（組織ディメンション値）
- **理由**: 達成率計算が容易、既存設計との整合性

```sql
-- 中計数値の例
INSERT INTO fact_amounts (
  scenario_type,        -- 'MTP'
  plan_event_id,        -- mtp_events.id を参照
  subject_id,           -- 売上高等
  dimension_value_id,   -- 組織ディメンション値（A事業部等、全社はNULL or 専用値）
  department_stable_id, -- NULL（中計は部門単位ではない）
  amount,
  ...
)
```

**予算データとの比較:**
```sql
-- 予算データを事業部別に集計して中計と比較
SELECT
  dv.value_name AS segment_name,
  mtp.amount AS mtp_amount,
  budget_sum.amount AS budget_amount
FROM fact_amounts mtp
JOIN dimension_values dv ON mtp.dimension_value_id = dv.id
LEFT JOIN (
  SELECT ddl.dimension_value_id, SUM(fa.amount) AS amount
  FROM fact_amounts fa
  JOIN department_dimension_links ddl
    ON fa.department_stable_id = ddl.department_stable_id
  WHERE fa.scenario_type = 'BUDGET'
  GROUP BY ddl.dimension_value_id
) budget_sum ON mtp.dimension_value_id = budget_sum.dimension_value_id
WHERE mtp.scenario_type = 'MTP';
```

### 表示・分析機能

| 機能 | 説明 |
|------|------|
| 年度推移表示 | 3〜5年の数値を横並び表示 |
| 前年比・成長率 | 対前年増減率の表示 |
| 達成率表示 | 中計 vs 実績 |
| ディメンション別内訳 | 事業部別等 |
| グラフ表示 | 棒グラフ/折れ線 |
| 戦略テーマ表示 | 数値と一緒に表示（スプリット/タブ可） |

### 予算ガイドラインとの関係

| 項目 | 内容 |
|------|------|
| 連携方法 | 参照表示のみ（コピーではない） |
| 入力方法 | 独立入力（中計と連動しない） |
| 用途 | 中計を参照しながらガイドラインを策定 |

## UI仕様

### 画面構成

```
【中期経営計画】
├── 一覧画面（/planning/mtp）
│   └── イベント一覧（テーブル形式）
└── 詳細画面（/planning/mtp/:eventId）
    └── タブ構成
        ├── [入力] - 事業部別数値入力（実績+計画）
        ├── [全社俯瞰] - 全社合計+全事業部横並び
        ├── [推移] - グラフ+表
        └── [戦略テーマ] - ツリー表示
```

### 一覧画面

| 項目 | 仕様 |
|------|------|
| 表示項目 | イベントコード、イベント名、開始年度、計画年数、ステータス、更新日時 |
| フィルター | ステータスのみ（DRAFT / CONFIRMED） |
| ソート | 各カラムでソート可能 |
| 操作 | 行クリックで詳細画面へ遷移、新規作成・複製・削除ボタン |

### 詳細画面（タブ構成）

#### タブ1: 入力（デフォルト表示）

**入力モード切替**（トグルグループ）
- **単一選択モード**: 従来通り、1つのディメンション値を選んで入力
- **一括入力モード**: 全ディメンション値を縦に並べて一括入力

**単一選択モード**
- ディメンション値セレクター（全社 / A事業部 / B事業部 ... を切替）
- 選択したディメンション値のグリッドを表示

**一括入力モード**
```
┌─────────────────────────────────────────────────────────┐
│ 全社合計（自動集計・読み取り専用）                        │
│ ├─ 売上高      │ FY23実績 │ FY24実績 │ ... │ FY28計画 │ │
│ ├─ 売上原価    │          │          │     │          │ │
│ └─ 営業利益    │          │          │     │          │ │
├─────────────────────────────────────────────────────────┤
│ ▼ A事業部（アコーディオン）                              │
│   ├─ 売上高    │ [__]     │ [__]     │ ... │ [入力]   │ │
│   └─ ...                                                 │
├─────────────────────────────────────────────────────────┤
│ ▼ B事業部（アコーディオン）                              │
│   └─ ...                                                 │
└─────────────────────────────────────────────────────────┘
```

- **全社合計**: 常に最上部に固定表示、フロントエンド側でリアルタイム集計（計画列のみ）
- **各事業部**: アコーディオンで折りたたみ可能（デフォルト展開）
- **横スクロール**: 列数が多い場合は横スクロール対応
- **権限制御**: 将来的に一括入力可否を権限で制御可能

**数値入力グリッド**
```
| 科目         | FY2023実績 | FY2024実績 | FY2025実績 | FY2026計画 | FY2027計画 | FY2028計画 | 計画合計 |
|-------------|-----------|-----------|-----------|-----------|-----------|-----------|---------|
| 売上高       | 9,000     | 9,500     | 10,000    | [入力]     | [入力]     | [入力]     | [自動]   |
| 営業利益     | 1,300     | 1,400     | 1,500     | [自動計算] | [自動計算] | [自動計算] | [自動]   |
```

- **実績列**: 計画年数と同じ年数分表示（3年計画→3年実績）、グレー背景、読み取り専用
- **計画列**: 白背景、編集可能
- **計画合計列**: 計画年度の合計を自動計算
- **集計行**: 自動計算、編集不可
- **操作性**: BudgetGrid相当
  - セルクリックで編集モード
  - Tab: 右セルへ移動
  - Enter: 下セルへ移動
  - 矢印キー: 各方向へ移動
  - 500msデバウンス自動保存

#### タブ2: 全社俯瞰

**フィルターなし**（固定表示、スクロールで対応）

**グリッド構成**
```
| 科目/年度      | 全社合計 | A事業部 | B事業部 | C事業部 |
|---------------|---------|--------|--------|--------|
| FY2026 売上高  | 30,000  | 12,000 | 10,000 | 8,000  |
| FY2026 営業利益 | 4,500  | 2,000  | 1,500  | 1,000  |
| FY2027 売上高  | 33,000  | 13,000 | 11,000 | 9,000  |
| FY2027 営業利益 | 5,000  | 2,200  | 1,700  | 1,100  |
| FY2028 売上高  | 36,000  | 14,000 | 12,000 | 10,000 |
| FY2028 営業利益 | 5,500  | 2,400  | 1,900  | 1,200  |
```

- 横軸: 全社合計 + 全事業部（横並び）
- 縦軸: 年度 × 科目（全計画年度を展開）
- 構成比・差異を一覧で把握

#### タブ3: 推移

**上部: グラフ**
- 科目セレクター（売上高、営業利益など）
- 全社 / 選択事業部を**切替**表示
- 実績 + 計画を時系列で表示

**下部: 表**
- 全社のみ表示
- 実績 + 計画を横並び

#### タブ4: 戦略テーマ

- 全社テーマ・事業部テーマのツリー表示
- CRUD操作はすべてダイアログで実行（安定志向）
- 関連KPI表示

### イベント作成ダイアログ

| 項目 | 入力タイプ | 必須 |
|------|----------|------|
| イベントコード | テキスト | ○ |
| イベント名 | テキスト | ○ |
| 計画年数 | セレクト（3年/5年） | ○ |
| 開始年度 | セレクト | ○ |
| 組織ディメンション | セレクト | ○ |
| レイアウト | セレクト | ○ |
| 説明 | テキストエリア | - |

### 戦略テーマダイアログ

| 項目 | 入力タイプ | 必須 |
|------|----------|------|
| テーマ名 | テキスト | ○ |
| 親テーマ | セレクト（全社テーマ選択可） | - |
| 対象ディメンション値 | セレクト | △（事業部テーマの場合） |
| 戦略種別 | テキスト（自由入力） | - |
| 概要 | テキストエリア | - |
| 責任者 | テキスト | - |
| 期限 | 日付ピッカー | - |
| 関連KPI | マルチセレクト | - |

### グリッド技術選定

| 観点 | 判断 |
|------|------|
| 対象画面 | 中期経営計画、予算ガイドライン |
| 入力セル数 | 最大250セル程度（少量） |
| 採用技術 | BudgetGrid相当（カスタム実装） |
| SpreadJS | 不要（予算入力・見込入力で将来採用予定） |

## Phase 2 構想

| 項目 | 内容 |
|------|------|
| 財務インパクト | テーマ → 科目 → 金額の紐付け入力 |
| 戦略別PL | どの戦略にいくら投資したかの表示 |
| シナリオ分析 | 楽観/悲観シナリオでの数値シミュレーション |
| 戦略種別マスタ | 自由入力 → マスタ管理への移行 |

## 関連 Feature

- `.kiro/specs/planning/mtp/` - 中期経営計画機能
- `.kiro/specs/planning/budget-guideline/` - 予算ガイドライン機能
- `.kiro/specs/planning/budget-entry/` - 予算入力機能

## 関連ドキュメント

- [予算業務フロー.md](予算業務フロー.md) - 予算全体の業務プロセス
- [KPI管理機能.md](KPI管理機能.md) - 戦略テーマに紐付けるKPI科目

## 検討経緯

- `.kiro/specs/仕様検討/20260111_中期経営計画.md` - 設計方針の決定

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-11 | 初版作成 | Claude Code |
| 2026-01-11 | 組織ディメンション設計を反映（入力単位、予算との接続、比較集計方式） | Claude Code |
| 2026-01-11 | UI仕様セクション追加（画面構成、グリッド操作性、ダイアログ仕様） | Claude Code |
| 2026-01-11 | UI設計見直し：左右スプリット→タブ構成へ変更（入力/全社俯瞰/推移/戦略テーマ）、入力タブに実績列追加 | Claude Code |
| 2026-01-12 | 入力タブ: 入力モード切替（単一選択/一括入力）を追加、一括入力モード仕様（アコーディオン、全社リアルタイム集計、横スクロール、権限制御）、計画合計列を追加 | Claude Code |
