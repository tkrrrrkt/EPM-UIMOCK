# プロジェクト予算 仕様概要

## 概要

プロジェクト（PJ）単位での予算・見込・実績管理機能。部門予算とは別に、PJ軸で予算を立て、部門予算への集約・シミュレーションを可能にする。

## 対象エンティティ

| エンティティ | 定義ファイル | 役割 |
|-------------|-------------|------|
| fact_amounts | `entities/01_各種マスタ.md` | 予算・見込・実績ファクト（project_id 列で PJ 識別） |
| projects | `entities/01_各種マスタ.md` | プロジェクトマスタ（主幹部門 = owner_department_stable_id） |
| report_layouts | `entities/01_各種マスタ.md` | 予算レイアウト（部門用・PJ用で別） |

## 主要な仕様

### データ構造

```
fact_amounts
├── department_stable_id（必須）
├── subject_id（必須）
├── project_id（nullable）← PJ識別
├── source_type: INPUT / ADJUST / ALLOC / PROJECT_ROLLUP
└── amount
```

- **project_id あり**: PJ別データ
- **project_id = NULL**: PJ紐付けなしデータ
- 同じ科目・部門でも PJ別と PJなしが混在可能

### PJ予算の運用フロー

```
1. 主幹部門ごとにPJ予算を入力
   開発1課: PJ-A, PJ-B, (空PJ)
   開発2課: PJ-C, PJ-D

2. 部門予算作成時に「PJ集約」
   開発1課の部門予算 ← PJ-A + PJ-B + (空PJ) の集計値
   source_type = 'PROJECT_ROLLUP'

3. 必要に応じて調整
   足らず分を追加入力（source_type = 'ADJUST'）
```

### 予算レイアウト

- **部門予算レイアウト**: 会社に1つ（標準PL科目等）
- **PJ予算レイアウト**: 会社に1つ（PJ原価項目に特化）
- 科目体系は共通、表示する科目・並び順が異なる

### 空PJの活用

- 予備費・調整用として「空のPJ」を作成可能
- 未割当予算を空PJに計上
- PJ確定時に振替

### 実績データの混在対応

```
【ERPからの実績】
外注費/開発部/PJ-A   100万  → project_id = PJ-A
外注費/開発部/PJ-B    50万  → project_id = PJ-B
外注費/開発部/(なし)  30万  → project_id = NULL
```

- PJ別実績とPJなし実績が同一科目・部門で混在可能
- 部門合計は `SUM(amount) GROUP BY department_stable_id, subject_id`

### source_type の語彙

| source_type | 説明 |
|-------------|------|
| INPUT | 直接入力・取込 |
| ADJUST | 調整 |
| ALLOC | 配賦 |
| PROJECT_ROLLUP | PJ集計からのコピー |

### 画面設計

予算入力画面で**モード切替**方式を採用：

```
┌─────────────────────────────────────────────────┐
│ [シナリオ] 当初予算 ▼   [バージョン] 第2回 ▼    │
├─────────────────────────────────────────────────┤
│ [部門選択] 開発1課 ▼                            │
├─────────────────────────────────────────────────┤
│ [部門全体]  [PJ別]                ← モード切替  │
├─────────────────────────────────────────────────┤
│              科目×月 グリッド                    │
└─────────────────────────────────────────────────┘
```

| モード | レイアウト | 操作 |
|--------|-----------|------|
| 部門全体 | 部門予算レイアウト | 科目×月を直接入力、PJ集約ボタン |
| PJ別 | PJ予算レイアウト | PJ選択 → 科目×月を入力 |

### PJ見込の外部取込

- 外部PJ管理ツールからCSV取込可能
- 予算だけでなく**見込データも取込対応**
- 取込 → fact_amounts（scenario_type='FORECAST', project_id あり）

## 関連 Feature

- `.kiro/specs/planning/budget-entry/` - 部門予算入力機能
- `.kiro/specs/planning/project-budget/` - PJ予算入力機能（将来）

## 検討経緯

- `.kiro/specs/仕様検討/20260109_プロジェクト予算.md` - 設計方針の決定

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-09 | 初版作成 | Claude Code |
