# 月次締処理状況管理 仕様概要

## 概要

会計期間（accounting_periods）の close_status を管理し、月次締め処理の進捗を可視化・制御する機能。実績取込後の入力制御を行い、データの整合性を担保する。

## 基本方針

- **入力制御が主目的**: 締めステータスにより実績・見込の入力可否を制御
- **不可逆な本締め**: HARD_CLOSEDは差し戻し不可で確定を保証
- **監査ログ記録**: 締め操作の履歴をDBに記録（画面表示は不要）

## 締めステータス

| close_status | 名称 | 説明 | 入力制御 |
|--------------|------|------|---------|
| OPEN | 未締め | 入力期間中 | すべて入力可 |
| SOFT_CLOSED | 仮締め | 原則入力禁止、差し戻し可能 | 権限者のみ入力可 |
| HARD_CLOSED | 本締め | 完全確定、不可逆 | 入力不可 |

## 締め処理フロー

```
OPEN（入力期間）
  ↓ [仮締め実行] ※チェック条件あり
SOFT_CLOSED（仮締め）
  ↓ ミス発見時
  ↓ [戻す] 権限者のみ
  ↓ ← OPEN に戻る → 修正 → 再度仮締め
  ↓
  ↓ [本締め実行]
HARD_CLOSED（本締め・不可逆）
```

### 仮締め実行時のチェック条件

1. **前月がHARD_CLOSED済みであること**
   - 4月を仮締めするには3月がHARD_CLOSED必須
   - 期首月（4月）の場合は前年度3月をチェック

2. **実績取込が完了していること**
   - 判定方法は後日検討（取込ログ or 手動フラグ等）

## 入力制御マトリクス

| 締め状態 | 実績取込 | 実績調整 | 見込入力（該当月） |
|---------|---------|---------|------------------|
| OPEN | ○ | ○ | ○ |
| SOFT_CLOSED | △権限者 | △権限者 | × |
| HARD_CLOSED | × | × | × |

※ 予算入力は締め状態の影響を受けない（年度単位で管理）

## 対象エンティティ

### 既存: accounting_periods

```sql
-- 既存カラム（変更なし）
close_status varchar(20) NOT NULL DEFAULT 'OPEN'  -- OPEN/SOFT_CLOSED/HARD_CLOSED
closed_at timestamptz  -- 本締め日時
```

### 新規: period_close_logs（締め操作ログ）

```sql
CREATE TABLE period_close_logs (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  accounting_period_id uuid NOT NULL,
  action varchar(20) NOT NULL,      -- 'SOFT_CLOSE' / 'HARD_CLOSE' / 'REOPEN'
  from_status varchar(20) NOT NULL, -- 変更前ステータス
  to_status varchar(20) NOT NULL,   -- 変更後ステータス
  operated_by uuid NOT NULL,        -- 操作者
  operated_at timestamptz NOT NULL, -- 操作日時
  notes text,                       -- 理由・メモ（任意）

  FOREIGN KEY (tenant_id, company_id, accounting_period_id)
    REFERENCES accounting_periods(tenant_id, company_id, id)
);

CREATE INDEX idx_period_close_logs_period
  ON period_close_logs(tenant_id, company_id, accounting_period_id);
```

## 画面設計

### 画面構成

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 月次締処理状況                              [会社: ABC株式会社 ▼]            │
├──────────────────────────────────────────────────────────────────────────────┤
│ 年度: [2026 ▼]                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│ 期間   │ ステータス │ 締め日時           │ 操作者     │ 操作               │
├────────┼───────────┼───────────────────┼───────────┼───────────────────┤
│ 4月    │ ● 本締め  │ 2026-05-10 10:00  │ 山田太郎  │ -                  │
│ 5月    │ ● 本締め  │ 2026-06-08 15:30  │ 山田太郎  │ -                  │
│ 6月    │ ● 本締め  │ 2026-07-09 14:00  │ 山田太郎  │ -                  │
│ 7月    │ ◐ 仮締め  │ 2026-08-07 11:20  │ 山田太郎  │ [本締め] [戻す]    │
│ 8月    │ ○ 未締め  │ -                 │ -         │ [仮締め]           │
│ 9月    │ ○ 未締め  │ -                 │ -         │ -                  │
│ 10月   │ ○ 未締め  │ -                 │ -         │ -                  │
│ 11月   │ ○ 未締め  │ -                 │ -         │ -                  │
│ 12月   │ ○ 未締め  │ -                 │ -         │ -                  │
│ 1月    │ ○ 未締め  │ -                 │ -         │ -                  │
│ 2月    │ ○ 未締め  │ -                 │ -         │ -                  │
│ 3月    │ ○ 未締め  │ -                 │ -         │ -                  │
└──────────────────────────────────────────────────────────────────────────────┘

凡例: ● 本締め(HARD)  ◐ 仮締め(SOFT)  ○ 未締め(OPEN)
```

### 操作ボタンの表示条件

| ボタン | 表示条件 | 有効条件 |
|--------|---------|---------|
| [仮締め] | OPEN状態 | チェック条件をすべて満たす |
| [本締め] | SOFT_CLOSED状態 | - |
| [戻す] | SOFT_CLOSED状態 | 権限者のみ |

### 確認ダイアログ

**仮締め実行時**:
```
7月を仮締めします。
仮締め後は権限者のみ入力可能になります。

[キャンセル] [仮締めを実行]
```

**本締め実行時**:
```
⚠️ 7月を本締めします。
本締め後は変更できません。

[キャンセル] [本締めを実行]
```

**差し戻し時**:
```
7月の仮締めを解除して未締めに戻します。
理由（任意）: [________________]

[キャンセル] [戻す]
```

## BFF Contracts

```typescript
// 締め状況一覧取得
interface BffPeriodCloseStatusListRequest {
  companyId: string;
  fiscalYear: number;
}

interface BffPeriodCloseStatusListResponse {
  periods: BffPeriodCloseStatus[];
}

interface BffPeriodCloseStatus {
  accountingPeriodId: string;
  periodNo: number;           // 1-12
  periodLabel: string;        // "4月", "5月"...
  closeStatus: 'OPEN' | 'SOFT_CLOSED' | 'HARD_CLOSED';
  closedAt: string | null;    // ISO8601
  operatedBy: string | null;  // 操作者名
  canSoftClose: boolean;      // 仮締め可能か
  canHardClose: boolean;      // 本締め可能か
  canReopen: boolean;         // 戻し可能か
  checkResults?: BffCloseCheckResult[];  // チェック結果（仮締め不可時）
}

interface BffCloseCheckResult {
  checkType: 'PREVIOUS_MONTH_CLOSED' | 'ACTUAL_IMPORTED';
  passed: boolean;
  message: string;  // "前月が本締めされていません" 等
}

// 仮締め実行
interface BffSoftCloseRequest {
  accountingPeriodId: string;
}

// 本締め実行
interface BffHardCloseRequest {
  accountingPeriodId: string;
}

// 差し戻し
interface BffReopenRequest {
  accountingPeriodId: string;
  notes?: string;  // 理由
}

// 共通レスポンス
interface BffCloseOperationResponse {
  success: boolean;
  newStatus: 'OPEN' | 'SOFT_CLOSED' | 'HARD_CLOSED';
  operatedAt: string;
  errorMessage?: string;
}
```

## 権限設計

| 操作 | 必要権限 |
|------|---------|
| 締め状況の閲覧 | 経理担当者以上 |
| 仮締め実行 | 締め操作権限 |
| 本締め実行 | 締め操作権限 |
| 差し戻し（SOFT→OPEN） | 締め操作権限 |

※ 具体的な権限名・ロール割当は権限設計で別途定義

## 関連機能との連携

### 実績入力との連携

- SOFT_CLOSED/HARD_CLOSED月: 入力不可（グレーアウト表示）
- 権限者は SOFT_CLOSED 月のみ編集可能

### 見込入力との連携

- HARD_CLOSED月: 実績値を表示（編集不可）
- 新規見込作成時: HARD_CLOSED月は自動で実績値をコピー

## Phase分け

### Phase 1

- [x] 締め状況一覧画面
- [x] 仮締め/本締め/差し戻し操作
- [x] period_close_logs による監査ログ
- [x] 前月HARD_CLOSEDチェック

### Phase 2（将来検討）

- [ ] 部門単位の締め進捗管理
- [ ] 実績取込完了の自動判定
- [ ] 操作履歴の画面表示

## 未確定事項

| 項目 | 状態 |
|------|------|
| 実績取込完了の判定方法 | 後日検討 |
| 権限名・ロール定義 | 権限設計で別途定義 |

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-12 | 初版作成（QA壁打ちに基づく） | Claude Code |
