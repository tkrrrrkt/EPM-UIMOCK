# 実績入力機能 仕様概要

## 概要

実績データの調整入力を行う機能。ERPから取り込まれた実績に対する調整（原価差異、期末調整等）を入力し、予算・見込との差異を確認する。

## 基本方針

- **調整入力がメイン**: ERPから自動取込される実績に対する調整が主目的
- **予算入力画面をベース**: UIは予算入力・見込入力とほぼ同じ
- **入力画面はシンプル**: 詳細分析はレポート機能に委ねる
- **単一バージョン**: 実績は常に1つ（上書き更新）

## 対象エンティティ

| エンティティ | 役割 |
|-------------|------|
| fact_amounts | 実績ファクト（scenario_type='ACTUAL'） |
| accounting_periods | 会計期間（締め状態管理） |

## 主要な仕様

### 画面構成

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│ [年度: 2026 ▼] [部門: 営業1課 ▼]                               [調整内訳を表示: ON/OFF]          │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 実績 (2026年度)                                                                                   │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 科目           │4月  │5月  │6月  │1Q   │7月  │8月  │9月  │2Q  │上期 │10月│...│通期│
│                │確定 │確定 │入力中│     │未経過│未経過│未経過│    │     │未経過│   │    │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 売上高         │1,000│1,150│1,180│3,330│  -  │  -  │  -  │  - │3,330│  - │   │    │
│ 売上原価       │  600│  680│  690│1,970│  -  │  -  │  -  │  - │1,970│  - │   │    │
│ 【売上総利益】 │  400│  470│  490│1,360│  -  │  -  │  -  │  - │1,360│  - │   │    │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘

凡例:
- 確定: 締め済み月（グレー背景、編集不可）
- 入力中: 当月（白背景、編集可能）
- 未経過: 未来月（薄グレー背景、データなし）
```

### 月の状態と表示

| 月の状態 | close_status | 表示 | 編集 | 備考 |
|---------|-------------|------|------|------|
| 確定 | HARD_CLOSED | グレー背景 | 不可 | 締め済み実績 |
| 仮締め | SOFT_CLOSED | 黄色背景 | 権限者のみ | 調整可能期間 |
| 入力中 | OPEN | 白背景 | 可能 | 当月の実績入力 |
| 未経過 | - | 薄グレー | 不可 | データなし表示 |

### 実績データの管理

**単一バージョン**
- 実績は常に1つ（バージョン管理なし）
- 上書き更新方式

**データの出所（source_type）**
| source_type | 用途 | 編集 |
|-------------|------|------|
| INPUT | ERP取込値 / 手入力値 | 基本不可（手入力時のみ可） |
| ADJUST | 調整入力 | 可能 |

### 調整行の表示

- **デフォルト**: 非表示（合計値のみ表示）
- **トグルON時**: INPUT行とADJUST行を分けて表示

```
調整行OFF時:
外注費: 105万

調整行ON時:
外注費（ERP取込）: 100万  ← INPUT（編集不可）
外注費（調整）   :  +5万  ← ADJUST（編集可）
外注費（合計）   : 105万
```

### 比較機能（削除）

> **決定事項（2026-01-12）**: 実績入力画面はシンプルに「当月の実績入力・調整」に特化する。
> 予算対比・見込対比はレポート機能で行う想定とし、実績入力画面には比較モードを設けない。

### モード切替

| モード | 用途 |
|--------|------|
| 部門全体 | 部門の実績を調整入力 |
| PJ別 | PJ選択後、PJの実績を調整入力 |

### 入力ケース

**ケース1: ERP取込後の調整**
- ERP取込値は編集不可（INPUT）
- 調整が必要な場合はADJUST行に入力
- 原価差異、期末調整等

**ケース2: 手入力（ERPがない科目/部門）**
- INPUT行に直接入力
- 企業によっては一部科目で手入力が必要

## BFF Contracts（予定）

```typescript
// 実績グリッド取得
interface BffActualGridRequest {
  fiscalYear: number;
  departmentId: string;
  projectId?: string;  // PJ別モード時
}

interface BffActualGridResponse {
  context: BffActualContext;
  periods: BffActualPeriodColumn[];  // 月の状態を含む
  rows: BffActualRow[];
}

// 期間列（実績用拡張）
interface BffActualPeriodColumn extends BffPeriodColumn {
  monthStatus: 'CLOSED' | 'SOFT_CLOSED' | 'OPEN' | 'FUTURE';
}

// 実績行（調整行対応）
interface BffActualRow extends BffBudgetRow {
  sourceType: 'INPUT' | 'ADJUST' | 'TOTAL';
  inputValue?: string;   // INPUT値（調整行表示時）
  adjustValue?: string;  // ADJUST値（調整行表示時）
}

// 比較用（※ Phase 1では未使用、レポート機能で対応）
// interface BffActualCompareRequest { ... }
```

## 画面フロー

```
1. コンテキスト選択
   └─ 年度、部門を選択（バージョン選択なし）

2. グリッド表示
   ├─ 締め済み月 → 実績値を表示（編集不可）
   ├─ 入力中月 → 実績値を表示（編集可能）
   └─ 未経過月 → データなし表示

3. 実績入力/調整
   ├─ 調整行トグルOFF → ADJUST行（調整値）を編集（合計に反映）
   └─ 調整行トグルON → INPUT/ADJUST行を分けて表示、ADJUST行を編集

4. 保存
   └─ 自動保存（debounce 500ms）
```

## 予算入力・見込入力との差異

| 項目 | 予算入力 | 見込入力 | 実績入力 |
|------|---------|---------|---------|
| scenario_type | BUDGET | FORECAST | ACTUAL |
| バージョン | 複数 | 複数（月次＋回数） | 単一 |
| イベント選択 | あり | あり | なし |
| 調整行 | なし | あり | あり（メイン機能） |
| 未来月 | 入力可 | 入力可 | データなし |
| 主な用途 | 予算策定 | 着地見通し | 調整入力 |

## Phase 1 スコープ

- [x] 実績グリッド表示（19期間列）
- [x] 月の状態による表示切替（確定/仮締め/入力中/未経過）
- [x] セル編集・自動保存
- [x] 調整行の表示切替（INPUT/ADJUST内訳表示）
- [ ] ~~予算対比表示~~ → レポート機能で対応
- [ ] ~~見込対比表示~~ → レポート機能で対応
- [ ] 科目フィルター（Phase 2）
- [ ] PJ別モード（Phase 2）
- [ ] 過去実績パネル（Phase 2）

## 関連機能

- `.kiro/specs/仕様概要/予算入力機能.md` - 予算入力（ベース機能）
- `.kiro/specs/仕様概要/見込入力機能.md` - 見込入力（姉妹機能）
- `.kiro/specs/data-import/` - データ取込機能（将来）

## 検討経緯

- QA壁打ち（2026-01-12）: 実績入力機能の要件整理

## 未確定事項

| 項目 | 状態 |
|------|------|
| ERP取込との連携詳細 | データ取込機能と連携（Phase 2以降） |
| 調整理由の管理 | notes列で自由記述（Phase 1） |
| PJ別モードの詳細UI | 予算入力と同様（Phase 1で実装予定） |

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-12 | 初版作成（QA壁打ちに基づく） | Claude Code |
| 2026-01-12 | 比較モード削除（レポート機能で対応）、画面構成簡素化 | Claude Code |
