# 予算実績照会レポート - 仕様概要

## 1. 概要

EPM SaaS における基本レポート機能。予算と見通し（実績＋見込）の比較、前年比較を通じて、経営状況の把握と差異分析を可能にする。

### 対象ユーザー
- 経営層、事業部長、部長、課長、経理部門、企画
- （見方は異なるが同一レポートを使用）

---

## 2. レポート構成（タブ構成）

```
┌─────────────────────────────────────────────────────────────┐
│  予算実績照会                                                │
├─────────────────────────────────────────────────────────────┤
│  [サマリー] [詳細テーブル] [推移分析] [差異分析]              │
├─────────────────────────────────────────────────────────────┤
│  共通ヘッダー:                                               │
│  会社: [▼]  予算イベント: [期初予算 ▼]  年度: [2026 ▼]       │
└─────────────────────────────────────────────────────────────┘
```

### タブ一覧

| タブ | 目的 | 行軸 | 列軸 | 主な表示 |
|------|------|------|------|---------|
| **サマリー** | 全体俯瞰、異常検知 | レイアウトマスタ | - | KPIカード、達成率バー、アラート |
| **詳細テーブル** | 組織×科目の詳細確認 | レイアウトマスタ（ツリー展開） | 組織階層 | マトリクス表示、ドリルダウン |
| **推移分析** | 時系列変化の把握 | 選択科目 | 月次 | 折れ線、前年比較（3パターン） |
| **差異分析** | 差異要因の特定 | 集計科目階層（rollup） | - | ウォーターフォール |

---

## 3. 主要機能

### 3.1 比較軸

| 比較種別 | 内容 | Phase |
|---------|------|-------|
| **予算 vs 見通し** | 選択した予算イベント vs (実績済み + 残見込) | Phase 1 |
| **前年比較** | 当期 vs 前年同期（3パターン） | Phase 1 |
| **数量単価金額（P/V/M）差異分析** | 物販的な差異分解 | Phase 2以降 |

### 3.2 見通し（Outlook）の定義

```
見通し = 実績済み金額 + この先の見込入力金額
```

- 実績済み: 締め処理完了分の実績データ
- 見込入力: 未来月の見込データ（見込入力機能で登録）

### 3.3 予算イベント選択

予算は複数バージョンが存在する:
- 期初予算（年度開始時の承認予算）
- 修正予算（半期見直し後の予算など）

**UI**: ドロップダウンでイベント単位選択 → 選択した予算と見通しを比較

### 3.4 前年比較（3パターン）

| パターン | 説明 | 用途 |
|---------|------|------|
| **前年同月比** | 当月 vs 前年同月 | 月次の季節性確認 |
| **前年同期累計比（YTD）** | 当期累計 vs 前年同期累計 | 進捗の前年比較 |
| **前年通期比** | 着地見込 vs 前年実績 | 年度計画の妥当性確認 |

---

## 4. 各タブの詳細仕様

### 4.1 サマリータブ

**目的**: 全体俯瞰、異常検知（経営層・管理者向け）

```
┌──────────────────────────────────────────────────────┐
│ 営業利益達成率  87% ████████░░  ⚠ 目標未達           │
│ 売上高達成率    92% █████████░                       │
│ 粗利率          38% (予算: 40%) ▼ 2pt               │
├──────────────────────────────────────────────────────┤
│ 【要注意】                                           │
│  • 事業部B: 売上達成率 78% (前年同期比 -12%)         │
│  • 販管費: 予算超過 +8%                              │
└──────────────────────────────────────────────────────┘
```

**表示要素**:
- KPIカード（主要指標の達成率）
- 達成率バー（プログレス表示）
- アラート（閾値未達の項目をハイライト）

**アラート閾値（Phase 1: 固定値）**:
| 指標 | 閾値 | アラート条件 |
|------|------|-------------|
| 達成率 | 90% | 90%未満でアラート |
| 前年比 | -10% | -10%以下でアラート |
| 予算超過 | +5% | 5%超過でアラート |

※ Phase 2以降でユーザー設定可能に拡張

### 4.2 詳細テーブルタブ

**目的**: 組織×科目のマトリクス表示、詳細確認

```
                    | 全社    | 事業部A | 事業部B | 管理部門 |
--------------------+---------+---------+---------+----------|
▼ 売上高            | 800M    | 500M    | 300M    | -        |
    製品売上        | 600M    | 400M    | 200M    | -        |
    サービス売上    | 200M    | 100M    | 100M    | -        |
▶ 売上原価          | 500M    | 300M    | 200M    | -        |
  売上総利益        | 300M    | 200M    | 100M    | -        |
▶ 販管費            | 130M    |  50M    |  30M    |  50M     |
  営業利益          | 170M    | 150M    |  70M    | -50M     |
```

**軸の定義**:
- **行軸**: レイアウトマスタ（`indent_level` でツリー展開）
- **列軸**: 組織マスタ階層（全社 → 事業部 → 部門）

**ドリルダウン**:
- 行: レイアウトのツリー展開（▼クリック）
- 列: 組織のドリルダウン（**置換方式**: 事業部Aクリック → 列が「事業部A計/営業1課/営業2課」に置換）
- パンくずナビで上位階層に戻る

**セル表示（切替式）**:
- ドロップダウンで表示モード選択
- 見通し金額のみ
- 予算 / 見通し
- 見通し (達成率%)
- 差異金額

**集計ロジック**:
- 「全社」列 = 子組織（事業部）の合計
- 各階層で子組織の合計を計算

**初期表示**:
- 行: レイアウトマスタの第1階層（展開前）
- 列: 全社 + 第1階層（事業部）
- セル: 見通し (達成率%)

### 4.3 推移分析タブ

**目的**: 時系列変化の把握、前年比較

```
科目選択: [売上高 ▼]  比較モード: [前年同月比 ▼]

        | 4月  | 5月  | 6月  | ... | 累計  |
--------+------+------+------+-----+-------|
当期    | 80M  | 85M  | 90M  |     | 650M  |
前期    | 75M  | 80M  | 88M  |     | 620M  |
増減    | +5M  | +5M  | +2M  |     | +30M  |
増減率  | +7%  | +6%  | +2%  |     | +5%   |

[グラフ: 当期実績(実線) + 前期(点線) + 見込(破線)]
```

**比較モード切替**:
- 前年同月比（月次）
- 前年同期累計比（YTD）
- 前年通期比（着地見込 vs 前年実績）

### 4.4 差異分析タブ

**目的**: 差異要因の特定（ウォーターフォール）

```
対象: [営業利益 ▼]  比較: [予算 vs 見通し ▼]

営業利益（予算）     100M  ████████████████████
  │
  ├─ 売上高          +30M  ██████ ↑ 緑
  │    ├─ 製品       +20M  ████ ↑
  │    └─ サービス   +10M  ██ ↑
  ├─ 売上原価        -10M  ██ ↓ 赤
  ├─ 販管費          -10M  ██ ↓ 赤
  │
営業利益（見通し）   110M  ██████████████████████
```

**軸の定義**:
- **集計科目階層**（`subject_rollup_items`）を使用
- レイアウトマスタではなく、科目の親子関係で分解

**ドリルダウン**:
- 要因クリックで下位rollup構造へ展開

---

## 5. ウォーターフォール差異分析（詳細）

### 5.1 概要

サマリー指標（営業利益、経常利益等）に対して、どの科目がUP/DOWNしているかを視覚的に分解表示。

### 5.2 データ構造

**集計科目階層**（`subject_rollup_items`）を使用:

```
営業利益（AGGREGATE）
  ├─ 売上総利益 (coefficient: +1)
  │    ├─ 売上高 (coefficient: +1)
  │    └─ 売上原価 (coefficient: -1)
  └─ 販管費 (coefficient: -1)
       ├─ 人件費
       └─ その他経費
```

**ポイント**:
- `coefficient` が符号を決定（+1: 利益増要因、-1: 利益減要因）
- rollupの係数で自動的に利益影響を計算

### 5.3 仕様定義

| 項目 | 仕様 |
|------|------|
| **対象指標** | AGGREGATE科目（営業利益、経常利益など） |
| **分解レベル** | rollupの直下構成科目を差異要因として表示 |
| **符号ルール** | `subject_rollup_items.coefficient` に従う |
| **表示順序** | `subject_rollup_items.sort_order` 順 |
| **ドリルダウン** | 構成科目クリックでさらに下位rollupへ展開 |
| **小さい差異** | Phase 1では全て表示（閾値によるまとめは後日検討） |

### 5.4 ロジック

```typescript
// 対象科目のrollup構成を取得
const rollupItems = await getRollupItems(targetSubjectId);

// 各構成科目の差異を計算
for (const item of rollupItems) {
  const 予算金額 = await getAmount(item.componentSubjectId, '予算');
  const 見通し金額 = await getAmount(item.componentSubjectId, '見通し');

  // 差異金額（元の科目の増減）
  const 差異金額 = 見通し金額 - 予算金額;

  // 利益への影響（coefficientを考慮）
  const 利益影響 = 差異金額 * item.coefficient;
  // +なら利益増要因（緑）、-なら利益減要因（赤）
}
```

### 5.5 比較モード

| モード | 起点 | 終点 |
|--------|------|------|
| **予算 vs 見通し** | 予算金額 | 見通し金額 |
| **予算 vs 実績** | 予算金額 | 実績金額（累計） |
| **前年 vs 当期** | 前年実績 | 当期見通し |

---

## 6. 推移・進捗表示

### 6.1 表示要素

| 要素 | 何がわかるか | 表示イメージ |
|------|-------------|-------------|
| **月次推移** | 各月の変動パターン | 折れ線/棒グラフ |
| **累計進捗** | 年度予算に対する消化率 | プログレスバー + % |
| **残予算** | あといくら使えるか | 残額表示 |
| **見通し着地** | このペースだと年度末どうなるか | 予測ライン（点線） |
| **前年同期比** | 去年の同時期と比べてどうか | 対比表示 |

### 6.2 表示パターン例

```
【売上】
  予算: 1,200M  累計実績: 650M  進捗: 54%  ████████░░░░
  見通し: 1,180M (達成率 98%)  前年同期比: +5%

  [月次推移グラフ: 4-9月実績 + 10-3月見込が点線で表示]
```

---

## 7. モダンUI要素

### 7.1 視覚的フィードバック

| 要素 | 説明 |
|------|------|
| **差異ハイライト** | 予算超過=赤、達成=緑、閾値で色分け |
| **達成率バー** | 数値横にプログレスバー表示 |
| **スパークライン** | 月次推移を小さなグラフで表示 |
| **ツールチップ** | ホバーで詳細情報表示 |

### 7.2 エクスポート機能

- Excel形式でのエクスポート必須
- 表示中のデータをそのまま出力
- フィルタ・ドリル状態を反映

---

## 8. データソース

### 8.1 レイアウト定義（詳細テーブル用）

- **レイアウトマスタ** (`report_layouts` + `report_layout_lines`)
- PL/BS/KPIの表示構造を定義
- 詳細テーブルの行軸として使用

### 8.2 集計科目階層（ウォーターフォール用）

- **科目マスタ** (`subjects`) + **rollup関係** (`subject_rollup_items`)
- AGGREGATE科目の構成を定義
- ウォーターフォールの分解軸として使用
- `coefficient` で利益影響の符号を決定

### 8.3 予算データ

- **計画イベント** (`plan_events`) から予算バージョンを選択
- **科目残高** (`subject_balances`) から予算金額を取得

### 8.3 実績・見込データ

- **科目残高** (`subject_balances`) から実績・見込金額を取得
- 締め処理状況 (`accounting_periods.close_status`) で実績確定判定

---

## 9. Phase分け

### Phase 1（今回スコープ）

- [ ] 予算 vs 見通し比較
- [ ] 前年比較
- [ ] レイアウトマスタベースの表示
- [ ] ドリルダウン（全社→事業部→部門→科目）
- [ ] テーブル表示 + 基本グラフ
- [ ] ウォーターフォール差異分析
- [ ] Excelエクスポート
- [ ] 達成率バー、差異ハイライト

### Phase 2以降

- [ ] 部門配下制御（インサイダー対応）※下記参照
- [ ] 数量単価金額（P/V/M）差異分析
- [ ] 差異閾値による「その他」まとめ
- [ ] AIインサイト（自動コメント生成）
- [ ] ダッシュボード統合

---

## 10. 将来検討事項

### 10.1 部門配下制御（インサイダー対応）

**背景**:
- 上場企業ではインサイダー情報管理が必須
- 自分が所属している部門配下の数値しか見れない制御が必要

**要件メモ**:
- ユーザーの所属部門を判定
- 所属部門配下の組織・数値のみ閲覧可能
- 経理・経営企画は全社閲覧可能（権限ロールで制御）

**設計**:
後日検討（Phase 2以降）

---

## 11. 関連仕様

- [レイアウトマスタ](.kiro/specs/master-data/report-layout/)
- [計画イベント](.kiro/specs/planning/)
- [科目マスタ](.kiro/specs/master-data/subject-master/)
- [組織マスタ](.kiro/specs/master-data/organization-master/)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-12 | 初版作成（仕様検討結果をまとめ） |
| 2026-01-12 | タブ構成追加、マトリクス表示（組織×科目）、ウォーターフォールをrollup構造ベースに変更 |
