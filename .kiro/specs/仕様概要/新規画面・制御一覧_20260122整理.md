# 新規画面・制御一覧（2026-01-22検討結果より）

## 概要

2026-01-20、2026-01-22の仕様検討結果から、新規で作成が必要な画面と制御機能を整理。

---

## 目次

1. [KPI管理関連](#1-kpi管理関連)
2. [データ取込・締処理関連](#2-データ取込締処理関連)
3. [承認ワークフロー関連](#3-承認ワークフロー関連)
4. [権限・アクセス制御関連](#4-権限アクセス制御関連)
5. [その他機能](#5-その他機能)

---

## 1. KPI管理関連

### 1.1 KPI管理マスタ登録画面【新規】

#### 概要
年度単位のKPI管理項目を登録・編集する画面。

#### 主要機能
- 年度別KPI管理イベント作成
- KPI項目登録（財務科目/非財務KPI/指標から選択）
- 責任部門・責任者の設定
- 表示順の設定
- ステータス管理（DRAFT/CONFIRMED）

#### 画面構成
```
画面一覧:
- KPI管理マスタ一覧画面
- KPI管理イベント作成画面
- KPI項目追加/編集モーダル
  - 財務科目選択モード
  - 非財務KPI選択/新規作成モード
  - 指標選択モード
```

#### 実装優先度
**高（Phase 1必須）**

---

### 1.2 非財務KPI定義マスタ画面【新規】

#### 概要
非財務KPI項目（CO2削減率、新規顧客数等）を定義・管理する画面。

#### 主要機能
- 非財務KPI項目の登録・編集・削除
- KPIコード、KPI名、単位の設定
- 集計方法の設定（SUM/EOP/AVG/MAX/MIN）
- 方向性の設定（higher_is_better / lower_is_better）

#### 画面構成
```
画面一覧:
- 非財務KPI定義一覧画面
- 非財務KPI定義登録/編集画面
```

#### 実装優先度
**高（Phase 1必須）**

---

### 1.3 非財務KPI目標・実績入力画面【新規】

#### 概要
非財務KPIの目標と実績を入力・管理する画面。レイアウトマスタ不要のシンプルな入力画面。

#### 主要機能
- 年度・KPI・部門選択
- 期間コード自由入力（"2026-Q1", "2026-04", "2026-H1" 等）
- 目標値・実績値の入力
- 達成率の自動計算・表示
- 年計の自動集計（集計方法に応じて）

#### 画面構成
```
画面一覧:
- 非財務KPI入力画面（一覧＋インライン編集）
- 期間追加モーダル
```

#### 技術要件
- SJS（SpreadJS）は使用しない（AGGrid等でシンプルに実装）
- 期間の軸は自由入力（テキスト）
- 単位マスタは不要（kpi_definitions.unit を参照）

#### 実装優先度
**高（Phase 1必須）**

---

### 1.4 KPI階層管理画面【新規】

#### 概要
KPI項目の階層構造（KGI→KPI→詳細KPI）を定義・管理する画面。

#### 主要機能
- KPI項目の親子関係設定
- 階層レベルの設定（1:KGI, 2:KPI, 3:詳細KPI）
- ツリー表示での階層確認
- ドラッグ&ドロップでの階層変更

#### 画面構成
```
画面一覧:
- KPI階層管理画面（ツリービュー）
```

#### 補足
- Phase 1では階層構造のみ実装（積み上げ集計はなし）
- Phase 2で自動積み上げ機能を検討

#### 実装優先度
**中（Phase 2検討）**

---

### 1.5 ダッシュボードマスタ登録画面【新規】

#### 概要
KPI連携ダッシュボードのレイアウト・表示内容を定義する画面。

#### 主要機能
- ダッシュボード定義の登録・編集
- カード配置・サイズの設定
- 表示対象の選択（財務科目/非財務KPI/指標/アクションプラン）
- フィルタ設定（部門・期間・予算/実績）
- 表示形式の選択（カード/グラフ/テーブル）
- デフォルトダッシュボードの設定

#### 画面構成
```
画面一覧:
- ダッシュボードマスタ一覧画面
- ダッシュボード定義登録/編集画面
  - レイアウト設計エリア（ドラッグ&ドロップ）
  - カード設定モーダル
  - プレビュー機能
```

#### 参考
- PM（プロジェクト管理ツール）のダッシュボード機能を参考
- 個人ごとにカスタマイズ可能な構成

#### 実装優先度
**中（Phase 2検討）**

---

### 1.6 アクションプラン登録画面の改修【改修】

#### 概要
既存のアクションプラン登録画面を改修し、KPI選択肢を拡張。

#### 主要変更点
- KPI選択UIの変更
  - 従来: 科目マスタ（subject_type='KPI'）のみ
  - 新規: 年度別KPI管理マスタから選択（財務/非財務/指標）
- KPI情報の表示追加
  - 財務: 予算・見込・実績の表示
  - 非財務: 目標・実績の表示
  - 指標: 計算結果の表示

#### 実装優先度
**高（Phase 1必須）**

---

### 1.7 KPI連携ダッシュボード画面の改修【改修】

#### 概要
KPI種別（財務/非財務/指標）に応じて表示内容を動的に切り替え。

#### 主要変更点
- 財務科目: 承認済み予算・見込・実績を表示
- 非財務KPI: 目標・実績を表示
- 指標: 自動計算結果を表示（予実管理なし）

#### 実装優先度
**高（Phase 1必須）**

---

## 2. データ取込・締処理関連

### 2.1 予算取込画面【新規】

#### 概要
CSVファイルから予算データを取り込む画面。

#### 主要機能
- CSVファイルアップロード
- マッピング設定（EPM側の科目・部門とのマッピング）
- プレビュー機能（マッピング結果の確認）
- バリデーションチェック
  - 科目マスタ存在チェック
  - 部門マスタ存在チェック
  - 期間の整合性チェック
- エラー表示・修正機能
- 取込実行（DELIN or UPSERT選択可）

#### 画面構成
```
画面一覧:
- 予算取込画面
  - ファイルアップロードエリア
  - マッピング設定エリア
  - プレビューエリア
  - エラー一覧表示
```

#### 技術要件
- ステージングテーブル（budget_import_staging）を使用
- マッピング定義の保存・再利用機能
- デフォルトテンプレートDL機能

#### 実装優先度
**高（Phase 1必須）**

---

### 2.2 実績取込画面【新規】

#### 概要
ERPシステム等から実績データを取り込む画面。

#### 主要機能
- CSVファイルアップロード
- 複数月一括取込対応
- マッピング設定
- プレビュー機能
- バリデーションチェック
- 取込実行（DELIN or UPSERT選択可）

#### 画面構成
```
画面一覧:
- 実績取込画面（予算取込と同様の構成）
```

#### 技術要件
- ステージングテーブル（actual_import_staging）を使用
- 集計科目は取込対象外（通常科目のみ）

#### 実装優先度
**高（Phase 1必須）**

---

### 2.3 見込取込画面【新規】

#### 概要
見込データを取り込む画面。

#### 主要機能
- 予算取込・実績取込と同様の機能
- 複数月一括取込対応

#### 画面構成
```
画面一覧:
- 見込取込画面（予算取込と同様の構成）
```

#### 実装優先度
**高（Phase 1必須）**

---

### 2.4 取込履歴ダウンロード機能【新規】

#### 概要
取り込んだ履歴データをCSVでダウンロードする機能。

#### 主要機能
- 取込バッチ一覧表示
- 取込内容のダウンロード（CSV）
- 取込エラー情報の表示・ダウンロード

#### 画面構成
```
画面一覧:
- 取込履歴一覧画面
  - バッチID、取込日時、ステータス、件数表示
  - ダウンロードボタン
```

#### 実装優先度
**中（Phase 1後半または Phase 2）**

---

### 2.5 マッピング定義管理画面【新規】

#### 概要
CSVファイルと EPM 側のマスタとのマッピングを定義・管理する画面。

#### 主要機能
- マッピング定義の登録・編集・削除
- ビジュアルマッピング機能（OBERライク）
- デフォルトマッピングの設定
- 会社ごとのマッピング保存

#### 画面構成
```
画面一覧:
- マッピング定義一覧画面
- マッピング定義登録/編集画面
  - ビジュアルマッピングエリア
  - マッピングルール設定
```

#### 技術要件
- マッピング定義はJSON形式で保存
- 自動検出機能（Phase 2検討）

#### 実装優先度
**中（Phase 1後半または Phase 2）**

---

### 2.6 月次締処理画面【新規】

#### 概要
月次の締処理を実行・管理する画面。

#### 主要機能
- 会社・年度・月次選択
- 締ステータス管理
  - 未締（入力可）
  - 本締（入力不可、確定）
- 本締前の確認アラート
  - 「配賦処理が完了していませんが、本締しますか？」
- 本締実行
- 締状態の一覧表示

#### 画面構成
```
画面一覧:
- 月次締処理画面
  - 年度・月次選択
  - 締ステータス表示（カレンダー形式）
  - 本締実行ボタン
```

#### 補足
- 仮締の概念は廃止（未締 or 本締のみ）
- 本締後は一切の変更不可

#### 実装優先度
**高（Phase 1必須）**

---

### 2.7 配賦処理実行画面【新規】

#### 概要
配賦処理を実行し、結果を確認する画面。

#### 主要機能
- 会社・年度・月次選択
- 配賦ドライバーの変更・登録（実績用）
- 配賦処理実行
- 配賦結果の確認（レポート機能へ遷移）
- 再実行機能

#### 画面構成
```
画面一覧:
- 配賦処理画面
  - ドライバー設定エリア
  - 配賦実行ボタン
  - 実行履歴表示
```

#### 補足
- 月次締処理画面から配賦処理をキック可能
- 配賦処理は締処理とは独立（連動しない）
- 配賦後に修正が必要な場合は、再実行可能

#### 実装優先度
**中（Phase 1後半または Phase 2）**

---

### 2.8 会計年度アーカイブ機能【新規】

#### 概要
本締完了した会計年度データをアーカイブする機能。

#### 主要機能
- 年度最終月の本締完了後、自動アーカイブ
- アーカイブデータの列志向保存
- アーカイブ状態の管理

#### 画面構成
```
画面一覧:
- 会計年度アーカイブ管理画面
  - アーカイブ状態表示
  - 手動アーカイブ実行（必要時）
```

#### 補足
- アーカイブ後もデータ参照は可能（JOIN考慮）
- アーカイブのタイミング: 年度最終月の本締後

#### 実装優先度
**低（Phase 2以降検討）**

---

## 3. 承認ワークフロー関連

### 3.1 承認者設定画面【新規】

#### 概要
予算・見込の承認者を設定する画面。

#### 主要機能
- 5段階固定の承認フロー設定
- 各段階の承認者設定（1名）
- 各段階の代理承認者設定（1名）
- 部門ごとの承認者設定

#### 画面構成
```
画面一覧:
- 承認者設定画面
  - 会社・部門選択
  - 承認フロー定義エリア
    - 1次承認者 / 代理1次承認者
    - 2次承認者 / 代理2次承認者
    - 3次承認者 / 代理3次承認者
    - 4次承認者 / 代理4次承認者
    - 5次承認者 / 代理5次承認者
```

#### 技術要件
- 通知設定用メールアドレスの管理
- 部門ごとの承認者設定データの取込機能（Phase 2検討）

#### 実装優先度
**高（Phase 1必須）**

---

### 3.2 承認申請画面【新規】

#### 概要
予算・見込データの承認申請を行う画面。

#### 主要機能
- 承認対象の選択（予算 or 見込）
  - 実績は承認対象外
- 申請コメント入力
- 承認申請実行
- 申請状態の確認

#### 画面構成
```
画面一覧:
- 承認申請画面
  - 対象データ選択
  - 申請コメント入力
  - 申請実行ボタン
```

#### 実装優先度
**高（Phase 1必須）**

---

### 3.3 承認処理画面【新規】

#### 概要
承認者が承認・差戻を行う画面。

#### 主要機能
- 承認待ちデータの一覧表示
- データプレビュー（リンク遷移）
- 承認コメント入力
- 承認・差戻の実行
- 承認履歴の表示

#### 画面構成
```
画面一覧:
- 承認処理画面
  - 承認待ち一覧
  - データプレビューリンク
  - 承認/差戻ボタン
  - 承認履歴表示エリア
```

#### 技術要件
- メール通知機能（承認依頼・承認完了・差戻）
- リンク経由での画面アクセス

#### 実装優先度
**高（Phase 1必須）**

---

### 3.4 部門別予算登録状況確認画面【新規】

#### 概要
各部門の予算登録・承認状況を一覧で確認する画面。

#### 主要機能
- 部門別の登録状況表示
  - 未登録 / 登録済 / 承認申請中 / 承認済
- 進捗率の表示
- 未完了部門のフィルタ表示
- 督促メール送信機能

#### 画面構成
```
画面一覧:
- 部門別予算登録状況画面
  - 部門一覧（ツリー表示 or テーブル表示）
  - ステータス表示
  - 進捗率表示
  - 督促メール送信ボタン
```

#### 補足
- 経営企画部門等、管理部門が全体状況を把握するための画面

#### 実装優先度
**高（Phase 1必須）**

---

## 4. 権限・アクセス制御関連

### 4.1 コントロール部門設定画面【新規】

#### 概要
データ閲覧権限を制御するコントロール部門を設定する画面。

#### 主要機能
- 社員マスタへのコントロール部門設定
- 部門ごとのアクセス権限設定
- 権限の継承設定（子部門への権限継承）

#### 画面構成
```
画面一覧:
- コントロール部門設定画面
  - 社員一覧
  - コントロール部門選択
  - 権限設定エリア
```

#### 補足
- OBPMのコントロール部門機能を参考
- データ閲覧権限の統制

#### 実装優先度
**中（Phase 1後半または Phase 2）**

---

### 4.2 会社選択機能【改修】

#### 概要
ログイン時に会社を選択する機能（マルチカンパニー対応）。

#### 主要機能
- ログイン画面での会社選択
- テナント単位のマルチカンパニーフラグ管理
- 会社ごとのメールアドレス管理

#### 画面構成
```
画面:
- ログイン画面
  - 会社選択ドロップダウン（マルチカンパニーの場合）
  - メールアドレス入力
  - パスワード入力
```

#### 補足
- テナント単位でマルチカンパニーフラグを管理
- 単一会社の場合は会社選択なし
- 個社ごとのメールアドレス取得が前提

#### 実装優先度
**中（Phase 1後半または Phase 2）**

---

### 4.3 連結データ閲覧権限機能【新規】

#### 概要
連結レベルでの複数会社データ閲覧権限を管理する機能。

#### 主要機能
- 単体レベルの権限（会社ごと）
- 連結レベルの権限（複数会社横断）
- 権限の切替機能

#### 補足
- 経営企画部門等が親会社・子会社両方のデータを見たい場合に対応
- 単体レベルで複数会社のアカウントを持つ場合の制御

#### 実装優先度
**中（Phase 2検討）**

---

## 5. その他機能

### 5.1 予算バージョン登録画面【新規】

#### 概要
予算イベントのバージョンを明示的に登録・管理する画面。

#### 主要機能
- バージョン登録（第1回予算、修正予算等）
- バージョンステータス管理（DRAFT/SUBMITTED/APPROVED/FIXED）
- FIXED後の更新不可制御

#### 画面構成
```
画面一覧:
- 予算バージョン管理画面
  - イベント選択
  - バージョン一覧
  - バージョン登録ボタン
```

#### 補足
- 予算のみ明示的なバージョン管理を実施
- 見込・実績はバージョン管理なし

#### 実装優先度
**高（Phase 1必須）**

---

### 5.2 調整入力画面の改修【改修】

#### 概要
調整入力時のコメント入力機能を追加。

#### 主要機能
- 調整金額入力
- 調整理由コメント入力
- 調整履歴の表示

#### 補足
- 調整入力は実績のみ対象
- コメントは必須項目として設定

#### 実装優先度
**中（Phase 1後半）**

---

### 5.3 入力画面のUI改善【改修】

#### 概要
入力画面のカラーリング・視認性改善。

#### 主要機能
- 入力セルの色分け
- 集計科目の背景色変更（入力不可を明示）
- 必須項目の明示

#### 技術要件
- SJSからAGGridへの移行を検討
- 予算・見込・実績入力画面すべて対応

#### 実装優先度
**中（Phase 1後半）**

---

### 5.4 集計科目入力制御【新規制御】

#### 概要
集計科目の入力制御ロジックを実装。

#### 主要機能
- 実績: 常に通常科目のみ入力可（集計科目は自動計算）
- 予算・見込: マスタ設定に応じて制御
  - 積み上げ方式: 通常科目のみ入力可
  - 集計方式: 集計科目のみ入力可
  - 予算と見込みで入力方式は統一（別々の設定不可）

#### 実装優先度
**高（Phase 1必須）**

---

## まとめ

### 優先度別サマリ

| 優先度 | 画面数 | 主要画面 |
|-------|-------|---------|
| 高（Phase 1必須） | 15 | KPI管理マスタ、非財務KPI入力、予算取込、承認関連、月次締処理 |
| 中（Phase 1後半～Phase 2） | 9 | マッピング定義、配賦処理、コントロール部門設定 |
| 低（Phase 2以降） | 2 | 会計年度アーカイブ、KPI階層管理 |

### 開発工数概算（参考）

| カテゴリ | Phase 1工数（想定） | Phase 2工数（想定） |
|---------|------------------|------------------|
| KPI管理関連 | 10～15日 | 5～10日 |
| データ取込・締処理 | 15～20日 | 5～10日 |
| 承認ワークフロー | 10～15日 | - |
| 権限・アクセス制御 | 5～10日 | 5～10日 |
| その他 | 5～10日 | 3～5日 |
| **合計** | **45～70日** | **18～35日** |

※ AI活用、ライブラリ活用前提の工数

---

## 実装順序の推奨

### Phase 1-1（基本機能）
1. KPI管理マスタ登録画面
2. 非財務KPI定義マスタ画面
3. 非財務KPI目標・実績入力画面
4. アクションプラン登録画面の改修

### Phase 1-2（取込・締処理）
5. 予算取込画面
6. 実績取込画面
7. 見込取込画面
8. 月次締処理画面
9. 予算バージョン登録画面

### Phase 1-3（承認ワークフロー）
10. 承認者設定画面
11. 承認申請画面
12. 承認処理画面
13. 部門別予算登録状況確認画面

### Phase 1-4（仕上げ）
14. 集計科目入力制御
15. 調整入力画面の改修
16. 入力画面のUI改善

### Phase 2（拡張機能）
17. マッピング定義管理画面
18. 配賦処理実行画面
19. 取込履歴ダウンロード機能
20. コントロール部門設定画面
21. ダッシュボードマスタ登録画面
22. KPI階層管理画面
23. 会計年度アーカイブ機能

---

## 関連ドキュメント

- `.kiro/specs/仕様検討/20260122_KPIアクションプラン管理機能レビュー・検討` - KPI管理検討メモ
- `/Users/ktkrr/root/21_Obsidian/ktkrr/010_EPM/61_機能設計検討/81_仕様検討経過/20260120_仕様検討.md` - データ取込・締処理検討メモ
- [KPIアクションプラン管理_変更案.md](KPIアクションプラン管理_変更案.md) - KPI管理仕様変更案
- [KPI管理_エンティティ変更サマリ.md](KPI管理_エンティティ変更サマリ.md) - エンティティ変更詳細
- [KPI管理_UI設計変更サマリ.md](KPI管理_UI設計変更サマリ.md) - UI設計変更詳細
