# 承認ワークフロー 仕様概要

## 概要

予算・見込の承認ワークフロー機能。部門×バージョン単位で、最大5段階の固定承認フローを提供する。

---

## 1. 承認対象

| 対象 | 承認要否 | 条件 |
|------|---------|------|
| 予算（BUDGET） | **必要** | 全て |
| 見込（FORECAST） | **必要** | purpose_type = 'CORPORATE' のみ |
| 見込（FORECAST） | 不要 | purpose_type = 'DIVISIONAL' |
| 実績（ACTUAL） | 不要 | - |

### 見込の区分

| purpose_type | 用途 | 承認 |
|--------------|------|------|
| CORPORATE | 全社報告用（経営会議・役員会） | 必要 |
| DIVISIONAL | 事業部ローカル用（内部管理） | 不要 |

---

## 2. 承認フロー構造

### 2.1 基本構造

- **固定段階制**: 最大5段階
- **承認単位**: 部門×バージョン
- **承認者設定**: 部門マスタに横持ち（本人+代理 × 5段階 = 10カラム）

### 2.2 承認段階の例

```
第1承認者: 課長（部門長）
第2承認者: 部長（事業部長）
第3承認者: 経営管理部門
第4承認者: （未使用）
第5承認者: （未使用）
```

※ 全段階を使う必要はない。詰めて設定する。

---

## 3. 承認ステータス

| status | 意味 | 遷移元 |
|--------|------|--------|
| DRAFT | 未提出（入力中） | 初期状態 |
| PENDING | 承認待ち | DRAFT, REJECTED, WITHDRAWN |
| APPROVED | 承認完了 | PENDING |
| REJECTED | 差戻し | PENDING |
| WITHDRAWN | 取下げ | PENDING |

### 状態遷移

```
DRAFT → PENDING（提出）
PENDING → APPROVED（最終承認）
PENDING → PENDING（次段階へ承認）
PENDING → REJECTED（差戻し）
PENDING → WITHDRAWN（取下げ）
REJECTED → PENDING（再提出）
WITHDRAWN → PENDING（再提出）
```

---

## 4. 承認権限

### 4.1 基本ルール

| 承認者 | 承認可能範囲 |
|--------|-------------|
| 第1承認者 or 代理 | 第1段階のみ |
| 第2承認者 or 代理 | 第1〜第2段階 |
| 第N承認者 or 代理 | 第1〜第N段階 |

### 4.2 垂直代理承認

上位承認者は下位段階をスキップして承認可能。

**例**: 第1承認待ちの状態で第3承認者が承認
- 第1、第2段階はスキップ（履歴に `SKIP` 記録）
- 第3段階まで一括承認

### 4.3 禁止事項

- 下位者が上位段階を承認: **禁止**
- 承認者の中抜け設定: **禁止**（詰めて設定）

---

## 5. 差戻し・取下げ

### 5.1 差戻し（REJECT）

- **起点**: 承認者
- **動作**: status = REJECTED
- **再提出後**: 第1段階からやり直し

### 5.2 取下げ（WITHDRAW）

- **起点**: 申請者本人
- **動作**: status = WITHDRAWN
- **再提出後**: 第1段階からやり直し

### 5.3 コメント

全アクションでコメントは**任意**。差戻し理由等は運用でカバー。

---

## 6. 通知機能

### 6.1 通知タイミング

| アクション | 通知先 | 内容 |
|-----------|--------|------|
| 提出 | 次の承認者 | 承認依頼 |
| 承認（次段階あり） | 次の承認者 | 承認依頼 |
| 承認（最終） | 申請者 | 承認完了 |
| 差戻し | 申請者 | 差戻し通知 |
| 取下げ | 現在の承認待ち者 | 取下げ通知 |

### 6.2 通知方法

- **メール通知**: employees.email に送信
- **フォーマット**: 固定文言 + 変数埋め込み
- **カスタマイズ画面**: なし（運用シンプル化）

---

## 7. 承認者設定

### 7.1 設定場所

部門マスタ（departments）に横持ち。

```
approver_1_employee_id        第1承認者
approver_1_deputy_employee_id 第1代理承認者
approver_2_employee_id        第2承認者
approver_2_deputy_employee_id 第2代理承認者
...（5段階分、計10カラム）
```

### 7.2 設定ルール

- 詰めて設定（1, 2, 3の順。中抜け禁止）
- 組織版（organization_version）ごとに設定
- 新版作成時は前版からのコピー機能で運用負荷軽減

---

## 8. エンティティ

### 8.1 新規テーブル

| テーブル | 用途 |
|---------|------|
| department_approval_status | 部門×バージョン単位の承認状態 |
| department_approval_histories | 承認履歴（誰がいつ何をしたか） |

### 8.2 既存テーブルの変更

| テーブル | 変更内容 |
|---------|---------|
| plan_events | purpose_type カラム追加 |
| departments | 承認者10カラム追加 |

詳細は `.kiro/specs/entities/03_承認ワークフロー.md` を参照。

---

## 9. MVP外機能

| 機能 | 理由 |
|------|------|
| 一括承認 | 運用頻度が低い |
| 承認期限 | 自動処理が複雑 |
| エスカレーション | 運用でカバー |
| 可変承認ルート | 設定・運用が複雑 |

---

## 10. 画面構成

### 10.1 画面遷移フロー

```
ヘッダ通知アイコン 🔔(3)
    │ クリック
    ▼
承認一覧ページ（/approvals）
    │ 予算データ確認リンク
    ▼
予算照会画面（読み取り専用）
```

### 10.2 画面一覧

| 画面 | 形式 | 用途 |
|------|------|------|
| ヘッダ通知アイコン | 常設 | 承認待ち件数をバッジ表示 |
| 承認一覧ページ | Split View | 一覧と詳細を同時表示、承認/差戻し操作 |
| 予算照会画面 | 別ページ | 予算データの詳細確認（読み取り専用） |
| 部門承認者設定 | 部門マスタ内 | 承認者の設定 |

---

## 11. 承認一覧ページUI

### 11.1 レイアウト（Split View）

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ← 承認依頼一覧                                                         │
├───────────────────────────────┬─────────────────────────────────────────┤
│                               │                                         │
│  🔍 検索...    [全て ▼]       │  営業1課 / FY2026予算 第1回             │
│                               │                                         │
│  ┌─────────────────────────┐ │  【承認ステータス】                     │
│  │ ● 営業1課              │ │  ┌─────────────────────────────────┐   │
│  │   FY2026予算 第1回     │ │  │ ✓ 申請 ── ✓ 第1 ── ● 第2 ── ○ 第3 │   │
│  │   田中一郎  01/10      │ │  │ 田中     佐藤     あなた   山田 │   │
│  └─────────────────────────┘ │  └─────────────────────────────────┘   │
│  ┌─────────────────────────┐ │                                         │
│  │ ○ 営業2課              │ │  【申請情報】                           │
│  │   FY2026予算 第1回     │ │  申請日: 2026/01/10                     │
│  │   鈴木太郎  01/11      │ │  申請者: 田中 一郎                      │
│  └─────────────────────────┘ │  部門: 営業1課                          │
│  ┌─────────────────────────┐ │  バージョン: FY2026予算 第1回           │
│  │ ○ 開発1課              │ │                                         │
│  │   FY2026見込 1月       │ │  【サマリ】                             │
│  │   山田花子  01/12      │ │  売上: 272,000,000円  原価: 114,953,600円│
│  └─────────────────────────┘ │  営業利益: 107,046,400円                │
│                               │                                         │
│                               │         [予算データを確認 →]           │
│                               │                                         │
│                               │  【コメント】                           │
│                               │  ┌─────────────────────────────────┐   │
│                               │  │                                 │   │
│                               │  └─────────────────────────────────┘   │
│                               │                                         │
│                               │      [差戻し]        [承認]             │
│                               │                                         │
└───────────────────────────────┴─────────────────────────────────────────┘
```

### 11.2 UI要素

| 要素 | 説明 |
|------|------|
| **左ペイン** | 承認待ち案件一覧。検索・フィルター付き |
| **右ペイン** | 選択した案件の詳細 |
| **ステッパー** | 承認進捗を横一列で可視化。現在段階（あなた）をハイライト |
| **申請情報** | 申請日、申請者、部門、バージョン |
| **サマリ** | 売上・原価・営業利益等の概要 |
| **データ確認リンク** | 予算照会画面へ遷移 |
| **コメント欄** | 任意入力 |
| **アクションボタン** | [差戻し] [承認] |

### 11.3 ステッパーの表示

```
✓ 申請 ── ✓ 第1 ── ● 第2 ── ○ 第3
田中     佐藤     あなた   山田

✓ = 完了（緑）
● = 現在の段階（青、ハイライト）
○ = 未到達（グレー）
```

### 11.4 左ペイン一覧のカード

```
┌─────────────────────────────┐
│ ● 営業1課                   │  ← ●=選択中、○=未選択
│   FY2026予算 第1回          │  ← バージョン名
│   田中一郎  01/10           │  ← 申請者、申請日
└─────────────────────────────┘
```

---

## 12. ヘッダ通知アイコン

### 12.1 表示仕様

```
🔔(3)  ← 承認待ち3件

- 承認待ちが0件の場合: バッジ非表示（アイコンのみ）
- クリックで承認一覧ページ（/approvals）へ遷移
```

### 12.2 件数カウント

- 自分が承認者（本人 or 代理）で、status = PENDING の案件数

---

## 13. MVP外機能

| 機能 | 理由 |
|------|------|
| 一括承認 | 運用頻度が低い |
| 承認期限 | 自動処理が複雑 |
| エスカレーション | 運用でカバー |
| 可変承認ルート | 設定・運用が複雑 |

---

## 関連ドキュメント

- [予算業務フロー.md](予算業務フロー.md) - 全体業務フロー
- [予算入力機能.md](予算入力機能.md) - 予算入力仕様
- `.kiro/specs/entities/03_承認ワークフロー.md` - エンティティ詳細
- `.kiro/specs/仕様検討/20260115_承認ワークフロー機能.md` - 検討経緯

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-15 | 初版作成 | Claude Code |
| 2026-01-15 | 画面構成（Split View + ステッパー）追加 | Claude Code |
