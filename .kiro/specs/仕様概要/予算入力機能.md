# 予算入力機能 仕様概要

## 概要

予算・見込・実績の入力機能。部門予算とPJ予算をモード切替で統合的に管理し、見込のローリング、調整入力、締め制御に対応する。

## 対象エンティティ

| エンティティ | 定義ファイル | 役割 |
|-------------|-------------|------|
| fact_amounts | `entities/01_各種マスタ.md` | 予算・見込・実績ファクト |
| plan_events | `entities/01_各種マスタ.md` | 計画イベント（予算/見込/実績の枠） |
| plan_versions | `entities/01_各種マスタ.md` | バージョン管理 |
| accounting_periods | `entities/01_各種マスタ.md` | 会計期間（締め状態管理） |
| report_layouts | `entities/01_各種マスタ.md` | 予算レイアウト |
| projects | `entities/01_各種マスタ.md` | プロジェクトマスタ |

## 主要な仕様

### 画面構成（実装済み Phase 1）

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│ [年度: 2026 ▼] [部門: 営業1課 ▼] [予算イベント: 当初予算 ▼] [バージョン: 第1回 ▼]                   │
│                                                                    [過去実績を表示: ON/OFF]       │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 比較モード: [比較しない] [過去実績比較] [Ver比較]                                                  │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 科目フィルター: [売上高] [売上原価] [販管費] ...                                                   │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 予算 (2026年度)                                                                                   │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 科目           │4月  │5月  │6月  │1Q   │7月  │8月  │9月  │2Q  │上期 │10月│11月│12月│3Q  │1月 │2月 │3月 │4Q  │下期│通期│
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ ▼ 売上高       │1,000│1,200│1,100│3,300│...  │     │     │    │     │    │    │    │    │    │    │    │    │    │    │
│   └ 得意先A    │  400│  500│  450│1,350│...  │     │     │    │     │    │    │    │    │    │    │    │    │    │    │
│   └ 得意先B    │  350│  400│  380│1,130│...  │     │     │    │     │    │    │    │    │    │    │    │    │    │    │
│ 売上原価       │  600│  700│  650│1,950│...  │     │     │    │     │    │    │    │    │    │    │    │    │    │    │
│ 【売上総利益】 │  400│  500│  450│1,350│...  │     │     │    │     │    │    │    │    │    │    │    │    │    │    │
│ 販管費         │  300│  350│  320│  970│...  │     │     │    │     │    │    │    │    │    │    │    │    │    │    │
│ 【営業利益】   │  100│  150│  130│  380│...  │     │     │    │     │    │    │    │    │    │    │    │    │    │    │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘

凡例:
- ▼: 展開可能（クリックで子行表示）
- 【】: 集計科目（AGGREGATE）- 背景色グレー、編集不可
- 1Q/2Q/3Q/4Q: 四半期集計列（背景色で区別）
- 上期/下期: 上下期集計列（背景色で区別）
- 通期: 年間集計列（背景色で区別）
- 科目列: スティッキー（スクロールしても固定）
```

### 期間列の構成（19列）

Phase 1 で実装された拡張期間列:

| 列ID | 表示名 | タイプ | 入力 | 算出ロジック |
|------|--------|--------|------|--------------|
| M04 | 4月 | MONTH | ○ | 入力値 |
| M05 | 5月 | MONTH | ○ | 入力値 |
| M06 | 6月 | MONTH | ○ | 入力値 |
| Q1 | 1Q | QUARTER | × | M04 + M05 + M06 |
| M07 | 7月 | MONTH | ○ | 入力値 |
| M08 | 8月 | MONTH | ○ | 入力値 |
| M09 | 9月 | MONTH | ○ | 入力値 |
| Q2 | 2Q | QUARTER | × | M07 + M08 + M09 |
| H1 | 上期 | HALF | × | Q1 + Q2 |
| M10 | 10月 | MONTH | ○ | 入力値 |
| M11 | 11月 | MONTH | ○ | 入力値 |
| M12 | 12月 | MONTH | ○ | 入力値 |
| Q3 | 3Q | QUARTER | × | M10 + M11 + M12 |
| M01 | 1月 | MONTH | ○ | 入力値 |
| M02 | 2月 | MONTH | ○ | 入力値 |
| M03 | 3月 | MONTH | ○ | 入力値 |
| Q4 | 4Q | QUARTER | × | M01 + M02 + M03 |
| H2 | 下期 | HALF | × | Q3 + Q4 |
| Y | 通期 | ANNUAL | × | H1 + H2 |

### 比較モード（タブ切り替え）

| モード | 用途 | 表示形式 |
|--------|------|----------|
| 比較しない | 通常の予算入力 | 予算グリッドのみ |
| 過去実績比較 | 過去年度実績との差異確認 | 各期間: 予算/実績/差異 の3列 |
| Ver比較 | バージョン間の差異確認 | 各期間: ベース/現在/差異 の3列 |

### 過去実績表示

- **トグルスイッチ**: 「過去実績を表示」ON/OFF
- **表示対象**: 選択年度の過去3年分（-1年、-2年、-3年）
- **表示形式**: 年度ごとのアコーディオン（デフォルト展開）
- **期間列**: 予算グリッドと同じ19列を使用
- **科目フィルター**: 予算グリッドのフィルターを過去実績にも適用
- **比較モード併用**: 比較モードON時でもトグルONなら表示

### 科目フィルター

- **形式**: マルチセレクト（複数科目選択可能）
- **適用範囲**: 予算グリッド + 過去実績パネル
- **動作**: 選択した科目とその子行（ディメンション展開行）のみ表示

### モード切替（Phase 2 予定）

| モード | レイアウト | 用途 |
|--------|-----------|------|
| 部門全体 | 部門予算レイアウト | 部門の予算・見込を入力 |
| PJ別 | PJ予算レイアウト | PJ選択後、PJの予算・見込を入力 |

### レイアウト

- **部門予算レイアウト**: 会社に1つ（標準PL科目等）
- **PJ予算レイアウト**: 会社に1つ（PJ原価項目に特化）
- 科目体系は共通、表示する科目・並び順が異なる

### シナリオ・バージョン

| scenario_type | 用途 |
|---------------|------|
| BUDGET | 予算（当初予算、修正予算等） |
| FORECAST | 見込（月次ローリング） |
| ACTUAL | 実績 |

- バージョン: 第1回、第2回...FIXED
- FIXED後は編集不可

### 入力ルール

| 項目 | 内容 |
|------|------|
| 入力粒度 | 月次（12ヶ月分） |
| 集計列 | 自動計算（編集不可） |
| 権限 | ロール・アカウント単位で制御 |
| PJ権限分離 | 部門予算不可・PJ予算のみ可のケースあり |

### 見込（FORECAST）の運用（Phase 2 予定）

#### 作成フロー

```
1. 起点データを選択
   ├── 前月見込コピー（標準）
   └── 予算コピー（初回見込）

2. 実績確定月を実績値で自動置換

3. 将来月を手動で修正

4. 保存
```

#### PJ見込の外部取込

- 外部PJ管理ツールからCSV取込可能
- 取込 → fact_amounts（scenario_type='FORECAST', project_id あり）
- 見込入力画面に反映

### 締め概念と入力制御

#### 締めステータス

| close_status | 意味 | 説明 |
|--------------|------|------|
| OPEN | 未締め | 入力可 |
| SOFT_CLOSED | 仮締め | 原則不可（権限者のみ可） |
| HARD_CLOSED | 本締め | 完全不可 |

#### 入力制御マトリクス

| 締め状態 | 実績入力 | 予算入力 | 見込入力 | 調整入力 |
|---------|---------|---------|---------|---------|
| OPEN | ○ | ○ | ○ | ○ |
| SOFT_CLOSED | △ | ○ | ○ | △ |
| HARD_CLOSED | × | ○ | ×（実績表示） | × |

※ △ = 権限者のみ可

#### UI表現

- HARD_CLOSED月: グレーアウト、実績値を表示
- SOFT_CLOSED月: 警告表示、権限者は編集可

### 調整入力（Phase 2 予定）

#### source_type

| source_type | 用途 |
|-------------|------|
| INPUT | 通常入力・取込 |
| ADJUST | 調整（原価差異修正等） |
| ALLOC | 配賦 |
| PROJECT_ROLLUP | PJ集計からのコピー |

#### 表示方法

- 調整用の行を分けて表示
- INPUT行とADJUST行が分かれて見える

```
外注費（実績）: 100万  ← INPUT（編集不可）
外注費（調整）:  +5万  ← ADJUST（編集可）
外注費（合計）: 105万
```

#### 調整理由

- fact_amounts.notes に自由記述（Phase1）
- 必要に応じて調整理由マスタを後で追加

### PJ予算の集約（Phase 2 予定）

#### フロー

```
1. [PJ別]モードでPJ予算を入力
2. [部門全体]モードに切替
3. 「PJ集約」ボタン押下
4. PJ合計を表示、差額を確認
   「PJ合計: 1,500万 / 現在の部門予算: 1,200万 / 差額: +300万」
5. 「コピー」で部門予算に反映（source_type='PROJECT_ROLLUP'）
6. 差額があれば調整入力
```

### データ構造

```
fact_amounts
├── scenario_type: BUDGET / FORECAST / ACTUAL
├── source_type: INPUT / ADJUST / ALLOC / PROJECT_ROLLUP
├── data_origin: ERP_IMPORT / MANUAL / SYSTEM
├── project_id: nullable（PJ別の場合に指定）
└── amount
```

## UI検討結果（Phase 1 実装済み）

### コンポーネント構成

```
apps/web/src/features/transactions/budget-entry/
├── page.tsx                    # メインページ
├── api/
│   ├── BffClient.ts           # BFFクライアントインターフェース
│   └── MockBffClient.ts       # モックBFFクライアント
└── ui/
    ├── BudgetGrid.tsx         # 予算入力グリッド
    ├── HistoricalActualsPanel.tsx  # 過去実績パネル（アコーディオン）
    ├── HistoricalCompareGrid.tsx   # 過去実績比較グリッド
    ├── VersionCompareGrid.tsx      # バージョン比較グリッド
    └── SubjectFilter.tsx      # 科目フィルター
```

### 主要機能

| 機能 | 実装状況 | 備考 |
|------|---------|------|
| 予算グリッド表示 | ✅ | 19期間列、集計科目表示 |
| セル編集・自動保存 | ✅ | debounce 500ms |
| キーボード操作 | ✅ | Tab/Enter/矢印キー |
| スティッキーカラム | ✅ | 科目列固定（z-index管理） |
| 過去実績表示 | ✅ | トグルON/OFF、3年分 |
| 過去実績比較 | ✅ | タブ切り替え |
| バージョン比較 | ✅ | タブ切り替え |
| 科目フィルター | ✅ | マルチセレクト |
| ディメンション展開 | ✅ | ツリー表示 |
| 集計科目自動計算 | ✅ | AGGREGATE科目 |

### BFF Contracts（SSoT）

`packages/contracts/src/bff/budget-entry/index.ts` で定義:

- **PeriodType**: MONTH, QUARTER, HALF, ANNUAL
- **BffPeriodColumn**: isAggregate フラグで集計列を識別
- **BffHistoricalActualResponse**: 過去実績データ
- **BffHistoricalCompareResponse**: 過去実績比較データ
- **BffBudgetCompareResponse**: バージョン比較データ
- **BffSubjectListResponse**: 科目フィルター用

## 関連 Feature

- `.kiro/specs/planning/budget-entry/` - 予算入力機能（実装）
- `.kiro/specs/data-import/` - データ取込機能（将来）

## 検討経緯

- `.kiro/specs/仕様検討/20260109_予算入力機能.md` - 画面設計・操作フローの検討
- `.kiro/specs/仕様検討/20260109_プロジェクト予算.md` - PJ予算の設計

## Phase別実装状況

### Phase 1（実装済み）

- [x] 予算グリッド（19期間列）
- [x] セル編集・自動保存
- [x] キーボード操作（Excel風）
- [x] スティッキーカラム
- [x] 過去実績表示（トグル）
- [x] 過去実績比較（タブ）
- [x] バージョン比較（タブ）
- [x] 科目フィルター
- [x] ディメンション展開
- [x] 集計科目自動計算

### Phase 2（予定）

- [ ] PJ別モード
- [ ] 見込（FORECAST）入力
- [ ] 調整入力（ADJUST）
- [ ] PJ予算集約
- [ ] 配賦入力（ALLOC）
- [ ] データインポート/エクスポート
- [ ] 予算承認ワークフロー

## 未確定事項

| 項目 | 状態 |
|------|------|
| 権限設計（ロール・アカウント） | 別途設計 |
| 閲覧権限の粒度 | 別途設計 |
| PJ別モードのUI詳細 | Phase 2 で検討 |

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-09 | 初版作成 | Claude Code |
| 2026-01-12 | Phase 1 実装内容を反映: 画面構成、期間列、比較モード、UI検討結果を大幅更新 | Claude Code |
