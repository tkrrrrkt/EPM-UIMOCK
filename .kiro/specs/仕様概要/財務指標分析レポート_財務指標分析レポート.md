# 財務指標分析レポート- 仕様概要

## 1. 概要

EPMの財務指標分析レポート機能の一部として、財務科目・非財務KPI・指標（metrics）を混在表示できる**定型レポート**を提供する。
管理者がレイアウトを登録し、ユーザーは期間やPrimary/Compareを選択して一覧で閲覧する。

### 対象ユーザー
- 経営層、経営企画、財務/経理、事業部長、部門責任者

---

## 2. 前提・スコープ

- **定型レポートは読み取り専用**（編集・シミュレーションはMVP外）
- **分析軸は組織のみ**（全社/事業部/部門）
- **フィルタと比較UIはCVPと同様**（同じレイヤー構成）
- **Primary/Compareは予算・見込・実績に対応**
- **非財務KPIの値は以下で固定**
  - 予算/見込: `target_value`
  - 実績: `actual_value`
  - 値が無い場合は `-` 表示

---

## 3. 参照データとマスタ前提

### 3.1 対象エンティティ
- `indicator_report_layouts` / `indicator_report_layout_lines`（定型レイアウト）
- `companies`（レイアウト指定）
- `fact_amounts`（予算/見込/実績）
- `plan_events` / `plan_versions`（イベント/バージョン）
- `accounting_periods`（会計期間）
- `subjects` / `subject_fin_attrs`（財務科目）
- `metrics`（指標）
- `kpi_master_events` / `kpi_definitions` / `kpi_fact_amounts`（非財務KPI）

### 3.2 レイアウト指定
- 会社マスタに `indicator_report_layout_id` を設定
- 未設定の場合は**画面をブロック**し案内メッセージのみ表示

---

## 4. レイアウト定義

### 4.1 レイアウトヘッダ
- レイアウト名（レポート名）
- ヘッダテキスト（画面上部の説明文）

### 4.2 レイアウト行
- 行種別: `header` / `item` / `divider` / `note` / `blank`
- `item` 行は以下のいずれか1つを参照
  - 財務科目（subject）
  - 非財務KPI（kpi_definition）
  - 指標（metric）
- `divider` 行は**区切り線＋任意の表示名**で「合計DIV」などに使用
- `indent_level` でインデント階層を表現
- `display_name` があればそれを優先表示

---

## 5. 画面構成（1画面完結）

```
┌──────────────────────────────────────────────────────────────┐
│ 年度: [▼]  Primary: [▼]  Compare: [なし/▼]                  │
├──────────────────────────────────────────────────────────────┤
│ 期間: [▼] 〜 [▼]   表示粒度: [月次/四半期/半期/年度 ▼]      │
├──────────────────────────────────────────────────────────────┤
│ 部門ツリー（単独/配下集約） │  財務指標分析レポート（表）        │
└──────────────────────────────────────────────────────────────┘
```

---

## 6. 選択項目・フィルタ

### 6.1 Primary / Compare
- **Primary**: 予算 / 見込 / 実績
- **Compare**: 任意選択（未選択可）
- 初期状態は未選択（必須項目が揃うまで表示しない）

### 6.2 イベント/バージョン
- **予算**: イベント + バージョン選択
- **見込**: イベント選択のみ（最新FIXEDを内部採用）
- **実績**: 年度のみ選択（イベント/バージョンなし）

### 6.3 期間レンジ/粒度
- 月範囲指定（年度内のみ）
- 表示粒度: 月次 / 四半期 / 半期 / 年度
- 粒度に応じて境界をスナップ（四半期/半期/年度は固定境界）

### 6.4 部門
- 部門ツリーから選択
- 単独 / 配下集約の切替

---

## 7. データ合成ルール

### 7.1 財務科目（subjects）
- `fact_amounts` を使用
- **予算**: 選択した予算イベント + バージョン
- **見込**: 選択イベントの最新FIXED
  - HARD_CLOSED月は実績値、実績なし月は見込値
- **実績**: 過去年度のみ（当年度は見込で表示）
- 集計は `subjects.aggregation_method` に従う
  - SUM: 合計
  - EOP: 期間末
  - AVG/MAX/MIN: 期間内集計

### 7.2 指標（metrics）
- `metrics.formula_expr` を評価して算出
- 対象は **FIN_METRIC** のみ（KPI_METRICはMVP外）
- CompareはPrimaryと同一ロジックで再計算

### 7.3 非財務KPI（kpi_definitions）
- `kpi_master_events` の **最新CONFIRMED（年度一致）** を自動採用
- 値の参照は以下に固定
  - 予算/見込: `target_value`
  - 実績: `actual_value`
- 集計は `kpi_definitions.aggregation_method` に従う

### 7.4 KPI期間コードの対応
- KPIは `kpi_fact_amounts.period_code` で照合
- 月次は `accounting_periods.period_code` と一致させる
- 四半期/半期/年度は以下のコードを採用
  - `FY{年度}-Q{1..4}`
  - `FY{年度}-H{1|2}`
  - `FY{年度}`

---

## 8. 表示ルール

### 8.1 表形式
- 行: レイアウト行を `line_no` 順に表示
- 列: **Primary / Compare / 差分(±/%)**
- Compare未選択時は差分列を非表示

### 8.2 行種別の表示
- `header`: 見出し行（値は表示しない）
- `divider`: 区切り線 + 任意の表示名
- `note`: 注記行（値は表示しない）
- `blank`: 空行
- `item`: 指標行（数値を表示）

### 8.3 差分計算
- 差分 = Primary − Compare
- 差分率 = 差分 / Compare
- Compareが0またはNULLの場合は `-`

### 8.4 欠損表示
- 値が存在しない場合は `-` を表示
- KPIイベント未存在の場合はKPI行のみ `-`

---

## 9. データ不足時の表示

以下の場合は**画面全体をブロック**し、案内メッセージのみ表示する。

- indicator_report_layout_id 未設定
- 必須項目（年度/Primary/期間/粒度/部門）未選択

---

## 10. 権限・可視範囲（注記）

- 権限は機能単位のロール権限（閲覧/編集）で制御
- 可視範囲は社員マスタのコントロール部門で制御
- 詳細は全体仕様で定義（本仕様では前提コメントのみ）

---

## 11. 非対象（MVP外）

- 指標値の編集・シミュレーション
- 追加の分析グラフ
- 他ディメンション（IRセグメント、プロジェクト等）のフィルター
