# 予算ガイドライン 仕様概要

## 概要

予算ガイドラインは、中期経営計画（MTP）と年度予算（BUDGET）の間に位置する指針機能。経営層が設定した目標値を、各部門が予算策定時に参照できるようにする。

## 対象エンティティ

| エンティティ | 定義ファイル | 役割 |
|-------------|-------------|------|
| guideline_events | `.kiro/specs/entities/01_各種マスタ.md` (16) | ガイドラインイベント |
| fact_amounts | `.kiro/specs/entities/02_トランザクション・残高.md` | ガイドライン数値（scenario_type = 'GUIDELINE'） |
| dimensions | `.kiro/specs/entities/01_各種マスタ.md` (4.1) | 組織ディメンション |
| dimension_values | `.kiro/specs/entities/01_各種マスタ.md` (4.2) | 組織ディメンション値（A事業部等） |
| report_layouts | `.kiro/specs/entities/01_各種マスタ.md` | レイアウト（layout_type='GUIDELINE'） |

## 主要な仕様

### 基本構造

```
【予算ガイドライン】
├── 対象: 主要PL科目（売上・費用・利益）
├── 時間粒度: 年度/半期/四半期（選択可能）
├── 組織粒度: 組織ディメンション単位（全社、事業部等）
├── 入力単位: dimension_values（組織ディメンション値）
└── 管理単位: イベント単位（DRAFT → CONFIRMED）
```

### 計画階層における位置づけ

```
中期経営計画（MTP）  ← 3〜5年、年度単位、戦略テーマ付き
    ↓ 参照
予算ガイドライン      ← 単年度、年度/半期/四半期、経営からの指針
    ↓ 参照
年度予算（BUDGET）   ← 単年度、月次、部門別詳細
```

### ガイドラインイベント

| 項目 | 説明 |
|------|------|
| event_code | イベントコード（例: FY2026_GL_Q1） |
| event_name | イベント名（例: FY2026 Q1ガイドライン） |
| fiscal_year | 対象年度 |
| period_type | 期間種別（ANNUAL/HALF/QUARTER） |
| period_no | 期番号（1, 2, 3, 4） |
| dimension_id | 使用する組織ディメンション |
| layout_id | 使用するレイアウト |
| status | DRAFT / CONFIRMED |

- 同一年度に複数イベント作成可能
- CONFIRMED後は編集不可（新イベント作成で対応）

### 中計との参照関係

| 状況 | 表示方法 |
|------|---------|
| 同じディメンション | 横並び比較表示（中計値とガイドライン値を同じ行に） |
| 異なるディメンション | タブ切り替えで確認可能（比較はしないが参照はできる） |

### 予算入力時の参照

予算入力画面でガイドライン値を参考表示：
- 入力中の部門が属する組織ディメンション値のガイドライン値を表示
- department_dimension_links で紐付けを取得

```
【予算入力画面】
┌──────────────────────────────────────────────────────────┐
│ 営業1課 予算入力                                         │
├──────────────────────────────────────────────────────────┤
│ ※ 所属: A事業部（ガイドライン売上: 40億）               │
├──────────────────────────────────────────────────────────┤
│ 科目        │ 4月  │ 5月  │ ...  │ 年計 │
│─────────────┼──────┼──────┼──────┼──────│
│ 売上高      │ ___  │ ___  │      │      │
└──────────────────────────────────────────────────────────┘
```

別途サマリー画面で「ガイドライン vs 予算集計」の詳細比較も可能。

### 数値格納

- **格納先**: fact_amounts を共用
- **scenario_type**: 'GUIDELINE'
- **入力単位**: dimension_values（組織ディメンション値）

```sql
-- ガイドライン数値の例
INSERT INTO fact_amounts (
  scenario_type,        -- 'GUIDELINE'
  plan_event_id,        -- guideline_events.id を参照
  subject_id,           -- 売上高等
  dimension_value_id,   -- 組織ディメンション値（A事業部等）
  department_stable_id, -- NULL（ガイドラインは部門単位ではない）
  amount,
  ...
)
```

## UI仕様

### 画面構成

```
【予算ガイドライン】
├── 一覧画面（/planning/guideline）
│   └── イベント一覧（テーブル形式）
└── 詳細画面（/planning/guideline/:eventId）
    └── タブ構成
        ├── [入力] - セグメント別数値入力（実績+ガイドライン）
        ├── [全社俯瞰] - 過去5年+全社合計+各セグメント横並び
        └── [推移] - グラフ+表
```

### 一覧画面

| 項目 | 仕様 |
|------|------|
| 表示項目 | イベントコード、イベント名、年度、期間種別、ステータス、更新日時 |
| フィルター | ステータス（DRAFT / CONFIRMED）、年度、期間種別（年度/半期/四半期） |
| ソート | 各カラムでソート可能 |
| 操作 | 行クリックで詳細画面へ遷移、新規作成・複製・削除ボタン |

### 詳細画面（タブ構成）

#### タブ1: 入力（デフォルト表示）

**入力モード切替**（トグルグループ）
- **単一選択モード**: 従来通り、1つのディメンション値を選んで入力
- **一括入力モード**: 全ディメンション値を縦に並べて一括入力

**単一選択モード**
- ディメンション値セレクター（全社 / A事業部 / B事業部 ... を切替）
- 選択したディメンション値のグリッドを表示

**一括入力モード**
```
┌─────────────────────────────────────────────────────────┐
│ 全社合計（自動集計・読み取り専用）                        │
│ ├─ 売上高      │ FY21 │ FY22 │ ... │ GL   │            │
│ ├─ 売上原価    │      │      │     │      │            │
│ └─ 営業利益    │      │      │     │      │            │
├─────────────────────────────────────────────────────────┤
│ ▼ A事業部（アコーディオン）                              │
│   ├─ 売上高    │ [__] │ [__] │ ... │ [入力] │          │
│   └─ ...                                                 │
├─────────────────────────────────────────────────────────┤
│ ▼ B事業部（アコーディオン）                              │
│   └─ ...                                                 │
└─────────────────────────────────────────────────────────┘
```

- **全社合計**: 常に最上部に固定表示、フロントエンド側でリアルタイム集計
- **各事業部**: アコーディオンで折りたたみ可能（デフォルト展開）
- **横スクロール**: 列数が多い場合は横スクロール対応
- **権限制御**: 将来的に一括入力可否を権限で制御可能

**数値入力グリッド**
```
| 科目         | FY2021実績 | FY2022実績 | FY2023実績 | FY2024実績 | FY2025実績 | [ガイドライン列] |
|-------------|-----------|-----------|-----------|-----------|-----------|--------------------|
| 売上高       | 8,000     | 8,500     | 9,000     | 9,500     | 10,000    | [入力]             |
| 営業利益     | 1,100     | 1,200     | 1,300     | 1,400     | 1,500     | [自動計算]         |
```

- **実績列**: 過去5年分固定表示、グレー背景、読み取り専用
- **ガイドライン列**: period_typeに応じて変化
  - ANNUAL: 1列（年計）
  - HALF: 2列（上期/下期）
  - QUARTER: 4列（Q1/Q2/Q3/Q4）
- **集計行**: 自動計算、編集不可
- **操作性**: BudgetGrid相当
  - セルクリックで編集モード
  - Tab: 右セルへ移動
  - Enter: 下セルへ移動
  - 矢印キー: 各方向へ移動
  - 500msデバウンス自動保存

#### タブ2: 全社俯瞰

**フィルターなし**（固定表示、スクロールで対応）

**グリッド構成**（年計のみ）
```
| 科目/年度        | FY2021〜FY2025計 | FY2026計 | A事業部 | B事業部 | C事業部 |
|-----------------|-----------------|---------|--------|--------|--------|
| 売上高          | 45,000          | 12,000  | 5,000  | 4,000  | 3,000  |
| 営業利益        | 6,500           | 1,800   | 800    | 600    | 400    |
```

- 縦軸: 科目（レイアウト順）
- 横軸: 過去5年合計 → 全社合計（今期） → 各セグメント横並び
- 構成比・差異を一覧で把握

#### タブ3: 推移

**上部: グラフ**
- 科目セレクター（売上高、営業利益など）
- 全社 / 選択セグメントを**切替**表示（年計のみ）
- 実績 + ガイドラインを時系列で表示

**下部: 表**
- 全社のみ表示（年計のみ）
- 実績 + ガイドラインを横並び

### イベント作成ダイアログ

| 項目 | 入力タイプ | 必須 |
|------|----------|------|
| イベントコード | テキスト | ○ |
| イベント名 | テキスト | ○ |
| 対象年度 | セレクト | ○ |
| 期間種別 | セレクト（年度/半期/四半期） | ○ |
| 期番号 | セレクト（期間種別に応じて1〜4） | ○ |
| 組織ディメンション | セレクト | ○ |
| レイアウト | セレクト | ○ |
| 説明 | テキストエリア | - |

### グリッド技術選定

| 観点 | 判断 |
|------|------|
| 対象画面 | 予算ガイドライン |
| 入力セル数 | 最大250セル程度（少量） |
| 採用技術 | BudgetGrid相当（カスタム実装） |
| SpreadJS | 不要（予算入力・見込入力で将来採用予定） |

## Phase 1 スコープ

| 機能 | 内容 |
|------|------|
| イベント作成 | guideline_events の CRUD |
| 数値入力 | 組織ディメンション値 × 科目 × 期間 |
| 中計参照表示 | 同じディメンションなら横並び、異なればタブ切替 |
| ステータス管理 | DRAFT / CONFIRMED |
| レイアウト選択 | layout_type = 'GUIDELINE' |

## Phase 2 以降

| 機能 | 内容 |
|------|------|
| 承認フロー | ワークフロー連携 |
| 趣旨・目標・備考 | ガイドラインの作成経緯・目的・背景を登録・表示する機能 |

## 対象外

| 機能 | 理由 |
|------|------|
| 配賦機能 | 手入力で十分、配賦ルール設計が複雑 |
| ガイドライン比較 | 個別に見れれば十分 |

## 関連 Feature

- `.kiro/specs/planning/budget-guideline/` - 予算ガイドライン機能

## 関連ドキュメント

- [中期経営計画.md](中期経営計画.md) - 上位計画との連携
- [予算業務フロー.md](予算業務フロー.md) - 予算全体の業務プロセス
- [予算入力機能.md](予算入力機能.md) - 予算入力画面での参照表示

## 検討経緯

- `.kiro/specs/仕様検討/20260111_予算ガイドライン.md` - 設計方針の決定

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-11 | 初版作成 | Claude Code |
| 2026-01-11 | UI仕様セクション追加（画面構成、グリッド操作性、ダイアログ仕様） | Claude Code |
| 2026-01-11 | UI設計見直し: 1カラム→タブ構成（入力/全社俯瞰/推移）、入力タブに過去5年実績列追加、period_typeに応じたガイドライン列（1/2/4列）、全社俯瞰・推移は年計のみ、Phase 2に趣旨・目標・備考機能追加 | Claude Code |
