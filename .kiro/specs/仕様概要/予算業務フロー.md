# 予算業務フロー 仕様概要

## 概要

予算・見込・実績管理の業務プロセスと、各STEPで作成・使用されるデータの関係を整理する。マスタ設定から業務イベント発生、データ蓄積までの全体像を示す。

---

## 1. 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────┐
│                        マスタ（事前設定）                             │
├─────────────────────────────────────────────────────────────────────┤
│  subjects           科目マスタ（会社COA）                            │
│  report_layouts     予算レイアウト（部門用・PJ用・ガイドライン用）    │
│  subject_budget_settings  科目×部門のディメンション使用設定          │
│  dimensions / dimension_values  分析軸・グループ                    │
│  projects           プロジェクトマスタ                               │
│  departments        部門マスタ（組織版に紐づく）                     │
│  accounting_periods 会計期間（月次・締め状態）                       │
└─────────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────────┐
│                   中長期計画（3〜5年スパン）                          │
├─────────────────────────────────────────────────────────────────────┤
│  mtp_events         中計イベント（2024年中計、2026年中計等）          │
│  mtp_strategy_themes  戦略テーマ（カスケード構造）                   │
│  mtp_theme_kpis     テーマ-KPI紐付け                                 │
│  fact_amounts       中計数値（scenario_type = 'MTP'）                │
└─────────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────────┐
│                   予算ガイドライン（単年度指針）                       │
├─────────────────────────────────────────────────────────────────────┤
│  guideline_events   ガイドラインイベント（年度/半期/四半期）           │
│  fact_amounts       ガイドライン数値（scenario_type = 'GUIDELINE'）   │
│  入力粒度: dimension_values（組織ディメンション単位）                 │
└─────────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────────┐
│                     業務イベント（計画の枠作成）                       │
├─────────────────────────────────────────────────────────────────────┤
│  plan_events        計画イベント作成（当初予算、見込、実績等）        │
│  plan_versions      バージョン作成（第1回、第2回、FIXED等）          │
│  scenario_subject_settings  科目設定スナップショット（自動コピー）   │
└─────────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      データ入力・蓄積                                │
├─────────────────────────────────────────────────────────────────────┤
│  fact_amounts       予算・見込・実績データ（ファクト）                │
│  fact_dimension_links  ディメンション付与（縦持ち）                  │
└─────────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        表示・分析                                    │
├─────────────────────────────────────────────────────────────────────┤
│  report_layouts + fact_amounts を結合して表示                        │
│  レイアウトは「見せ方」、ファクトは「データ」で独立                   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 業務プロセス詳細

### STEP 1: マスタ設定（年度開始前）

#### 1.1 科目・レイアウト設定

| 操作 | 対象テーブル | 説明 |
|------|-------------|------|
| 科目登録 | `subjects` | 会社の勘定科目を登録 |
| 部門予算レイアウト作成 | `report_layouts` + `report_layout_lines` | 部門予算で使う科目・表示順を定義 |
| PJ予算レイアウト作成 | `report_layouts` + `report_layout_lines` | PJ予算で使う科目・表示順を定義 |

```
【レイアウトの役割】
・表示する科目を選択
・表示順序を定義
・見出し・階層を設定
※ データ保存先には影響しない（参照のみ）
```

#### 1.2 科目予算設定

| 操作 | 対象テーブル | 説明 |
|------|-------------|------|
| ディメンション使用設定 | `subject_budget_settings` | 科目×部門ごとにディメンション展開を設定 |

```
【例】
外注費 × 開発1課 → ディメンション「得意先グループ」を使用
人件費 × 開発1課 → ディメンション使用しない
```

#### 1.3 その他マスタ

| 操作 | 対象テーブル | 説明 |
|------|-------------|------|
| 会計期間設定 | `accounting_periods` | FY2026-P01〜P12 等を登録 |
| 部門設定 | `organization_versions` + `departments` | 組織版と部門を登録 |
| PJ登録 | `projects` | プロジェクトマスタを登録 |
| ディメンション設定 | `dimensions` + `dimension_values` | 分析軸とグループを登録 |

---

### STEP 2: 予算イベント作成（年度計画開始時）

#### 2.1 計画イベント作成

| 操作 | 対象テーブル | 作成データ |
|------|-------------|-----------|
| 当初予算イベント作成 | `plan_events` | `scenario_type='BUDGET'`, `event_code='FY2026_BUDGET_INIT'` |

```sql
-- 例：作成されるレコード
INSERT INTO plan_events (
  event_code, event_name, scenario_type, fiscal_year
) VALUES (
  'FY2026_BUDGET_INIT', 'FY2026 当初予算', 'BUDGET', 2026
);
```

#### 2.2 バージョン作成

| 操作 | 対象テーブル | 作成データ |
|------|-------------|-----------|
| 第1回バージョン作成 | `plan_versions` | `version_code='V1'`, `status='DRAFT'` |

```sql
-- 例：作成されるレコード
INSERT INTO plan_versions (
  plan_event_id, version_no, version_code, version_name, status
) VALUES (
  'PE-...', 1, 'V1', '第1回予算', 'DRAFT'
);
```

#### 2.3 科目設定スナップショット（自動）

| タイミング | 対象テーブル | 処理 |
|-----------|-------------|------|
| 予算イベント作成時 | `scenario_subject_settings` | `subject_budget_settings` から一括コピー |

```
【スナップショットの目的】
・予算イベント作成時点の科目設定を固定
・後からマスタを変更しても既存予算に影響しない
・予算入力時はこのスナップショットを参照
```

---

### STEP 3: 予算入力（予算編成期間）

#### 3.1 部門予算入力

| 操作 | 参照テーブル | 保存先 |
|------|-------------|--------|
| レイアウト取得 | `report_layouts` + `report_layout_lines` | - |
| 科目設定取得 | `scenario_subject_settings` | - |
| 金額入力 | - | `fact_amounts` |
| ディメンション付与 | - | `fact_dimension_links` |

```
【入力時のデータフロー】

1. 画面表示
   report_layouts → 表示科目・順序を決定
   scenario_subject_settings → ディメンション展開を決定

2. 入力
   ユーザーが科目×月の金額を入力

3. 保存
   fact_amounts に INSERT/UPDATE（Upsert）
   - plan_event_id: 選択中のイベント
   - plan_version_id: 選択中のバージョン
   - scenario_type: 'BUDGET'
   - source_type: 'INPUT'
   - subject_id: 科目
   - department_stable_id: 部門
   - amount: 金額

   ディメンション展開がある場合：
   fact_dimension_links にも INSERT
```

#### 3.2 PJ予算入力

| 操作 | 参照テーブル | 保存先 |
|------|-------------|--------|
| PJレイアウト取得 | `report_layouts`（PJ用） | - |
| 金額入力 | - | `fact_amounts`（project_id指定） |

```
【PJ予算の特徴】
fact_amounts.project_id に PJ を指定
同じ科目・部門でも project_id が異なれば別レコード
```

#### 3.3 PJ集約（部門予算への反映）

| 操作 | 参照元 | 保存先 |
|------|--------|--------|
| PJ合計計算 | `fact_amounts`（project_id IS NOT NULL） | - |
| 部門予算にコピー | - | `fact_amounts`（source_type='PROJECT_ROLLUP'） |

```
【PJ集約の処理】

1. 集計
   SELECT SUM(amount)
   FROM fact_amounts
   WHERE department_stable_id = ? AND project_id IS NOT NULL
   GROUP BY subject_id, accounting_period_id

2. コピー
   INSERT INTO fact_amounts (
     source_type = 'PROJECT_ROLLUP',
     project_id = NULL,  -- 部門全体
     amount = 集計値
   )
```

---

### STEP 4: 見込入力（月次ローリング）

#### 4.1 見込イベント・バージョン作成

| 操作 | 対象テーブル | 作成データ |
|------|-------------|-----------|
| 見込イベント作成 | `plan_events` | `scenario_type='FORECAST'` |
| バージョン作成 | `plan_versions` | 月次で新規作成 |

#### 4.2 見込作成フロー

```
1. 起点データ選択
   ├── 前月見込コピー（標準）
   └── 予算コピー（初回見込）

2. 実績確定月を実績値で置換
   accounting_periods.close_status = 'HARD_CLOSED' の月

3. 将来月を手動修正

4. 保存 → fact_amounts（scenario_type='FORECAST'）
```

#### 4.3 PJ見込の外部取込

| 操作 | ステージング | 保存先 |
|------|-------------|--------|
| CSV取込 | `budget_import_staging` | - |
| バリデーション | - | validation_status 更新 |
| 反映 | - | `fact_amounts`（scenario_type='FORECAST', project_id あり） |

---

### STEP 5: 実績取込（月次締め後）

#### 5.1 実績イベント管理

| 操作 | 対象テーブル | 説明 |
|------|-------------|------|
| 実績イベント | `plan_events` | `scenario_type='ACTUAL'`（年度に1つ） |
| バージョン | `plan_versions` | 通常1つ（調整用に複数も可） |

#### 5.2 実績取込フロー

```
【集約実績】
ERP集約データ → actual_import_staging → バリデーション → fact_amounts

【仕訳明細】
ERP仕訳 → fact_journal_lines（詳細保持）
              ↓ 別途バッチ
         fact_amounts（月次集約）
```

---

### STEP 6: 締め処理

| 締め状態 | accounting_periods.close_status | 影響 |
|----------|--------------------------------|------|
| 未締め | OPEN | すべて入力可 |
| 仮締め | SOFT_CLOSED | 実績・調整は権限者のみ |
| 本締め | HARD_CLOSED | 実績入力不可、見込は実績表示 |

---

## 3. データ関係図

### 3.1 マスタ → 業務イベント → ファクト

```
                    ┌─────────────────┐
                    │   subjects      │
                    │   (科目マスタ)   │
                    └────────┬────────┘
                             │
    ┌────────────────────────┼────────────────────────┐
    │                        │                        │
    ▼                        ▼                        ▼
┌─────────────┐    ┌─────────────────────┐    ┌─────────────────┐
│report_layouts│    │subject_budget_settings│    │   plan_events   │
│ (レイアウト) │    │  (科目予算設定)       │    │ (計画イベント)   │
└──────┬──────┘    └──────────┬──────────┘    └────────┬────────┘
       │                      │ コピー                  │
       │                      ▼                        │
       │           ┌─────────────────────┐             │
       │           │scenario_subject_    │             │
       │           │settings (スナップ)  │             │
       │           └──────────┬──────────┘             │
       │                      │                        │
       │    ┌─────────────────┼────────────────────────┤
       │    │                 │                        │
       ▼    ▼                 ▼                        ▼
    ┌──────────────────────────────────────────────────────┐
    │                     fact_amounts                      │
    │                   (予算・見込・実績)                    │
    │  ├── plan_event_id (どのイベントか)                    │
    │  ├── plan_version_id (どのバージョンか)                │
    │  ├── subject_id (どの科目か)                          │
    │  ├── department_stable_id (どの部門か)                │
    │  ├── project_id (どのPJか、NULLは部門全体)            │
    │  ├── scenario_type (BUDGET/FORECAST/ACTUAL)          │
    │  ├── source_type (INPUT/ADJUST/ALLOC/PROJECT_ROLLUP) │
    │  └── amount (金額)                                    │
    └──────────────────────────────────────────────────────┘
                              │
                              │ 表示時に結合
                              ▼
                    ┌─────────────────┐
                    │  report_layouts │
                    │  （表示順・見出し）│
                    └─────────────────┘
```

### 3.2 レイアウトとファクトの独立性

```
【重要】レイアウトとファクトはリレーションなし

fact_amounts                          report_layouts
┌──────────────────────┐              ┌──────────────────────┐
│ subject_id = SUB-001 │              │ layout_type = 'PL'   │
│ amount = 100,000     │◄─────────────│ line: 売上高         │
│                      │  表示時JOIN   │   subject_id=SUB-001 │
│ subject_id = SUB-002 │              │ line: 売上原価       │
│ amount = 60,000      │◄─────────────│   subject_id=SUB-002 │
└──────────────────────┘              └──────────────────────┘

・同じ fact_amounts を複数レイアウトで表示可能
・レイアウト変更してもデータは変わらない
・レイアウト削除してもデータは残る
```

---

## 4. 語彙・ステータス一覧

### 4.1 scenario_type（シナリオ種別）

| 値 | 日本語 | 用途 |
|-----|--------|------|
| MTP | 中期経営計画 | 3〜5年スパンの経営目標 |
| GUIDELINE | 予算ガイドライン | 単年度の経営指針（年度/半期/四半期） |
| BUDGET | 予算 | 当初予算、修正予算 |
| FORECAST | 見込 | 月次ローリング見込 |
| ACTUAL | 実績 | 確定実績 |

### 4.2 source_type（データ発生元）

| 値 | 日本語 | 用途 |
|-----|--------|------|
| INPUT | 入力 | 直接入力・取込 |
| ADJUST | 調整 | 原価差異修正等 |
| ALLOC | 配賦 | 配賦計算結果 |
| PROJECT_ROLLUP | PJ集約 | PJ合計→部門予算コピー |

### 4.3 plan_versions.status（バージョンステータス）

| 値 | 日本語 | 編集可否 |
|-----|--------|---------|
| DRAFT | 作成中 | ○ |
| SUBMITTED | 提出済 | △（権限者） |
| APPROVED | 承認済 | △（権限者） |
| FIXED | 確定 | × |

### 4.4 accounting_periods.close_status（締め状態）

| 値 | 日本語 | 実績入力 | 予算入力 | 見込入力 |
|-----|--------|---------|---------|---------|
| OPEN | 未締め | ○ | ○ | ○ |
| SOFT_CLOSED | 仮締め | △ | ○ | ○ |
| HARD_CLOSED | 本締め | × | ○ | ×（実績表示） |

---

## 関連ドキュメント

- [中期経営計画.md](中期経営計画.md) - 中期経営計画機能の詳細仕様
- [予算ガイドライン.md](予算ガイドライン.md) - 予算ガイドライン機能の詳細仕様
- [予算入力機能.md](予算入力機能.md) - 予算入力画面の詳細仕様
- [プロジェクト予算.md](プロジェクト予算.md) - PJ予算機能の詳細仕様
- [科目予算設定.md](科目予算設定.md) - 科目×部門のディメンション設定
- [データ取込_タグ機能.md](データ取込_タグ機能.md) - データ取込アーキテクチャ

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-09 | 初版作成 | Claude Code |
| 2026-01-11 | 中期経営計画を全体アーキテクチャに追加、scenario_typeにMTP追加 | Claude Code |
| 2026-01-11 | 予算ガイドラインを全体アーキテクチャに追加、scenario_typeにGUIDELINE追加 | Claude Code |
