# 権限設定 仕様概要

## 概要

機能（メニュー）ベースの権限管理システム。会社単位でロールを定義し、ロールごとに各機能へのアクセスレベルとデータスコープを設定する。社員にロールを割り当てることでアクセス制御を実現。

## 基本方針

- **会社単位の権限管理**: 各会社が独自にロール・メニュー権限を管理
- **1社員1会社**: 社員は1つの会社にのみ所属
- **1社員1ロール**: 権限の競合を避けるため、社員には1つのロールのみ割当可能
- **親子会社完全分離**: 親会社・子会社間でのデータアクセスは不可
- **主会社の連結機能**: 連結関係の機能は `tenants.primary_company_id` の会社のみ使用可能

## アクセスレベル

| レベル | 名称 | 説明 |
|--------|------|------|
| A | フル権限 | 参照・編集・削除が可能 |
| B | 参照のみ | 参照のみ、編集・削除不可 |
| C | アクセス不可 | メニューに表示されない |

## データスコープ

| スコープ | 名称 | 説明 |
|----------|------|------|
| ALL | 全社 | 会社内の全データを参照可能 |
| HIERARCHY | 階層配下 | 所属部門と配下部門のデータのみ |
| ASSIGNED | 指定部門 | 明示的に指定された部門のみ |

**補足**: ASSIGNED 時は `include_children` オプションで配下部門を含めるか選択可能

## エンティティ構成

```
┌─────────────────────────────────────────────────────────────────┐
│ tenants                                                         │
│  └─ primary_company_id (連結機能が使える会社)                    │
└─────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ companies                                                        │
└─────────────────────────────────────────────────────────────────┘
         │
    ┌────┴────┬──────────────┐
    ▼         ▼              ▼
┌────────┐ ┌────────┐  ┌────────────┐
│ menus  │ │ roles  │  │ employees  │
└────────┘ └────────┘  └────────────┘
    │          │              │
    └────┬─────┘              │
         ▼                    │
┌──────────────────────┐      │
│ role_menu_permissions│      │
│  - access_level      │      │
│  - data_scope        │      │
└──────────────────────┘      │
         │                    │
         ▼                    │
┌────────────────────────────┐│
│role_menu_department_assign.││
│  (ASSIGNED時の部門指定)    ││
└────────────────────────────┘│
                              │
         ┌────────────────────┘
         ▼
┌──────────────────┐
│ employee_roles   │
│  (1社員1ロール)  │
└──────────────────┘
```

## エンティティ定義

### menus（機能マスタ）

```sql
CREATE TABLE menus (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  menu_code varchar(50) NOT NULL,       -- 機能コード
  menu_name varchar(200) NOT NULL,      -- 機能名
  menu_category varchar(50),            -- カテゴリ（任意）
  menu_type varchar(50),                -- 種別（任意: master/transaction/report/admin）
  parent_menu_id uuid,                  -- 親メニュー（階層用）
  url_path varchar(500),                -- 画面パス
  icon_name varchar(100),               -- アイコン名
  sort_order int NOT NULL DEFAULT 0,    -- 表示順
  is_consolidation boolean NOT NULL DEFAULT false,  -- 連結専用フラグ
  is_active boolean NOT NULL DEFAULT true,

  UNIQUE(tenant_id, company_id, menu_code)
);
```

### roles（ロール定義）

```sql
CREATE TABLE roles (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  role_code varchar(50) NOT NULL,       -- ロールコード
  role_name varchar(200) NOT NULL,      -- ロール名
  role_description text,                -- 説明
  is_active boolean NOT NULL DEFAULT true,

  UNIQUE(tenant_id, company_id, role_code)
);
```

### role_menu_permissions（ロール×機能 権限設定）

```sql
CREATE TABLE role_menu_permissions (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  role_id uuid NOT NULL,
  menu_id uuid NOT NULL,
  access_level char(1) NOT NULL CHECK (access_level IN ('A', 'B', 'C')),
  data_scope varchar(20) NOT NULL CHECK (data_scope IN ('ALL', 'HIERARCHY', 'ASSIGNED')),

  UNIQUE(tenant_id, role_id, menu_id)
);
```

### role_menu_department_assignments（ASSIGNED時の部門指定）

```sql
CREATE TABLE role_menu_department_assignments (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  role_menu_permission_id uuid NOT NULL,
  department_stable_id varchar(50) NOT NULL,
  include_children boolean NOT NULL DEFAULT false,  -- 配下部門を含むか

  UNIQUE(tenant_id, role_menu_permission_id, department_stable_id)
);
```

### employee_roles（社員ロール割当）

```sql
CREATE TABLE employee_roles (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  employee_id uuid NOT NULL,
  role_id uuid NOT NULL,

  UNIQUE(tenant_id, employee_id)  -- 1社員1ロール制約
);
```

### tenants（追加カラム）

```sql
ALTER TABLE tenants ADD COLUMN primary_company_id uuid;
```

## 権限判定フロー

```
1. ユーザーがメニューにアクセス
       ↓
2. employee_roles から role_id 取得
       ↓
3. role_menu_permissions で該当メニューの権限を取得
       ↓
4. access_level をチェック
   - C → アクセス拒否
   - B → 参照のみモードで表示
   - A → フルアクセスで表示
       ↓
5. data_scope を適用
   - ALL → フィルタなし
   - HIERARCHY → 所属部門と配下でフィルタ
   - ASSIGNED → 指定部門でフィルタ（role_menu_department_assignments参照）
```

## 連結機能の制御

```typescript
// 連結メニュー（is_consolidation = true）の表示条件
const canAccessConsolidationMenu = (
  menu: Menu,
  userCompanyId: string,
  tenant: Tenant
): boolean => {
  if (!menu.isConsolidation) return true;
  return userCompanyId === tenant.primaryCompanyId;
};
```

## BFF Contracts

```typescript
// ロール一覧取得
interface BffRoleListRequest {
  companyId: string;
}

interface BffRoleListResponse {
  roles: BffRoleSummary[];
}

interface BffRoleSummary {
  id: string;
  roleCode: string;
  roleName: string;
  roleDescription?: string;
  assignedEmployeeCount: number;
  isActive: boolean;
}

// ロール詳細（権限設定含む）
interface BffRoleDetailResponse {
  id: string;
  roleCode: string;
  roleName: string;
  roleDescription?: string;
  permissions: BffRoleMenuPermission[];
  isActive: boolean;
}

interface BffRoleMenuPermission {
  menuId: string;
  menuCode: string;
  menuName: string;
  menuCategory?: string;
  accessLevel: 'A' | 'B' | 'C';
  dataScope: 'ALL' | 'HIERARCHY' | 'ASSIGNED';
  assignedDepartments?: BffAssignedDepartment[];  // ASSIGNED時のみ
}

interface BffAssignedDepartment {
  departmentStableId: string;
  departmentName: string;
  includeChildren: boolean;
}

// メニュー一覧（権限設定画面用）
interface BffMenuListResponse {
  menus: BffMenuSummary[];
}

interface BffMenuSummary {
  id: string;
  menuCode: string;
  menuName: string;
  menuCategory?: string;
  menuType?: string;
  parentMenuId?: string;
  isConsolidation: boolean;
  sortOrder: number;
}

// 社員ロール割当
interface BffEmployeeRoleAssignRequest {
  employeeId: string;
  roleId: string;
}

// ユーザー権限情報取得（ログイン時）
interface BffUserPermissionsResponse {
  roleId: string;
  roleName: string;
  permissions: BffUserMenuPermission[];
}

interface BffUserMenuPermission {
  menuCode: string;
  menuName: string;
  urlPath: string;
  accessLevel: 'A' | 'B';  // Cはそもそも返さない
  dataScope: 'ALL' | 'HIERARCHY' | 'ASSIGNED';
  assignedDepartmentIds?: string[];  // ASSIGNED時のみ
}
```

## 管理画面

### ロール管理画面

```
┌────────────────────────────────────────────────────────────────┐
│ ロール管理                         会社: [ABC株式会社 ▼]        │
├────────────────────────────────────────────────────────────────┤
│                                    [+ 新規ロール] [保存]        │
├────────────────────────────────────────────────────────────────┤
│ コード   │ 名称         │ 割当人数 │ 有効 │                     │
├──────────┼──────────────┼──────────┼──────┼─────────────────────┤
│ ADMIN    │ システム管理者│    2名   │  ☑  │ [編集] [権限設定]   │
│ MANAGER  │ 部門管理者   │   15名   │  ☑  │ [編集] [権限設定]   │
│ USER     │ 一般ユーザー │   50名   │  ☑  │ [編集] [権限設定]   │
│ VIEWER   │ 閲覧者       │    5名   │  ☑  │ [編集] [権限設定]   │
└────────────────────────────────────────────────────────────────┘
```

### 権限設定画面

```
┌────────────────────────────────────────────────────────────────────────┐
│ 権限設定: 部門管理者                                     [保存]        │
├────────────────────────────────────────────────────────────────────────┤
│ 機能              │ アクセス    │ データスコープ     │ 部門指定       │
├───────────────────┼─────────────┼────────────────────┼────────────────┤
│ ▼ マスタ管理                                                          │
│   社員マスタ      │ [A フル ▼]  │ [HIERARCHY ▼]     │ -              │
│   部門マスタ      │ [B 参照 ▼]  │ [ALL ▼]           │ -              │
│   科目マスタ      │ [C 不可 ▼]  │ -                  │ -              │
├───────────────────┼─────────────┼────────────────────┼────────────────┤
│ ▼ 予算管理                                                            │
│   予算入力        │ [A フル ▼]  │ [ASSIGNED ▼]      │ [設定...]      │
│   予算承認        │ [B 参照 ▼]  │ [HIERARCHY ▼]     │ -              │
├───────────────────┼─────────────┼────────────────────┼────────────────┤
│ ▼ レポート                                                            │
│   予算実績照会    │ [A フル ▼]  │ [HIERARCHY ▼]     │ -              │
│   連結レポート    │ [C 不可 ▼]  │ -                  │ - (連結専用)   │
└────────────────────────────────────────────────────────────────────────┘
```

### 社員ロール割当画面

```
┌────────────────────────────────────────────────────────────────┐
│ 社員ロール割当                     会社: [ABC株式会社 ▼]        │
├────────────────────────────────────────────────────────────────┤
│ 検索: [____________] [部門: ▼ 全て] [ロール: ▼ 全て]           │
├────────────────────────────────────────────────────────────────┤
│ 社員番号 │ 氏名       │ 部門       │ 現在のロール │            │
├──────────┼────────────┼────────────┼──────────────┼────────────┤
│ E001     │ 山田太郎   │ 経営企画部 │ [管理者 ▼]  │            │
│ E002     │ 佐藤花子   │ 営業部     │ [一般 ▼]    │            │
│ E003     │ 田中一郎   │ 製造部     │ [未割当 ▼]  │ ← 要割当   │
└────────────────────────────────────────────────────────────────┘
```

## Phase分け

### Phase 1: 基本機能

- [ ] menus テーブル作成
- [ ] roles テーブル作成
- [ ] role_menu_permissions テーブル作成
- [ ] role_menu_department_assignments テーブル作成
- [ ] employee_roles テーブル作成
- [ ] tenants への primary_company_id 追加
- [ ] ロール管理画面
- [ ] 権限設定画面
- [ ] 社員ロール割当画面

### Phase 2: 権限適用

- [ ] BFF での権限チェックミドルウェア
- [ ] メニュー表示フィルタリング
- [ ] データスコープ適用
- [ ] アクセスレベルによる UI 制御（参照のみモード）

### Phase 3: 拡張

- [ ] 権限テンプレート（よく使うロールパターン）
- [ ] 権限変更履歴
- [ ] 一括割当機能

## 関連機能

- `.kiro/specs/仕様検討/20260113_権限設定.md` - 仕様検討の議事録
- `.kiro/specs/entities/01_各種マスタ.md` - エンティティ定義

## 未確定事項

| 項目 | 状態 | 備考 |
|------|------|------|
| メニュー一覧の洗い出し | 後日 | 全機能確定後に作成 |
| 典型ロールパターン | 後日 | 管理者/部門管理者/一般/閲覧者 |
| 承認ワークフロー | 別機能 | 権限とは切り離して検討 |

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-13 | 初版作成（QA壁打ちに基づく） | Claude Code |
