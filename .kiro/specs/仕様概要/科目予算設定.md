# 科目予算設定 仕様概要

## 概要

科目ごとに予算作成時のディメンション使用有無を設定するマスタ機能。予算イベント作成時に設定をスナップショットとして保持し、バージョン変更後も構成を固定する。

## 対象エンティティ

| エンティティ | 定義ファイル | 役割 |
|-------------|-------------|------|
| subject_budget_settings | `entities/01_各種マスタ.md` | 科目予算設定マスタ |
| scenario_subject_settings | `entities/01_各種マスタ.md` | 予算イベント別スナップショット |
| fact_amounts | `entities/01_各種マスタ.md` | 数値ファクト（変更対象） |
| fact_dimension_links | `entities/01_各種マスタ.md` | ディメンションリンク |

## 主要な仕様

### 設定の粒度

- **科目 × 部門** 単位で設定
- 1科目につき **最大1ディメンション** まで設定可能

### 予算作成パターン

| パターン | 予算の粒度 | use_dimension | 例 |
|---------|-----------|---------------|-----|
| A | 科目 × 部門 のみ | false | 人件費、一般管理費 |
| B | 科目 × 部門 × ディメンション | true | プロジェクト別原価 |

### スナップショット方式

```
subject_budget_settings（マスタ: 現在の設定）
    ↓ 予算イベント作成時にコピー
scenario_subject_settings（スナップショット: イベントごとに保持）
```

- 予算イベント作成時点の設定が「凍結」される
- バージョン（Ver.1, Ver.2...）が変わっても構成は固定
- マスタ変更は既存イベントに影響しない

### ファクトテーブル設計

- **全ディメンションを縦持ち統一**
- `fact_amounts` から `project_id`, `ir_segment_value_id` 等の固定列を削除
- ディメンションは全て `fact_dimension_links` 経由で付与

### 予算入力フロー

```
1. 部門を選択
2. レイアウトに従った科目一覧表示
   ├─ 人件費（直接入力）
   ├─ 外注費（直接入力）
   └─ プロジェクト原価（展開可能）
       ├─ PJ-A（ディメンションバリュー）
       ├─ PJ-B
       └─ PJ-C
3. 保存 → fact_amounts + fact_dimension_links
```

## 関連 Feature

- `.kiro/specs/planning/budget-entry/` - 予算入力機能
- `.kiro/specs/master-data/report-layout/` - レイアウトマスタ

## 検討経緯

- `.kiro/specs/仕様検討/科目予算設定_20260109.md` - 設計方針の決定

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-09 | 初版作成 | Claude Code |
