# AIシミュレーション機能 仕様概要

## 概要

EPMシステムに生成AI機能を導入し、経営判断のスピードと質を向上させる。競合他社（Loglass、DIGGLE、Anaplan等）が2026年を「エージェントAI元年」として相次いで機能投入している市場トレンドに対応。

**市場エビデンス**:
- 58%の財務部門が既にAI活用中（2024年、前年比+21pt）
- ROI実績: 予測精度+25%、計画サイクル40-60%短縮、レポート作成時間30-80%削減

---

## 機能スコープ

6ヶ月で以下5機能を実装:

### P0（最優先、0-3ヶ月）

#### 1. 自然言語Q&A（Natural Language Query）
**概要**: ユーザーが日本語で質問すると、AIが経営データを検索・集計して回答。

**ユースケース**:
```
Q: CFO「今期着地は？」
A: 「2024年度の見込着地は売上120億円（予算比▲5億円、-4.2%）、
    営業利益8億円（予算比▲1.2億円、-13.0%）です。
    主要要因は第2四半期の受注遅延です。【詳細レポート】」
```

**Phase 1実装範囲**:
- 対応質問パターン: 10種類に限定
  1. 「今期着地は？」
  2. 「XX月のXX部門の売上高は？」
  3. 「XX科目の前年比は？」
  4. 「予算との差異は？」
  5. 他6パターン
- UI: 画面右下に常駐チャットウィンドウ（Copilot風）

#### 2. 差異分析オートコメント（Variance Intelligence）
**概要**: 月次締め後、予算vs実績の差異を自動分析し、要因仮説付きのレポートを生成。

**ユースケース**:
```
トリガー: 月次締め完了時（手動実行 or 自動実行）
出力: Markdown/PDF レポート
内容:
  - 差異TOP10（絶対額 + 比率）
  - トレンド分析（過去3-6ヶ月推移）
  - 要因仮説（RAGで過去事例検索）
  - 推奨アクション
  - KPI・利益への影響分析
```

**特徴**:
- AIは仮説生成のみ、計算は自社エンジンで正確性担保
- 出典・根拠を必ず明示
- ユーザーが編集・追記可能

### P1（早期、3-6ヶ月）

#### 3. グラフ自動生成（Insight Visualizer）
**概要**: 自然言語指示から適切なグラフ・表を自動生成。

**Phase 1実装範囲**:
- 対応グラフ: 4種類（折れ線、棒、円、表）
- エクスポート: PNG、PDF
- UI: チャット内でグラフ表示

**ユースケース**:
```
ユーザー: 「営業利益の前年比推移をグラフで」
AI:
  1. データ抽出: 当期・前期の営業利益（月次）
  2. グラフ選定: 折れ線グラフ（2系列比較）
  3. 生成: [折れ線グラフ表示]
  4. ナラティブ: 「2024年4-9月の営業利益は前年同期比+8.2%...」
```

#### 4. 異常値検知アラート（Anomaly Detection）
**概要**: 実績データ入力時、異常値を自動検知してアラート通知。

**検知パターン**:
- 閾値ベース: 前月比±30%、予算比±20%、前年同月比±50%
- 統計ベース（Phase 2）: 過去12ヶ月の±2σ外れ値
- トレンド逸脱（Phase 2）: 過去3ヶ月のトレンド線から逸脱

**ユースケース**:
```
シナリオ: 実績入力時
ユーザー: 9月の広告宣伝費に「50,000,000円」を入力
システム: 🚨 異常値検知
  「広告宣伝費が前月比+180%です。入力ミスの可能性があります。
   前月実績: 18,000,000円
   今月入力: 50,000,000円
   確認してください: (1) 入力ミス (2) 正しい (3) コメント追加」
```

#### 5. 経営参謀Bot（Executive Analyst Agent）
**概要**: CFO/経営企画の「デジタル参謀」として、対話を通じて経営判断を支援。

**自然言語Q&Aとの違い**:
- 対話深度: 複数ターン対話（最大10ターン）
- 文脈保持: 会話履歴を保持
- 能動性: 提案・深掘り質問を能動的に提示
- 分析深度: 事実 → 要因 → 仮説 → 推奨の階層的分析

**Phase 1実装範囲**:
- 対話深度: 3ターンまで
- 能動提案: 選択肢3つまで
- 分析深度: 事実 + 簡易仮説

---

## 技術アーキテクチャ

### 全体構成

```
UI Layer (React)
  ↓
BFF (NestJS) - AI Gateway
  ↓
AI Orchestration Layer (NEW)
  ├─ Intent Classifier
  ├─ Semantic Layer (メタデータ構造化)
  ├─ RAG Engine (pgvector)
  ├─ Query Planner & Executor
  └─ LLM Service (Claude / Azure OpenAI)
  ↓
Domain API (NestJS) - Calculation Engine
  ↓
Database (PostgreSQL + pgvector)
```

### コア技術要素

#### 1. セマンティックレイヤー（最重要）
**目的**: AIが正確にデータを理解・抽出できるようにする

**構成**:
- 科目マスタのメタデータ構造化（別名・説明・集計方法）
- 部門マスタの階層構造・stable_id追跡
- 期間マスタの相対表現解決（「今期」「前年同期」等）
- KPI定義の計算式構造化

**実装**: マスタテーブルから自動生成、JSON Schema化

#### 2. RAG（Retrieval Augmented Generation）
**目的**: ドメイン固有の知識でAI回答精度を向上

**インデックス対象**:
- 科目定義書、KPI定義書
- 過去コメント（fact_amounts.memo等）
- 経営会議議事録
- 予算策定資料・前提条件
- 過去施策DB

**技術**:
- ベクターDB: PostgreSQL pgvector（Phase 1）
- 埋め込みモデル: OpenAI text-embedding-3-small

#### 3. LLM選定
- **第1候補**: Claude 3.5 Sonnet（日本語精度最高、推論能力強）
- **第2候補**: Azure OpenAI GPT-3.5 Turbo（コスト削減用）
- **重要方針**: LLMには計算させない（自社計算エンジンで集計 → LLMは言語整形のみ）

### セキュリティ・ガバナンス

1. **テナント分離**: すべてのAI機能で tenant_id による厳格なフィルタ
2. **権限制御（RLS）**: ユーザーロールに基づくデータアクセス制御
3. **監査ログ**: 質問内容、回答、参照データ、実行時間、ユーザーフィードバックを記録
4. **プロンプトインジェクション対策**: 入力サニタイズ、システムプロンプト保護
5. **出力の透明性**: すべてのAI回答に出典を明示、「AI生成の回答です」と明記

---

## 新規エンティティ

### 1. ai_conversations（会話履歴）
- セッション単位で質問・回答を記録
- 複数ターン対話の文脈保持に使用
- 監査証跡として保存

### 2. ai_knowledge_base（RAG用知識ベース）
- 科目定義、KPI定義、過去コメント等をベクトル化
- pgvectorで類似検索
- tenant_id でテナント分離

### 3. ai_audit_logs（監査ログ）
- 質問内容、意図、参照データ、LLMモデル、トークン数、実行時間を記録
- セキュリティ監査・コスト管理に使用

### 4. ai_anomaly_alerts（異常値アラート）
- 検知した異常値を記録
- ユーザーが確認・無視・コメント追加可能
- 学習ループに活用

---

## 既存システムとの関係

### 依存する既存エンティティ

| エンティティ | 用途 |
|------------|------|
| subjects | セマンティックレイヤー、科目検索 |
| departments | セマンティックレイヤー、部門検索 |
| accounting_periods | 期間解決、トレンド分析 |
| fact_amounts | データ集計、差異分析 |
| metrics | KPI定義、計算式 |
| login_accounts | 権限制御、監査ログ |
| tenants / companies | テナント分離 |

### 影響を与える既存機能

| 機能 | 影響内容 |
|------|---------|
| 予算入力 | 異常値検知アラートが入力時に表示 |
| 実績入力 | 異常値検知アラートが入力時に表示 |
| 月次締め | 差異分析レポート自動生成（設定次第） |
| レポート画面 | チャットウィンドウ常駐、グラフ生成連携 |

---

## 実装ロードマップ

### Phase 1（0-3ヶ月）: MVP

**Month 1: 基盤構築**
- AI Orchestration Layer 実装
- セマンティックレイヤー構築
- RAG基盤構築（pgvector）
- 新規エンティティ追加
- Claude API / Azure OpenAI 連携
- セキュリティ・権限制御

**Month 2: P0機能実装**
- 自然言語Q&A（10パターン）
- 差異分析オートコメント（手動実行）
- チャットUI実装
- 監査ログ記録
- テスト

**Month 3: P1前半機能実装**
- グラフ自動生成（4種類）
- 異常値検知アラート（閾値ベース）
- レポートエクスポート（PDF、PNG）
- β版ユーザーテスト

### Phase 2（4-6ヶ月）: 拡張

**Month 4: P1後半機能実装**
- 経営参謀Bot（β版、3ターン）
- 自然言語Q&A拡張（50パターン）
- 差異分析自動実行・Slack通知

**Month 5: 高度化**
- 経営参謀Bot（本格版、10ターン）
- グラフ拡張（ウォーターフォール、散布図）
- 異常値検知拡張（統計ベース、日次バッチ）

**Month 6: 仕上げ**
- 性能最適化
- コスト最適化
- ドキュメント整備
- GA（General Availability）リリース

---

## コスト試算

### 月間LLMコスト（想定）

| 機能 | 利用頻度 | 月間コスト |
|------|---------|----------|
| 自然言語Q&A | 100回/日 | $50 |
| 差異分析レポート | 1回/月 | $25 |
| グラフ生成 | 50回/日 | $15 |
| 異常値検知 | ルールベース | $0 |
| 経営参謀Bot | 10セッション/日 | $75 |
| **合計** | - | **$165** |

### コスト最適化策
1. モデル使い分け（簡易質問はGPT-3.5、複雑分析はClaude 3.5）
2. レスポンスキャッシュ（24時間）
3. 段階的トークン制限（一般ユーザー月100回、CFO無制限）
4. バッチ処理（差異分析は夜間実行）

---

## リスク管理

| リスク | 影響度 | 対策 |
|--------|--------|------|
| AIの誤回答による信用失墜 | 高 | 出典表示、検算機能、利用規約明記 |
| データ漏洩 | 高 | RLS厳格化、監査ログ、セキュリティテスト |
| LLMコスト超過 | 中 | モデル使い分け、キャッシュ、利用制限 |
| ユーザー不採用 | 中 | β版でフィードバック収集、改善ループ |
| 開発遅延 | 中 | Phase分割、優先順位明確化、スコープ調整 |

---

## 未決定事項（要確認）

### 1. レポート生成のトリガー
- **A案**: 月次締め後にバッチ自動実行
- **B案**: CFOが画面で「レポート作成」ボタン
- **C案**: 両方対応（推奨）

**暫定決定**: C案で進め、β版で使い勝手を検証

### 2. 優先対応質問TOP5
NLQ設計・セマンティックレイヤー構築の基準

**暫定案**:
1. 「今期着地は？」
2. 「XX月のXX部門の売上高は？」
3. 「予算との差異は？」
4. 「XX科目の前年比は？」
5. 「XX科目の推移を見せて」

**決定**: 暫定案で進め、β版で実際の利用頻度を測定

### 3. よく作るグラフTOP3
グラフ自動生成の優先実装対象

**暫定案**:
1. 折れ線グラフ（推移）
2. 棒グラフ（比較）
3. 円グラフ（構成比）

**決定**: 暫定案で進め、4つ目に表（数値一覧）を追加

---

## 次のステップ

### 1. CCSDD開発プロセス

```
現在地: 仕様概要 作成完了 ← HERE
次: Feature Spec 作成
  ↓
`.kiro/specs/ai/nlq/`
  ├─ spec.json
  ├─ requirements.md
  ├─ design.md
  └─ tasks.md

`.kiro/specs/ai/variance-analysis/`
  ├─ spec.json
  ├─ requirements.md
  ├─ design.md
  └─ tasks.md

（以下同様）
```

### 2. 実装前の準備

- [ ] `/kiro:spec-init "ai/nlq"`
- [ ] `/kiro:spec-requirements "ai/nlq"`
- [ ] `/kiro:spec-design "ai/nlq"`
- [ ] `/kiro:spec-tasks "ai/nlq"`
- [ ] （他4機能も同様）

### 3. エンティティ設計への影響確認

既存のPrisma Schemaへの追加:
- [ ] `ai_conversations` テーブル追加
- [ ] `ai_knowledge_base` テーブル追加（pgvector型）
- [ ] `ai_audit_logs` テーブル追加
- [ ] `ai_anomaly_alerts` テーブル追加
- [ ] RLS（Row Level Security）設定
- [ ] インデックス設定

---

## 関連ドキュメント

### 仕様検討
- `.kiro/specs/仕様検討/20260128_AIシミュレーション機能.md` - 詳細仕様検討
- `.kiro/specs/仕様検討/20260128_生成AI機能の機能検討のためのDeepReaserch結果` - 競合調査
- `.kiro/specs/仕様検討/20260109_時点の仕様検討状況と残の概要.md` - EPM機能カバレッジ

### Steering
- `.kiro/steering/development-process.md` - CCSDD開発プロセス
- `.kiro/steering/tech.md` - 技術憲法
- `.kiro/steering/product.md` - AI戦略

### エンティティ
- `.kiro/specs/entities/01_各種マスタ.md` - マスタエンティティ定義
- `.kiro/specs/entities/02_トランザクション・残高.md` - ファクトエンティティ定義

---

**作成日**: 2026-01-28
**ステータス**: 仕様概要確定、Feature Spec作成待ち
**次回アクション**: `/kiro:spec-init "ai/nlq"` からFeature Spec作成開始
