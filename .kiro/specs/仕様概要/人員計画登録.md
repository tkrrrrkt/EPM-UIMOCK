# 人員計画登録 仕様概要

## 概要

部門ごとの人員計画（社員・外注）を登録し、労務費予算を自動算出する機能。職種×等級での一括管理と、役員・兼務者の個人別配賦管理の2層構造で運用する。

## 対象エンティティ

| エンティティ | 定義ファイル | 役割 |
|-------------|-------------|------|
| labor_cost_rates | `entities/01_各種マスタ.md` 4.8 | 単価マスタ（社員・外注統一） |
| labor_cost_rate_items | `entities/01_各種マスタ.md` 4.9 | 単価内訳（科目別） |
| resource_plans | `entities/01_各種マスタ.md` 4.10 | 人員計画ヘッダー |
| resource_plan_months | `entities/01_各種マスタ.md` 4.11 | 月別人数 |
| resource_allocations | `entities/01_各種マスタ.md` 4.12 | 人員配賦（部門間振替の割合） |
| individual_allocations | `entities/01_各種マスタ.md` 4.13 | 個人別配賦（兼務者・役員用） |
| plan_events | `entities/01_各種マスタ.md` 11.1 | 予算イベント（allocation_check_mode 設定） |
| fact_amounts | `entities/01_各種マスタ.md` 12.1 | 予算ファクト（労務費算出結果） |

## 主要な仕様

### 2層構造の設計

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ レイヤー1: 一括管理（職種×等級）                                             │
│   - 通常社員・外注を職種×等級で人数管理                                      │
│   - 配賦率は職種×等級単位で設定                                              │
│   - 例: エンジニア×シニア = 10名 → A1課40%, A3課30%, A4課30%                │
├─────────────────────────────────────────────────────────────────────────────┤
│ レイヤー2: 個人別管理                                                        │
│   - 役員・兼務者を個人名で管理                                               │
│   - 個人ごとに配賦率を設定                                                   │
│   - 例: 田中部長 → B1課50%, B2課30%, B3課20%                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### レイヤー1: 一括管理（resource_plans + resource_allocations）

#### 対象

- 通常社員（正社員・契約社員・派遣社員等）
- 外注（業務委託・SES等）

#### データ構造

```
resource_plans（人員計画ヘッダー）
├── plan_event_id（予算イベント）
├── plan_version_id（バージョン）
├── source_department_stable_id（所属部門）
├── resource_type: EMPLOYEE / CONTRACTOR
├── job_category（職種: エンジニア、デザイナー等）
├── grade（等級: シニア、ジュニア等）
├── rate_type: MONTHLY / HOURLY / DAILY
├── rate_id（労務費単価マスタへの参照、nullable）
├── custom_rate（カスタム単価、rate_idがnullの場合使用）
└── notes

resource_plan_months（月別人数）
├── resource_plan_id（FK）
├── period_month（月: 4〜3 or 1〜12）
├── headcount（人数: 0.01単位、例: 10.50）
└── notes

resource_allocations（配賦設定）
├── resource_plan_id（FK）
├── target_department_stable_id（配賦先部門）
├── allocation_type: PERCENTAGE / HEADCOUNT
├── percentage（配賦率: 40.00%、合計100%チェックあり）
├── headcount_amount（人月数: allocation_type=HEADCOUNTの場合）
└── notes
```

**月別入力のポイント**:
- resource_plan_months で月ごとに人数を設定
- 中途採用（10月から3人増）などに対応可能
- 0.01人月単位まで入力可能

#### 入力方式の選択

| 入力方式 | allocation_type | 説明 |
|---------|-----------------|------|
| 割合入力 | PERCENTAGE | 合計100%になるよう配賦率を入力 |
| 人数入力 | HEADCOUNT | 各部門への人月数を直接入力 |

### レイヤー2: 個人別管理（individual_allocations）

#### 対象

- 役員（事業部長、本部長等）
- 兼務者（複数部門に所属する社員）
- 特殊な配賦が必要な個人

#### データ構造

```
individual_allocations
├── plan_event_id（予算イベント）
├── plan_version_id（バージョン）
├── employee_stable_id（社員マスタへの参照、nullable）
├── individual_name（名前: employee_stable_idがnullの場合）
├── source_department_stable_id（主幹部門）
├── job_category（職種）
├── grade（等級）
├── rate_type: MONTHLY / HOURLY / DAILY
├── rate_id（労務費単価マスタへの参照、nullable）
├── custom_rate（カスタム単価）
├── target_department_stable_id（配賦先部門）
├── allocation_type: PERCENTAGE / HEADCOUNT
├── percentage（配賦率: 40.00%）
├── headcount_amount（人月数）
├── effective_months（適用月）
└── notes
```

### 単価管理（社員・外注統一、科目別内訳対応）

単価マスタは**社員・外注を統一管理**し、**科目別の内訳**を持つ。人月単価（合計）は内訳の合計として自動計算される。

#### データ構造

```
labor_cost_rates（単価マスタ：社員・外注統一）
├── rate_code（単価コード）
├── resource_type: EMPLOYEE / CONTRACTOR  ← 区分で分ける
├── vendor_name（取引先名、外注の場合のみ）
├── job_category（職種）
├── grade（等級）
├── employment_type（雇用区分、社員の場合のみ）
├── rate_type: MONTHLY / HOURLY / DAILY
├── total_rate（人月単価 = 内訳合計、自動計算）
├── effective_date（有効開始日）
├── expiry_date（有効終了日）
├── is_active（有効フラグ）
└── notes

labor_cost_rate_items（科目別内訳）
├── rate_id（FK → labor_cost_rates）
├── subject_id（科目マスタから選択）
├── amount（金額）
├── percentage（割合: 自動計算）
└── display_order（表示順）
```

#### 単価登録画面イメージ

```
┌────────────────────────────────────────────────────────────────────────┐
│ 単価登録                                                               │
├────────────────────────────────────────────────────────────────────────┤
│ 単価コード: [ENG-SR        ]                                           │
│ 区分:       ● 社員  ○ 外注                                            │
│ 職種:       [エンジニア ▼  ]    等級: [シニア ▼    ]                   │
│ 単価種別:   ○ 月額  ○ 時給  ○ 日給                                   │
│ 有効期間:   [2026-04-01] 〜 [          ]                               │
├────────────────────────────────────────────────────────────────────────┤
│ 【科目別内訳】                                        [+ 科目追加]     │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ 科目              │ 金額          │ 割合     │ 操作              │  │
│ ├──────────────────────────────────────────────────────────────────┤  │
│ │ 給与手当 ▼        │ ¥600,000     │  75.0%  │ [削除]            │  │
│ │ 賞与引当金繰入 ▼  │ ¥100,000     │  12.5%  │ [削除]            │  │
│ │ 法定福利費 ▼      │ ¥80,000      │  10.0%  │ [削除]            │  │
│ │ 福利厚生費 ▼      │ ¥20,000      │   2.5%  │ [削除]            │  │
│ ├──────────────────────────────────────────────────────────────────┤  │
│ │ 合計（人月単価）  │ ¥800,000     │ 100.0%  │                   │  │
│ └──────────────────────────────────────────────────────────────────┘  │
├────────────────────────────────────────────────────────────────────────┤
│                                          [キャンセル]    [保存]        │
└────────────────────────────────────────────────────────────────────────┘
```

#### ポイント

- **社員・外注を統一テーブルで管理**: resource_type で区分
- **科目はマスタから選択**: 科目マスタ（subjects）からセレクトで選択
- **複数科目登録可能**: 1つの単価に対して複数の科目内訳を設定
- **内訳合計 = 人月単価**: total_rate は内訳の合計として自動計算
- **割合は自動計算**: 金額を入力すると割合が自動計算される

#### 典型的な科目内訳パターン

| 区分 | 科目内訳例 |
|------|-----------|
| 社員 | 給与手当、賞与引当金繰入、法定福利費、福利厚生費（複数科目） |
| 外注 | 外注費（単一科目が一般的、複数科目も可能） |

### 労務費算出ロジック

#### 算出フロー（科目別内訳対応）

```
1. レイヤー1の算出
   各 resource_plan について:
   ├── 単価内訳 = rate_id参照 → labor_cost_rate_items（科目別）
   ├── 総人月 = headcount × 12（または effective_months数）
   └── 配賦先ごと・科目ごとの金額:
       ├── 給与手当: ¥600,000 × 10人月 × 40% = ¥2,400,000
       ├── 賞与引当: ¥100,000 × 10人月 × 40% = ¥400,000
       ├── 法定福利費: ¥80,000 × 10人月 × 40% = ¥320,000
       └── 福利厚生費: ¥20,000 × 10人月 × 40% = ¥80,000

2. レイヤー2の算出
   各 individual_allocation について:
   ├── 単価内訳 = rate_id参照 → labor_cost_rate_items（科目別）
   └── 配賦先ごと・科目ごとの金額を算出

3. fact_amountsへの反映
   source_type = 'HEADCOUNT_CALC'
   ├── 部門別・科目別・月別に集計
   └── 科目は単価内訳から自動決定
```

#### 算出例

```
人員計画: エンジニア × シニア 10人 → A1課 40%（4人月）

単価内訳（ENG-SR）:
├── 給与手当: ¥600,000
├── 賞与引当金繰入: ¥100,000
├── 法定福利費: ¥80,000
└── 福利厚生費: ¥20,000
    ────────────────
    合計: ¥800,000/月

↓ 予算反映

fact_amounts（A1課・年間）:
├── 給与手当:       ¥28,800,000 (¥600,000 × 4人 × 12月)
├── 賞与引当金繰入:  ¥4,800,000 (¥100,000 × 4人 × 12月)
├── 法定福利費:      ¥3,840,000 (¥80,000 × 4人 × 12月)
└── 福利厚生費:        ¥960,000 (¥20,000 × 4人 × 12月)
    ─────────────────
    合計:           ¥38,400,000
```

### 画面設計

#### 一覧画面

```
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│ [年度: 2026 ▼] [予算イベント: 当初予算 ▼] [バージョン: 第1回 ▼]                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ [部門選択] A事業部 ▼                                                                         │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ [一括管理] [個人別管理]                                           ← タブ切り替え            │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│ 【一括管理タブ】                                                                             │
│ ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│ │ 区分    │職種      │等級    │人数  │単価(月)   │年間金額    │配賦設定  │操作        │  │
│ ├────────────────────────────────────────────────────────────────────────────────────────┤  │
│ │ 社員    │エンジニア│シニア  │ 10.0 │¥800,000  │¥96,000,000│ [設定]   │ [編集][削除]│  │
│ │ 社員    │エンジニア│ジュニア│  5.0 │¥500,000  │¥30,000,000│ [設定]   │ [編集][削除]│  │
│ │ 外注    │デザイナー│-       │  2.0 │¥600,000  │¥14,400,000│ [設定]   │ [編集][削除]│  │
│ └────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                              [+ 人員追加]                    │
│                                                                                              │
│ 【個人別管理タブ】                                                                           │
│ ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│ │ 氏名      │職種      │等級    │単価(月)   │配賦先      │配賦率  │年間金額    │操作    │  │
│ ├────────────────────────────────────────────────────────────────────────────────────────┤  │
│ │ 田中部長  │管理職    │部長    │¥1,200,000│ A1課       │ 40%   │¥5,760,000 │[編集]  │  │
│ │           │          │        │          │ A3課       │ 30%   │¥4,320,000 │        │  │
│ │           │          │        │          │ A4課       │ 30%   │¥4,320,000 │        │  │
│ │ 山田課長  │管理職    │課長    │¥900,000  │ B1課       │ 70%   │¥7,560,000 │[編集]  │  │
│ │           │          │        │          │ B2課       │ 30%   │¥3,240,000 │        │  │
│ └────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                              [+ 個人追加]                    │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 合計: 社員 15.0人 ¥126,000,000 / 外注 2.0人 ¥14,400,000 / 個人配賦 2名 ¥25,200,000          │
│ 総計: ¥165,600,000                                                    [予算反映] [保存]     │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 配賦設定ダイアログ

```
┌───────────────────────────────────────────────────────────────────────┐
│ 配賦設定: エンジニア × シニア (10.0人)                                │
├───────────────────────────────────────────────────────────────────────┤
│ 入力方式: ○ 割合(%) ● 人月数                                         │
├───────────────────────────────────────────────────────────────────────┤
│ 配賦先部門     │ 割合/人月 │ 年間金額        │                       │
├───────────────────────────────────────────────────────────────────────┤
│ A1課           │ 4.0 人月  │ ¥38,400,000    │ [削除]                 │
│ A3課           │ 3.0 人月  │ ¥28,800,000    │ [削除]                 │
│ A4課           │ 3.0 人月  │ ¥28,800,000    │ [削除]                 │
├───────────────────────────────────────────────────────────────────────┤
│ 合計           │10.0 人月  │ ¥96,000,000    │                        │
│ 残り           │ 0.0 人月  │                │ [+ 配賦先追加]         │
├───────────────────────────────────────────────────────────────────────┤
│                                      [キャンセル]    [保存]           │
└───────────────────────────────────────────────────────────────────────┘
```

### 部門集計ビュー

各部門から見た人員・労務費の集計表示:

```
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│ [部門選択] A1課 ▼                               [集計ビュー表示]                             │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│ 【A1課 人員・労務費集計】                                                                    │
│ ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│ │ 区分        │ソース部門  │職種      │等級    │人月   │年間金額                        │  │
│ ├────────────────────────────────────────────────────────────────────────────────────────┤  │
│ │ 自部門社員  │A1課        │エンジニア│シニア  │ 4.0   │¥38,400,000                     │  │
│ │ 自部門社員  │A1課        │エンジニア│ジュニア│ 2.0   │¥12,000,000                     │  │
│ │ 振替受入    │A事業部     │管理職    │部長    │ 4.8   │¥5,760,000 ← 田中部長(40%)     │  │
│ │ 振替受入    │B事業部     │管理職    │本部長  │ 2.4   │¥3,600,000 ← 鈴木本部長(20%)   │  │
│ │ 外注        │A1課        │デザイナー│-       │ 1.0   │¥7,200,000                      │  │
│ ├────────────────────────────────────────────────────────────────────────────────────────┤  │
│ │ 合計        │            │          │        │14.2   │¥66,960,000                     │  │
│ └────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 予算反映（fact_amounts への書き込み）

```
fact_amounts への反映データ:
├── scenario_type: BUDGET
├── source_type: 'HEADCOUNT_CALC'
├── department_stable_id: 配賦先部門
├── subject_id: 人件費 or 外注費科目
├── period_id: 月別
├── amount: 月額金額
├── data_origin: SYSTEM
└── notes: "人員計画より自動算出"
```

### source_type の追加

| source_type | 説明 |
|-------------|------|
| INPUT | 直接入力・取込 |
| ADJUST | 調整 |
| ALLOC | 経費配賦 |
| PROJECT_ROLLUP | PJ集計からのコピー |
| **HEADCOUNT_CALC** | 人員計画からの算出（新規） |

## 運用フロー

```
1. 単価マスタの整備
   - labor_cost_rates: 社員・外注の単価を登録（resource_type で区分）
   - labor_cost_rate_items: 科目別内訳を登録

2. 人員計画の登録
   - レイヤー1: 職種×等級での一括登録（resource_plans）
   - レイヤー2: 役員・兼務者の個人別登録（individual_allocations）
   - 配賦率/人月の設定（resource_allocations）
   - ※この時点ではまだ fact_amounts には反映されない

3. 人件費予算のFIX（確定）
   - 人員計画の内容を確認・承認
   - 「確定」操作で fact_amounts に書き込み
   - source_type = 'HEADCOUNT_CALC'
   - 科目は単価内訳から自動展開
   - ※既存データがある場合は警告を表示し、ユーザーに選択させる

4. 予算入力画面での確認・調整
   - HEADCOUNT_CALC 行として表示
   - 必要に応じて ADJUST で調整
```

**ポイント**: 人員計画と経費配賦（予算配賦）は独立した機能。100%チェックもそれぞれ独立して動作する。

## 関連 Feature

- `.kiro/specs/master-data/labor-cost-rate/` - 労務費予算単価マスタ
- `.kiro/specs/planning/budget-entry/` - 予算入力機能
- `.kiro/specs/仕様概要/予算入力機能.md` - 予算入力の全体像

## QA確定事項

### Q1: 単価マスタの運用
| 項目 | 決定内容 |
|------|---------|
| 単価コード命名 | 自由命名。resource_type で区分 |
| 有効期間重複 | 単価改定時は履歴管理が必要（別単価コードで管理） |

### Q2: 人員計画の入力単位
| 項目 | 決定内容 |
|------|---------|
| 期間 | **月別入力**（年間一律ではなく月ごとに人数指定可能） |
| 小数点 | **0.01人月単位**まで対応 |

### Q3: 配賦の運用
| 項目 | 決定内容 |
|------|---------|
| 配賦率合計チェック | **100%チェック必須**（予算イベントで挙動選択可能） |
| チェック挙動オプション | ①エラーで進めない ②アラートのみ（予算イベント設定で選択） |
| 配賦先の重複 | **禁止**（同一部門は1行にまとめる） |

### Q4: 予算反映
| 項目 | 決定内容 |
|------|---------|
| 既存データとの関係 | **警告表示**（「既存データがあります」と警告し、ユーザーに選択させる） |
| 反映タイミング | **人件費予算をFIX（確定）した時点**で fact_amounts に反映 |
| 予算配賦との関係 | **独立**（人員計画と経費配賦は別機能、100%チェックもそれぞれ独立） |

### Q5: 個人別配賦
| 項目 | 決定内容 |
|------|---------|
| 合計チェック | **100%必須**（全稼働時間を部門に配賦する運用）|

### Q4-1: 予算反映方式（確定）
| 項目 | 決定内容 |
|------|---------|
| 方式 | **全削除→再作成**（HEADCOUNT_CALC 行を全削除し再作成） |
| 理由 | シンプルで確実、差分計算の複雑さを回避 |
| 処理内容 | 対象イベント・バージョンの source_type='HEADCOUNT_CALC' 行を全削除後、人員計画から再計算して挿入 |

---

## Out of Scope

| 項目 | 理由 |
|------|------|
| 実績工数管理 | 計画用単価・人数のみ対象 |
| 給与計算・社保計算 | 計画用の概算のみ |
| プロジェクト別人員配置 | 初期は部門単位のみ |
| 社員マスタとの厳密連携 | 初期は名前入力で運用可 |

## 将来検討

| 項目 | 内容 |
|------|------|
| PJ別人員配置 | 部門だけでなくPJ単位での配賦 |
| 社員マスタ連携 | 社員選択での入力補助 |
| 一括インポート | CSV/Excelからの取り込み |
| 工数実績連携 | 実績工数データの取り込み |

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-13 | 初版作成（壁打ち結果を反映） | Claude Code |
| 2026-01-13 | 単価マスタの科目別内訳対応を追加 | Claude Code |
| 2026-01-13 | 単価マスタを社員・外注統一テーブルに変更 | Claude Code |
| 2026-01-13 | QA反映: 月別入力対応、0.01単位、100%チェック（会社設定） | Claude Code |
| 2026-01-13 | QA反映: 配賦先重複禁止、既存データ警告、個人別100%必須 | Claude Code |
| 2026-01-13 | QA反映: 反映タイミング確定（人件費予算FIX時）、予算配賦との独立性明確化 | Claude Code |
| 2026-01-13 | allocation_check_mode を companies から plan_events に移動 | Claude Code |
| 2026-01-13 | Q4-1確定: 予算反映方式は「全削除→再作成」 | Claude Code |
