# KPI管理マスタ機能仕様（確定版）

## 策定日
2026-01-25

## 策定経緯
`.kiro/specs/仕様検討/20260125_KPI管理マスタ仕様検討.md` の壁打ち検討結果を元に確定。

---

## 1. 機能概要

### 1.1 目的

年度単位でKPI管理項目を登録・運用し、目標達成に向けたモニタリングとアクションプラン管理を実現する。

### 1.2 主要機能

| 機能 | 概要 |
|------|------|
| KPI管理マスタ登録 | 年度単位のKPI項目を登録・管理 |
| KPI一覧画面 | KPIの階層表示、予実閲覧・入力、AP管理 |
| アクションプラン連携 | KPIに紐づくAPの登録・WBS/かんばん管理 |
| 部門別権限制御 | コントロール部門による閲覧権限管理 |

---

## 2. 画面構成

### 2.1 画面一覧

```
1. KPI管理マスタ画面
   └ KPI項目追加モーダル
      ├ 財務科目選択モード
      ├ 非財務KPI選択/新規作成モード
      └ 指標選択モード

2. KPI一覧画面（パネル開閉式）
   └ アクションプラン追加モーダル

3. ガントチャート画面（既存）
4. カンバンボード画面（既存）
```

---

## 3. KPI管理マスタ画面

### 3.1 画面レイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ KPI管理マスタ                                                │
├─────────────────────────────────────────────────────────────┤
│ [年度] 2026 ▼   [ステータス] DRAFT ▼        [+ KPI項目追加] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ KPI項目一覧                                                 │
│ ┌──────┬───────────┬──────────┬─────────┬───────┬─────┐   │
│ │コード│ KPI名     │ 種別     │ 参照元  │責任者 │操作 │   │
│ ├──────┼───────────┼──────────┼─────────┼───────┼─────┤   │
│ │KPI001│ 売上高    │ 財務科目 │ 4010    │営業部 │[編集]│  │
│ │KPI002│ CO2削減率 │非財務KPI │ -       │総務部 │[編集]│  │
│ │KPI003│営業利益率 │ 指標     │OP_RATE  │経営企画│[編集]│  │
│ └──────┴───────────┴──────────┴─────────┴───────┴─────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 主要機能

#### イベント管理
- 年度単位のKPI管理イベント作成
- ステータス管理
  - **DRAFT**: 編集可能（KPI項目の追加・編集・削除が自由）
  - **CONFIRMED**: 確定（削除不可、追加・編集は可能）

#### 作成タイミング
- 年度開始前でも作成可能
- 年度途中でも作成・変更可能

#### KPI項目管理
- 3種類のKPIから選択
  - 財務科目（subjects.kpi_managed=true）
  - 非財務KPI（kpi_definitions）
  - 指標（metrics.kpi_managed=true）

---

## 4. KPI一覧画面

### 4.1 画面レイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ KPI一覧                                                      │
├─────────────────────────────────────────────────────────────┤
│ [年度] 2026 ▼   [部門フィルタ] ▼                            │
│                 ☑ 全社                                      │
│                 ☑ 営業部                                    │
│                 ☑ 製造部                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ▼ KGI: 売上高（全社・財務）                    [予実]       │
│   ├ KPI: 新規顧客売上（営業部・非財務）        [予実][AP]   │
│   │  └ AP: 新規顧客開拓施策（営業1課）             [詳細]   │
│   └ KPI: 既存顧客売上（営業部・財務）          [予実][AP]   │
│                                                             │
│ ▼ KGI: CO2削減率（全社・非財務）               [予実][AP]   │
│   └ KPI: 省エネ設備導入率（総務部・非財務）    [予実][AP]   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 階層構造

```
Level 1: KGI（全社レベル）
└── Level 2: KPI（事業部レベル）
    └── Level 3: アクションプラン（部・課レベル）
```

**実装方針**:
- Level 1/2: `kpi_master_items` テーブルで管理
- Level 3: `action_plans` テーブルで管理（kpi_master_item_id で紐付け）
- 階層表示はアプリケーション層で統合

### 4.3 部門フィルタ

#### フィルタ方式
- 複数選択（チェックボックス）
- 閲覧権限内の部門のみ表示

#### デフォルト表示
- 閲覧可能な全部門をチェック済みで表示
- 必要に応じて絞り込み

#### 権限制御
```
社員マスタのコントロール部門で制御:
- 営業部長 → 営業部配下のみ閲覧可
- 経営企画 → 全社閲覧可
```

### 4.4 パネル開閉式UI

#### 閉じた状態
```
▼ 新規顧客売上（KPI・営業部・非財務）
  責任者: 山田部長  達成率: 95%  [予実][AP]
```

#### 開いた状態（非財務KPIの場合）
```
▼ 新規顧客売上（KPI・営業部・非財務）           [閉じる]
├─────────────────────────────────────────────────────┤
│ 責任部門: 営業部   責任者: 山田部長                  │
│                                                     │
│ 【目標・実績】（インライン編集）                    │
│ ┌──────┬─────┬──────┬──────┬────────┬──────┐   │
│ │ 期間 │ 単位│ 目標 │ 実績 │ 達成率 │ 操作 │   │
│ ├──────┼─────┼──────┼──────┼────────┼──────┤   │
│ │ Q1   │ 件  │ 100  │  95  │  95%   │[保存]│   │
│ │ Q2   │ 件  │ 120  │  -   │   -    │[編集]│   │
│ │ Q3   │ 件  │ 130  │  -   │   -    │[編集]│   │
│ │ Q4   │ 件  │ 150  │  -   │   -    │[編集]│   │
│ └──────┴─────┴──────┴──────┴────────┴──────┘   │
│ [+ 期間追加]                                        │
│                                                     │
│ 【アクションプラン】                                │
│ ┌────────────────┬─────┬────────┬────────┬──────┐ │
│ │ プラン名       │担当 │ 期限   │ 進捗   │ 操作 │ │
│ ├────────────────┼─────┼────────┼────────┼──────┤ │
│ │ 新規顧客開拓   │営業1│ 9/30   │ 40%    │[詳細]│ │
│ │                │     │        │        │[WBS] │ │
│ │                │     │        │        │[かん]│ │
│ └────────────────┴─────┴────────┴────────┴──────┘ │
│ [+ アクションプラン追加]                            │
└─────────────────────────────────────────────────────┘
```

### 4.5 KPI種別ごとの表示内容

#### 財務科目（FINANCIAL）
```
【予算・実績】（表示のみ、入力は予算管理画面で）
- 予算: 最新の承認済み（APPROVED or FIXED）バージョン
- 見込: 最新バージョン
- 実績: 最新実績

期間: 会計年度の月次（accounting_periods）

┌──────┬─────┬──────┬──────┬──────┬────────┐
│ 期間 │ 単位│ 予算 │ 見込 │ 実績 │ 達成率 │
├──────┼─────┼──────┼──────┼──────┼────────┤
│04月  │百万 │ 100  │  95  │  90  │  90%   │
│05月  │百万 │ 100  │  95  │  -   │   -    │
└──────┴─────┴──────┴──────┴──────┴────────┘

[予算管理画面へ] リンク
```

#### 非財務KPI（NON_FINANCIAL）
```
【目標・実績】（インライン編集可能）
- データソース: kpi_fact_amounts
- 期間: 自由入力（"2026-Q1", "2026-04" 等）

┌──────┬─────┬──────┬──────┬────────┬──────┐
│ 期間 │ 単位│ 目標 │ 実績 │ 達成率 │ 操作 │
├──────┼─────┼──────┼──────┼────────┼──────┤
│ Q1   │  %  │ 10.0 │  9.5 │  95%   │[保存]│
│ Q2   │  %  │ 12.0 │  -   │   -    │[編集]│
└──────┴─────┴──────┴──────┴────────┴──────┘

[+ 期間追加] ボタン → モーダルで入力
```

#### 指標（METRIC）
```
【計算結果】（予実管理なし、表示のみ）
- データソース: 構成要素から自動計算
- 目標値: kpi_target_values から取得

┌──────┬─────┬──────┬──────┬────────┐
│ 期間 │ 単位│ 実績 │ 目標 │ 達成率 │
├──────┼─────┼──────┼──────┼────────┤
│04月  │  %  │  8.5 │ 10.0 │  85%   │
│05月  │  %  │  8.3 │ 10.0 │  83%   │
└──────┴─────┴──────┴──────┴────────┘

構成要素:
- 営業利益: 85百万円（実績）
- 売上高: 1,000百万円（実績）
- 計算式: （営業利益 / 売上高）× 100
```

---

## 5. アクションプラン管理

### 5.1 AP追加フロー

```
1. KPI一覧でパネルを開く
   ↓
2. [+ アクションプラン追加] クリック
   ↓
3. APモーダル表示（画面遷移なし）
   ┌─────────────────────────┐
   │ アクションプラン追加    │
   ├─────────────────────────┤
   │ プラン名: [          ] │
   │ 担当部門: [営業1課 ▼]  │
   │ 担当者: [山田 ▼]       │
   │ 期限: [2026-09-30]     │
   │                        │
   │      [キャンセル][登録]│
   └─────────────────────────┘
   ↓
4. 登録完了 → KPI一覧に反映
```

### 5.2 WBS/かんばん管理

```
APの [WBS] [かんばん] ボタンから別画面へ遷移:

[WBS] → ガントチャート画面
- WBS項目の階層管理
- スケジュール管理
- 依存関係設定

[かんばん] → カンバンボード画面
- タスクのステータス管理
- ドラッグ&ドロップ
- 進捗管理
```

---

## 6. 権限・閲覧制御

### 6.1 部門別閲覧権限

```
社員マスタ:
- control_department_stable_ids: 閲覧可能な部門リスト

閲覧ルール:
1. 全社KPI（department_stable_id=NULL）
   → 全員が閲覧可能

2. 事業部KPI（Level 2）
   → 当該事業部 + 上位部門 + 管理部門が閲覧可能

3. 部・課KPI/AP（Level 3）
   → 当該部・課 + 上位部門 + 管理部門が閲覧可能

権限:
- epm.kpi.admin: 全社閲覧可
- epm.kpi.write: 所属部門の編集可
- epm.kpi.read: 所属部門の閲覧のみ
```

### 6.2 KPI項目の責任部門・責任者

| 項目 | 設定 | 推奨 |
|------|------|------|
| 責任部門 | 任意（NULL=全社） | Level 2/3では設定推奨 |
| 責任者 | 任意（NULL=未設定） | Level 2/3では設定推奨 |

---

## 7. データ管理

### 7.1 KPI項目の追加・変更・削除

#### 追加
- 年度途中でもいつでも追加可能
- 追加時点から予実入力・AP登録が可能
- 過去期間の予実を遡って入力することも可能

#### 変更
- KPI名、責任者等の変更は自由
- **KPI種別（財務/非財務/指標）の変更は不可**
- **参照先（科目ID等）の変更は不可**

#### 削除
- 論理削除（is_active=false）
- 既存の予実データは保持（閲覧可能）
- 紐づくアクションプランは「削除されたKPIに紐付くプラン」として警告表示
- 復元機能を提供（is_active=true に戻す）

### 7.2 期間管理

#### 非財務KPIの期間コード
- テキスト自由入力（最大32文字）
- フォーマット制限なし
- 同一KPI内での期間コード重複は不可

#### 推奨フォーマット
```
2026-Q1  （四半期）
2026-04  （月次）
2026-H1  （半期）
2026-ANNUAL （年間）
```

#### UIでのサポート
- プリセット選択肢を提供
- 日付範囲（period_start_date, period_end_date）も入力可能（任意）

---

## 8. エンティティ概要

### 8.1 主要エンティティ

```
kpi_master_events（KPI管理イベント）
├── 年度単位の枠組み
└── ステータス管理（DRAFT/CONFIRMED）

kpi_master_items（KPI管理項目）
├── Level 1/2 のKPI項目
├── 3種類（財務/非財務/指標）
└── 階層構造（parent_kpi_item_id）

action_plans（アクションプラン）
├── Level 3 相当
├── kpi_master_item_id で紐付け
└── WBS/タスクとの関連

kpi_target_values（指標の目標値）
├── 指標の期間別目標値
└── kpi_master_items に紐づく
```

### 8.2 データフロー

```
【財務科目】
subjects (kpi_managed=true)
  ↓ 参照
kpi_master_items (kpi_type='FINANCIAL')
  ↓ 予実データ
fact_amounts (承認済み予算・見込・実績)

【非財務KPI】
kpi_definitions
  ↓ 参照
kpi_master_items (kpi_type='NON_FINANCIAL')
  ↓ 予実データ
kpi_fact_amounts (目標・実績)

【指標】
metrics (kpi_managed=true)
  ↓ 参照
kpi_master_items (kpi_type='METRIC')
  ↓ 目標値
kpi_target_values (期間別目標)
  ↓ 実績値
構成要素から自動計算
```

---

## 9. 実装範囲

### 9.1 Phase 1（必須）

- [x] KPI管理マスタ画面
- [x] KPI項目追加機能（財務/非財務/指標）
- [x] KPI一覧画面（階層表示、パネル開閉）
- [x] 非財務KPI目標・実績入力（インライン編集）
- [x] 指標の目標値管理（kpi_target_values）
- [x] 部門フィルタ（複数選択）
- [x] AP追加（モーダル）
- [x] 権限制御（部門別閲覧権限）

### 9.2 Phase 2（拡張）

- [ ] 前年度からのコピー機能
- [ ] KPI階層の自動積み上げ集計
- [ ] ダッシュボードカスタマイズ
- [ ] レポート出力機能

---

## 10. 関連ドキュメント

- `.kiro/specs/仕様検討/20260125_KPI管理マスタ仕様検討.md` - 壁打ち検討記録
- `.kiro/specs/仕様概要/KPIアクションプラン管理_変更案.md` - 全体変更案
- `.kiro/specs/仕様概要/KPI管理_エンティティ変更サマリ.md` - エンティティ変更詳細
- `.kiro/specs/仕様概要/KPI管理_UI設計変更サマリ.md` - UI設計詳細
- `.kiro/specs/entities/01_各種マスタ.md` - エンティティ定義（最新版反映予定）

---

## 11. 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-25 | 初版作成（壁打ち検討結果を反映） | Claude Code |
