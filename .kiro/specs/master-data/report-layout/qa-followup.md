# 仕様QA 追加確認事項: master-data/report-layout

## 確認済み（回答ありがとうございます）

✅ **Issue 1: 科目選択時のcompany_idフィルタリング**
- **決定**: 同じcompany_idの科目のみ表示する
- **反映先**: Requirements 13.3、Design SubjectSearchService

✅ **Issue 2: account行のdisplay_nameの扱い**
- **決定**: 手動入力可能（レイアウトマスタ用に設定可能）
- **反映先**: Requirements 7.3、Design Line Service

✅ **Issue 3: 科目の無効化時の整合性チェック**
- **決定**: 
  - 修正更新時: チェックではじく（エラー返却）
  - 表示時: 無効科目がある場合はアラートを出すが、描画はする（数値は表示しない？）
- **反映先**: Requirements 8（行編集）、Design Line Service、UI責務

---

## 追加確認事項

### Issue 4: レイアウトのcompany_id変更時の整合性チェック

**✅ 回答済み**:
- **決定**: 会社A専用レイアウトのcompany_idを会社Bに変更することはない
- **設計方針**: 
  - company_idの変更機能は提供しない（要件から除外）
  - 権限に応じて複数社の権限がある人の場合は、DDL（ドロップダウンリスト）で会社を選択
  - ログイン時または画面表示時に会社を選択し、選択された会社のマスタのみ表示・編集可能
  - 基本的にその会社のマスタのみ変更する

**反映先**:
- Requirements: 3（レイアウトの編集）に「company_idは変更不可」を追加
- Design: Layout Serviceに「company_id変更不可」を明記
- UI責務: 会社選択DDLの表示を追加（複数社権限がある場合）

---

### Issue 5: subject_fin_attrsが存在しない科目の扱い

**📚 背景知識（かみくだき説明）**

**科目の種類**:
- **財務科目（FIN）**: 売上高、売上原価、営業利益など、PL/BSに表示される科目
  - 例: 売上高（subject_type='FIN'）
  - `subject_fin_attrs`テーブルに`fin_stmt_class`（PL/BS）が記録されている
- **KPI科目（KPI）**: 顧客満足度、従業員数など、財務諸表には表示されない指標
  - 例: 顧客満足度（subject_type='KPI'）
  - `subject_fin_attrs`テーブルには**存在しない**（財務属性がないため）

**レイアウトマスタの目的**:
- PL（損益計算書）やBS（貸借対照表）の表示レイアウトを定義する
- つまり、**財務科目（FIN）のみ**を対象とする

**問題点**:
1. 科目選択時に、KPI科目も表示してしまう可能性がある
2. 既存のaccount行にKPI科目が紐付いている可能性がある（過去のデータ）

---

**📋 具体的なシナリオ**

**シナリオ1: 科目選択ダイアログを開く**
```
【状況】
- 会社選択: "会社A"
- レイアウト種別: PL
- account行を追加しようとして科目選択ダイアログを開く

【データ例】
- 売上高: subject_type='FIN', subject_fin_attrs.fin_stmt_class='PL' ✅ 表示すべき
- 売上原価: subject_type='FIN', subject_fin_attrs.fin_stmt_class='PL' ✅ 表示すべき
- 顧客満足度: subject_type='KPI', subject_fin_attrsなし ❌ 表示すべき？

【質問 Q5-1】
科目選択時に表示する科目の条件は？
  A) subject_type='FIN' かつ subject_fin_attrsが存在する科目のみ
     → 売上高、売上原価のみ表示（顧客満足度は表示しない）
  
  B) subject_type='FIN' の科目のみ（subject_fin_attrsの存在チェックはしない）
     → 売上高、売上原価を表示（ただし、subject_fin_attrsが存在しないFIN科目も表示される可能性）
  
  C) 全科目（FIN/KPI問わず）を表示するが、subject_fin_attrsが存在しない科目は選択不可
     → 売上高、売上原価、顧客満足度を表示するが、顧客満足度は選択できない（グレーアウト）
```

**シナリオ2: 既存のaccount行にKPI科目が紐付いている**
```
【状況】
- 過去に誤ってKPI科目「顧客満足度」をaccount行に紐付けてしまった
- 現在、そのレイアウトを表示・編集しようとする

【質問 Q5-2】
この場合、どう扱いますか？
  A) エラーとして扱う（表示不可・編集不可）
     → レイアウト表示時にエラーを出し、表示できない
  
  B) 警告を表示するが、表示はする（編集時はエラー）
     → レイアウト表示時は「無効な科目が含まれています」と警告を出すが、表示はする
     → その行を編集しようとするとエラーを出す
  
  C) そのまま表示する（fin_stmt_classフィルタは適用しない）
     → 警告も出さず、そのまま表示する（ただし、数値は表示できない）
```

**シナリオ3: レイアウト種別と科目の整合性チェック**
```
【状況】
- レイアウト種別: PL
- account行に紐付いている科目: 売上高（fin_stmt_class='PL'）✅ 整合性OK
- account行に紐付いている科目: 現金（fin_stmt_class='BS'）❌ 整合性NG

【質問 Q5-3】
レイアウト種別（PL/BS）と科目のfin_stmt_classの整合性チェックはどこで行いますか？
  A) 科目選択時のみ（既存行はチェックしない）
     → 新規に科目を選択する時だけチェック
     → 既存のaccount行にBS科目が紐付いていても、そのまま表示する
  
  B) 科目選択時 + 行編集時（既存行の科目変更時）
     → 新規選択時と、既存行の科目を変更する時だけチェック
     → 既存のaccount行にBS科目が紐付いていても、そのまま表示する（編集時のみチェック）
  
  C) 科目選択時 + 行編集時 + レイアウト種別変更時
     → 新規選択時、科目変更時、レイアウト種別変更時にチェック
     → レイアウト種別をPL→BSに変更する時、PL科目が紐付いている行をチェック
```

---

**✅ 回答済み**:
- **決定**: 財務レイアウトかKPIレイアウトかを選択できるようにする
- **設計方針**:
  - 財務レイアウト（PL/BS）: subject_type='FIN' かつ subject_fin_attrsが存在する科目のみ表示・選択可能
  - KPIレイアウト: subject_type='KPI' の科目のみ表示・選択可能
  - 登録時（科目選択時）にチェックを行う
  - 行編集時にもチェックを行う
  - レイアウト種別変更時（財務⇔KPI）にもチェックを行う（種別変更時は全行削除するため、実質的には種別変更時のチェックは不要）

**重要な設計変更**:
- `layout_type` を 'PL' | 'BS' | 'KPI' に拡張する必要がある
- エンティティ定義（7.1 report_layouts）の `layout_type` の制約を更新する必要がある
- 現在のエンティティ定義では `layout_type` は 'PL/BS' のみ想定されているため、エンティティ定義の更新が必要

**反映先**:
- エンティティ定義: 7.1 report_layouts.layout_type の制約を更新
- Requirements: 2（新規作成）、3（編集）、13（科目選択）を更新
- Design: Layout Service、SubjectSearchService、Line Service を更新

---

### Issue 6: レイアウト複製時のcompany_idの扱い

**✅ 回答済み**:
- **決定**: コピーしてつくるときはもちろん同じカンパニーIDです
- **反映先**: Requirements 12（レイアウトの複製）、Design LayoutCopyService

**反映内容**:
- 複製時のcompany_idは複製元を引き継ぐ（変更不可）
- 複製時の入力項目は layoutCode, layoutName のみ（company_idは含めない）
- 会社選択により、選択された会社のマスタのみを対象とするため、複製先も同じcompany_idになる

---

## 回答形式

以下の形式で回答をお願いします：

```
### Issue 4
Q4-1: [選択肢A/B/C/D または その他の回答]
Q4-2: [はい/いいえ または その他の回答]

### Issue 5
Q5-1: [選択肢A/B/C または その他の回答]
Q5-2: [選択肢A/B/C または その他の回答]
Q5-3: [選択肢A/B/C または その他の回答]

### Issue 6
Q6-1: [選択肢A/B/C/D または その他の回答]
Q6-2: [選択肢A/B/C/D または その他の回答]
Q6-3: [選択肢A/B または その他の回答]
```

回答いただいた内容を基に、Requirements.mdとDesign.mdを更新します。

