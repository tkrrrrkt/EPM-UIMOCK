# Design Review: master-data/report-layout

## Summary

レポートレイアウトマスタ機能の設計は、既存のマスタ系機能（organization-master、company-master等）と一貫したアーキテクチャパターンを採用し、エンティティ定義（7.1 report_layouts、7.2 report_layout_lines）との整合性が確保されている。BFF/APIの責務分離、Contracts定義、マルチテナント対応（RLS + double-guard）が適切に設計されており、実装準備が整っている。

---

## Critical Issues (≤3)

### Issue 1: 種別変更時の行削除処理のトランザクション整合性

**Concern**: レイアウト種別（PL/BS）変更時に既存の全行を削除する処理について、UI側の警告ダイアログとAPI側の削除処理の整合性が設計上は明確だが、実装時にUIが警告を表示せずにAPIを呼び出した場合の挙動が不明確。

**Impact**: UI側の警告が実装されていない、または警告をバイパスした場合、ユーザーが意図せず全行が削除される可能性がある。また、種別変更と行削除が単一トランザクションで実行されることは設計に明記されているが、UI側の実装ガイドラインが不足している。

**Suggestion**: design.md の「UI の責務」セクションに、種別変更時の警告ダイアログ表示を「必須」として明記し、API側でも種別変更リクエスト時に既存行が存在する場合は警告フラグを返すか、またはUI側の実装チェックリストに「種別変更警告ダイアログの実装」を追加する。また、tasks.md生成時にこの実装順序を明記する。

**Traceability**: Requirement 3.6-3.8（レイアウト種別変更時の警告・削除・キャンセル）

**Evidence**: design.md「UI の責務」セクション（614行目）、「Transaction Boundary」セクション（258行目）

---

## Strengths

1. **既存パターンとの一貫性**: organization-masterと同様の1画面統合型アーキテクチャを採用し、既存コードベースとの学習コストを最小化している。BFF/APIの責務分離、Contracts定義、Error Policy（Pass-through）の選択も既存パターンに準拠している。

2. **エンティティ整合性の確保**: エンティティ定義（7.1、7.2）との整合性チェックリストが完備され、カラム網羅性・型の一致・制約の反映・ビジネスルールの反映がすべて確認済みである。Prisma Schemaもエンティティ定義に忠実に反映されている。

---

## Final Assessment

**Decision**: **GO**

**Rationale**: 設計は既存アーキテクチャパターンに準拠し、エンティティ定義との整合性が確保されている。Contracts定義、BFF/API責務分離、マルチテナント対応、要件トレーサビリティが適切に設計されている。Issue 1は実装時の注意点であり、tasks.md生成時に実装順序とチェックリストを明記することで対応可能。設計品質は実装開始に十分な水準に達している。

**Next Steps**:
1. 本レビュー結果を確認し、Issue 1について必要に応じてdesign.mdの「UI の責務」セクションを補強する（任意）
2. `/kiro:spec-tasks master-data/report-layout` を実行して実装タスクを生成する
3. tasks.md生成時に、種別変更警告ダイアログの実装をUI実装タスクに明記する

---

## Interactive Discussion

設計レビューを完了しました。Issue 1は実装時の注意点であり、設計の根本的な問題ではありません。tasks.md生成時に実装順序を明記することで対応可能です。

設計の強みとして、既存パターンとの一貫性とエンティティ整合性の確保が挙げられます。これにより、実装時の迷いが少なく、既存コードベースとの統合もスムーズに進められると判断します。

追加で確認したい点や、Issue 1についてdesign.mdを補強する必要があればお知らせください。問題なければ、次のステップとして `/kiro:spec-tasks master-data/report-layout` の実行に進むことをお勧めします。

