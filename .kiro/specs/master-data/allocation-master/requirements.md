# Requirements Document

## Introduction

本ドキュメントは、EPM SaaSにおける配賦マスタ機能（Phase 1）の要件を定義する。

配賦マスタは、本社共通費・間接費等を事業部門やセグメントへ按分配賦するためのルール定義機能である。
Phase 1 では配賦ルールの定義（CRUD）に集中し、配賦実行・プレビュー機能は後続フェーズで実装する。

---

## Entity Reference（必須）

本機能で使用するエンティティ定義を `.kiro/specs/entities/*.md` から確認し、以下を記載する：

### 対象エンティティ
- allocation_events: `.kiro/specs/entities/01_各種マスタ.md` セクション 13.1
- allocation_steps: `.kiro/specs/entities/01_各種マスタ.md` セクション 13.2
- allocation_step_targets: `.kiro/specs/entities/01_各種マスタ.md` セクション 13.3
- allocation_drivers: `.kiro/specs/entities/01_各種マスタ.md` セクション 13.4

### 関連エンティティ（参照のみ）
- subjects: セクション 6.1（配賦元科目）
- departments: セクション 3.2（配賦元・配賦先部門）
- dimension_values: セクション 4.2（配賦先ディメンション値）
- companies: セクション 1.2（会社）

### エンティティ整合性確認
- [x] 対象エンティティのカラム・型・制約を確認した
- [x] エンティティ補足のビジネスルールを要件に反映した
- [x] スコープ外の関連エンティティを Out of Scope に明記した

---

## Out of Scope（Phase 1 対象外）

以下は Phase 1 では実装しない：
- filter_json / exclude_json（カラムは残すがUI非表示）
- 配賦実行（Fact生成）
- 配賦結果プレビュー
- 連結配賦
- 非財務（KPI）配賦

---

## Requirements

### Requirement 1: 配賦イベント管理

**Objective:** As a 経営管理担当者, I want 配賦イベント（配賦処理の束）を登録・編集・削除できる, so that 配賦ルールを体系的に管理できる

#### Acceptance Criteria

1.1. When ユーザーが配賦イベント一覧画面を開く, the 配賦マスタ shall 当該会社の配賦イベント一覧を表示する

1.2. When ユーザーが新規作成ボタンをクリックする, the 配賦マスタ shall 配賦イベント作成ダイアログを表示する

1.3. When ユーザーが必須項目（イベントコード、イベント名、シナリオタイプ）を入力して保存する, the 配賦マスタ shall 配賦イベントを登録する

1.4. The 配賦マスタ shall イベントコードを会社内で一意に制約する

1.5. When ユーザーが既存イベントを選択する, the 配賦マスタ shall イベント詳細画面を表示し、配下のステップ一覧を表示する

1.6. When ユーザーがイベントを編集して保存する, the 配賦マスタ shall 変更内容を保存する

1.7. When ユーザーがイベントを削除する and 配下にステップが存在しない, the 配賦マスタ shall イベントを削除する

1.8. If ユーザーがイベントを削除しようとする and 配下にステップが存在する, the 配賦マスタ shall 削除を拒否し、エラーメッセージを表示する

1.9. When ユーザーがイベントを無効化する, the 配賦マスタ shall is_active を false に設定する

---

### Requirement 2: 配賦ステップ管理

**Objective:** As a 経営管理担当者, I want 配賦イベント内に複数の配賦ステップを定義できる, so that 多段階配賦（本社→事業部→部門等）を設定できる

#### Acceptance Criteria

2.1. When ユーザーがイベント詳細画面でステップ追加ボタンをクリックする, the 配賦マスタ shall ステップ作成ダイアログを表示する

2.2. When ユーザーがステップを作成する, the 配賦マスタ shall step_no を自動採番し、末尾に追加する

2.3. The 配賦マスタ shall ステップに以下を設定可能とする：ステップ名、配賦元科目、配賦元部門（必須、stable_id で参照）、配賦基準種別、配賦基準参照元

2.4. When ユーザーが配賦基準種別として FIXED を選択する, the 配賦マスタ shall 固定比率による配賦設定を可能とする

2.5. When ユーザーが配賦基準種別として HEADCOUNT を選択する, the 配賦マスタ shall 人員比による配賦設定を可能とする

2.6. When ユーザーが配賦基準種別として SUBJECT_AMOUNT を選択する, the 配賦マスタ shall 特定科目金額比による配賦設定を可能とし、参照科目の選択を必須とする

2.7. When ユーザーが配賦基準種別として MEASURE を選択する, the 配賦マスタ shall 物量（面積・工数等）比による配賦設定を可能とし、measure_key の入力を必須とする

2.8. When ユーザーが配賦基準種別として KPI を選択する, the 配賦マスタ shall KPI値比による配賦設定を可能とし、KPI科目の選択を必須とする

2.9. When ユーザーがステップの順序を変更する（ドラッグ＆ドロップまたは上下ボタン）, the 配賦マスタ shall step_no を再採番し、実行順序を更新する

2.10. The 配賦マスタ shall ステップ順序変更時に楽観的ロック（eventVersion）を使用し、競合を検出する

2.11. If ステップ順序変更時にバージョン競合が発生した場合, the 配賦マスタ shall エラーを返し、最新データの再取得を促す

2.12. When ユーザーがステップを削除する and 配下にターゲットが存在しない, the 配賦マスタ shall ステップを削除する

2.13. If ユーザーがステップを削除しようとする and 配下にターゲットが存在する, the 配賦マスタ shall 削除を拒否し、エラーメッセージを表示する

2.14. When ユーザーが配賦ドライバ参照を選択する, the 配賦マスタ shall 登録済みドライバから選択可能とする

2.15. When ユーザーがインラインでドライバ設定を行う（ドライバ参照なし）, the 配賦マスタ shall ステップ内に直接設定を保存する

---

### Requirement 3: 配賦先（ターゲット）管理

**Objective:** As a 経営管理担当者, I want 各ステップの配賦先を複数定義できる, so that 配賦金額を適切な部門・セグメントに按分できる

#### Acceptance Criteria

3.1. When ユーザーがステップ詳細で配賦先追加ボタンをクリックする, the 配賦マスタ shall 配賦先追加ダイアログを表示する

3.2. The 配賦マスタ shall 配賦先タイプとして「部門」または「ディメンション値」を選択可能とする

3.3. When ユーザーが配賦先タイプ「部門」を選択する, the 配賦マスタ shall 当該会社の部門一覧から選択可能とする

3.4. When ユーザーが配賦先タイプ「ディメンション値」を選択する, the 配賦マスタ shall ディメンション→値の階層選択を可能とする

3.5. The 配賦マスタ shall 配賦先ごとに配賦先科目（to_subject_id）を設定可能とする（任意、NULL の場合は配賦元科目と同じ）

3.6. When 配賦基準種別が FIXED の場合, the 配賦マスタ shall 各配賦先に固定比率（0〜1）を設定可能とする

3.7. While 配賦基準種別が FIXED の場合, the 配賦マスタ shall 全配賦先の固定比率合計が1.0であることを検証する

3.8. If 固定比率の合計が1.0でない場合, the 配賦マスタ shall 警告メッセージを表示する（保存は許可）

3.9. When ユーザーが配賦先を削除する, the 配賦マスタ shall 当該ターゲットを削除する

3.10. When ユーザーが配賦先の表示順序を変更する, the 配賦マスタ shall sort_order を更新する

3.11. The 配賦マスタ shall 同一ステップ内で同一ターゲット（同一target_type + target_id）の重複登録を禁止する

3.12. When 配賦先タイプが部門の場合, the 配賦マスタ shall target_id に部門の stable_id を使用する（組織改編に対応）

---

### Requirement 4: 配賦ドライバ管理

**Objective:** As a 経営管理担当者, I want 配賦ドライバ（按分基準）を独立したマスタとして管理できる, so that 複数のステップで同一の配賦基準を再利用できる

#### Acceptance Criteria

4.1. When ユーザーが配賦ドライバ一覧画面を開く, the 配賦マスタ shall 当該会社の配賦ドライバ一覧を表示する

4.2. When ユーザーが新規ドライバを作成する, the 配賦マスタ shall ドライバコード、ドライバ名、基準種別、参照元種別を登録する

4.3. The 配賦マスタ shall ドライバコードを会社内で一意に制約する

4.4. When ユーザーがドライバ種別 SUBJECT_AMOUNT を選択する, the 配賦マスタ shall 参照科目の選択を必須とする

4.5. When ユーザーがドライバ種別 MEASURE を選択する, the 配賦マスタ shall measure_key（面積・工数等）の入力を必須とする

4.6. When ユーザーがドライバ種別 KPI を選択する, the 配賦マスタ shall KPI科目の選択を必須とする

4.7. When ユーザーがドライバを編集する, the 配賦マスタ shall 変更内容を保存する

4.8. When ユーザーがドライバを削除する and 参照しているステップが存在しない, the 配賦マスタ shall ドライバを削除する

4.9. If ユーザーがドライバを削除しようとする and 参照しているステップが存在する, the 配賦マスタ shall 削除を拒否し、参照元ステップの情報を表示する

---

### Requirement 5: 配賦設定コピー機能

**Objective:** As a 経営管理担当者, I want 既存の配賦イベントをコピーして新規イベントを作成できる, so that 類似の配賦設定を効率的に作成できる

#### Acceptance Criteria

5.1. When ユーザーがイベント一覧でコピーボタンをクリックする, the 配賦マスタ shall コピー作成ダイアログを表示する

5.2. When ユーザーが新しいイベントコードとイベント名を入力してコピー実行する, the 配賦マスタ shall 元イベントの全ステップと配賦先をコピーした新規イベントを作成する

5.3. The 配賦マスタ shall コピー時にイベントコードの一意性を検証する

5.4. If コピー先イベントコードが既に存在する場合, the 配賦マスタ shall エラーメッセージを表示し、別のコードの入力を促す

5.5. The 配賦マスタ shall コピー時にステップ内のドライバ参照を維持する（同一ドライバを参照）

---

### Requirement 6: 一覧・検索・フィルタ

**Objective:** As a 経営管理担当者, I want 配賦イベント・ドライバを検索・フィルタできる, so that 目的の設定を素早く見つけられる

#### Acceptance Criteria

6.1. The 配賦マスタ shall イベント一覧でキーワード検索（コード・名前）を提供する

6.2. The 配賦マスタ shall イベント一覧でシナリオタイプ（ACTUAL/BUDGET/FORECAST）によるフィルタを提供する

6.3. The 配賦マスタ shall イベント一覧で有効/無効（is_active）によるフィルタを提供する

6.4. The 配賦マスタ shall ドライバ一覧でキーワード検索（コード・名前）を提供する

6.5. The 配賦マスタ shall ドライバ一覧で基準種別によるフィルタを提供する

6.6. The 配賦マスタ shall 一覧にページネーションを提供する（デフォルト50件）

6.7. The 配賦マスタ shall 一覧のソート機能を提供する（コード・名前・更新日時）

---

### Requirement 7: データ整合性・バリデーション

**Objective:** As a システム, I want データ整合性を保証する, so that 不正な配賦設定が登録されない

#### Acceptance Criteria

7.1. The 配賦マスタ shall 配賦元科目（from_subject_id）が存在することを検証する

7.2. The 配賦マスタ shall 配賦元部門（from_department_stable_id）が存在することを検証する（必須、stable_id で参照）

7.3. When 配賦先タイプが部門の場合, the 配賦マスタ shall 当該部門が存在することを検証する

7.4. When 配賦先タイプがディメンション値の場合, the 配賦マスタ shall 当該ディメンション値が存在することを検証する

7.5. When ドライバ参照が指定される, the 配賦マスタ shall 当該ドライバが存在することを検証する

7.6. The 配賦マスタ shall 必須項目の入力検証を行う

7.7. The 配賦マスタ shall fixed_ratio が 0〜1 の範囲であることを検証する

7.8. The 配賦マスタ shall 同一イベント内でステップ番号（step_no）が重複しないことを保証する

---

### Requirement 8: 権限・マルチテナント

**Objective:** As a システム, I want 権限とテナント分離を適用する, so that 各社が自社の配賦ルールのみを管理できる

#### Acceptance Criteria

8.1. The 配賦マスタ shall ログインユーザーの所属会社の配賦データのみを表示する

8.2. The 配賦マスタ shall 他社の配賦データへのアクセスを禁止する（RLS適用）

8.3. The 配賦マスタ shall 配賦マスタ参照権限（epm.allocation.read）を持つユーザーのみが閲覧できる

8.4. The 配賦マスタ shall 配賦マスタ作成権限（epm.allocation.create）を持つユーザーのみが新規イベント・ステップ・ターゲット・ドライバを作成できる

8.5. The 配賦マスタ shall 配賦マスタ更新権限（epm.allocation.update）を持つユーザーのみが編集・順序変更・コピー操作ができる

8.6. The 配賦マスタ shall 配賦マスタ削除権限（epm.allocation.delete）を持つユーザーのみが削除できる

8.7. While ユーザーが作成権限を持たない場合, the 配賦マスタ shall 新規作成ボタンを非表示にする

8.8. While ユーザーが更新権限を持たない場合, the 配賦マスタ shall 編集・コピーボタンを非表示にする

8.9. While ユーザーが削除権限を持たない場合, the 配賦マスタ shall 削除ボタンを非表示にする

---

### Requirement 9: UI/UX

**Objective:** As a 経営管理担当者, I want 直感的で効率的なUIで配賦設定を行える, so that 運用負荷を最小限に抑えられる

#### Acceptance Criteria

9.1. The 配賦マスタ shall イベント詳細画面内にステップ一覧を埋め込み表示する（階層的一画面構成）

9.2. The 配賦マスタ shall ステップ詳細をダイアログで表示し、配賦先一覧を含める

9.3. The 配賦マスタ shall ステップ順序をドラッグ＆ドロップまたは上下ボタンで変更可能とする

9.4. The 配賦マスタ shall 配賦先追加時にインクリメンタルサーチを提供する（部門・ディメンション値）

9.5. The 配賦マスタ shall 入力エラーをフィールド単位でインライン表示する

9.6. The 配賦マスタ shall 保存成功時にトースト通知を表示する

9.7. The 配賦マスタ shall 削除操作に確認ダイアログを表示する

9.8. The 配賦マスタ shall ローディング状態を適切に表示する

