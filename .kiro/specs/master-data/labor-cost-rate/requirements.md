# Requirements Document

## Introduction

労務費予算単価マスタ（Labor Cost Rate Master）は、EPM SaaS における労務費予算算出のための「計画用単価」を管理する機能である。

**社員・外注を統一管理**し、職種・等級・雇用区分別の標準単価を登録・管理する。単価は**科目別内訳**を持ち、人数計画や工数計画と組み合わせて予算算出に活用する。単価は有効期間を持ち、改定履歴を追跡可能とする。将来の単価を事前登録しておくことも可能。

**注意**: 実績給与・手当・社保等の管理は対象外であり、計画上の標準単価のみを扱う。

---

## Entity Reference（必須）

本機能で使用するエンティティ定義を `.kiro/specs/entities/*.md` から確認し、以下を記載する：

### 対象エンティティ
- **labor_cost_rates**: `.kiro/specs/entities/01_各種マスタ.md` セクション 4.8（単価マスタ：社員・外注統一）
- **labor_cost_rate_items**: `.kiro/specs/entities/01_各種マスタ.md` セクション 4.9（単価内訳：科目別）
- **subjects**: `.kiro/specs/entities/01_各種マスタ.md`（参照のみ、科目マスタ）
- **companies**: `.kiro/specs/entities/01_各種マスタ.md` セクション 1.2（参照のみ）

### エンティティ整合性確認
- [x] 対象エンティティのカラム・型・制約を確認した
- [x] エンティティ補足のビジネスルールを要件に反映した
- [x] スコープ外の関連エンティティを Out of Scope に明記した

---

## Requirements

### Requirement 1: 労務費予算単価の一覧表示
**Objective:** 経営企画担当者として、登録済みの労務費予算単価を一覧で確認したい。予算策定時に適用可能な単価を素早く把握するため。

#### Acceptance Criteria
1.1. システムは、労務費予算単価の一覧を表示する
1.2. 一覧には以下の項目を表示する：単価コード、リソース区分（社員/外注）、職種、等級、雇用区分（社員の場合）、取引先名（外注の場合）、単価種別（月額/時給/日給）、人月単価（内訳合計）、有効開始日、有効終了日、有効状態
1.3. When ユーザーが一覧画面を開いたとき、the システム shall 当日時点で有効な単価をデフォルトで表示する（基準日=当日）
1.4. 一覧はページネーションに対応する（デフォルト20件/ページ）
1.5. When ユーザーがソートを指定したとき、the システム shall 指定列でソートする（単価コード、職種、等級、有効開始日、人月単価）

### Requirement 2: 労務費予算単価の検索・フィルタリング
**Objective:** 経営企画担当者として、特定条件で単価を絞り込みたい。多数の単価から目的の単価を素早く見つけるため。

#### Acceptance Criteria
2.1. When ユーザーがキーワードを入力したとき、the システム shall 単価コード・職種・取引先名での部分一致検索を行う
2.2. When ユーザーがリソース区分（社員/外注）を選択したとき、the システム shall 指定区分の単価のみ表示する
2.3. When ユーザーが等級を選択したとき、the システム shall 指定等級の単価のみ表示する
2.4. When ユーザーが雇用区分を選択したとき、the システム shall 指定雇用区分の単価のみ表示する（社員の場合）
2.5. When ユーザーが単価種別（月額/時給/日給）を選択したとき、the システム shall 指定種別の単価のみ表示する
2.6. When ユーザーが有効フラグを選択したとき、the システム shall 有効/無効/すべてで絞り込む
2.7. When ユーザーが基準日を指定したとき、the システム shall その日時点で有効な単価（effective_date <= 基準日 AND (expiry_date IS NULL OR expiry_date > 基準日)）のみ表示する
2.8. 基準日のデフォルトは当日とする。ユーザーは基準日を変更して将来・過去の有効単価を確認できる
2.9. 無効化（is_active=false）された単価は、基準日フィルタの対象外とする（有効期間内でも表示されない）

### Requirement 3: 労務費予算単価の新規登録
**Objective:** 経営企画担当者として、新しい労務費予算単価を登録したい。新年度や組織変更に伴う新しい単価体系を管理するため。

#### Acceptance Criteria
3.1. システムは、ダイアログ形式で以下の項目を入力可能な登録フォームを提供する：
   - 単価コード（必須、最大50文字、半角英数字・ハイフン・アンダースコアのみ、大文字小文字区別）
   - リソース区分（必須、社員/外注から選択）
   - 取引先名（外注の場合のみ、任意、最大100文字）
   - 職種（必須、最大50文字、将来マスタ化予定）
   - 等級（任意、最大50文字、将来マスタ化予定）
   - 雇用区分（社員の場合のみ、任意、最大50文字、将来マスタ化予定）
   - 単価種別（必須、月額/時給/日給から選択）
   - 有効開始日（必須）
   - 有効終了日（任意、NULL=無期限）
   - 備考（任意）
3.2. 単価の科目別内訳を登録できる（Requirement 9 参照）
3.3. When ユーザーが登録を実行したとき、the システム shall 入力値を検証し、問題なければ登録する
3.4. If 単価コードが同一会社内で重複する場合、then the システム shall エラーを表示し登録を拒否する
3.5. If 有効終了日が有効開始日以前の場合、then the システム shall エラーを表示し登録を拒否する
3.6. When 登録が成功したとき、the システム shall ダイアログを閉じ、一覧を更新し、成功メッセージを表示する
3.7. 将来の有効開始日を持つ単価も事前登録できる

### Requirement 4: 労務費予算単価の詳細表示
**Objective:** 経営企画担当者として、単価の詳細情報を確認したい。適用条件や履歴を正確に把握するため。

#### Acceptance Criteria
4.1. When ユーザーが一覧から単価を選択したとき、the システム shall ダイアログ形式で詳細情報を表示する
4.2. 詳細ダイアログには以下を表示する：全登録項目、科目別内訳一覧、作成日時、更新日時
4.3. 詳細ダイアログから編集・無効化操作に遷移できる

### Requirement 5: 労務費予算単価の編集
**Objective:** 経営企画担当者として、登録済み単価の情報を修正したい。入力ミスの訂正や条件変更に対応するため。

#### Acceptance Criteria
5.1. When ユーザーが編集を開始したとき、the システム shall ダイアログ形式で現在の値をフォームに表示する
5.2. 編集可能な項目：単価コード、リソース区分、取引先名、職種、等級、雇用区分、単価種別、科目別内訳、有効開始日、有効終了日、備考
5.3. If 変更後の単価コードが同一会社内で重複する場合（自身を除く）、then the システム shall エラーを表示し更新を拒否する
5.4. If 変更後の有効終了日が有効開始日以前の場合、then the システム shall エラーを表示し更新を拒否する
5.5. When 更新が成功したとき、the システム shall ダイアログを閉じ、一覧を更新し、成功メッセージを表示する

### Requirement 6: 労務費予算単価の無効化・再有効化
**Objective:** 経営企画担当者として、不要になった単価を無効化し、必要に応じて再有効化したい。誤削除を防ぎつつ単価の有効性を管理するため。

#### Acceptance Criteria
6.1. When ユーザーが無効化を実行したとき、the システム shall is_active を false に更新する
6.2. When ユーザーが再有効化を実行したとき、the システム shall is_active を true に更新する
6.3. 無効化された単価は一覧でグレーアウト表示される
6.4. 無効化・再有効化は物理削除ではなく論理削除で行う

### Requirement 7: 単価改定（有効期間管理）
**Objective:** 経営企画担当者として、単価改定を履歴として管理したい。年度ごとの単価変更を追跡し、過去単価での予算計算も可能にするため。

#### Acceptance Criteria
7.1. 同一職種・等級・雇用区分に対して、異なる単価コードで有効期間の異なる複数の単価を登録できる
7.2. 単価コードは会社内で一意（同一単価コードでの期間重複は発生しない）
7.3. When ユーザーが基準日を指定して検索したとき、the システム shall その時点で有効な単価を特定できる
7.4. 過去の有効期間を持つ単価も参照可能（削除されない）
7.5. 将来の有効期間を持つ単価も事前登録・参照可能

### Requirement 8: 金額表示フォーマット
**Objective:** 経営企画担当者として、金額を見やすい形式で確認したい。一目で金額を把握できるようにするため。

#### Acceptance Criteria
8.1. 人月単価は桁区切り（カンマ）付きで表示する
8.2. 月額単価は「¥650,000」形式で表示する
8.3. 時給単価は「¥2,500/時」形式で表示する
8.4. 日給単価は「¥25,000/日」形式で表示する
8.5. 入力時は数値のみ入力し、表示時に自動フォーマットする

### Requirement 9: 科目別内訳の管理
**Objective:** 経営企画担当者として、単価を科目別に分解して登録したい。給与・賞与・法定福利費など、科目ごとの予算算出に対応するため。

#### Acceptance Criteria
9.1. 単価登録・編集画面で、科目別内訳を追加・編集・削除できる
9.2. 科目別内訳には以下の項目を入力する：
   - 科目（必須、科目マスタからセレクト）
   - 金額（必須、正の数値）
   - 表示順（必須、数値）
9.3. 同一単価に同一科目は1回のみ登録可能
9.4. 科目別内訳の金額合計が人月単価（total_rate）として自動計算・表示される
9.5. 各内訳の割合（percentage）は金額÷合計として自動計算・表示される
9.6. 内訳が0件の場合はエラーとし、最低1件の内訳登録を必須とする
9.7. 社員の典型的な科目内訳例：給与手当、賞与引当金繰入、法定福利費、福利厚生費
9.8. 外注の典型的な科目内訳例：外注費（単一科目が一般的）

### Requirement 10: リソース区分による入力制御
**Objective:** 経営企画担当者として、社員と外注で適切な入力項目を使い分けたい。入力ミスを防ぎ、データの整合性を保つため。

#### Acceptance Criteria
10.1. When リソース区分が「社員」の場合、the システム shall 雇用区分フィールドを有効にし、取引先名フィールドを無効にする
10.2. When リソース区分が「外注」の場合、the システム shall 取引先名フィールドを有効にし、雇用区分フィールドを無効にする
10.3. リソース区分変更時、無効になったフィールドの値はクリアされる

---

## Out of Scope

以下は本機能のスコープ外とする：

1. **実績給与管理** - 実際の給与支払データは対象外（計画用単価のみ）
2. **手当・社保計算** - 福利厚生費の詳細計算は対象外
3. **人数計画・工数計画** - 別機能として管理（本機能は単価マスタのみ）
4. **予算算出計算** - 単価×人数/工数の計算は別機能（人員計画登録）
5. **社員マスタ連携** - 社員個人への単価紐付けは対象外
6. **複数通貨対応** - 初期リリースでは円建てのみ
7. **一括インポート/エクスポート** - 初期リリースでは手動入力のみ
8. **一括無効化** - 初期リリースでは個別操作のみ
9. **科目マスタのCRUD** - 科目マスタは別機能で管理（本機能は参照のみ）

---

## UI Specification

### 画面構成
- **一覧画面**: 検索パネル（上部） + テーブル（中央） + ページネーション（下部）
- **詳細表示**: ダイアログ形式（一覧画面上にオーバーレイ）
- **登録/編集**: ダイアログ形式（科目別内訳の入力エリア含む）

### 入力フィールド
- **単価コード**: 半角英数字・ハイフン・アンダースコアのみ（最大50文字、大文字小文字区別）
- **リソース区分**: セレクト（社員 / 外注）
- **取引先名**: 自由入力テキスト（外注の場合のみ、最大100文字）
- **職種**: 自由入力テキスト（将来マスタ化でセレクト化予定）
- **等級**: 自由入力テキスト（将来マスタ化でセレクト化予定）
- **雇用区分**: 自由入力テキスト（社員の場合のみ、将来マスタ化でセレクト化予定）
- **単価種別**: セレクト（月額 / 時給 / 日給）
- **有効開始日/終了日**: DatePicker

### 科目別内訳入力
- 科目: セレクト（科目マスタから選択）
- 金額: 正の数値入力
- 表示順: 数値入力
- 割合: 自動計算・表示のみ
- 合計（人月単価）: 自動計算・表示のみ

### 金額表示
- 月額: `¥650,000`
- 時給: `¥2,500/時`
- 日給: `¥25,000/日`
- 入力時は数値のみ、表示時に自動フォーマット

---

## Future Considerations（将来検討）

以下は将来のバージョンで検討する：

1. **職種マスタ化** - 職種を別マスタで管理し、セレクト入力に変更
2. **等級マスタ化** - 等級を別マスタで管理し、セレクト入力に変更
3. **雇用区分マスタ化** - 雇用区分を別マスタで管理し、セレクト入力に変更
4. **一括インポート** - CSVからの一括登録
5. **一括エクスポート** - CSV/Excelへの出力
6. **単価テンプレート** - よく使う科目内訳パターンのテンプレート機能

---

## Entity Consistency Checklist

### labor_cost_rates

| チェック項目 | 確認結果 |
|-------------|---------|
| rate_code: varchar(50), NOT NULL | 要件3.1に反映（自由入力） |
| resource_type: varchar(20), NOT NULL, CHECK('EMPLOYEE','CONTRACTOR') | 要件3.1, 10に反映（必須選択） |
| vendor_name: varchar(100), NULL | 要件3.1, 10に反映（外注の場合のみ） |
| job_category: varchar(50), NOT NULL | 要件3.1に反映（必須、将来マスタ化） |
| grade: varchar(50), NULL | 要件3.1に反映（任意、将来マスタ化） |
| employment_type: varchar(50), NULL | 要件3.1, 10に反映（社員の場合のみ） |
| rate_type: varchar(20), CHECK('MONTHLY','HOURLY','DAILY') | 要件3.1に反映（選択肢） |
| total_rate: numeric, NOT NULL | 要件9.4に反映（内訳合計、自動計算） |
| effective_date: date, NOT NULL | 要件3.1, 3.7, 7.5に反映（必須、将来日付可） |
| expiry_date: date, NULL | 要件3.1, 3.5に反映（任意、終了日チェック） |
| is_active: boolean, NOT NULL | 要件6に反映（論理削除） |
| UNIQUE(tenant_id, company_id, rate_code) | 要件3.4, 5.3, 7.2に反映（重複チェック） |
| CHECK(expiry_date > effective_date) | 要件3.5, 5.4に反映（日付整合性） |

### labor_cost_rate_items

| チェック項目 | 確認結果 |
|-------------|---------|
| rate_id: uuid, NOT NULL, FK labor_cost_rates | 要件9に反映（親テーブル参照） |
| subject_id: uuid, NOT NULL, FK subjects | 要件9.2に反映（科目マスタから選択） |
| amount: numeric, NOT NULL, CHECK > 0 | 要件9.2に反映（必須、正の数値） |
| percentage: numeric(5,2), NULL | 要件9.5に反映（自動計算） |
| display_order: int, NOT NULL | 要件9.2に反映（表示順） |
| UNIQUE(rate_id, subject_id) | 要件9.3に反映（同一科目重複禁止） |

---
