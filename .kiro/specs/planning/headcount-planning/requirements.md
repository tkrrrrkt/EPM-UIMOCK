# Requirements Document

## Introduction

人員計画登録機能は、部門ごとの人員計画（社員・外注）を登録し、労務費予算を自動算出する機能である。職種×等級での一括管理（レイヤー1）と、役員・兼務者の個人別配賦管理（レイヤー2）の2層構造で運用する。

本機能により、経営企画担当者は人件費予算を人員ベースで策定し、科目別に自動展開された予算データを fact_amounts に反映できる。

---

## Spec Reference（INPUT情報）

本要件を作成するにあたり、以下の情報を確認した：

### 仕様概要（確定済み仕様）
- **参照ファイル**: `.kiro/specs/仕様概要/人員計画登録.md`
- **確認日**: 2026-01-13
- **主要な仕様ポイント**:
  - 2層構造（レイヤー1: 職種×等級一括管理、レイヤー2: 個人別管理）
  - 単価マスタは社員・外注統一、科目別内訳対応
  - 月別入力（0.01人月単位）
  - 配賦率100%チェック必須（予算イベント設定でERROR/WARN選択可）
  - 予算反映は人件費予算FIX時に全削除→再作成

### 仕様検討（経緯・背景）※参考
- **参照ファイル**: N/A（仕様概要のQA確定事項に経緯を記載）
- **経緯メモ**: 予算配賦機能とは独立、100%チェックもそれぞれ独立して動作

---

## Entity Reference（必須）

本機能で使用するエンティティ定義を `.kiro/specs/entities/*.md` から確認し、以下を記載する：

### 対象エンティティ
- **labor_cost_rates**: `.kiro/specs/entities/01_各種マスタ.md` セクション 4.8（単価マスタ：社員・外注統一）
- **labor_cost_rate_items**: `.kiro/specs/entities/01_各種マスタ.md` セクション 4.9（単価内訳：科目別）
- **resource_plans**: `.kiro/specs/entities/01_各種マスタ.md` セクション 4.10（人員計画ヘッダー）
- **resource_plan_months**: `.kiro/specs/entities/01_各種マスタ.md` セクション 4.11（月別人数）
- **resource_allocations**: `.kiro/specs/entities/01_各種マスタ.md` セクション 4.12（人員配賦）
- **individual_allocations**: `.kiro/specs/entities/01_各種マスタ.md` セクション 4.13（個人別配賦）
- **plan_events**: `.kiro/specs/entities/01_各種マスタ.md` セクション 11.1（予算イベント）
- **fact_amounts**: `.kiro/specs/entities/01_各種マスタ.md` セクション 12.1（予算ファクト）

### エンティティ整合性確認
- [x] 対象エンティティのカラム・型・制約を確認した
- [x] エンティティ補足のビジネスルールを要件に反映した
- [x] スコープ外の関連エンティティを Out of Scope に明記した

---

## INPUT整合性チェック

| チェック項目 | 確認結果 |
|-------------|---------|
| 仕様概要との整合性 | 要件が仕様概要の内容と矛盾しない: ✅ |
| エンティティとの整合性 | 要件がエンティティ定義と矛盾しない: ✅ |
| 仕様検討の背景理解 | 必要に応じて経緯を確認した: ✅ |

---

## Requirements

### Requirement 1: 人員計画の一覧表示（レイヤー1：一括管理）
**Objective:** 経営企画担当者として、職種×等級単位で登録された人員計画を一覧で確認したい。人件費予算の全体像を素早く把握するため。

#### Acceptance Criteria
1.1. When ユーザーが人員計画画面を開いたとき、the システム shall 選択された予算イベント・バージョン・部門に紐づく人員計画一覧を表示する
1.2. The システム shall 一覧に以下の項目を表示する：区分（社員/外注）、職種、等級、人数（合計）、単価（月）、年間金額、配賦設定状態
1.3. When ユーザーが年度・予算イベント・バージョンを変更したとき、the システム shall 選択条件に応じた人員計画を再表示する
1.4. When ユーザーが部門を選択したとき、the システム shall 選択部門を所属部門（source_department）とする人員計画のみ表示する
1.5. The システム shall 一覧下部に合計（社員人数・金額、外注人数・金額、総計）を表示する

### Requirement 2: 人員計画の新規登録（レイヤー1：一括管理）
**Objective:** 経営企画担当者として、職種×等級単位で人員計画を新規登録したい。部門の人件費予算を人員ベースで策定するため。

#### Acceptance Criteria
2.1. When ユーザーが「人員追加」ボタンをクリックしたとき、the システム shall 人員計画登録ダイアログを表示する
2.2. The システム shall 以下の入力項目を提供する：区分（社員/外注）、職種、等級、単価種別（月額/時給/日給）、単価選択または直接入力
2.3. When ユーザーが区分を選択したとき、the システム shall 対応する resource_type（EMPLOYEE/CONTRACTOR）の単価マスタを絞り込み表示する
2.4. When ユーザーが単価マスタから単価を選択したとき、the システム shall rate_id を設定し、単価内訳（科目別金額）をプレビュー表示する
2.5. Where 単価マスタに該当する単価がない場合、the システム shall custom_rate として直接金額入力を許可する
2.6. When ユーザーが登録を実行したとき、the システム shall resource_plans に新規レコードを作成する
2.7. The システム shall 登録時に月別人数（resource_plan_months）を12ヶ月分初期化する（デフォルト0.00人）

### Requirement 3: 月別人数の入力
**Objective:** 経営企画担当者として、月ごとの人数を個別に設定したい。中途採用や期中の増減に対応するため。

#### Acceptance Criteria
3.1. When ユーザーが人員計画を選択したとき、the システム shall 月別人数入力パネルを表示する
3.2. The システム shall 各月（4月〜3月 または 1月〜12月）の人数入力フィールドを提供する
3.3. The システム shall 人数を0.01人月単位で入力可能とする（numeric(10,2)）
3.4. When ユーザーが月別人数を変更したとき、the システム shall 年間合計人月と年間金額をリアルタイムで再計算する
3.5. The システム shall 一括入力機能（全月同一人数）を提供する
3.6. If 入力値が負の数または不正な形式の場合、then the システム shall エラーを表示し入力を拒否する
3.7. When ユーザーが月別セルをダブルクリックしたとき、the システム shall セル内にテキストボックスを表示し、直接入力を可能とする
3.8. When ユーザーが月別セルをシングルクリックしたとき、the システム shall 当該月の配賦設定ダイアログを表示する

### Requirement 4: 配賦設定（部門間振替）
**Objective:** 経営企画担当者として、人員計画の配賦先部門と配賦率を設定したい。間接部門の人件費を関連部門に配賦するため。

#### Acceptance Criteria
4.1. When ユーザーが「配賦設定」ボタンをクリックしたとき、the システム shall 配賦設定ダイアログを表示する
4.2. The システム shall 入力方式選択を提供する：割合入力（PERCENTAGE）/ 人月数入力（HEADCOUNT）
4.3. When ユーザーが割合入力を選択したとき、the システム shall 配賦率（%）入力フィールドを表示する
4.4. When ユーザーが人月数入力を選択したとき、the システム shall 人月数入力フィールドを表示する
4.5. When ユーザーが「配賦先追加」をクリックしたとき、the システム shall 部門選択と配賦値入力行を追加する
4.6. If 同一部門が配賦先として重複している場合、then the システム shall エラーを表示し登録を拒否する
4.7. The システム shall 配賦合計（割合または人月数）をリアルタイムで表示する
4.8. When 配賦率合計が100%でない場合 and 予算イベント設定が ERROR のとき、the システム shall 保存を拒否しエラーメッセージを表示する
4.9. When 配賦率合計が100%でない場合 and 予算イベント設定が WARN のとき、the システム shall 警告を表示するが保存を許可する
4.10. When ユーザーが配賦設定を保存したとき、the システム shall resource_allocations に配賦レコードを作成/更新する

### Requirement 5: 個人別配賦の一覧表示（レイヤー2）
**Objective:** 経営企画担当者として、役員・兼務者の個人別配賦を一覧で確認したい。特殊な配賦が必要な人員を管理するため。

#### Acceptance Criteria
5.1. When ユーザーが「個人別管理」タブを選択したとき、the システム shall 個人別配賦の一覧を表示する
5.2. The システム shall 一覧に以下の項目を表示する：氏名、職種、等級、単価（月）、配賦先部門、配賦率、年間金額
5.3. The システム shall 同一個人の複数配賦先をグループ化して表示する
5.4. The システム shall 個人ごとの配賦率合計を表示する

### Requirement 6: 個人別配賦の登録・編集（レイヤー2）
**Objective:** 経営企画担当者として、役員・兼務者の個人別配賦を登録・編集したい。複数部門に所属する人員の人件費を適切に配分するため。

#### Acceptance Criteria
6.1. When ユーザーが「個人追加」ボタンをクリックしたとき、the システム shall 個人別配賦登録ダイアログを表示する
6.2. The システム shall 以下の入力項目を提供する：社員選択または氏名入力、主幹部門、職種、等級、単価選択または直接入力
6.3. Where 社員マスタから選択した場合、the システム shall employee_stable_id を設定する
6.4. Where 社員マスタから選択しない場合、the システム shall individual_name を必須入力とする
6.5. The システム shall 配賦先部門と配賦率（または人月数）の複数行入力を可能とする
6.6. When ユーザーが登録を実行したとき、the システム shall individual_allocations に配賦先ごとにレコードを作成する
6.7. If 個人の配賦率合計が100%でない場合、then the システム shall エラーを表示し登録を拒否する（個人別配賦は常に100%必須）

### Requirement 7: 労務費の自動算出
**Objective:** 経営企画担当者として、人員計画から労務費予算を自動算出したい。手計算の手間を省き、正確な予算を策定するため。

#### Acceptance Criteria
7.1. The システム shall 各人員計画について以下の計算を実行する：月別金額 = 単価内訳（科目別） × 月別人数 × 配賦率
7.2. The システム shall 単価マスタに紐づく科目別内訳（labor_cost_rate_items）を参照し、科目ごとに金額を算出する
7.3. Where custom_rate が設定されている場合、the システム shall 単一科目（デフォルト人件費科目）として計算する
7.4. The システム shall 配賦先部門ごと・科目ごと・月ごとの金額を算出する
7.5. The システム shall 一覧画面に年間金額（12ヶ月合計）を表示する

### Requirement 8: 予算反映（fact_amounts への書き込み）
**Objective:** 経営企画担当者として、人員計画を予算データとして確定・反映したい。予算入力画面で人件費予算として参照できるようにするため。

#### Acceptance Criteria
8.1. When ユーザーが「予算反映」ボタンをクリックしたとき、the システム shall 反映確認ダイアログを表示する
8.2. If 対象イベント・バージョンに既存の HEADCOUNT_CALC データがある場合、then the システム shall 「既存データがあります。上書きしますか？」と警告を表示する
8.3. When ユーザーが反映を確定したとき、the システム shall 以下の処理を実行する：
    - 対象イベント・バージョンの source_type='HEADCOUNT_CALC' レコードを全削除
    - 人員計画から科目別・部門別・月別に金額を再計算
    - fact_amounts に新規レコードを挿入
8.4. The システム shall fact_amounts に以下の値を設定する：
    - scenario_type: BUDGET
    - source_type: HEADCOUNT_CALC
    - data_origin: SYSTEM
    - department_stable_id: 配賦先部門
    - subject_id: 単価内訳から取得した科目
8.5. When 反映が完了したとき、the システム shall 成功メッセージを表示する
8.6. If 反映処理中にエラーが発生した場合、then the システム shall ロールバックしエラーメッセージを表示する

### Requirement 9: 部門集計ビュー
**Objective:** 経営企画担当者として、部門視点で人員・労務費の集計を確認したい。各部門にどれだけの人件費が配賦されているかを把握するため。

#### Acceptance Criteria
9.1. When ユーザーが「集計ビュー」を選択したとき、the システム shall 選択部門を配賦先とする人員・労務費の集計を表示する
9.2. The システム shall 集計に以下の情報を表示する：区分（自部門社員/振替受入/外注）、ソース部門、職種、等級、人月、年間金額
9.3. The システム shall 振替受入の場合、ソース部門と個人名（レイヤー2の場合）を表示する
9.4. The システム shall 部門合計（人月・年間金額）を表示する

### Requirement 10: 人員計画の編集・削除
**Objective:** 経営企画担当者として、登録済みの人員計画を編集・削除したい。入力ミスの訂正や計画変更に対応するため。

#### Acceptance Criteria
10.1. When ユーザーが一覧から人員計画を選択して「編集」をクリックしたとき、the システム shall 編集ダイアログを表示する
10.2. The システム shall 編集ダイアログに現在の値をプリセットする
10.3. When ユーザーが編集を保存したとき、the システム shall resource_plans および関連テーブルを更新する
10.4. When ユーザーが「削除」をクリックしたとき、the システム shall 削除確認ダイアログを表示する
10.5. When ユーザーが削除を確定したとき、the システム shall resource_plans および関連する resource_plan_months, resource_allocations を削除する
10.6. If 削除対象のデータが既に fact_amounts に反映されている場合、then the システム shall 警告を表示する（fact_amounts のデータは自動削除しない）

---

## Out of Scope

以下は本機能のスコープ外とする：

1. **実績工数管理** - 計画用単価・人数のみ対象（実績は別機能）
2. **給与計算・社保計算** - 計画用の概算のみ
3. **プロジェクト別人員配置** - 初期は部門単位のみ（将来検討）
4. **社員マスタとの厳密連携** - 初期は名前入力で運用可
5. **一括インポート/エクスポート** - 初期リリースでは手動入力のみ
6. **予算配賦機能との自動連携** - 人員計画と経費配賦は独立した機能

---

## UI Specification

### 画面構成
- **一覧画面**: 検索条件（年度・イベント・バージョン・部門） + タブ切り替え（一括管理/個人別管理） + テーブル + 合計表示
- **登録/編集ダイアログ**: モーダルダイアログ形式
- **配賦設定ダイアログ**: モーダルダイアログ形式、配賦先の動的追加対応
- **集計ビュー**: 部門視点での集計表示

### 金額表示フォーマット
- 金額は桁区切り（カンマ）付きで表示
- 月額単価: `¥800,000`
- 時給単価: `¥2,500/時`
- 日給単価: `¥25,000/日`

---

## Entity Consistency Checklist

| チェック項目 | 確認結果 |
|-------------|---------|
| resource_plans.resource_type: EMPLOYEE/CONTRACTOR | 要件2.2に反映（区分選択） |
| resource_plan_months.headcount: numeric(10,2) | 要件3.3に反映（0.01単位） |
| resource_allocations.allocation_type: PERCENTAGE/HEADCOUNT | 要件4.2に反映（入力方式選択） |
| resource_allocations UNIQUE(resource_plan_id, target_department) | 要件4.6に反映（重複禁止） |
| plan_events.allocation_check_mode: ERROR/WARN | 要件4.8, 4.9に反映（チェック挙動） |
| individual_allocations 100%必須 | 要件6.7に反映（個人別は常に100%） |
| fact_amounts.source_type: HEADCOUNT_CALC | 要件8.4に反映（新規source_type） |
