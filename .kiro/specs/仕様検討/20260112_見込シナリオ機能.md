# 見込入力のワースト/ノーマル/ベスト機能 仕様検討

## 検討日: 2026-01-12

## 概要

見込入力において、複数シナリオ（ワースト/ノーマル/ベスト）を管理し、リスク分析や経営判断を支援する機能。

---

## 1. 現状確認

### 1.1 既存の見込管理

現在の plan_events / plan_versions 設計:

```
plan_events（計画イベント）
├── scenario_type: BUDGET / FORECAST / ACTUAL
├── event_code: "FY2026_FORECAST" など
└── バージョン管理: plan_versions で管理

plan_versions（計画バージョン）
├── version_code: "5月第1回" など
├── status: DRAFT / FIXED
└── 月次＋回数でローリング管理
```

### 1.2 現状の見込入力フロー

```
1. 見込イベント選択（年度単位）
2. バージョン選択（月次＋回数）
3. 単一の見込値を入力
```

---

## 2. シナリオ管理の設計案

### 案A: シナリオをバージョンで管理

```
見込イベント: FY2026見込
├── バージョン: 5月_ワースト
├── バージョン: 5月_ノーマル
├── バージョン: 5月_ベスト
├── バージョン: 6月_ワースト
├── バージョン: 6月_ノーマル
└── ...
```

**メリット**:
- 既存の plan_versions 構造をそのまま活用
- 追加テーブル不要

**デメリット**:
- バージョン数が3倍に増える
- シナリオ間の紐付けが弱い

### 案B: シナリオタイプをplan_versionsに追加

```sql
-- plan_versions に scenario_case を追加
ALTER TABLE plan_versions ADD COLUMN scenario_case varchar(20);
-- WORST / NORMAL / BEST / NULL（シナリオ管理しない場合）
```

```
見込イベント: FY2026見込
├── バージョン: 5月第1回
│   ├── scenario_case: WORST
│   ├── scenario_case: NORMAL
│   └── scenario_case: BEST
└── バージョン: 6月第1回
    ├── scenario_case: WORST
    ├── scenario_case: NORMAL
    └── scenario_case: BEST
```

**メリット**:
- シナリオ間の関係が明確
- 既存データとの互換性を保ちやすい

**デメリット**:
- plan_versions の複合キーが変わる可能性

### 案C: scenario_cases テーブルを新設

```sql
-- scenario_cases: シナリオケースマスタ
CREATE TABLE scenario_cases (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  case_code varchar(20) NOT NULL,  -- 'WORST' / 'NORMAL' / 'BEST'
  case_name varchar(100) NOT NULL,
  sort_order int NOT NULL,
  is_default boolean DEFAULT false,  -- デフォルト表示用
  is_active boolean DEFAULT true
);

-- fact_amounts に scenario_case_id を追加
ALTER TABLE fact_amounts ADD COLUMN scenario_case_id uuid;
```

**メリット**:
- シナリオケースをマスタ管理（カスタマイズ可能）
- 「楽観/中間/悲観」など名称変更が容易

**デメリット**:
- 新規テーブル追加が必要
- fact_amounts の主キー/一意制約の変更が必要

---

## 3. 検討ポイント

### Q1. シナリオの種類は固定か？

**選択肢**:
1. 固定3種類: ワースト/ノーマル/ベスト
2. カスタマイズ可能: 会社ごとに定義
3. 可変: 任意の数のシナリオを定義可能

**推奨**: 固定3種類（シンプルさ優先）で開始し、将来拡張可能に

### Q2. どの入力でシナリオを使うか？

| 入力種別 | シナリオ管理 |
|---------|-------------|
| 予算入力 | なし（単一値） |
| 見込入力 | あり（3シナリオ） |
| 実績入力 | なし（単一値） |

### Q3. シナリオの入力UIは？

**選択肢**:

**A. 横並び表示（期間×シナリオ）**
```
        │ 4月    │ 5月    │ 6月    │ ...
────────┼────────┼────────┼────────┼
売上高  │        │        │        │
 ワースト│  900   │  950   │ 1,000  │
 ノーマル│ 1,000  │ 1,050  │ 1,100  │
 ベスト │ 1,100  │ 1,150  │ 1,200  │
```

**B. タブ切り替え**
```
[ワースト] [ノーマル] [ベスト]
─────────────────────────────
        │ 4月    │ 5月    │ 6月    │ ...
────────┼────────┼────────┼────────┼
売上高  │ 1,000  │ 1,050  │ 1,100  │
```

**C. セル内にシナリオ値**
```
        │ 4月           │ 5月           │ ...
────────┼───────────────┼───────────────┼
売上高  │ W: 900        │ W: 950        │
        │ N: 1,000      │ N: 1,050      │
        │ B: 1,100      │ B: 1,150      │
```

### Q4. シナリオ間の計算支援は必要か？

**想定機能**:
1. **差異自動計算**: ベスト - ワースト = 幅
2. **加重平均**: (ワースト×20% + ノーマル×60% + ベスト×20%) = 期待値
3. **確率分布表示**: グラフで可視化

### Q5. どのシナリオを「公式見込」とするか？

**選択肢**:
1. ノーマルが公式（デフォルト）
2. 明示的に「公式見込」を指定
3. レポート時に選択

---

## 4. UI設計案

### 4.1 シナリオ切り替え付き見込入力画面

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│ [年度: 2026 ▼] [部門: 営業1課 ▼] [見込イベント: 2026年度見込 ▼] [バージョン: 5月第1回 ▼]            │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ シナリオ: [ワースト] [●ノーマル] [ベスト]   [シナリオ比較表示: OFF/ON]                           │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 見込 (2026年度) - 5月見込第1回 - ノーマルシナリオ                                                 │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 科目           │4月  │5月  │6月  │1Q   │7月  │8月  │9月  │2Q  │...│通期│
│                │実績 │締中 │見込 │     │見込 │見込 │見込 │    │   │    │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 売上高         │1,000│1,150│1,200│3,350│1,100│1,100│1,100│3,300│...│    │
│ 売上原価       │  600│  680│  700│1,980│  650│  650│  650│1,950│...│    │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 シナリオ比較表示ON時

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│ シナリオ比較表示: ON                                                                             │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 科目           │     5月      │     6月      │     7月      │ ...                               │
│                │ W   │ N   │ B   │ W   │ N   │ B   │ W   │ N   │ B   │                         │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 売上高         │1,050│1,150│1,250│1,100│1,200│1,300│1,000│1,100│1,200│                         │
│ 売上原価       │  630│  680│  730│  660│  700│  740│  600│  650│  700│                         │
│ 【売上総利益】 │  420│  470│  520│  440│  500│  560│  400│  450│  500│                         │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘

凡例: W=ワースト, N=ノーマル, B=ベスト
```

### 4.3 シナリオサマリーパネル

```
┌────────────────────────────────────────────────────────────────┐
│ シナリオサマリー（通期見通し）                                  │
├────────────────────────────────────────────────────────────────┤
│                 │ 売上高    │ 営業利益  │ 達成率    │          │
│ ワースト        │ 12,000    │   800     │  96.0%    │          │
│ ノーマル        │ 12,500    │ 1,000     │ 100.0%    │ ← 公式  │
│ ベスト          │ 13,000    │ 1,200     │ 104.0%    │          │
│ 予算            │ 12,500    │ 1,000     │ -         │          │
├────────────────────────────────────────────────────────────────┤
│ 期待値（加重平均）│ 12,500    │ 1,000     │ 100.0%    │          │
│ シナリオ幅      │ 1,000     │   400     │   8.0pt   │          │
└────────────────────────────────────────────────────────────────┘
```

---

## 5. エンティティ設計案（案B採用の場合）

### 5.1 plan_versions への追加

```sql
-- scenario_case カラムを追加
ALTER TABLE plan_versions ADD COLUMN scenario_case varchar(20);
-- NULL: シナリオ管理なし, 'WORST', 'NORMAL', 'BEST'

-- 一意制約を更新
-- UNIQUE(tenant_id, company_id, event_id, version_code)
-- → UNIQUE(tenant_id, company_id, event_id, version_code, scenario_case)
```

### 5.2 scenario_case_masters（オプション）

カスタマイズ可能にする場合:

```sql
CREATE TABLE scenario_case_masters (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid,  -- NULL=テナント共通
  case_code varchar(20) NOT NULL,  -- 'WORST', 'NORMAL', 'BEST'
  case_name varchar(100) NOT NULL,  -- 'ワーストケース', 'ノーマルケース', 'ベストケース'
  case_name_short varchar(20),  -- 'W', 'N', 'B'
  sort_order int NOT NULL,
  is_default boolean DEFAULT false,
  weight_ratio numeric(5,2),  -- 加重平均用: 0.20, 0.60, 0.20
  is_active boolean DEFAULT true
);
```

---

## 6. BFF Contracts案

```typescript
// シナリオケース
type ScenarioCase = 'WORST' | 'NORMAL' | 'BEST' | null;

// 見込グリッド取得（シナリオ対応）
interface BffForecastGridRequest {
  fiscalYear: number;
  departmentId: string;
  forecastEventId: string;
  forecastVersionId: string;
  scenarioCase?: ScenarioCase;  // 追加: シナリオ指定
  projectId?: string;
}

// シナリオ比較取得
interface BffForecastScenarioCompareRequest {
  fiscalYear: number;
  departmentId: string;
  forecastEventId: string;
  forecastVersionId: string;
  scenarios: ScenarioCase[];  // ['WORST', 'NORMAL', 'BEST']
}

interface BffForecastScenarioCompareResponse {
  periods: BffPeriodColumn[];
  rows: BffForecastScenarioRow[];
  summary: BffScenarioSummary;
}

interface BffForecastScenarioRow {
  subjectId: string;
  subjectCode: string;
  subjectName: string;
  scenarioValues: {
    [scenario: string]: {  // 'WORST', 'NORMAL', 'BEST'
      values: BffCellValue[];
    };
  };
}

interface BffScenarioSummary {
  scenarios: {
    case: ScenarioCase;
    caseName: string;
    fullYearForecast: string;
    achievementRate: number;
    isOfficial: boolean;  // 公式見込フラグ
  }[];
  expectedValue: string;  // 期待値（加重平均）
  range: string;  // シナリオ幅
}
```

---

## 7. 決定事項

（QA壁打ち後に記録）

| 項目 | 決定内容 | 決定日 |
|------|---------|-------|
| - | - | - |

---

## 8. 次のアクション

1. [ ] シナリオ管理方式の決定（案A/B/C）
2. [ ] シナリオ入力UIの決定（タブ/横並び/セル内）
3. [ ] 「公式見込」の扱いを決定
4. [ ] エンティティ設計の確定
5. [ ] 加重平均の計算要否を決定

---

## 9. 関連仕様

- `.kiro/specs/仕様概要/見込入力機能.md` - 見込入力の基本仕様
- `.kiro/specs/entities/01_各種マスタ.md` - plan_events / plan_versions エンティティ
