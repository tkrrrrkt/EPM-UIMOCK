# AIシミュレーション機能 仕様検討

## 検討日
2026-01-28

## 参加者
- ユーザー
- Claude Code（プロ経営ITコンサルタント視点）

## 検討背景

EPMシステムにおいて、経営判断のスピードと質を向上させるため、生成AI機能の導入を検討。DeepResearch調査（20260128）により、競合他社（Loglass、DIGGLE、Anaplan、Oracle等）がエージェントAI機能を相次いで発表しており、市場トレンドとして「予測・異常値・差異分析」「自然言語Q&A」「経営参謀Bot」が必須機能となっている。

**市場状況**:
- 58%の財務部門がAI活用中（2024年、前年比+21pt）
- ROI実績: 予測精度+25%、計画サイクル40-60%短縮、レポート作成時間30-80%削減
- 2026年は「エージェントAI元年」（Gartner予測）

**開発スコープ（6ヶ月で実装）**:
1. 自然言語Q&A（基本）- P0（最優先）
2. 差異分析オートコメント - P0（最優先）
3. グラフ自動生成 - P1（早期）
4. 異常値検知アラート - P1（早期）
5. 経営参謀Bot（高度）- P1（早期）

---

## 1. 機能概要と議論

### 1.1 自然言語Q&A（Natural Language Query）

#### 概要
ユーザーが日本語で質問すると、AIが経営データを検索・集計して回答する機能。

#### 典型的なユースケース
```
Q1: CFO「今期着地は？」
→ A: 「2024年度の見込着地は売上120億円（予算比▲5億円、-4.2%）、
      営業利益8億円（予算比▲1.2億円、-13.0%）です。
      主要要因は第2四半期の受注遅延です。【詳細レポート】」

Q2: 事業部長「9月の営業1部の売上高は？」
→ A: 「2024年9月の営業1部売上高は2.8億円です。
      予算2.5億円に対し+12.0%、前年同月比+8.5%です。【グラフ表示】」

Q3: 経営企画「XX科目の推移を見せて」
→ A: [期間選択UI表示]「期間を指定してください。
      (1) 今期（4-9月） (2) 過去12ヶ月 (3) 前年同期比較」

Q4: CFO「売上高の前年比は？」
→ A: 「2024年4-9月の売上高は58億円、前年同期比+8.2%（+4.4億円）です。
      主要貢献は製造事業（+2.8億円）です。【内訳表示】」

Q5: 経営企画「何月のXX部門の売上高？」
→ A: [月・部門の補完候補表示]「月と部門を確認させてください。
      月: [9月▼] 部門: [営業1部▼] で検索しますか？」
```

#### 技術構成

**セマンティックレイヤー（最重要）**:
- 科目マスタ（subjects）のメタデータ構造化
  - 科目コード、科目名、別名（エイリアス）、説明
  - 例: 「売上高」「Revenue」「トップライン」→ 同一科目として認識
- 部門マスタ（departments）の階層構造
  - stable_id による版跨ぎ追跡
  - 階層パス（「営業本部 > 営業1部 > 東日本チーム」）
- 期間マスタ（accounting_periods）
  - 「今期」「前年同期」「Q2」等の相対表現の解決
- KPI定義（metrics）
  - 計算式、集計方法、単位の構造化

**RAG（Retrieval Augmented Generation）**:
- ベクターDB: Pinecone / Qdrant / PostgreSQL pgvector
- インデックス対象:
  1. 科目定義・KPI算定方法のドキュメント
  2. 過去のコメント・経営会議議事録（fact_amounts.memo等）
  3. 予算策定時の前提条件・仮説
  4. 過去の差異要因説明（ナレッジベース化）

**LLM選定**:
- 第1候補: **Claude 3.5 Sonnet**（日本語精度最高、推論能力強）
- 第2候補: Azure OpenAI GPT-4（エンタープライズ契約、データ隔離保証）
- 用途別使い分け:
  - 複雑な質問・要約: Claude 3.5 Sonnet
  - 定型応答・短文: GPT-3.5 Turbo（コスト削減）

**計算ロジック**:
- **重要**: LLMには計算させない
- 自社計算エンジンで集計 → LLMは言語整形のみ
- 理由: 正確性担保、ハルシネーション防止

**権限制御（RLS）**:
- ユーザーの tenant_id、権限ロールに基づきデータフィルタ
- 事業部長は自部門のみアクセス可能
- CFOは全社データアクセス可能

#### 実装段階（MVP → 拡張）

**Phase 1（MVP - 0-3ヶ月）**:
- 対応質問パターン: 10種類に限定
  1. 「今期着地は？」
  2. 「XX月のXX部門の売上高は？」
  3. 「XX科目の前年比は？」
  4. 「XX科目の推移を見せて」
  5. 「予算との差異は？」
  6. 「XX事業部の営業利益は？」
  7. 「今月の実績は？」
  8. 「KPI: XXの値は？」
  9. 「XX科目の構成比は？」
  10. 「前年同月比は？」
- UI: 画面右下に常駐チャットウィンドウ（Copilot風）
- 回答フォーマット: テキスト + 数値 + リンク

**Phase 2（拡張 - 4-6ヶ月）**:
- 対応質問パターン拡張: 50種類以上
- 複数ターンの対話（文脈保持）
- グラフ・表の自動生成（後述）
- 音声入力対応（検討）

#### 懸念事項と対策

**Q1: 曖昧な質問への対応**
- 問題: 「売上は？」→ 期間・部門が不明
- 対策: 補完候補を提示して確認
  - 「期間を指定してください: (1) 今期 (2) 今月 (3) 前年同期」
  - 「部門を指定してください: [全社▼] [営業1部▼] [...]」

**Q2: 誤回答リスク**
- 問題: AIが間違った数値・解釈を返す
- 対策:
  1. 信頼度スコア表示（Low/Medium/High）
  2. 出典リンク必須表示（「fact_amounts: 2024-09の集計」等）
  3. 「AIの計算による回答」と明記
  4. ユーザーが検算ボタンで自社エンジン再計算
  5. 利用規約で「AI出力は参考情報」と明記

**Q3: セキュリティ・権限**
- 問題: 権限外データへのアクセス
- 対策:
  1. セマンティックレイヤーでRLS強制適用
  2. AIクエリ実行前に権限チェック
  3. 監査ログ記録（質問内容、回答、参照データ、ユーザーID、時刻）

---

### 1.2 差異分析オートコメント（Variance Intelligence）

#### 概要
月次締め後、予算vs実績の差異を自動分析し、要因仮説付きのレポートを生成する機能。

#### 典型的なユースケース

**トリガー**:
- **自動実行**: 月次締め完了時（accounting_periods.close_status = 'SOFT_CLOSED'）
- **手動実行**: CFO/経営企画が「差異レポート作成」ボタンをクリック

**処理フロー**:
1. **差異抽出**: fact_amounts から予算vs実績の差異を計算
   - 絶対額TOP10（例: 広告宣伝費 +3,500万円）
   - 比率TOP10（例: 研修費 +150%）
   - 部門別、科目別、プロジェクト別
2. **トレンド分析**: 過去3-6ヶ月の推移を確認
   - 単発 or 継続的な差異か
3. **仮説生成**: RAGで過去コメント・施策DBから類似ケース検索
   - 過去の「広告宣伝費増加」時のコメントを参照
   - 例: 「2023年Q4に新製品キャンペーンで類似の増加。その際は売上+8%の効果」
4. **影響分析**: KPI、営業利益率等への影響を計算
5. **レポート生成**: Markdown → PDF / PowerPoint

**出力例**:
```markdown
# 2024年9月 予実差異分析レポート

生成日時: 2024-10-05 09:00
対象期間: 2024年9月（単月）
生成者: AIエンジン v1.0

## エグゼクティブサマリ

全社売上高は予算比▲5.2%（▲6,200万円）で着地。主要要因は大口案件の受注遅延（製造事業▲8,500万円）。一方、変動費削減により営業利益は予算比▲8.0%に留まる。

**アラート**: 営業利益率が目標12.0%に対し11.2%（▲0.8pt）で推移。Q4での挽回が必要。

---

## 1位: 売上高 ▲¥62,000,000 (▲5.2%)

### 差異の事実
- 予算: ¥1,200,000,000
- 実績: ¥1,138,000,000
- 差異: ▲¥62,000,000 (▲5.2%)

### 部門別内訳
| 部門 | 予算 | 実績 | 差異 | 差異率 |
|------|------|------|------|--------|
| 製造事業部 | ¥600,000,000 | ¥515,000,000 | ▲¥85,000,000 | ▲14.2% |
| サービス事業部 | ¥400,000,000 | ¥415,000,000 | +¥15,000,000 | +3.8% |
| その他 | ¥200,000,000 | ¥208,000,000 | +¥8,000,000 | +4.0% |

### トレンド分析
- 過去3ヶ月: 7月+2.1%、8月▲1.5%、9月▲5.2%
- **懸念**: 8月から下振れトレンドに転換

### 要因仮説（AI生成）
1. **主要因**: A社向け大口案件（¥85,000,000）の受注が10月にずれ込み
   - 予算策定時: 9月受注想定
   - 実態: 先方の稟議承認遅延により10月第1週に受注確定
   - 根拠: 営業日報（2024-09-28）、受注データ（2024-10-02）
2. **副次的要因**: 製造ライン改修による出荷遅延（¥15,000,000）
   - 9月第2週のライン停止が影響
   - 10月に挽回出荷予定

### 過去類似事例
2023年6月に同様の大口案件遅延が発生。その際は翌月に+18%の挽回達成。

### 推奨アクション
1. A社案件のデリバリースケジュールを確認し、10月売上を精査
2. 製造ラインの10月出荷計画を前倒しできるか検討
3. サービス事業部の好調要因を分析し、横展開可能性を評価

### 影響分析
- **KPI影響**: 売上高達成率 94.8% → 経営目標（95%以上）未達
- **利益影響**: 粗利額▲2,480万円（粗利率40%前提）
- **年間着地への影響**: 10月に全額回収できれば年間目標は達成可能

---

## 2位: 広告宣伝費 +¥35,000,000 (+15.2%)

### 差異の事実
- 予算: ¥230,000,000
- 実績: ¥265,000,000
- 差異: +¥35,000,000 (+15.2%)

### 要因仮説（AI生成）
1. **主要因**: 新製品「ProductX」キャンペーンの前倒し実施
   - 予算策定時: 10月開始想定
   - 実態: 9月第1週から開始（経営判断により前倒し）
   - 根拠: 稟議書（2024-08-25承認）、請求書データ
2. **内訳**: Web広告¥20,000,000、TV-CM¥10,000,000、展示会¥5,000,000

### 過去類似事例
2023年Q4に新製品キャンペーンで類似の予算超過（+12%）。その際は売上+8%の効果を確認。ROI 1.7倍を達成。

### 推奨アクション
1. 今回のキャンペーン効果を10月末時点で定量評価（売上寄与額、ROI算出）
2. 効果が高ければ、Q4予算の再配分を検討
3. 効果が低ければ、残期間の広告予算を抑制

### 影響分析
- **KPI影響**: 広告費率 8.8% → 経営目標（8.0%以下）超過
- **利益影響**: 営業利益▲3,500万円
- **ROI検証**: 売上寄与が+6,000万円以上であればROI正（要検証）

---

## 3位～10位（サマリ）

| 順位 | 科目 | 差異額 | 差異率 | 主要因 |
|------|------|--------|--------|--------|
| 3 | 外注費 | ▲¥18,000,000 | ▲12.0% | 外注先との価格交渉成功 |
| 4 | 研修費 | +¥12,000,000 | +150% | 全社研修の追加実施 |
| 5 | 旅費交通費 | +¥8,500,000 | +22.5% | 海外出張の増加（営業活動） |
| ... | ... | ... | ... | ... |

【詳細レポート】を参照

---

## 総合評価

### リスク評価
- 🔴 **高リスク**: 売上高の下振れトレンド（要注意）
- 🟡 **中リスク**: 広告費率の超過（ROI検証必要）
- 🟢 **低リスク**: 外注費削減は好材料

### 次回アクション
1. 10月第1週: A社案件の受注確定を確認
2. 10月末: 広告キャンペーンROIを算出
3. 11月初: Q4見込を再精査

---

**免責事項**: 本レポートはAIによる分析結果であり、参考情報として提供されます。最終的な経営判断は人間が行ってください。

出典: fact_amounts (2024-09), 過去コメント履歴, 稟議書DB
```

#### 実装段階（MVP → 拡張）

**Phase 1（MVP - 0-3ヶ月）**:
- 対象: 全社合計の科目別差異TOP10
- 分析深度: 事実 + 簡易トレンド + 基本仮説
- 出力フォーマット: Markdown / PDF
- トリガー: 手動実行のみ

**Phase 2（拡張 - 4-6ヶ月）**:
- 対象拡張: 部門別、プロジェクト別、ディメンション別
- 分析深度: 過去事例検索、ROI計算、推奨アクション
- 出力フォーマット追加: PowerPoint、Excel
- トリガー追加: 月次締め後の自動実行、Slack/メール通知

#### 技術詳細

**差異計算ロジック**:
```sql
-- 単月の差異（絶対額TOP10）
SELECT
  s.subject_name,
  SUM(CASE WHEN fa.scenario_type = 'BUDGET' THEN fa.amount ELSE 0 END) as budget,
  SUM(CASE WHEN fa.scenario_type = 'ACTUAL' THEN fa.amount ELSE 0 END) as actual,
  SUM(CASE WHEN fa.scenario_type = 'ACTUAL' THEN fa.amount ELSE 0 END)
    - SUM(CASE WHEN fa.scenario_type = 'BUDGET' THEN fa.amount ELSE 0 END) as variance,
  (SUM(CASE WHEN fa.scenario_type = 'ACTUAL' THEN fa.amount ELSE 0 END)
    / NULLIF(SUM(CASE WHEN fa.scenario_type = 'BUDGET' THEN fa.amount ELSE 0 END), 0) - 1) * 100 as variance_pct
FROM fact_amounts fa
JOIN subjects s ON fa.subject_id = s.id
WHERE fa.accounting_period_id = :target_period_id
  AND fa.tenant_id = :tenant_id
GROUP BY s.subject_name
ORDER BY ABS(variance) DESC
LIMIT 10;
```

**仮説生成プロンプト**（Claude API）:
```
あなたは経営企画のプロフェッショナルです。以下の予実差異について、要因仮説を生成してください。

【差異の事実】
科目: {{subject_name}}
予算: {{budget}}
実績: {{actual}}
差異: {{variance}} ({{variance_pct}}%)

【トレンド】
- 過去3ヶ月: {{trend_3m}}
- 前年同月: {{yoy}}

【過去コメント】
{{past_comments}}

【過去類似事例】
{{similar_cases}}

【出力形式】
1. 主要因（1-2文）
2. 副次的要因（あれば）
3. 根拠データ
4. 過去類似事例の参照
5. 推奨アクション（3つ以内）
6. KPI・利益への影響

必ず具体的な数値と根拠を示してください。
```

#### 懸念事項と対策

**Q1: AIの仮説が間違っている場合**
- 対策:
  1. 「AI生成の仮説です。人間による検証が必要です」と明記
  2. 編集機能: ユーザーがコメントを修正・追記可能
  3. フィードバック収集: 「この仮説は正確でしたか？」評価ボタン
  4. 学習ループ: フィードバックをRAGに反映

**Q2: 過去事例がない新規事象**
- 対策:
  1. 「過去に類似事例が見つかりませんでした」と明示
  2. 一般的な分析フレームワークを適用（例: コスト増加の場合は「数量要因 vs 単価要因」）

**Q3: 複数要因が絡む場合**
- 対策:
  1. 主要因・副次的要因を階層化して提示
  2. 寄与度分析（可能な場合）

---

### 1.3 グラフ自動生成（Insight Visualizer）

#### 概要
自然言語指示から適切なグラフ・表を自動生成する機能。

#### 典型的なユースケース

```
例1:
ユーザー: 「営業利益の前年比推移をグラフで」
AI:
  1. データ抽出: 当期・前期の営業利益（月次）
  2. グラフ選定: 折れ線グラフ（2系列比較）
  3. 生成: [折れ線グラフ表示]
  4. ナラティブ: 「2024年4-9月の営業利益は前年同期比+8.2%。
                  主要要因は変動費削減（▲2億円）です。」

例2:
ユーザー: 「事業部別の売上構成比を円グラフで」
AI:
  1. データ抽出: 事業部別売上高（当期累計）
  2. グラフ選定: 円グラフ
  3. 生成: [円グラフ表示]
  4. ナラティブ: 「製造事業45%、サービス事業35%、その他20%。
                  前年から製造が+5pt増加しています。」

例3:
ユーザー: 「売上と利益の相関を見たい」
AI:
  1. データ抽出: 部門別の売上高・営業利益
  2. グラフ選定: 散布図
  3. 生成: [散布図表示]
  4. ナラティブ: 「営業1部は高売上・高利益。営業3部は改善余地あり。」

例4:
ユーザー: 「予実差異のウォーターフォール」
AI:
  1. データ抽出: 予算→実績の増減要因
  2. グラフ選定: ウォーターフォールチャート
  3. 生成: [ウォーターフォール表示]
  4. ナラティブ: 「予算100億円から、売上増+8億円、変動費増▲3億円、...」
```

#### 対応グラフ種類

**Phase 1（MVP）**:
1. 折れ線グラフ（推移）
2. 棒グラフ（比較）
3. 円グラフ（構成比）
4. 表（数値一覧）

**Phase 2（拡張）**:
5. ウォーターフォール（差異分析）
6. 散布図（相関）
7. ヒートマップ（マトリクス）
8. 積み上げ棒グラフ（内訳推移）

#### 技術詳細

**グラフ選定ロジック**:
```typescript
// LLMにグラフ種別を判定させる
const prompt = `
以下の質問に最適なグラフ種類を選定してください。

質問: ${userQuery}

選択肢:
1. line - 時系列推移を見る場合
2. bar - カテゴリ間比較の場合
3. pie - 構成比を見る場合
4. table - 詳細数値を見る場合
5. waterfall - 差異要因分解の場合
6. scatter - 相関を見る場合

回答形式: {"chart_type": "line", "reason": "前年比推移のため"}
`;

const response = await callLLM(prompt);
const chartType = response.chart_type;
```

**グラフライブラリ**:
- **Recharts** (React): シンプル、カスタマイズ容易
- **Apache ECharts**: 高機能、ウォーターフォール対応
- **D3.js**: 完全カスタマイズ（複雑なグラフ用）

**エクスポート機能**:
- PNG画像: html2canvas
- PDF: jsPDF
- Excel: xlsx
- PowerPoint: pptxgenjs

#### 実装段階（MVP → 拡張）

**Phase 1（MVP - 0-3ヶ月）**:
- 対応グラフ: 4種類（折れ線、棒、円、表）
- エクスポート: PNG、PDF
- UI: チャット内でグラフ表示

**Phase 2（拡張 - 4-6ヶ月）**:
- 対応グラフ拡張: 8種類
- エクスポート追加: Excel、PowerPoint
- ダッシュボード埋め込み機能

---

### 1.4 異常値検知アラート（Anomaly Detection）

#### 概要
実績データの入力時、異常値を自動検知してアラート通知する機能。

#### 検知パターン

**1. 閾値ベース**:
- 前月比±30%以上の変動
- 予算比±20%以上の乖離
- 前年同月比±50%以上の変動

**2. 統計ベース**:
- 過去12ヶ月の標準偏差σを計算
- ±2σ以上の外れ値を検知

**3. トレンド逸脱**:
- 過去3ヶ月のトレンド線から大きく逸脱

#### 典型的なユースケース

```
シナリオ1: 実績入力時
ユーザー: 9月の広告宣伝費に「50,000,000円」を入力
システム: 🚨 異常値検知
  「広告宣伝費が前月比+180%です。入力ミスの可能性があります。
   - 前月実績: 18,000,000円
   - 今月入力: 50,000,000円
   - 差異: +32,000,000円 (+180%)

   確認してください: (1) 入力ミス (2) 正しい (3) コメント追加」

シナリオ2: 日次モニタリング
システム: 毎朝9:00に前日の実績データをチェック
検知: 「営業1部の売上高が過去平均の-40%です」
→ Slack/メール通知:
  「⚠️ 異常値検知: 営業1部売上高
   実績: 800万円（過去平均: 1,200万円、-33%）
   【詳細】 | 【無視】」

シナリオ3: 月次締め前チェック
経営企画: 「締め処理実行」ボタンをクリック
システム: 異常値チェック実行
結果: 「以下3件の異常値が検出されました。確認してください。
  1. 広告宣伝費（全社）: 予算比+65%
  2. 営業1部売上高: 前年同月比-45%
  3. 外注費（製造）: 前月比+120%

  【すべて確認済み】 | 【個別確認】」
```

#### 技術詳細

**検知アルゴリズム**:
```python
def detect_anomaly(subject_id, department_id, period_id, amount):
    # 1. 履歴データ取得
    history = get_history(subject_id, department_id, months=12)

    # 2. 統計量計算
    mean = history.mean()
    std = history.std()

    # 3. Zスコア計算
    z_score = (amount - mean) / std

    # 4. 判定
    if abs(z_score) > 2:
        return {
            "is_anomaly": True,
            "severity": "high" if abs(z_score) > 3 else "medium",
            "message": f"過去平均の±{abs(z_score):.1f}σ",
            "history_mean": mean,
            "history_std": std
        }

    # 5. 前月比チェック
    prev_month = get_prev_month_amount(subject_id, department_id)
    if prev_month:
        change_pct = (amount - prev_month) / prev_month * 100
        if abs(change_pct) > 30:
            return {
                "is_anomaly": True,
                "severity": "medium",
                "message": f"前月比{change_pct:+.1f}%",
                "prev_amount": prev_month
            }

    return {"is_anomaly": False}
```

**通知チャネル**:
- UI内アラート（即座）
- Slack通知（設定可能）
- メール通知（設定可能）

#### 実装段階（MVP → 拡張）

**Phase 1（MVP - 0-3ヶ月）**:
- 検知ロジック: 閾値ベース（前月比、予算比）
- 通知: UI内アラートのみ
- 対象: 実績入力時のリアルタイムチェック

**Phase 2（拡張 - 4-6ヶ月）**:
- 検知ロジック追加: 統計ベース（Zスコア）、トレンド逸脱
- 通知追加: Slack、メール
- 日次バッチモニタリング

---

### 1.5 経営参謀Bot（Executive Analyst Agent）

#### 概要
CFO/経営企画の「デジタル参謀」として、対話を通じて経営判断を支援するAIエージェント。

#### 自然言語Q&Aとの違い

| 観点 | 自然言語Q&A | 経営参謀Bot |
|------|------------|-----------|
| **対話深度** | 1問1答 | 複数ターン対話 |
| **文脈保持** | なし | あり（会話履歴） |
| **能動性** | 受動的（質問待ち） | 能動的（提案・深掘り） |
| **分析深度** | 事実回答 | 仮説・示唆・推奨 |
| **ペルソナ** | データアシスタント | 経営参謀・アナリスト |

#### 典型的なユースケース（対話例）

```
【シーン: 月次レビュー準備】

CFO: 「今月の業績サマリを教えて」

Bot: 「2024年9月の業績サマリです。

📊 売上高: ¥1,138M（予算比▲5.2%、前年比+3.8%）
📊 営業利益: ¥127M（予算比▲8.0%、前年比+2.1%）
📊 営業利益率: 11.2%（目標12.0%、▲0.8pt）

🚨 アラート:
- 売上高の下振れが8月から継続（要注意）
- 広告宣伝費が予算比+15%で超過

💡 主要トピック:
1. A社大口案件の受注遅延（▲¥85M）
2. 新製品キャンペーン前倒しによる広告費増（+¥35M）

詳細を確認しますか？
【1. 売上下振れの詳細】【2. 広告費超過の詳細】【3. 部門別業績】」

---

CFO: 「1. 売上下振れの詳細」

Bot: 「売上下振れの詳細です。

【差異内訳】
- 製造事業部: ▲¥85M（▲14.2%）← 主要因
- サービス事業部: +¥15M（+3.8%）← 好調
- その他: +¥8M（+4.0%）

【製造事業部の要因】
- A社向け大口案件（¥85M）の受注が10月にずれ込み
  - 理由: 先方の稟議承認遅延
  - 確定日: 2024-10-02（既に受注済み）
- 製造ライン改修による出荷遅延（¥15M）
  - 9月第2週のライン停止が影響
  - 10月に挽回出荷予定

【リスク評価】
🟡 中リスク: 10月の受注確定済みのため、挽回可能性高

【過去類似事例】
2023年6月に同様の遅延発生。翌月+18%で挽回達成。

💡 推奨アクション:
1. A社案件のデリバリースケジュールを確認
2. 10月第1週の受注実績を精査
3. 製造ラインの前倒し出荷可能性を検討

【他の確認】【年間着地への影響】【部門長へのヒアリング項目】」

---

CFO: 「年間着地への影響」

Bot: 「年間着地への影響を試算します。

【前提条件】
- 10月: A社案件全額回収（+¥85M）
- 11-12月: 計画通り推移

【着地予測】
- 売上高: ¥14,580M（年間予算¥14,400M、+1.3%）✅ 達成可能
- 営業利益: ¥1,690M（年間予算¥1,728M、▲2.2%）⚠️ 未達リスク

【リスクシナリオ】
もし10月の挽回が50%に留まった場合:
- 売上高: ¥14,538M（年間予算比+0.9%）← ギリギリ達成
- 営業利益: ¥1,656M（年間予算比▲4.2%）← 未達

【推奨】
Q4で営業利益を挽回するため:
1. 変動費の更なる削減（目標: ▲¥50M）
2. サービス事業部の好調維持（上積み目標: +¥30M）
3. 固定費の執行抑制（採用・設備投資の後ろ倒し）

【シミュレーション実行】【見込更新】【対策プラン詳細】」

---

CFO: 「対策プラン詳細」

Bot: 「Q4営業利益挽回プランの詳細です。

【目標】: 年間営業利益¥1,728M達成（▲¥38M挽回必要）

【施策1】変動費削減（目標: ▲¥50M）
- 外注費の価格交渉継続
  - 実績: 9月に▲¥18M達成
  - 追加目標: Q4で▲¥30M
- 物流費の最適化
  - 配送ルート見直しで▲¥10M
  - 10月から実行可能
- 原材料調達の見直し
  - 代替サプライヤー活用で▲¥10M

【施策2】サービス事業部の上積み（目標: +¥30M）
- 既存顧客向けアップセル
  - 対象: 20社（過去実績あり）
  - 期待売上: +¥20M
- 新規受注の前倒し
  - 現在商談中の5案件を11月に受注
  - 期待売上: +¥10M

【施策3】固定費の執行抑制（目標: ▲¥20M）
- 採用計画の後ろ倒し（3名 → 1月以降）: ▲¥6M
- 設備投資の延期（システム更新）: ▲¥10M
- 研修・出張の抑制: ▲¥4M

【合計効果】: +¥100M（目標▲¥38Mを大きく上回る）

【リスク】
- 変動費削減が計画通り進まない可能性
- サービス事業部の上積みが未達の可能性

【KPI】
- 外注費削減進捗（月次モニタリング）
- サービス事業部受注件数（週次モニタリング）

【Excel資料作成】【Slack共有】【タスク登録】」
```

#### 機能要件

**1. 対話管理**:
- 会話履歴の保持（セッション単位）
- 文脈理解（「それ」「これ」等の代名詞解決）
- 複数ターン対話（最大10ターン程度）

**2. 能動的提案**:
- 「詳細を確認しますか？」等の選択肢提示
- 関連情報の自動サジェスト
- 次のアクション推奨

**3. 分析深度**:
- 事実 → 要因 → 仮説 → 推奨 の階層的分析
- シナリオシミュレーション
- リスク評価

**4. アクション連携**:
- Excel資料自動生成
- Slack/メール共有
- タスク・TODO登録（将来）

#### 技術詳細

**対話管理アーキテクチャ**:
```typescript
interface ConversationContext {
  session_id: string;
  user_id: string;
  tenant_id: string;
  messages: Message[];
  entities: {
    period?: string;        // "2024-09"
    department?: string;    // "営業1部"
    subject?: string;       // "売上高"
    scenario?: string;      // "予算" | "実績" | "見込"
  };
  current_topic: string;    // "売上下振れ" | "広告費超過" 等
}

// LLMに渡すプロンプト
const systemPrompt = `
あなたは経営参謀AIアシスタントです。
CFOや経営企画担当者の意思決定を支援してください。

【役割】
- 経営データを分析し、事実・要因・仮説・推奨を提示
- 対話を通じて深掘り分析を支援
- 能動的に関連情報や次のアクションを提案

【口調】
- 簡潔・明瞭に回答
- 数値は必ず根拠付きで提示
- 不確実な情報は「推定」と明記

【制約】
- 計算は自社エンジンの結果を使用（LLMで計算しない）
- 権限外のデータにはアクセス不可
- 最終判断は人間が行うことを前提
`;
```

**エージェント・オーケストレーション**:
```
ユーザー質問
  ↓
意図理解（Intent Recognition）
  ↓
エンティティ抽出（Entity Extraction）
  ↓
データ取得（Data Retrieval）← セマンティックレイヤー
  ↓
分析実行（Analysis）← RAG + 自社計算エンジン
  ↓
応答生成（Response Generation）← LLM
  ↓
次のアクション提案（Action Suggestion）
```

#### 実装段階（MVP → 拡張）

**Phase 1（MVP - 0-3ヶ月）**:
- 対話深度: 3ターンまで
- 能動提案: 選択肢3つまで
- 分析深度: 事実 + 簡易仮説
- UI: チャットウィンドウ（基本）

**Phase 2（拡張 - 4-6ヶ月）**:
- 対話深度: 10ターン
- 能動提案: 動的に生成
- 分析深度: 仮説 + シミュレーション + 推奨
- UI: サイドパネル常駐、音声入力対応（検討）
- アクション連携: Excel生成、Slack共有

---

## 2. 横断的技術方針

### 2.1 AIアーキテクチャ（確定）

```
┌─────────────────────────────────────────────────────────┐
│                     UI Layer (React)                    │
│  - Chat UI - Graph Viewer - Report Viewer              │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│              BFF (NestJS)                               │
│  - AI Gateway - Permission Guard - Response Formatter  │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│          AI Orchestration Layer (NEW)                   │
│                                                           │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────┐  │
│  │  Intent     │  │  Semantic    │  │  RAG Engine   │  │
│  │  Classifier │→ │  Layer       │→ │  (Vector DB)  │  │
│  └─────────────┘  └──────────────┘  └───────────────┘  │
│                           │                               │
│  ┌────────────────────────▼──────────────────────────┐  │
│  │         Query Planner & Executor                   │  │
│  │  - SQL Generation  - Calculation Engine Call      │  │
│  └────────────────────┬───────────────────────────────┘  │
│                       │                                   │
│  ┌────────────────────▼───────────────────────────────┐ │
│  │         LLM Service (Azure OpenAI / Claude)        │ │
│  │  - Response Generation  - Narrative Creation      │ │
│  └────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│          Domain API (NestJS)                            │
│  - Fact Amounts Service - Calculation Engine           │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│          Database (PostgreSQL + pgvector)               │
│  - fact_amounts - subjects - departments - ...         │
│  - ai_conversations (NEW) - ai_knowledge_base (NEW)    │
└─────────────────────────────────────────────────────────┘
```

### 2.2 セマンティックレイヤー設計（最重要）

**目的**: AIが正確にデータを理解・抽出できるようにする

**構成要素**:

```typescript
// 1. メタデータ定義
interface SemanticModel {
  entities: {
    subject: {
      id: string;
      code: string;
      name: string;
      aliases: string[];        // ["売上高", "Revenue", "トップライン"]
      description: string;
      data_type: "monetary" | "quantity" | "ratio";
      unit: string;             // "円", "件", "%"
      parent_id?: string;       // 階層構造
      aggregation: "SUM" | "AVG" | "EOP";
    },
    department: {
      id: string;
      stable_id: string;
      code: string;
      name: string;
      aliases: string[];
      hierarchy_path: string;
      level: number;
    },
    period: {
      id: string;
      fiscal_year: number;
      period_no: number;
      display_label: string;
      aliases: string[];        // ["9月", "2024年9月", "2024-09", "Q2"]
    }
  },
  metrics: {
    // KPI定義
    id: string;
    name: string;
    formula: string;            // "売上高 / 従業員数"
    components: string[];       // ["売上高", "従業員数"]
  },
  relationships: {
    // エンティティ間の関係
    from: string;
    to: string;
    type: "hierarchy" | "calculation" | "reference";
  }
}
```

**実装方法**:
1. マスタテーブルからメタデータを自動生成
2. JSON Schemaとして保存
3. LLMのコンテキストに注入

### 2.3 RAG（知識ベース）設計

**インデックス対象データ**:

| データソース | 内容 | 更新頻度 |
|------------|------|---------|
| 科目定義書 | 各科目の説明、計算方法 | 月次 |
| KPI定義書 | KPIの算定式、目標値 | 四半期 |
| 過去コメント | fact_amounts.memo, notes | リアルタイム |
| 経営会議議事録 | 意思決定の背景・理由 | 会議後 |
| 予算策定資料 | 前提条件、仮説 | 年次 |
| 過去施策DB | 施策と効果の記録 | 随時 |

**ベクターDB選定**:
- **Phase 1**: PostgreSQL pgvector（既存DBを活用）
- **Phase 2**: Pinecone / Qdrant（スケール時）

**埋め込みモデル**:
- OpenAI text-embedding-3-small（コスト重視）
- または text-embedding-3-large（精度重視）

### 2.4 セキュリティ・ガバナンス

**1. テナント分離**:
- すべてのAI機能で tenant_id による厳格なフィルタ
- ベクターDB検索時も tenant_id をメタデータフィルタとして適用

**2. 権限制御（RLS）**:
- ユーザーロールに基づくデータアクセス制御
- 事業部長は自部門のみ、CFOは全社
- AI回答も権限フィルタを適用

**3. 監査ログ**:
```typescript
interface AIAuditLog {
  id: string;
  tenant_id: string;
  user_id: string;
  session_id: string;
  timestamp: Date;
  feature: "nlq" | "variance_analysis" | "anomaly_detection" | "chat_bot";
  query: string;                // ユーザーの質問
  intent: string;               // 解析された意図
  data_accessed: {              // アクセスしたデータ
    tables: string[];
    record_count: number;
  };
  response_summary: string;     // 回答の要約
  llm_model: string;            // 使用したLLMモデル
  llm_tokens: number;           // トークン数
  execution_time_ms: number;
  user_feedback?: "positive" | "negative" | "neutral";
}
```

**4. プロンプトインジェクション対策**:
- ユーザー入力のサニタイズ
- システムプロンプトの保護（BEGIN/ENDトークン）
- 危険なキーワードのブロックリスト

**5. 出力の透明性**:
- すべてのAI回答に出典を明示
- 「AI生成の回答です」と明記
- 信頼度スコアの表示（可能な場合）

### 2.5 コスト管理

**想定コスト（月間）**:

| 機能 | 利用頻度 | LLMコール数/月 | トークン数 | コスト見積 |
|------|---------|--------------|-----------|----------|
| 自然言語Q&A | 100回/日 | 3,000回 | 10M tokens | $50 |
| 差異分析レポート | 1回/月 | 30回 | 5M tokens | $25 |
| グラフ生成 | 50回/日 | 1,500回 | 3M tokens | $15 |
| 異常値検知 | 1,000回/月 | 0回（ルールベース） | 0 | $0 |
| 経営参謀Bot | 10セッション/日 | 300回 | 15M tokens | $75 |
| **合計** | - | 4,830回 | 33M tokens | **$165** |

**コスト最適化策**:
1. モデル使い分け:
   - 簡易質問: GPT-3.5 Turbo（安価）
   - 複雑分析: Claude 3.5 Sonnet（高精度）
2. レスポンスキャッシュ:
   - 同一質問は24時間キャッシュ
3. 段階的トークン制限:
   - 一般ユーザー: 月100回まで
   - CFO/経営企画: 無制限
4. バッチ処理:
   - 差異分析は夜間バッチで実行

---

## 3. 新規エンティティ設計

### 3.1 ai_conversations（会話履歴）

```sql
CREATE TABLE ai_conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  user_id UUID NOT NULL,
  session_id UUID NOT NULL,
  feature VARCHAR(50) NOT NULL, -- 'nlq' | 'chat_bot' | 'variance_analysis'
  message_type VARCHAR(20) NOT NULL, -- 'user' | 'assistant' | 'system'
  message_content TEXT NOT NULL,
  message_metadata JSONB, -- {intent, entities, confidence}
  parent_message_id UUID, -- 返信元メッセージ（スレッド構造）
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT fk_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id),
  CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES login_accounts(id)
);

CREATE INDEX idx_ai_conversations_session ON ai_conversations(tenant_id, session_id, created_at);
CREATE INDEX idx_ai_conversations_user ON ai_conversations(tenant_id, user_id, created_at);
```

### 3.2 ai_knowledge_base（RAG用知識ベース）

```sql
CREATE TABLE ai_knowledge_base (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  company_id UUID, -- NULL = テナント共通
  source_type VARCHAR(50) NOT NULL, -- 'subject_definition' | 'kpi_definition' | 'comment' | 'meeting_minutes' | 'budget_guideline'
  source_id UUID, -- 元データのID（fact_amounts.id等）
  title VARCHAR(500),
  content TEXT NOT NULL,
  content_summary TEXT, -- LLMで生成した要約
  embedding VECTOR(1536), -- OpenAI text-embedding-3-small
  metadata JSONB, -- {fiscal_year, period_id, department_id, subject_id, ...}
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT fk_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id),
  CONSTRAINT fk_company FOREIGN KEY (company_id) REFERENCES companies(id)
);

-- ベクター検索用インデックス（pgvector）
CREATE INDEX idx_ai_knowledge_embedding ON ai_knowledge_base
  USING ivfflat (embedding vector_cosine_ops)
  WITH (lists = 100);

-- メタデータフィルタ用インデックス
CREATE INDEX idx_ai_knowledge_metadata ON ai_knowledge_base
  USING gin (metadata);

-- テナント分離用インデックス
CREATE INDEX idx_ai_knowledge_tenant ON ai_knowledge_base(tenant_id, is_active);
```

### 3.3 ai_audit_logs（監査ログ）

```sql
CREATE TABLE ai_audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  user_id UUID NOT NULL,
  session_id UUID NOT NULL,
  feature VARCHAR(50) NOT NULL,
  query TEXT NOT NULL,
  intent VARCHAR(200),
  entities JSONB, -- {period, department, subject, ...}
  data_accessed JSONB, -- {tables, record_count}
  response_summary TEXT,
  llm_model VARCHAR(100),
  llm_tokens INTEGER,
  execution_time_ms INTEGER,
  user_feedback VARCHAR(20), -- 'positive' | 'negative' | 'neutral'
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT fk_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id),
  CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES login_accounts(id)
);

CREATE INDEX idx_ai_audit_tenant_user ON ai_audit_logs(tenant_id, user_id, created_at);
CREATE INDEX idx_ai_audit_feature ON ai_audit_logs(tenant_id, feature, created_at);
```

### 3.4 ai_anomaly_alerts（異常値アラート）

```sql
CREATE TABLE ai_anomaly_alerts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  company_id UUID NOT NULL,
  accounting_period_id UUID NOT NULL,
  subject_id UUID NOT NULL,
  department_stable_id UUID NOT NULL,
  fact_amount_id UUID, -- 該当のfact_amounts
  anomaly_type VARCHAR(50) NOT NULL, -- 'threshold' | 'statistical' | 'trend_deviation'
  severity VARCHAR(20) NOT NULL, -- 'low' | 'medium' | 'high'
  detected_amount DECIMAL(20,4) NOT NULL,
  expected_amount DECIMAL(20,4),
  variance_amount DECIMAL(20,4),
  variance_pct DECIMAL(10,2),
  message TEXT NOT NULL,
  detection_metadata JSONB, -- {z_score, prev_month, history_mean, ...}
  status VARCHAR(20) NOT NULL DEFAULT 'pending', -- 'pending' | 'confirmed' | 'ignored'
  confirmed_by UUID,
  confirmed_at TIMESTAMPTZ,
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT fk_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id),
  CONSTRAINT fk_company FOREIGN KEY (company_id) REFERENCES companies(id),
  CONSTRAINT fk_period FOREIGN KEY (accounting_period_id) REFERENCES accounting_periods(id),
  CONSTRAINT fk_subject FOREIGN KEY (subject_id) REFERENCES subjects(id),
  CONSTRAINT fk_fact FOREIGN KEY (fact_amount_id) REFERENCES fact_amounts(id)
);

CREATE INDEX idx_ai_anomaly_pending ON ai_anomaly_alerts(tenant_id, company_id, status, created_at);
CREATE INDEX idx_ai_anomaly_period ON ai_anomaly_alerts(tenant_id, accounting_period_id);
```

---

## 4. 実装ロードマップ（6ヶ月）

### Phase 1（0-3ヶ月）: MVP

**Month 1（基盤構築）**:
- [ ] AI Orchestration Layer の設計・実装
- [ ] セマンティックレイヤー構築（メタデータ自動生成）
- [ ] RAG基盤構築（pgvector、埋め込み生成）
- [ ] 新規エンティティ追加（ai_conversations, ai_knowledge_base, ai_audit_logs, ai_anomaly_alerts）
- [ ] Azure OpenAI / Claude API 連携実装
- [ ] セキュリティ・権限制御の実装

**Month 2（機能実装 - P0）**:
- [ ] 自然言語Q&A（基本10パターン）
- [ ] 差異分析オートコメント（手動実行）
- [ ] UI: チャットウィンドウ（React）
- [ ] 監査ログ記録
- [ ] 単体テスト・統合テスト

**Month 3（機能実装 - P1前半）**:
- [ ] グラフ自動生成（4種類: 折れ線、棒、円、表）
- [ ] 異常値検知アラート（閾値ベース）
- [ ] レポートエクスポート（PDF、PNG）
- [ ] β版ユーザーテスト・フィードバック収集

### Phase 2（4-6ヶ月）: 拡張

**Month 4（機能拡張 - P1後半）**:
- [ ] 経営参謀Bot（β版、3ターン対話）
- [ ] 自然言語Q&A拡張（50パターン）
- [ ] 差異分析オートコメント（自動実行、Slack通知）

**Month 5（高度化）**:
- [ ] 経営参謀Bot（本格版、10ターン対話、能動提案）
- [ ] グラフ自動生成拡張（ウォーターフォール、散布図）
- [ ] 異常値検知拡張（統計ベース、日次バッチ）
- [ ] シナリオシミュレーション（検討開始）

**Month 6（仕上げ・GA準備）**:
- [ ] 性能最適化（キャッシュ、バッチ処理）
- [ ] コスト最適化（モデル使い分け）
- [ ] ドキュメント整備
- [ ] GA（General Availability）リリース

---

## 5. 決定事項

### 5.1 スコープ確定

**Phase 1（0-3ヶ月）でMVPリリース**:
1. 自然言語Q&A（基本10パターン）
2. 差異分析オートコメント（手動実行）
3. グラフ自動生成（4種類）
4. 異常値検知アラート（閾値ベース）

**Phase 2（4-6ヶ月）で機能拡張**:
5. 経営参謀Bot（高度対話）
6. 上記機能の高度化・自動化

### 5.2 技術スタック確定

- **LLM**: Claude 3.5 Sonnet（メイン）+ GPT-3.5 Turbo（サブ）
- **ベクターDB**: PostgreSQL pgvector（Phase 1）
- **グラフライブラリ**: Recharts（Phase 1）
- **エクスポート**: PNG（html2canvas）、PDF（jsPDF）

### 5.3 優先対応質問TOP5（NLQ設計用）

※ユーザーからの追加インプット待ち

暫定案:
1. 「今期着地は？」
2. 「XX月のXX部門の売上高は？」
3. 「予算との差異は？」
4. 「XX科目の前年比は？」
5. 「XX科目の推移を見せて」

---

## 6. 未決事項・次回検討

### 6.1 要確認事項

1. **レポート生成のトリガー**:
   - A案: 月次締め後にバッチ自動実行
   - B案: CFOが画面で「レポート作成」ボタン
   - C案: 両方対応
   - **→ ユーザー判断待ち**

2. **最優先で答えてほしい質問TOP5**:
   - NLQ設計・セマンティックレイヤー構築の基準
   - **→ ユーザー判断待ち**

3. **よく作るグラフTOP3**:
   - グラフ自動生成の優先実装対象
   - **→ ユーザー判断待ち**

4. **音声入力対応**:
   - Phase 2で検討
   - 技術的には可能（Azure Speech / Google Cloud Speech）
   - **→ Phase 2で再検討**

5. **シナリオシミュレーション**:
   - 「売上が10%減ったら営業利益は？」等のWhat-If分析
   - Phase 2後半で検討
   - **→ 別途仕様検討必要**

### 6.2 リスク管理

| リスク | 影響度 | 対策 |
|--------|--------|------|
| AIの誤回答による信用失墜 | 高 | 出典表示、検算機能、利用規約明記 |
| データ漏洩 | 高 | RLS厳格化、監査ログ、セキュリティテスト |
| LLMコスト超過 | 中 | モデル使い分け、キャッシュ、利用制限 |
| ユーザー不採用 | 中 | β版でフィードバック収集、改善ループ |
| 開発遅延 | 中 | Phase分割、優先順位明確化、スコープ調整 |

---

## 7. 関連ドキュメント

- `.kiro/specs/仕様検討/20260128_生成AI機能の機能検討のためのDeepReaserch結果` - 競合調査・市場トレンド
- `.kiro/steering/development-process.md` - CCSDD開発プロセス
- `.kiro/steering/tech.md` - 技術憲法
- `.kiro/specs/entities/01_各種マスタ.md` - エンティティ定義
- `.kiro/specs/entities/02_トランザクション・残高.md` - ファクト定義

---

## 8. 次のアクション

1. **ユーザー確認事項（1週間以内）**:
   - レポート生成のトリガー（A/B/C案）
   - 最優先質問TOP5
   - よく作るグラフTOP3

2. **仕様概要ファイル作成（確認後）**:
   - `.kiro/specs/仕様概要/AIシミュレーション機能.md`

3. **Feature Spec作成（確認後）**:
   - `.kiro/specs/ai/nlq/requirements.md`
   - `.kiro/specs/ai/variance-analysis/requirements.md`
   - `.kiro/specs/ai/graph-generation/requirements.md`
   - `.kiro/specs/ai/anomaly-detection/requirements.md`
   - `.kiro/specs/ai/chat-bot/requirements.md`

---

**以上**
