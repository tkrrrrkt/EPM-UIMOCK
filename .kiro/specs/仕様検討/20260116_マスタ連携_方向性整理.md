# マスタ連携 方向性整理

> **ステータス**: 方向性整理（詳細設計は後日）
> **作成日**: 2026-01-16
> **目的**: ERP・外部システムとのマスタデータ連携の方向性を整理

---

## 1. 背景と優先度

### 1.1 位置づけ

マスタ連携は**トランザクションデータ取込の前提条件**として必要だが、
取込機能のUI/UX設計が優先。マスタ連携の詳細設計は後日実施。

### 1.2 優先度

| カテゴリ | 優先度 | 理由 |
|---------|--------|------|
| トランザクション取込 | **高** | 月次運用の根幹、UX設計が重要 |
| マスタ連携 | 中 | 初期導入時に整備、以降は差分同期 |

---

## 2. 対象マスタと連携方向

### 2.1 連携対象

| マスタ | 連携元 | 連携頻度 | 備考 |
|--------|--------|---------|------|
| 組織・部門 | ERP / HR | 月次〜四半期 | 組織改編時に更新 |
| 勘定科目 | ERP | 年次〜随時 | 新科目追加時 |
| 従業員 | HR | 月次 | 人員計画連携用 |
| プロジェクト | PJ管理 | 随時 | PJ別予実管理用 |
| 取引先 | ERP / SFA | 随時 | 売上分析用（将来） |

### 2.2 連携パターン

```
パターンA: EPM側マスタ（EPMがSSoT）
├── 予算レイアウト
├── 確度ランク
├── 見込イベント設定
└── レポート定義

パターンB: ERP側マスタ（ERPがSSoT、EPMは参照）
├── 勘定科目 → EPM科目にマッピング
├── 部門 → EPM部門にマッピング
└── プロジェクト → EPM PJにマッピング

パターンC: HR側マスタ（HRがSSoT）
├── 従業員 → 人員計画用
└── 組織 → 部門マスタ更新
```

---

## 3. 設計方針

### 3.1 基本方針

1. **マッピングテーブル方式**
   - 外部コード → EPMコードのマッピングを保持
   - 取込時に自動変換

2. **差分同期**
   - 全件洗い替えではなく差分更新
   - 削除は論理削除（is_active=false）

3. **整合性チェック**
   - 親子関係の整合性
   - 有効期間の整合性
   - 参照整合性（使用中マスタの削除防止）

### 3.2 マッピング管理

```
外部システム                    EPM
┌─────────────┐               ┌─────────────┐
│ ERP科目     │──マッピング──▶│ EPM科目     │
│ code: 4100  │   テーブル    │ code: SALES │
│ name: 売上高│               │ name: 売上高│
└─────────────┘               └─────────────┘

マッピングテーブル:
┌────────────────────────────────────────────────┐
│ source_system | source_code | epm_subject_id  │
├────────────────────────────────────────────────┤
│ SAP           | 4100        | uuid-sales      │
│ SAP           | 4110        | uuid-sales-dom  │
│ Oracle        | REV001      | uuid-sales      │
└────────────────────────────────────────────────┘
```

---

## 4. 想定エンティティ（概要のみ）

### 4.1 マッピングテーブル

```
subject_mappings        - 科目マッピング
department_mappings     - 部門マッピング
project_mappings        - プロジェクトマッピング
```

### 4.2 同期管理

```
master_sync_logs        - 同期履歴
master_sync_errors      - 同期エラー
```

---

## 5. 検討事項（後日詳細化）

| 項目 | 検討内容 |
|------|----------|
| 同期トリガー | 手動 / スケジュール / Webhook |
| 競合解決 | EPM側変更とERP側変更の競合時 |
| 履歴管理 | マスタ変更履歴の保持期間 |
| 権限 | マスタ同期の実行権限 |
| 監査 | 同期操作のログ |

---

## 6. 次のステップ

1. トランザクションデータ取込機能の詳細設計・実装
2. マスタ連携の詳細設計（トランザクション取込安定後）
3. マッピングUIの設計

---

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2026-01-16 | 初版作成（方向性整理） |
