# 承認ワークフロー機能 仕様検討経緯

## 検討日

2026-01-15

## 参加者

- ユーザー
- Claude Code

## 検討背景

EPM SaaSにおける承認機能の設計。予算・見込の承認ワークフローを実装するにあたり、スコープ・構造・エンティティ設計を検討した。

---

## 1. 承認対象のスコープ

### 検討内容

MVPとして何を承認対象にすべきか議論。

### 候補と評価

| 対象 | 評価 | 理由 |
|------|------|------|
| 予算バージョン | ✅ 必須 | 経営管理の根幹。証跡が必要 |
| 見込バージョン（全社報告用） | ✅ 必須 | 「この見込でOK」の確定行為が必要 |
| 予算ガイドライン | ❌ 不要 | 経営層からの一方的通達。配布≒確定で十分 |
| 配賦マスタ | ❌ 不要 | 変更頻度低。監査証跡（updated_by/at）で足りる |
| 配賦処理結果 | ❌ 不要 | 再実行可能。「確定フラグ」で十分 |
| 実績取込結果 | ❌ 不要 | ERP側で仕訳承認済み。二重統制は運用負荷高 |

### 決定

**予算・見込（全社報告用）のみを承認対象とする。**

---

## 2. 見込の区分（CORPORATE / DIVISIONAL）

### 検討内容

見込には2つのユースケースがある：

1. **全社見込**: 経営会議・役員会報告用（月1回、固定タイミング）
2. **事業部見込**: 事業部内の進捗管理用（随時、週次・隔週等）

全社見込は承認が必要だが、事業部見込は自由に使えるべき。

### 検討した案

| 案 | 説明 | 評価 |
|----|------|------|
| A. plan_eventsで区分 | イベント名で区別 | ❌ イベント増えすぎ、判別困難 |
| B. purpose_type追加 | ENUM('CORPORATE','DIVISIONAL') | ✅ 明確、シンプル |
| C. is_officialフラグ | バージョン単位で公式/非公式 | △ 管理が曖昧になりやすい |

### 決定

**B案採用: plan_events に purpose_type カラムを追加**

```sql
plan_events に追加:
  purpose_type ENUM('CORPORATE', 'DIVISIONAL')

CORPORATE = 全社報告用 → 承認対象
DIVISIONAL = 事業部ローカル用 → 承認不要
```

---

## 3. 承認フローの構造

### 検討内容

承認フローを固定にするか可変にするか。

### 検討した案

| パターン | 説明 | 評価 |
|---------|------|------|
| A. 固定フロー | 全部門共通の段階数 | ✅ シンプル、設定不要 |
| B. 可変フロー | 部門や金額で承認ルートが変わる | ❌ 設定・運用が複雑 |

### 決定

**固定フロー採用。EPMはERPではないので、承認機能は「必要十分」で止める。**

---

## 4. 承認段階数

### 検討内容

MAX何段階にすべきか。

### 検討結果

| 段階 | 想定承認者 |
|------|-----------|
| 1 | 部門長（課長・部長） |
| 2 | 事業部長・本部長 |
| 3 | 経営管理部門 |
| 4-5 | 予備（将来拡張用） |

- 4段階以上が必要なケースは超大企業（対象外）
- 役員承認はシステム外（会議体での意思決定）

### 決定

**MAX 5段階固定。全段階使う必要はない（1〜5段階で柔軟に運用）。**

---

## 5. 承認単位（粒度）

### 検討内容

承認を何単位で行うか。

### 検討した案

| 案 | 承認単位 | 評価 |
|----|---------|------|
| A. バージョン全体 | plan_version単位で一括 | ❌ 部門別進捗が見えない |
| B. 部門×バージョン | department × plan_version | ✅ 部門別に進捗管理可能 |
| C. 事業部×バージョン | 複数部門まとめて | △ 1部門の遅れで全体停止 |

### 決定

**B案採用: 部門×バージョン単位で承認管理**

---

## 6. 承認者の設定方法

### 検討内容

承認者をどこに、どう持つか。

### 検討した案

| 案 | 説明 | 評価 |
|----|------|------|
| A. departmentsに横持ち | 5段階分のカラムを直接追加 | ✅ シンプル、JOIN不要 |
| B. 別テーブル（stable_id単位） | 承認者テーブルを新設 | △ 組織改編時の引継ぎは楽だが複雑 |

### 決定

**A案採用: departments テーブルに横持ち**

- 組織版（organization_version）ごとに設定
- 新版作成時は前版からのコピー機能で運用負荷軽減

---

## 7. 代理承認

### 検討内容

承認者不在時の対応。

### 決定

**各段階に代理承認者を1名設定可能（横持ち）**

```sql
departments テーブル:
  approver_1_employee_id        -- 第1承認者
  approver_1_deputy_employee_id -- 第1代理承認者
  approver_2_employee_id        -- 第2承認者
  approver_2_deputy_employee_id -- 第2代理承認者
  ... （計10カラム）
```

---

## 8. 垂直代理承認

### 検討内容

上位承認者が下位段階をスキップして承認できるか。

### 決定

**許可する（垂直代理承認）**

- 第3承認者が承認 → 第1〜3段階すべて承認済みになる
- スキップされた段階は履歴に `SKIP` として記録

**ただし、下位者が上位段階を承認することは禁止。**

---

## 9. 承認ステータス

### 検討内容

どのような状態を管理するか。

### 決定

**5ステータス**

| status | 意味 |
|--------|------|
| DRAFT | 未提出（入力中） |
| PENDING | 承認待ち |
| APPROVED | 承認完了 |
| REJECTED | 差戻し（承認者から） |
| WITHDRAWN | 取下げ（本人から） |

---

## 10. 差戻し後の再開位置

### 検討内容

差戻し後、どの段階から再開するか。

### 検討した案

| 案 | 動き | 評価 |
|----|------|------|
| A. 第1からやり直し | 全員が修正内容を再確認 | ✅ シンプル、確実 |
| B. 差戻し位置から再開 | 効率的だが下位者が確認できない | ❌ |

### 決定

**A案採用: 第1段階からやり直し**

---

## 11. 承認者設定の制約

### 検討内容

承認者の「中抜け」（1, 3は設定、2は空）を許可するか。

### 決定

**禁止（詰めて設定を強制）**

- approver_1, 2, 3 の順に設定し、途中をNULLにしない
- UIで順番に入力させることで自然に詰まる

---

## 12. MVP外とした機能

| 機能 | 理由 |
|------|------|
| 承認期限 | 期限超過時の自動処理が複雑 |
| エスカレーション | 運用でカバー可能 |
| 可変承認ルート | 設定・運用が複雑 |

---

## 13. エンティティ設計（案）

### 13.1 plan_events への追加

```sql
ALTER TABLE plan_events ADD COLUMN purpose_type VARCHAR(20)
  CHECK (purpose_type IN ('CORPORATE', 'DIVISIONAL'));
```

### 13.2 departments への追加

```sql
ALTER TABLE departments ADD COLUMN approver_1_employee_id UUID REFERENCES employees(id);
ALTER TABLE departments ADD COLUMN approver_1_deputy_employee_id UUID REFERENCES employees(id);
ALTER TABLE departments ADD COLUMN approver_2_employee_id UUID REFERENCES employees(id);
ALTER TABLE departments ADD COLUMN approver_2_deputy_employee_id UUID REFERENCES employees(id);
ALTER TABLE departments ADD COLUMN approver_3_employee_id UUID REFERENCES employees(id);
ALTER TABLE departments ADD COLUMN approver_3_deputy_employee_id UUID REFERENCES employees(id);
ALTER TABLE departments ADD COLUMN approver_4_employee_id UUID REFERENCES employees(id);
ALTER TABLE departments ADD COLUMN approver_4_deputy_employee_id UUID REFERENCES employees(id);
ALTER TABLE departments ADD COLUMN approver_5_employee_id UUID REFERENCES employees(id);
ALTER TABLE departments ADD COLUMN approver_5_deputy_employee_id UUID REFERENCES employees(id);
```

### 13.3 department_approval_status（新規）

```sql
CREATE TABLE department_approval_status (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id               UUID NOT NULL REFERENCES tenants(id),
  plan_version_id         UUID NOT NULL REFERENCES plan_versions(id),
  department_stable_id    TEXT NOT NULL,
  current_step            INT NOT NULL DEFAULT 0,  -- 0=未提出, 1〜5=承認段階
  status                  VARCHAR(20) NOT NULL DEFAULT 'DRAFT'
    CHECK (status IN ('DRAFT', 'PENDING', 'APPROVED', 'REJECTED', 'WITHDRAWN')),
  submitted_at            TIMESTAMP,
  final_approved_at       TIMESTAMP,
  created_at              TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at              TIMESTAMP NOT NULL DEFAULT NOW(),

  UNIQUE (tenant_id, plan_version_id, department_stable_id)
);
```

### 13.4 department_approval_histories（新規）

```sql
CREATE TABLE department_approval_histories (
  id                              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id                       UUID NOT NULL REFERENCES tenants(id),
  department_approval_status_id   UUID NOT NULL REFERENCES department_approval_status(id),
  step                            INT NOT NULL,  -- 操作対象の段階
  action                          VARCHAR(20) NOT NULL
    CHECK (action IN ('SUBMIT', 'APPROVE', 'REJECT', 'WITHDRAW', 'SKIP')),
  actor_employee_id               UUID NOT NULL REFERENCES employees(id),
  acted_at                        TIMESTAMP NOT NULL DEFAULT NOW(),
  comment                         TEXT,

  created_at                      TIMESTAMP NOT NULL DEFAULT NOW()
);
```

---

## 14. 状態遷移図

```
┌─────────┐
│  DRAFT  │
│ (未提出) │
└────┬────┘
     │ 提出 (SUBMIT)
     ▼
┌─────────┐      承認 (APPROVE)           ┌──────────┐
│ PENDING │──────────────────────────────▶│ APPROVED │
│(承認待ち)│    （全段階完了時）             │  (完了)   │
└────┬────┘                               └──────────┘
     │
     ├─────────┬─────────┐
     │         │         │
     │差戻し    │取下げ    │承認（次段階へ）
     │(REJECT) │(WITHDRAW)│(APPROVE)
     ▼         ▼         ▼
┌─────────┐ ┌──────────┐  PENDING
│REJECTED │ │WITHDRAWN │  (current_step+1)
│ (差戻し) │ │ (取下げ)  │
└────┬────┘ └────┬─────┘
     │           │
     └─────┬─────┘
           │ 再提出 (SUBMIT)
           ▼
       PENDING
       (current_step=1)
```

---

## 15. 承認コメント

### 検討内容

各アクション時のコメント入力を必須にするか任意にするか。

### 決定

**全アクションでコメントは任意**

| アクション | コメント | 備考 |
|-----------|---------|------|
| SUBMIT | 任意 | 「ご確認お願いします」等 |
| APPROVE | 任意 | 「確認済み」等 |
| REJECT | 任意 | 差戻し理由は運用でカバー |
| WITHDRAW | 任意 | 取下げ理由は運用でカバー |

---

## 16. 通知機能

### 検討内容

承認アクション時にメール通知を送るか、どのような形式にするか。

### 決定

**メール通知あり。固定文言 + 変数埋め込み。**

#### 通知タイミングと宛先

| アクション | 通知先 | 内容 |
|-----------|--------|------|
| SUBMIT（提出） | 次の承認者（第1承認者） | 「承認依頼が届きました」 |
| APPROVE（次段階あり） | 次の承認者 | 「承認依頼が届きました」 |
| APPROVE（最終承認） | 申請者 | 「承認されました」 |
| REJECT（差戻し） | 申請者 | 「差し戻されました」 |
| WITHDRAW（取下げ） | 現在の承認待ち者 | 「取り下げられました」 |

#### メール送信先

- `employees.email` を使用

#### フォーマット

固定文言（コード埋め込み or 設定ファイル）。カスタマイズ画面は作らない。

**変数一覧**:
- {承認者名} / {申請者名} / {差戻し者名} / {取下げ者名}
- {部門名}
- {バージョン名}
- {シナリオ種別}
- {コメント}
- {承認画面URL}
- {日時}

#### メールテンプレート例

```
【承認依頼】
件名: [EPM] 承認依頼: {部門名} {バージョン名}
本文:
{承認者名} 様

{申請者名} より承認依頼が届いています。

対象: {部門名}
バージョン: {バージョン名}（{シナリオ種別}）

以下のURLから確認・承認をお願いします。
{承認画面URL}

---
【承認完了】
件名: [EPM] 承認完了: {部門名} {バージョン名}
本文:
{申請者名} 様

以下の申請が承認されました。

対象: {部門名}
バージョン: {バージョン名}
承認者: {最終承認者名}
承認日時: {日時}

---
【差戻し】
件名: [EPM] 差戻し: {部門名} {バージョン名}
本文:
{申請者名} 様

以下の申請が差し戻されました。

対象: {部門名}
バージョン: {バージョン名}
差戻し者: {差戻し者名}
コメント: {コメント（あれば）}

内容を修正のうえ、再提出をお願いします。

---
【取下げ通知】
件名: [EPM] 取下げ: {部門名} {バージョン名}
本文:
{承認者名} 様

以下の承認依頼が取り下げられました。

対象: {部門名}
バージョン: {バージョン名}
取下げ者: {取下げ者名}
```

---

## 17. 承認画面UI設計

### 検討内容

承認機能のUI構成をどのようにするか。

### 検討した案

| 案 | 説明 | 評価 |
|----|------|------|
| 初期案 | 通知アイコン→ダイアログ→詳細画面→データ確認 | △ ダイアログが窮屈 |
| A案 | Split View + ステッパー（専用ページ） | ✅ モダン、一覧と詳細を同時表示 |
| B案 | インライン承認（予算入力画面に埋め込み） | △ 画面が複雑化 |

### 決定

**A案採用: Split View + ステッパー**

### 画面構成

```
1. ヘッダ通知アイコン
   - ベルアイコン + 赤バッジ（件数）
   - クリックで承認一覧ページ（/approvals）へ遷移

2. 承認一覧ページ（Split View）
   - 左ペイン: 承認待ち案件一覧（検索・フィルター付き）
   - 右ペイン: 選択した案件の詳細
     - 承認ステッパー（横一列、進捗可視化）
     - 申請情報
     - サマリ（売上・原価・利益等）
     - [予算データを確認→] リンク
     - コメント欄
     - [差戻し] [承認] ボタン

3. 予算照会画面
   - 予算入力画面と同構成（読み取り専用）
   - 承認一覧ページからリンクで遷移
```

### 画面イメージ

```
┌─────────────────────────────────────────────────────────────────────────┐
│  EPM SaaS     [予算] [見込] [レポート] ...      🔔(3) 👤田中           │
└─────────────────────────────────────────────────────────────────────────┘
                                                   │
                                                   ▼ クリック
┌─────────────────────────────────────────────────────────────────────────┐
│  ← 承認依頼一覧                                                         │
├───────────────────────────────┬─────────────────────────────────────────┤
│                               │                                         │
│  🔍 検索...    [全て ▼]       │  営業1課 / FY2026予算 第1回             │
│                               │                                         │
│  ┌─────────────────────────┐ │  【承認ステータス】                     │
│  │ ● 営業1課              │ │  ┌─────────────────────────────────┐   │
│  │   FY2026予算 第1回     │ │  │ ✓ 申請 ── ✓ 第1 ── ● 第2 ── ○ 第3 │   │
│  │   田中一郎  01/10      │ │  │ 田中     佐藤     あなた   山田 │   │
│  └─────────────────────────┘ │  └─────────────────────────────────┘   │
│  ┌─────────────────────────┐ │                                         │
│  │ ○ 営業2課              │ │  【申請情報】                           │
│  │   FY2026予算 第1回     │ │  申請日: 2026/01/10                     │
│  │   鈴木太郎  01/11      │ │  申請者: 田中 一郎                      │
│  └─────────────────────────┘ │  部門: 営業1課                          │
│  ┌─────────────────────────┐ │  バージョン: FY2026予算 第1回           │
│  │ ○ 開発1課              │ │                                         │
│  │   FY2026見込 1月       │ │  【サマリ】                             │
│  │   山田花子  01/12      │ │  売上: 272,000,000円  原価: 114,953,600円│
│  └─────────────────────────┘ │  営業利益: 107,046,400円                │
│                               │                                         │
│                               │         [予算データを確認 →]           │
│                               │                                         │
│                               │  【コメント】                           │
│                               │  ┌─────────────────────────────────┐   │
│                               │  │                                 │   │
│                               │  └─────────────────────────────────┘   │
│                               │                                         │
│                               │      [差戻し]        [承認]             │
│                               │                                         │
└───────────────────────────────┴─────────────────────────────────────────┘
```

### UI特徴

| 要素 | 説明 |
|------|------|
| Split View | 左に一覧、右に詳細を同時表示 |
| ステッパー | 承認進捗を横一列で可視化。現在段階をハイライト |
| 検索・フィルター | 部門名、シナリオ種別で絞り込み |
| サマリ表示 | 詳細画面遷移前に概要を把握可能 |
| 即操作 | 一覧から選んで即承認/差戻し |

---

## 18. 一括承認

### 決定

**MVP外**。運用頻度が低いため、必要に応じてUI機能として後から追加。

---

## 関連ドキュメント

- `.kiro/specs/仕様概要/予算業務フロー.md` - 全体業務フロー
- `.kiro/specs/仕様検討/20260109_時点の仕様検討状況と残の概要.md` - 機能カバレッジ整理

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-15 | 初版作成（承認機能の基本設計検討） | Claude Code |
