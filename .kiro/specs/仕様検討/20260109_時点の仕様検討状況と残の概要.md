# EPM機能カバレッジ整理

## 検討日

2026-01-09

## 参加者

- ユーザー
- Claude Code

## 検討背景

マスタと予算実績のファクト設計が一段落したタイミングで、EPMとしての基盤機能のカバレッジを整理。「数値を集めて予算実績管理運用する」という観点で、設計済み領域と未検討領域を明確化する。

---

## 1. 設計済み領域（エンティティ完備）

### 1.1 データ収集

| 機能 | エンティティ | 状態 |
|------|------------|------|
| 予算入力 | fact_amounts | ✅ |
| 見込入力 | fact_amounts (scenario_type='FORECAST') | ✅ |
| 実績取込（集約） | actual_import_staging → fact_amounts | ✅ |
| 実績取込（仕訳明細） | fact_journal_lines | ✅ |
| PJ予算入力 | fact_amounts (project_id) | ✅ |
| PJ見込外部取込 | budget_import_staging | ✅ |

### 1.2 予算編成・管理

| 機能 | エンティティ | 状態 |
|------|------------|------|
| 計画イベント管理 | plan_events | ✅ |
| バージョン管理 | plan_versions | ✅ |
| 科目予算設定 | subject_budget_settings | ✅ |
| 設定スナップショット | scenario_subject_settings | ✅ |
| 予算レイアウト | report_layouts, report_layout_lines | ✅ |
| 締め制御 | accounting_periods.close_status | ✅ |

### 1.3 組織・科目体系

| 機能 | エンティティ | 状態 |
|------|------------|------|
| 組織版管理 | organization_versions, departments | ✅ |
| 部門追跡 | department_stable_id | ✅ |
| 科目マスタ | subjects | ✅ |
| 科目集計定義 | subject_rollups | ✅ |
| 連結COA | group_subjects, group_subject_mappings | ✅ |

### 1.4 分析軸

| 機能 | エンティティ | 状態 |
|------|------------|------|
| ディメンション定義 | dimensions | ✅ |
| グループ（経営粒度） | dimension_values | ✅ |
| Leaf（大量コード） | dimension_members | ✅ |
| Fact連携 | fact_dimension_links | ✅ |
| 軽量タグ | fact_journal_lines.tag1〜tag5 | ✅ |

### 1.5 配賦

| 機能 | エンティティ | 状態 |
|------|------------|------|
| 配賦イベント | allocation_events | ✅ |
| 多段階ステップ | allocation_steps | ✅ |
| 配賦先定義 | allocation_step_targets | ✅ |
| 配賦ドライバ | allocation_drivers | ✅ |

### 1.6 プロジェクト

| 機能 | エンティティ | 状態 |
|------|------------|------|
| PJマスタ | projects | ✅ |
| PJグループ | project_groups, project_group_members | ✅ |
| PJ予算集約 | source_type='PROJECT_ROLLUP' | ✅ |

### 1.7 指標計算

| 機能 | エンティティ | 状態 |
|------|------------|------|
| 財務指標（式） | metrics | ✅ |
| 指標構成要素 | metric_components | ✅ |

---

## 2. 対応可能だが画面・運用設計が残る領域

### 2.1 差異分析

**エンティティ: ✅ 基盤完備**

```
差異分析に必要なデータ構造は整っている:
- 予算: fact_amounts WHERE scenario_type='BUDGET'
- 見込: fact_amounts WHERE scenario_type='FORECAST'
- 実績: fact_amounts WHERE scenario_type='ACTUAL'
- 前年: accounting_period_id で前年期間を指定

差異計算例:
SELECT
  budget.amount - actual.amount AS variance_amount,
  (budget.amount - actual.amount) / budget.amount AS variance_rate
FROM fact_amounts budget
JOIN fact_amounts actual ON ...
```

**残タスク**: レポート・View・画面の設計（表現の話）

---

### 2.2 KPI入力

**エンティティ: ✅ 準拠済み**

```
subjects テーブル:
- subject_type = 'KPI' で KPI 科目を定義
- aggregation_method (SUM/EOP/AVG) で集計方法を指定

fact_amounts:
- subject_id に KPI 科目を指定
- amount に KPI の値を保存
- scenario_type で予算/見込/実績を区別

report_layouts:
- layout_type = 'KPI' で KPI 用レイアウトを作成
```

**残タスク**: KPI入力画面、KPIレイアウト設計

---

### 2.3 シミュレーション・What-If

**エンティティ: ✅ 対応可能**

```
方法1: 別バージョンとして保存
  plan_versions に「シミュレーション用」バージョンを作成
  fact_amounts に通常通り保存

方法2: 一時領域（保存しない）
  画面上でのみ計算、DBに書かない
  → UI実装の話
```

**残タスク**: シミュレーション用バージョンの運用ルール、UI設計

---

## 3. Phase 1 対応可能、必要に応じて後で拡張する領域

### 3.1 コメント・注釈

**現状**:
- `fact_amounts.notes` で1レコード単位のメモは可能

**検討ポイント**:

| 観点 | 現状 | 拡張案 |
|------|------|--------|
| 粒度 | 1行（科目×部門×月×DIM）単位 | 科目×月のセル単位コメント別テーブル |
| 用途 | 入力時のメモ | 差異理由説明、レポート注釈 |
| バージョン | notes はレコードに紐づく | コメント引継ぎルールが必要かも |

**結論**: Phase 1 は `fact_amounts.notes` で運用。不足を感じたら別テーブル追加（後付け可能）

---

### 3.2 データ検証・整合性チェック

**現状**:
- ステージングの `validation_status` で取込時検証は可能

**検討ポイント**:
- 科目間の整合性（BS貸借一致等）
- 前月比の異常値検知
- 必須入力のチェック
- 検証結果の記録

**結論**: ビジネスルールレベルの検証は必要に応じて設計

---

### 3.3 監査証跡（Audit Trail）

**現状**:
- `created_at` / `updated_at` はある

**検討ポイント**:
- 変更履歴の保持（before/after）
- 変更理由の記録
- 監査レポート出力

**結論**: 必要に応じて `fact_amounts_history` 等を追加（後付け可能）

---

## 4. 後付けで拡張可能な設計になっている領域

### 4.1 ワークフロー・承認

**現状**:
- `plan_versions.status` (DRAFT/SUBMITTED/APPROVED/FIXED) で簡易的な状態管理は可能

**後付け拡張**:
```
追加するもの:
- approval_routes（承認ルート定義）
- approval_histories（承認履歴）
- plan_versions との FK

既存テーブルの変更:
- 不要（fact_amounts, plan_events, plan_versions の構造変更なし）
```

**結論**: 別途検討。後付けでいける設計

---

### 4.2 為替・通貨管理

**現状**:
- `fact_amounts.currency_code` はある

**後付け拡張**:
```
追加するもの:
- exchange_rates（為替レートマスタ）
- 換算ロジック（月末/月中平均）
- 予算レート vs 実績レート

既存テーブルの変更:
- 軽微（rate適用日等の追加程度）
```

**結論**: 後回し。国内単体なら不要なケースも多い

---

## 5. サマリ

### 設計状況一覧

| 領域 | エンティティ | 画面/運用 | 優先度 |
|------|------------|----------|--------|
| データ収集 | ✅ 完備 | 設計中 | - |
| 予算編成 | ✅ 完備 | 設計中 | - |
| 見込管理 | ✅ 完備 | 設計中 | - |
| 実績管理 | ✅ 完備 | 設計中 | - |
| PJ管理 | ✅ 完備 | 設計中 | - |
| 配賦 | ✅ 完備 | 未着手 | 中 |
| 差異分析 | ✅ 完備 | 未着手 | 高 |
| KPI入力 | ✅ 完備 | 未着手 | 中 |
| シミュレーション | ✅ 対応可 | 未着手 | 低 |
| コメント | △ Phase1可 | 未着手 | 中 |
| データ検証 | △ Phase1可 | 未着手 | 中 |
| 監査証跡 | △ 後付け可 | 未着手 | 低 |
| ワークフロー | △ 後付け可 | 未着手 | 別途 |
| 為替 | △ 後付け可 | 未着手 | 後回し |

### 結論

**エンティティ設計としては、EPMの基盤機能はほぼカバーできている。**

残りは主に：
1. レポート・画面の設計（差異分析、KPI等）
2. 運用ルールの詳細化（シミュレーション、コメント等）
3. 必要に応じた拡張テーブル追加（ワークフロー、監査証跡等）

---

## 関連ドキュメント

- `.kiro/specs/entities/01_各種マスタ.md` - エンティティ定義
- `.kiro/specs/仕様概要/予算業務フロー.md` - 業務フロー全体像
- `.kiro/specs/仕様概要/予算入力機能.md` - 予算入力仕様
- `.kiro/specs/仕様概要/プロジェクト予算.md` - PJ予算仕様
