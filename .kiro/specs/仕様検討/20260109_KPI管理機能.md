# KPI管理機能 仕様検討

## 検討日

2026-01-09

## 参加者

- ユーザー
- Claude Code

## 検討背景

EPMの基盤機能として、財務予算に加えてKPI（非財務指標）の目標・実績管理機能を検討。既存のエンティティ設計でどこまで対応可能か、追加で必要な設計があるかを整理。

---

## 1. 基本方針

### 1.1 設計思想

**財務科目とKPIを統一的に管理する**

```
subjects テーブル
├── subject_type = 'FIN'  → 財務科目（売上、費用等）
└── subject_type = 'KPI'  → 非財務KPI（人員数、契約件数等）

fact_amounts テーブル
├── 財務データ（subject_type='FIN' の科目）
└── KPIデータ（subject_type='KPI' の科目）
```

### 1.2 確定事項

| 項目 | 決定 |
|------|------|
| KPI目標 | = 予算（fact_amounts.scenario_type='BUDGET' で管理） |
| KPI実績 | fact_amounts.scenario_type='ACTUAL' で管理 |
| KPI見込 | fact_amounts.scenario_type='FORECAST' で管理 |
| 画面構成 | 財務予算とは別画面（KPI専用画面） |
| 基本機能 | 財務予算入力と同等、差異分のみ個別対応 |
| ディメンション展開 | 必要（科目×部門×ディメンション1つ、財務と同じ仕組み） |
| PJモード | 不要 |

---

## 2. KPIの分類について

### 2.1 検討した分類

| 分類 | 例 | Phase 1 対応 |
|------|-----|-------------|
| 先行指標 / 遅行指標 | 商談件数(先行) / 売上(遅行) | 不要 |
| 結果指標 / プロセス指標 | 売上達成率 / 営業訪問数 | 不要 |
| 入力KPI / 計算KPI | 人員数 / 一人当り売上 | metrics で対応可 |

### 2.2 決定

**Phase 1 では分類ラベルは設けない。**

- 必要を感じたら後付けで subjects にカラム追加
- または別途タグ機能で対応

### 2.3 補足：結果指標 / プロセス指標とは

```
【結果指標】
= 最終的なアウトカム、達成したい結果
例: 売上、利益、契約件数、顧客満足度

【プロセス指標】
= 結果に至るまでの活動・プロセスを測る
例: 営業訪問数、提案件数、リード獲得数

関係性:
プロセス指標（先行）→ 結果指標（遅行）
営業訪問数 → 商談件数 → 受注件数 → 売上
```

---

## 3. KPIの階層構造

### 3.1 対応方針

**既存のエンティティで対応可能。**

```
【科目の階層】
subjects (subject_type='KPI')
├── subject_class='BASE'      : 入力用KPI
└── subject_class='AGGREGATE' : 集計用KPI

【集計定義】
subject_rollup_items で親子関係を定義

例:
  顧客満足度（AGGREGATE）
  ├── NPS（BASE）coefficient: +1
  ├── リピート率（BASE）coefficient: +1
  └── クレーム件数（BASE）coefficient: -1

【レイアウト】
report_layouts (layout_type='KPI')
report_layout_lines で表示順・階層を定義
```

### 3.2 決定

**追加エンティティ不要。財務科目と同じ仕組みを使用。**

---

## 4. 画面構成

### 4.1 検討した選択肢

| 選択肢 | メリット | デメリット |
|--------|---------|-----------|
| 財務と同じ画面（モード切替） | 画面数が少ない | 複雑化、権限分離困難 |
| 別画面 | シンプル、権限分離容易 | 画面数が増える |

### 4.2 決定

**別画面を採用。**

理由:
- 画面の責務が明確
- 権限分離が容易
- KPI向けに最適化可能（単位表示、集計方法等）
- 内部コンポーネントは共通化可能

### 4.3 画面構成

```
【入力系画面】
├── 部門予算入力        ← 財務科目 × 部門
├── PJ予算入力          ← 財務科目 × PJ
└── KPI目標入力         ← KPI科目 × 部門（別画面）

【共通点】
- シナリオ/バージョン選択
- 部門選択
- 科目×月グリッド
- 保存先は同じ fact_amounts
- ディメンション展開（科目×部門×ディメンション1つ）

【KPI固有の差異】
- 使用レイアウト: layout_type='KPI'
- 対象科目: subject_type='KPI'
- 単位表示: subjects.unit に応じて（人、件、%等）
- 集計表示: subjects.aggregation_method に応じて
- PJモードなし
```

### 4.4 画面イメージ

```
┌─────────────────────────────────────────────────┐
│ 【KPI目標入力】                                  │
├─────────────────────────────────────────────────┤
│ [シナリオ] 当初予算 ▼   [バージョン] 第1回 ▼    │
├─────────────────────────────────────────────────┤
│ [部門選択] 営業本部 ▼                           │
├─────────────────────────────────────────────────┤
│                                                  │
│  KPI項目      単位   4月    5月    6月   合計   │
│  ─────────────────────────────────────────────  │
│  契約件数     件     50     55     60    165   │
│  商談件数     件    120    130    140    390   │
│  訪問件数     件    200    220    240    660   │
│  顧客満足度   pt    4.2    4.3    4.3    -     │
│  人員数       人     25     25     26     -    │
│  ...                                            │
└─────────────────────────────────────────────────┘
```

---

## 5. KPI実績の入力方法

### 5.1 検討した方法

| 方法 | 想定用途 | Phase 1 |
|------|---------|---------|
| 手入力 | KPI目標入力と同じ形式 | ○ |
| CSV取込 | 人事システム等から（人員数など） | ○ |
| 自動計算 | 財務データから（一人当り売上など） | × |

### 5.2 決定

**Phase 1 は手入力 + CSV取込で対応。**

- 財務実績と同じ仕組み（staging → fact_amounts）
- 自動計算（財務連携）は Phase 2 以降

---

## 6. KPI固有の属性

### 6.1 既存の subjects カラムで対応

| カラム | 用途 | KPIでの使い方 |
|--------|------|--------------|
| measure_kind | 数値の種類 | AMOUNT / COUNT / WEIGHT / RATIO |
| unit | 単位 | 人 / 件 / pt / % |
| aggregation_method | 集計方法 | SUM / EOP / AVG / MAX / MIN |
| direction | 増減の良し悪し | higher_is_better / lower_is_better |
| allow_negative | 負値許容 | true / false |

### 6.2 aggregation_method の運用

| 集計方法 | 例 | 部門合計の計算 |
|----------|-----|---------------|
| SUM | 契約件数 | 子部門の合計 |
| EOP | 人員数 | 子部門の合計（期末残高） |
| AVG | 顧客満足度 | 子部門の平均 |

### 6.3 画面表示ルール

#### 単位表示

**単位列を表示する**（KPIは単位がバラバラなため必須）

```
KPI項目      単位   4月    5月    6月   年計
─────────────────────────────────────────────
契約件数     件     50     55     60    165
人員数       人     25     25     26     26
顧客満足度   pt    4.2    4.3    4.3   4.27
達成率       %      85     88     90     -
```

#### 合計列（年計列）の表示

aggregation_method に応じて表示を分ける:

| aggregation_method | 年計列の表示 | 例 |
|-------------------|-------------|-----|
| SUM | 合計値 | 契約件数: 165件 |
| AVG | 平均値 | 顧客満足度: 4.27pt |
| EOP | 期末値（最終月の値） | 人員数: 26人 |
| MAX/MIN | 非表示（-） | - |

### 6.4 決定

**追加カラム不要。既存の属性で十分。**

---

## 7. KPIと財務の連携

### 7.1 検討内容

KPIを使った財務計算（例: 人員数 × 単価 = 人件費）

### 7.2 決定

**Phase 1 では連携不要。独立して運用。**

- 必要になったら metrics（計算式）で対応可能
- labor_cost_rates（労務費予算単価）は既にある

---

## 8. エンティティ対応状況

### 8.1 既存エンティティで対応可能

| 機能 | 対応エンティティ | 状態 |
|------|-----------------|------|
| KPI科目定義 | subjects (subject_type='KPI') | ✅ 対応済 |
| KPI階層 | subject_rollup_items | ✅ 対応済 |
| KPI目標値 | fact_amounts (BUDGET) | ✅ 対応済 |
| KPI実績値 | fact_amounts (ACTUAL) | ✅ 対応済 |
| KPI見込値 | fact_amounts (FORECAST) | ✅ 対応済 |
| KPIレイアウト | report_layouts (layout_type='KPI') | ✅ 対応済 |
| KPI取込 | budget_import_staging / actual_import_staging | ✅ 対応済 |
| KPI計算式 | metrics (metric_type='KPI_METRIC') | ✅ 対応済 |

### 8.2 追加が必要なエンティティ

**なし。**

---

## 9. 残タスク

### 9.1 画面設計

| 画面 | 状態 |
|------|------|
| KPI目標入力画面 | 未着手 |
| KPI実績入力画面 | 未着手（目標入力と共通化検討） |
| KPIレイアウト管理画面 | 未着手（財務レイアウトと同等） |

### 9.2 運用設計

| 項目 | 状態 |
|------|------|
| KPIマスタの初期設定フロー | 未着手 |
| KPI取込のCSVフォーマット | 未着手 |

---

## 10. 決定事項まとめ

| 項目 | 決定内容 |
|------|---------|
| データ構造 | 財務と統合（subjects + fact_amounts） |
| KPI分類ラベル | Phase 1 不要、後付け可 |
| KPI階層 | 既存の rollup で対応 |
| 画面構成 | 別画面（財務と分離） |
| ディメンション展開 | 必要（科目×部門×ディメンション1つ、財務と同じ仕組み） |
| PJモード | 不要 |
| 単位表示 | 単位列を表示（subjects.unit を使用） |
| 年計列表示 | aggregation_method に応じて合計/平均/期末値を表示 |
| KPI実績入力 | 手入力 + CSV取込 |
| 財務連携 | Phase 1 不要、独立運用 |
| 追加エンティティ | 不要（subjects.unit は既存） |

---

## 関連ドキュメント

- `.kiro/specs/entities/01_各種マスタ.md` - subjects, fact_amounts 等
- `.kiro/specs/仕様検討/20260109_予算入力機能.md` - 財務予算入力
- `.kiro/specs/仕様概要/予算入力機能.md` - 財務予算入力仕様
