# データ取込・締処理・権限設計 レビュー結果

**レビュー日**: 2026年1月20日
**対象**: データ取込機能、月次締処理、権限・マルチカンパニー設計、承認ワークフロー
**記録者**: 小泉

---

## 1. データ取込機能

### 1.1 取込処理方式

| 項目 | 決定事項 | 備考 |
|------|---------|------|
| 処理方式 | **DELETE-INSERT と UPSERT の両方を用意** | ユースケースに応じて選択可能 |
| 調整行 | 画面から追加する | 取込ではなく手動入力 |
| 取込対象月 | 単月・複数月どちらも対応 | 複数月一括取込も可能とする |

### 1.2 取込対象シナリオ

| シナリオ | 取込対応 | SJS対応 | 備考 |
|---------|---------|---------|------|
| 予算（BUDGET） | ✅ | ✅ | 入力・取込・SJS対応 |
| 見込（FORECAST） | ✅ | ✅ | 入力・取込・SJS対応 |
| 実績（ACTUAL） | ✅ | ✅ | 入力・取込・SJS対応 |
| 中期経営計画（MTP） | ❌ | ✅ | 基本入力・SJS貼り付けのみ |
| 予算ガイドライン（GUIDELINE） | ❌ | ✅ | 基本入力・SJS貼り付けのみ |

### 1.3 調整入力

| 項目 | 決定事項 |
|------|---------|
| 対象 | **実績のみ** |
| コメント | 調整入力時にコメント入力可能とする |

### 1.4 集計科目の入力制御

| 項目 | 決定事項 |
|------|---------|
| 実績 | 集計科目への取込は**常に不可**（通常科目での取込のみ） |
| 予算・見込 | 集計科目マスタで「積み上げ入力」か「集計上位で入力」を選択可能 |
| 制約 | 予算と見込の入力階層は**同一**とする（予算は積み上げ、見込は集計、というパターンは不可） |

### 1.5 取込履歴・テンプレート

| 機能 | 決定事項 | 優先度 |
|------|---------|--------|
| 取込履歴データのDL | 対応する | Phase 1 |
| マッピング自動検出 | 対応する | Phase 2 |
| デフォルトテンプレートDL | 対応する | Phase 1 |
| テンプレート管理場所 | **会社ごとにマッピングを保持** | - |

### 1.6 マッピング設定UI（検討事項）

以下の方式を検討中：

1. **レポート定義マスタ方式**: マスタ画面でマッピング定義を管理
2. **OBER風UI**: 視覚的なマッピング設定
3. **ステージング環境でのVisualマッピング**: ステージングにファイル添付 → EPM側とのマッピング設定 → 標準フォーマットとして保存

**推奨**: ステージング環境でのVisualマッピング方式（開発難易度を考慮して最終決定）

### 1.7 プレビュー機能

```
【取込フロー】
1. ファイルアップロード
2. マッピング適用
3. プレビュー表示（予算入力画面形式）
   └─ このタイミングでマスタ存在チェック実施
4. 確定・登録
```

### 1.8 グリッドライブラリ

| 項目 | 決定事項 | 備考 |
|------|---------|------|
| 入力画面 | **AG Grid を検討** | SJSではなくAG Gridの方が良い可能性 |
| 表示 | カラー設定でわかりやすくする | - |

---

## 2. バージョン管理

### 2.1 イベントのバージョン管理

| シナリオ | 明示的Ver管理 | 備考 |
|---------|--------------|------|
| 予算（BUDGET） | ✅ あり | 業務的に明示的に画面から登録 |
| 見込（FORECAST） | ❌ なし | - |
| 実績（ACTUAL） | ❌ なし | - |

### 2.2 予算バージョン登録

| 項目 | 決定事項 |
|------|---------|
| 登録方法 | 画面から明示的に登録（UIが現状ないため追加必要） |
| 必要画面 | 予算バージョン登録・管理画面を追加 |

---

## 3. 月次締処理

### 3.1 締ステータス

| ステータス | 説明 | 入力可否 | 取込可否 | 配賦可否 |
|-----------|------|---------|---------|---------|
| 未締 | 初期状態 | ✅ 可 | ✅ 可 | ✅ 可 |
| 仮締 | 一時的なロック | ❌ 不可 | ❌ 不可 | ❌ 不可 |
| 本締 | 完全確定 | ❌ 不可 | ❌ 不可 | ❌ 不可 |

### 3.2 仮締の扱い

| 項目 | 決定事項 |
|------|---------|
| 仮締の機能 | **入力許可のON/OFFのみ**（具体的な処理なし） |
| 検討事項 | 仮締という概念自体が不要かもしれない |
| 入力許可切り替え | 再度入力したい場合は「入力許可をON」に戻す |

### 3.3 本締の挙動

| 項目 | 決定事項 |
|------|---------|
| 本締後の操作 | **一切不可**（入力・取込・配賦すべて不可） |
| 本締時のアラート | 「配賦が終わっていないけど良いですか？」の確認表示 |
| 不可逆性 | 本締後は戻せない |

### 3.4 配賦処理との関係

| 項目 | 決定事項 |
|------|---------|
| 配賦処理の実行場所 | **締画面からキック可能**（結果のVIEWは遷移先で表示） |
| 締画面との連動 | **不要**（配賦処理は独立） |
| 集計処理 | 別途実施しない |
| 配賦後の状態 | 配賦実行で自動的に入力不可（仮締扱い）とする案あり |

### 3.5 配賦処理の運用フロー

```
1. 配賦ドライバー（実績用）を変更・登録
2. 配賦処理を実行
3. レポート機能で結果確認
4. 修正が必要な場合 → 配賦を再実行
5. 問題なければ本締へ
```

---

## 4. データアーカイブ（検討事項）

### 4.1 本締後データの扱い

| 方式 | 説明 | 考慮事項 |
|------|------|---------|
| テーブル分離 | FIX側のテーブルに列志向でアーカイブ | JOINの考慮が必要（4月FIX + 5月以降未FIX の年間データ参照時） |
| 年単位アーカイブ | 年度の最終月が本締めになったらアーカイブ | 年度更新タイミングと連動 |

### 4.2 会計年度管理

| 項目 | 決定事項 |
|------|---------|
| 現在の会計年度 | **属性として保持が必要** |
| 会計年度設定 | 4月-3月、3月-2月 など設定可能 |
| 年度更新時のアーカイブ | 検討事項（いったん保留） |

### 4.3 ファクトと明細の持ち方

| 項目 | 決定事項 |
|------|---------|
| 設計タイミング | **後で詳細・エンティティを検討** |
| 構成 | ファクト（集計）と明細（仕訳）の分離を検討 |

---

## 5. マルチカンパニー・権限設計

### 5.1 URL・テナント構成

| 項目 | 決定事項 |
|------|---------|
| URL | **テナント単位** |
| マルチカンパニーフラグ | テナントレベルで保持 |
| メールアドレス | テナント内で一意 |

### 5.2 ログイン・認証

| 項目 | 決定事項 |
|------|---------|
| ログイン画面 | 会社選択 → ID → PASS の入力（または会社選択なし） |
| メールアドレス | 取得されている前提 |
| 会社切り替え | メールアドレスがテナント内一意なら会社選択不要 |

### 5.3 データ閲覧権限

| 項目 | 決定事項 |
|------|---------|
| 見れる部門の管理 | **コントロール部門を別で保持**（OBPMのような方式） |
| 複数会社のデータ閲覧 | 各会社ごとに社員マスタを登録（個社ごとのメールアドレス取得） |
| 連結レベルの閲覧 | 連結機能への権限で制御 |

### 5.4 マルチカンパニー時の会計月度

| ケース | 対応方針 |
|--------|---------|
| カンパニーごとに会計月度が異なる | 月度IDで結合して対応 |
| 連結合算の見方 | 3-4-5月と1-2-3月を合わせるか、同じ月度で見るか選択可能（月度IDが必須） |

### 5.5 統制・権限の見せ方

| 項目 | 決定事項 |
|------|---------|
| 会社の統制上の見せ方・制御 | **企画（森田くん）のレビューを織り込む** |

---

## 6. 承認ワークフロー

### 6.1 承認対象

| シナリオ | 承認対象 | 備考 |
|---------|---------|------|
| 予算（BUDGET） | ✅ | - |
| 見込（FORECAST） | ✅ | - |
| 実績（ACTUAL） | ❌ | 不要 |

### 6.2 承認段階設定

| 項目 | 決定事項 |
|------|---------|
| 承認段階数 | **5段階固定** |
| 代理承認者 | 各段階ごとに**1人だけ**選択可能 |
| 設定場所 | 部門ごとに設定 |

### 6.3 必要な追加画面

| 画面 | 用途 |
|------|------|
| 承認者設定画面 | 部門ごとの承認者・代理承認者を設定 |
| 各部予算登録・完了状況一覧画面 | 予算登録の進捗を一覧で確認 |

### 6.4 申請者向け機能

| 機能 | 説明 |
|------|------|
| 画面閲覧リンク | 申請者がリンクをクリックすると対象画面を閲覧可能 |

### 6.5 通知設定

| 項目 | 検討事項 |
|------|---------|
| 通知用メールアドレス | 専用のメールアドレスを持つか検討 |
| 承認者データ取込 | 部門ごとに承認者を設定する場合、データ取込の対応が必要 |

---

## 7. 既存仕様への影響・追加検討事項

### 7.1 追加が必要な画面

| 画面 | 用途 | 優先度 |
|------|------|--------|
| 予算バージョン登録・管理画面 | 予算Verの明示的な登録 | 高 |
| 承認者設定画面 | 部門ごとの承認者設定 | 高 |
| 各部予算登録・完了状況一覧画面 | 予算登録進捗の可視化 | 中 |
| マッピング設定画面 | 取込時のマッピング定義 | 中 |

### 7.2 追加が必要なエンティティ属性

| テーブル | 追加属性 | 用途 |
|---------|---------|------|
| companies | current_fiscal_year | 現在の会計年度 |
| companies | fiscal_year_start_month | 会計年度開始月（4月なら4） |
| employees | control_department_ids[] | コントロール部門（閲覧可能部門） |
| subjects | input_level_type | 積み上げ/集計上位 入力の選択 |

### 7.3 保留事項

| 項目 | 理由 |
|------|------|
| 会計年度変更時の処理 | 複雑なため保留（GRは可能） |
| ファクト・明細の詳細設計 | 後で詳細を検討 |
| データアーカイブ方式 | JOINの影響を考慮して検討継続 |

---

## 8. 次のアクション

1. **企画レビュー**: 会社統制・権限の見せ方について森田くんのレビューを実施
2. **エンティティ更新**: 上記の追加属性を entities ドキュメントに反映
3. **画面設計**: 追加が必要な画面のワイヤーフレーム作成
4. **マッピング設定UI**: 開発難易度を考慮して方式を最終決定
5. **AG Grid評価**: SJS vs AG Grid の比較検証

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-20 | 初版作成（レビュー結果の整理） | Claude Code |




## XX. 整理のもととなったメモ

- 取込処理→DELINとUPSERT両方用意する。調整行は画面で追加する。
- 見込と実績を単月づつの取込にするか、一気に複数月を取り込みできるようにするか。
  （取込みできてもいいかも）
- 中計ー実績まで入力・取込機能の各画面はSJS対応の予定　取込に関しては、予算・見込・実績だけ。（ちゅうけい、ガイドラインは基本入力、SJSはりつけ）
- 調整入力いれれたら、コメント入力できたほうがいい
- イベントの明示的なVer管理は、予算だけの予定
- 予算のVerは業務的に明示的に画面から登録する（UIが今ないので追加必要）
- 取り込みした履歴データはDLできたほうがいい
- 取り込みマッピングの自動検出は２次かな
- テンプレートをどこでもつのか。会社ごとにマッピングをおいておく。
- 開発難易度応じて検討、ステージングに添付して、EPM側とのマッピングをすると、今後標準フォーマットとして保存管理されるのが、一番いい。
- 最初の紐付けの設定をどういうUIでどこでやるか。
　　→レポート定義マスタみたいなのをもつか　OBERみたいなUIか？ステージング環境でVisualマッピングできるようにするか。
- デフォルトテンプレートをDLできるようにする。
- 入力テンプレート、入力画面　SJS 表のカラーをつけてわかりやすくしておいたほうがいい
- プレビュー機能ー取り込みしたらマッピングされた状態で、それでOKだったら、予算入力画面に遷移してプレビューがみれる。みたいな。
- プレビューのタイミングでマスタとの存在チェックする必要がある
- SJSでなくAGGridのほうがいいかも。入力画面も
- 集計科目は、常に実績は通常科目での取り込みのみ。選択不可
  →予算見込を積み上げか集計上位で入力するかどうかを集計科目のマスタで選べる（予算は積み上げ、見込みは集計で　というのはえらべない。予算と見込みのいれかたの階層は一緒しかだめ）
- 調整入力は実績のみ
- 締ステータスは、未締・仮締・本締とある。
- 仮締・本締がされている場合は、見込・実績の入力はその対象月は入力できない。
- 本締は、もう何もできない。仮締は再実行、入力可か不可だけの機能でいいのでは（具体的な処理がなければ）本締されると、もう入力もとりこみもなにもできない
- 仮締めという概念がいらないのでは。
- 配賦処理をどうするか。入力ふかだったら、配賦処理もできない。もう一回処理したいなら、入力許可をONにして。
- 配賦処理は、締画面とは連動しなくていいのでは。集計処理なども別途しない
- 本締の時に「配布おわってないけどいいですか？」のアラートは必要
- ファクト（集計）と明細（仕分け）の持ち方は、あとで詳細・エンティティ考える
- 完全確定した本締後のデータは、テーブルは分ける形でFIX側のテーブルに列志向でデータをアーカイブするか？　4月はFIX5月以降はまだ　のときに年でデータみるときなのどJOINの考慮が必要。年単位でFIXしたらアーカイブするとか。
- 今の会計年度がいつか　という属性を持つ必要がある。年度更新したタイミングでアーカイブするか？　とか。
- 年度の最終月が本締めになったら、アーカイブするか？とか。
- 会計年度設定（4月ー3月、３ー２月）
- 本締め後にはかえれない。
- 配賦処理をどこでやるかきめないと（配布は独立する）
- 配賦処理の実行は月次締め画面でキックできてもいい。結果はのVIEWは遷移先で
- はいふしたら、配布後の状態が仮締めというあつかいでかってに入力不可になるとか。配布処理には配布のドライバーを（実績用）を配布前に変更・登録するシチュエーションがある
- 配布後にレポート機能で結果を確認して、もし修正が必要なら、もう一度配布をまわしなおす
- 会計年度がかわる場合の想定は、いったん保留。GRはできる
- カンパニーによって会計月度が違う場合の連結合算での見方についてある。
- ３４５と１２３なのか、３４５と３４５に合わすのか。どっちでもいいのか。月度IDで結合したらいけるかも月度IDが必須。
- データをみれる部門をどこでもつか。社員マスタにOBPMみたいにコントロール部門でもつか。
- 経営企画が親会社と子会社両方のデータを見たい場合には、それぞれの社員マスタを登録してもらう想定とする。ただし、その時にログインキー（アカウントID）になるメールアドレス
- 単体レベルで見たい場合には↑ 連結でまたいでみたいような機能は、その機能に権限があるかどうかとする。
　　→単体レベルで複数会社のアカウントを持つ場合、
- ログイン画面は、会社選択、ID、PASSで入力する想定
- 個社ごとのメールアドレスは取得してもらう想定。
- URL はテナント単位　マルチカンパニーするかどうかのフラグ
- メールアドレスは取得されている前提。会社選択なし。てなんとで一意のメールアドレス
- コントロール部門を別でもつ
- 会社の統制上のみれるみれないの見せ方や制御については企画（森田くん）のレビューを織り込む
- 申請者が見る画面
- リンクをとぶと画面がみれる
- 承認対象は、予算と見込（実績はいらないのでは）
- ５段階固定　５段階ごとに代理承認社も一人だけえらべる
- 承認者設定の画面が必要
- 通知設定用のメールアドレスをもつか
- 承認社を部門ごとに設定する場合のデータ取り込みは考えないといけないかも。
- 各部の予算登録・完了状況をみれる画面が必要では。
- 
