# 確度単位の入力・確度マスタ 仕様検討

## 検討日: 2026-01-12

## 概要

予算・見込入力において、金額とともに「確度」（確信度/確率）を入力・管理する機能。案件の成約確度や見込みの実現可能性を数値化し、リスク加味した着地予測を可能にする。

---

## 1. 確度管理の目的

### 1.1 ユースケース

1. **営業見込の確度管理**
   - 受注見込み: Aランク(90%) / Bランク(70%) / Cランク(50%) / Dランク(30%)
   - 確度加味した売上予測: 金額 × 確度 = 期待値

2. **予算策定の確度管理**
   - 確実な予算 vs 挑戦的な予算の識別
   - リスク分析用の情報

3. **プロジェクト収益の確度**
   - PJ受注確度
   - コスト発生確度

### 1.2 期待されるアウトプット

```
売上見込サマリー
─────────────────────────────────────────
          │ 金額     │ 確度   │ 期待値   │
案件A     │ 1,000万  │  90%   │   900万  │
案件B     │   500万  │  70%   │   350万  │
案件C     │   300万  │  50%   │   150万  │
─────────────────────────────────────────
合計      │ 1,800万  │   -    │ 1,400万  │

リスク考慮後の売上見込: 1,400万円
```

---

## 2. 設計方針の検討

### 2.1 確度の粒度

| 方式 | 説明 | 例 |
|------|------|-----|
| 科目×期間×確度 | セルごとに確度を持つ | 売上高 5月 = 1,000万(70%) |
| 明細行×確度 | 案件/PJごとに確度を持つ | 案件A = 500万(90%) |
| バージョン×確度 | 見込全体の確度 | 5月見込第1回 = 確度高 |

**推奨**: 明細行×確度（案件/PJ単位）が実用的

### 2.2 確度の表現方法

| 方式 | 説明 | 例 |
|------|------|-----|
| パーセンテージ | 0-100%の数値 | 70%, 80% |
| ランク | 離散的なランク | A/B/C/D |
| ランク+割合 | ランクに標準割合を紐付け | Aランク=90% |

**推奨**: ランク+割合（マスタ管理＋視認性）

---

## 3. エンティティ設計案

### 3.1 confidence_levels（確度マスタ）

```sql
CREATE TABLE confidence_levels (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid,  -- NULL=テナント共通
  level_code varchar(20) NOT NULL,  -- 'A', 'B', 'C', 'D', 'LOST'
  level_name varchar(100) NOT NULL,  -- 'Aランク（ほぼ確実）'
  level_name_short varchar(20),  -- 'A'
  probability_rate numeric(5,2) NOT NULL,  -- 0.90, 0.70, 0.50, 0.30, 0.00
  color_code varchar(7),  -- '#22C55E' (緑), '#EAB308' (黄), '#EF4444' (赤)
  sort_order int NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamptz NOT NULL,
  updated_at timestamptz NOT NULL,

  UNIQUE(tenant_id, COALESCE(company_id, '00000000-0000-0000-0000-000000000000'), level_code)
);
```

### 3.2 初期データ例

| level_code | level_name | probability_rate | color_code |
|------------|------------|------------------|------------|
| A | Aランク（ほぼ確実） | 90% | #22C55E (緑) |
| B | Bランク（見込み高） | 70% | #84CC16 (黄緑) |
| C | Cランク（五分五分） | 50% | #EAB308 (黄) |
| D | Dランク（可能性低） | 30% | #F97316 (橙) |
| E | Eランク（見込み薄） | 10% | #EF4444 (赤) |
| LOST | 失注・消滅 | 0% | #6B7280 (灰) |

### 3.3 fact_amounts への確度追加案

**案A: confidence_level_idを直接持つ**

```sql
ALTER TABLE fact_amounts ADD COLUMN confidence_level_id uuid;
ALTER TABLE fact_amounts ADD COLUMN confidence_adjusted_amount numeric(20,2);  -- 期待値
```

**案B: 別テーブルで管理**

```sql
CREATE TABLE fact_confidence_details (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  fact_amount_id uuid NOT NULL,  -- fact_amounts.id
  confidence_level_id uuid NOT NULL,
  original_amount numeric(20,2) NOT NULL,
  adjusted_amount numeric(20,2) NOT NULL,  -- = original × probability
  notes text,

  FOREIGN KEY (fact_amount_id) REFERENCES fact_amounts(id),
  FOREIGN KEY (confidence_level_id) REFERENCES confidence_levels(id)
);
```

---

## 4. 確度入力のUI設計案

### 4.1 案件/PJ単位での確度入力

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│ 見込入力 - PJ別モード                                                                            │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ プロジェクト   │ 確度  │ 5月    │ 6月    │ 7月    │ 通期   │ 期待値 │                           │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│ ▼ 売上高                                                                                         │
│   PJ-001 A社案件│ [A▼] │  500   │  500   │  500   │ 1,500  │ 1,350  │ (90%)                     │
│   PJ-002 B社案件│ [B▼] │  300   │  300   │  300   │   900  │   630  │ (70%)                     │
│   PJ-003 C社案件│ [C▼] │  200   │  200   │  200   │   600  │   300  │ (50%)                     │
│   └ 【小計】   │  -   │ 1,000  │ 1,000  │ 1,000  │ 3,000  │ 2,280  │                           │
│   PJ未割当     │  -   │  200   │  200   │  200   │   600  │   600  │ (確度なし=100%)           │
│ 【売上高計】   │  -   │ 1,200  │ 1,200  │ 1,200  │ 3,600  │ 2,880  │                           │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 確度サマリーパネル

```
┌────────────────────────────────────────────────────────────────┐
│ 確度別サマリー（売上高・通期）                                  │
├────────────────────────────────────────────────────────────────┤
│ 確度    │ 件数 │ 金額     │ 期待値   │ 構成比 │                │
│ Aランク │  3件 │ 1,500万  │ 1,350万  │  42%   │ ████████       │
│ Bランク │  5件 │   900万  │   630万  │  25%   │ █████          │
│ Cランク │  4件 │   600万  │   300万  │  17%   │ ███            │
│ Dランク │  2件 │   400万  │   120万  │  11%   │ ██             │
│ Eランク │  1件 │   200万  │    20万  │   6%   │ █              │
├────────────────────────────────────────────────────────────────┤
│ 合計    │ 15件 │ 3,600万  │ 2,420万  │ 100%   │                │
├────────────────────────────────────────────────────────────────┤
│ 予算    │  -   │ 3,000万  │    -     │   -    │                │
│ 達成率  │  -   │   120%   │   81%    │   -    │ ← リスク考慮後 │
└────────────────────────────────────────────────────────────────┘
```

### 4.3 確度マスタ管理画面

```
┌────────────────────────────────────────────────────────────────┐
│ 確度マスタ設定                        [+ 新規追加] [保存]      │
├────────────────────────────────────────────────────────────────┤
│ コード │ 名称                │ 確率   │ 色     │ 順序 │        │
├────────────────────────────────────────────────────────────────┤
│ A      │ Aランク（ほぼ確実） │  90%   │ ■緑   │  1   │ [編集] │
│ B      │ Bランク（見込み高） │  70%   │ ■黄緑 │  2   │ [編集] │
│ C      │ Cランク（五分五分） │  50%   │ ■黄   │  3   │ [編集] │
│ D      │ Dランク（可能性低） │  30%   │ ■橙   │  4   │ [編集] │
│ E      │ Eランク（見込み薄） │  10%   │ ■赤   │  5   │ [編集] │
│ LOST   │ 失注・消滅          │   0%   │ ■灰   │  6   │ [編集] │
└────────────────────────────────────────────────────────────────┘
```

---

## 5. 検討ポイント

### Q1. 確度はどの入力で使用するか？

| 入力種別 | 確度管理 | 備考 |
|---------|---------|------|
| 予算入力 | △ | オプション（挑戦予算の識別用） |
| 見込入力 | ◎ | メイン用途（案件確度管理） |
| 実績入力 | × | 不要（確定値） |

### Q2. 確度の入力粒度は？

| 粒度 | 適用場面 |
|------|---------|
| PJ/案件単位 | 営業見込み、PJ収益管理 |
| 科目×月単位 | 細かい管理が必要な場合 |
| 明細行単位 | ディメンション展開行ごと |

**推奨**: PJ/案件単位をベースとし、将来的に拡張可能に

### Q3. 確度なしの場合のデフォルトは？

| 選択肢 | 説明 |
|--------|------|
| 100%扱い | 確度未設定=確実とみなす |
| 別途フラグ | 確度管理対象外を明示 |
| 必須入力 | 確度入力を強制 |

**推奨**: 100%扱い（既存データとの互換性）

### Q4. 期待値の計算タイミングは？

| タイミング | 説明 |
|-----------|------|
| リアルタイム | 入力時に即時計算・表示 |
| 保存時 | 保存時に計算してDBに格納 |
| 集計時 | レポート表示時に計算 |

**推奨**: 保存時に計算（パフォーマンス考慮）

### Q5. 確度履歴の管理は必要か？

- 案件の確度推移を追跡したい場合
- 「先月Cランク → 今月Aランク」の変化を分析

---

## 6. BFF Contracts案

```typescript
// 確度レベル
interface BffConfidenceLevel {
  id: string;
  levelCode: string;
  levelName: string;
  levelNameShort: string;
  probabilityRate: number;  // 0.0 - 1.0
  colorCode: string;
  sortOrder: number;
}

// 確度マスタ取得
interface BffConfidenceLevelListRequest {
  companyId: string;
}

interface BffConfidenceLevelListResponse {
  levels: BffConfidenceLevel[];
}

// 確度付き見込セル
interface BffForecastCellWithConfidence {
  value: string;
  confidenceLevelId?: string;
  confidenceLevelCode?: string;
  adjustedValue?: string;  // 期待値
}

// 確度サマリー
interface BffConfidenceSummary {
  byLevel: {
    levelCode: string;
    levelName: string;
    count: number;
    totalAmount: string;
    expectedAmount: string;
    ratio: number;  // 構成比
  }[];
  totalAmount: string;
  totalExpectedAmount: string;
  budgetAmount?: string;
  achievementRate?: number;  // 予算に対する達成率
  riskAdjustedAchievementRate?: number;  // リスク考慮後達成率
}
```

---

## 7. Phase分け案

### Phase 1: 基本機能

- [ ] confidence_levels テーブル作成
- [ ] 確度マスタ管理画面
- [ ] fact_amounts への confidence_level_id 追加
- [ ] 期待値の自動計算

### Phase 2: UI統合

- [ ] 見込入力画面での確度入力
- [ ] 確度サマリーパネル
- [ ] 確度別フィルタリング

### Phase 3: 分析機能

- [ ] 確度推移グラフ
- [ ] ファネル分析
- [ ] 確度別予実対比

---

## 8. 決定事項

（QA壁打ち後に記録）

| 項目 | 決定内容 | 決定日 |
|------|---------|-------|
| - | - | - |

---

## 9. 次のアクション

1. [ ] 確度管理の適用範囲を決定（見込のみ？予算も？）
2. [ ] 入力粒度の決定（PJ単位？科目×月単位？）
3. [ ] エンティティ設計の確定
4. [ ] 確度マスタの初期データを決定
5. [ ] UI設計の詳細化

---

## 10. 関連仕様

- `.kiro/specs/仕様概要/見込入力機能.md` - 見込入力の基本仕様
- `.kiro/specs/仕様概要/プロジェクト予算.md` - PJ別入力
- `.kiro/specs/entities/01_各種マスタ.md` - fact_amounts エンティティ
