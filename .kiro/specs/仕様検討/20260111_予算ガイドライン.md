# 予算ガイドライン 仕様検討

## 検討日時
2026-01-11

## 参加者
- ユーザー（プロダクトオーナー）
- Claude Code（ITアーキテクト）

## 背景

中期経営計画（MTP）の下位、年度予算（BUDGET）の上位に位置する「予算ガイドライン」機能の仕様を策定する。

既に決定済みの事項（中期経営計画QAより）：
- report_layouts.layout_type = 'GUIDELINE' で拡張
- 独立入力方式（中計からの自動コピーではない）
- ディメンション（事業部等）単位で登録可能

---

## Q&A

### Q1: 予算ガイドラインの基本的な位置づけ

予算ガイドラインは以下のような位置づけで認識していますが、認識合っていますか？

```
【計画階層】
中期経営計画（MTP）  ← 3〜5年、年度単位、戦略テーマ付き
    ↓ 参照
予算ガイドライン      ← 単年度、年度 or 半期単位？、経営からの指針
    ↓ 参照
年度予算（BUDGET）   ← 単年度、月次、部門別詳細
```

**確認ポイント：**
1. 予算ガイドラインの時間粒度は？（年度/半期/四半期）
2. 誰が入力する想定ですか？（経営企画/CFO/各事業部長）
3. どの程度の科目粒度ですか？（売上・利益のみ？PLフル？）

**回答：**
- 時間粒度: 年単位・半期・四半期すべて作成可能にしたい（実装コスト差がなければ）
- 入力者: 事業部長レベル、または経営企画。権限・ロール設計に準拠（検討中）
- 科目粒度: 主要なPL科目のみ。予算レイアウトから選択する形式。中計と同様の考え方

---

### Q1.5: 中計の科目選択方式の確認

中期経営計画では以下の設計でした：

```
【中期経営計画の科目設計】
- 対象: PL科目（売上・費用・利益）
- レイアウト: report_layouts.layout_type = 'MTP' で専用レイアウト
- 入力科目は「中計用レイアウト」で定義した科目のみ
```

予算ガイドラインも同様に：
- `report_layouts.layout_type = 'GUIDELINE'` で専用レイアウトを作成
- そのレイアウトに含まれるPL科目のみ入力対象

という方式でよいですか？

**回答：**
- OK。専用レイアウト方式で進める

---

### Q2: データ格納方式

予算ガイドラインのデータ格納について、2つの選択肢があります。

**【選択肢A】fact_amounts を共用（中計と同じ方式）**

```sql
fact_amounts
├── scenario_type = 'GUIDELINE'  ← 新規追加
├── plan_event_id → guideline_events.id を参照
├── subject_id
├── dimension_value_id（事業部等）
└── amount
```

メリット:
- 中計・予算・実績との横並び比較が容易
- 達成率計算のSQLがシンプル
- 既存設計との整合性

デメリット:
- scenario_type の種類が増える

**【選択肢B】専用テーブル guideline_amounts を新設**

```sql
guideline_amounts
├── guideline_event_id
├── subject_id
├── dimension_value_id
├── period_type (ANNUAL/HALF/QUARTER)
├── period_no (1, 2, ...)
└── amount
```

メリット:
- ガイドライン固有の属性を自由に追加可能

デメリット:
- 中計・予算との比較時にUNION必要
- テーブル増加

**推奨**: 選択肢A（fact_amounts共用）

中計で `scenario_type = 'MTP'` を追加したのと同様に、`scenario_type = 'GUIDELINE'` を追加する方式。統一性が高く、比較分析が容易です。

どちらがよいですか？

**回答：**
- 選択肢A（fact_amounts共用）で進める

---

### Q3: ガイドラインイベントの管理単位

中計では `mtp_events` を用意しました。ガイドラインも同様にイベント管理が必要です。

**質問: 既存の plan_events を使うか、専用テーブルを作るか？**

**【選択肢A】plan_events を拡張**

```sql
plan_events
├── scenario_type = 'GUIDELINE'
├── event_code = 'FY2026_GUIDELINE'
├── fiscal_year = 2026
└── period_type = 'ANNUAL' / 'HALF' / 'QUARTER'  ← 新規カラム追加
```

メリット:
- テーブル増加なし
- 年度予算と同じ管理体系

デメリット:
- plan_events が多目的になる
- period_type は BUDGET/FORECAST/ACTUAL では使わない

**【選択肢B】専用テーブル guideline_events を新設**

```sql
guideline_events
├── event_code = 'FY2026_GL_Q1'
├── event_name = 'FY2026 Q1ガイドライン'
├── fiscal_year = 2026
├── period_type = 'QUARTER'  (ANNUAL/HALF/QUARTER)
├── period_no = 1  (1, 2, 3, 4)
├── status = 'DRAFT' / 'CONFIRMED'
└── layout_id → report_layouts.id
```

メリット:
- ガイドライン固有の属性を自由に定義
- 中計(mtp_events)と同様のパターン

デメリット:
- テーブル増加

**推奨**: 選択肢B（guideline_events 新設）

理由:
1. 中計が `mtp_events` を持つのと同様、ガイドラインも専用イベントテーブルが自然
2. period_type/period_no はガイドライン固有の概念
3. plan_events は年度予算/見込/実績に特化させておく方が明確

どちらがよいですか？

**回答：**
- 選択肢B（guideline_events 新設）で進める。中計と同様のパターン

---

### Q4: ディメンション（事業部等）の扱い

ガイドラインは「事業部別」で登録したいとのことでした。

**質問: ディメンションの使い方について**

```
【想定する入力粒度】
全社 or 事業部（ディメンション値）単位

【例】
FY2026 Q1ガイドライン
├── 全社: 売上 100億、営業利益 10億
├── A事業部: 売上 40億、営業利益 5億
├── B事業部: 売上 35億、営業利益 3億
└── C事業部: 売上 25億、営業利益 2億
```

**確認ポイント:**

1. **全社とディメンション別は同時に入力？**
   - A) 全社のみ入力（ディメンション別はPhase 2）
   - B) ディメンション別のみ入力、全社は自動集計
   - C) 両方入力可能（全社も個別に入力、ディメンション別も入力）

2. **ディメンション軸は1つ固定？**
   - 既存設計では dimensions テーブルで複数軸を定義可能
   - ガイドラインで使う軸は「事業部」1つで十分？

**補足: 中計の現状設計**

中計では「組織粒度: 全社 + ディメンション（事業部等）」と記載しましたが、具体的なディメンション指定方法は未確定でした。ここで統一設計を決めたいです。

**【3つの設計オプション】**

**【A】イベント単位でディメンション軸を指定**

```sql
guideline_events
├── dimension_id → dimensions.id  ← イベント作成時に「どの軸で入力するか」を指定
└── ...

mtp_events
├── dimension_id → dimensions.id  ← 中計も同様
└── ...
```

- イベント作成時に「事業部軸」「地域軸」等を選択
- シンプルだが、イベントごとに軸が固定される

**【B】組織マスタに「中計/ガイドライン対象」フラグを持つ**

```sql
dimension_values（Group）
├── is_mtp_target: boolean      ← 中計入力対象か
├── is_guideline_target: boolean ← ガイドライン入力対象か
└── ...
```

- dimension_values（A事業部、B事業部等）に対象フラグを設定
- 軸の選択が不要、対象Groupを直接指定
- ただし、異なる軸（事業部と地域）を使い分けたい場合は困る

**【C】テナント/会社レベルで「中計用軸」「ガイドライン用軸」を設定**

```sql
companies
├── mtp_dimension_id → dimensions.id      ← 中計で使う軸
├── guideline_dimension_id → dimensions.id ← ガイドラインで使う軸
└── ...
```

- 会社設定で「うちの会社は事業部軸で中計を管理」と決める
- 全イベントで統一される（一貫性）

**推奨: 【A】イベント単位でディメンション軸を指定**

理由:
1. 柔軟性が高い（イベントごとに軸を変えられる）
2. 将来「地域別中計」「製品別ガイドライン」も対応可能
3. mtp_events / guideline_events に dimension_id を追加するだけでシンプル
4. 中計と同じパターンで統一できる

どれがベターですか？

**回答：**
- 上記の選択肢では不十分。もっと本質的に「組織単位で計画を作る」ことをモデリングしたい

---

### Q4.5: 組織単位での計画作成 - 本質的な設計検討

**問題の本質:**

中計やガイドラインは「ディメンション軸で展開する」というより、**組織の責任単位で作成する**ものです。

```
【現実の業務フロー】
1. 全社計画を経営企画が作成
2. 事業部別に責任者が計画を作成（事業部長）
3. 必要に応じて地域別・製品別に分解

→ これは「ディメンション軸を選ぶ」ではなく「どの組織階層で計画を持つか」の問題
```

**既存エンティティの再確認:**

```
【現状のモデル】
dimensions（軸定義）
├── 事業部
├── 地域
└── 製品カテゴリ

dimension_values（Group: 経営粒度の分類）
├── A事業部
├── B事業部
├── 北米
├── 欧州
└── ...
```

**課題:** dimension_values は「分析軸の値」であって「組織の責任単位」とは少し違う

---

**【設計オプション再検討】**

**【D】組織階層（Organization Hierarchy）を明示的にモデリング**

```sql
-- 組織ノード（責任単位）
organization_nodes
├── id
├── tenant_id
├── company_id
├── parent_node_id       ← 階層構造
├── node_type            ← 'COMPANY' / 'DIVISION' / 'DEPARTMENT' / 'REGION'
├── node_code
├── node_name
├── dimension_value_id   ← dimension_values への紐付け（任意）
├── is_mtp_unit: boolean         ← 中計作成単位か
├── is_guideline_unit: boolean   ← ガイドライン作成単位か
└── ...

-- 中計イベントは organization_node を参照
mtp_events
├── organization_node_id → organization_nodes.id  ← どの組織単位の中計か
└── ...

-- ガイドラインイベントも同様
guideline_events
├── organization_node_id → organization_nodes.id
└── ...
```

**メリット:**
- 「組織の責任単位」を明示的にモデリング
- 全社→事業部→地域 のような階層を表現可能
- 中計/ガイドラインの作成単位を組織ノード単位で制御
- dimension_values とは別の概念として管理

**デメリット:**
- 新しいテーブル追加
- departments との関係が複雑になる可能性

---

**【E】departments の拡張（既存モデル活用）**

実は departments 自体が組織階層を持っています（stable_id で版を跨いで追跡可能）。

```sql
-- departments を拡張
departments
├── (既存カラム)
├── is_mtp_unit: boolean         ← この部門で中計を作成するか
├── is_guideline_unit: boolean   ← この部門でガイドラインを作成するか
└── ...
```

**メリット:**
- 既存モデルの活用
- 部門マスタに集約されてわかりやすい

**デメリット:**
- departments は「予算入力単位」であり「経営計画単位」とは粒度が違うことがある
  - 例: 中計は事業部単位だが、予算は課単位
- dimension_values との関係が曖昧になる

---

**【F】ハイブリッド: dimension_values を「経営計画単位」として活用**

そもそも dimension_values は「経営粒度の分類（Group）」として設計されています。

```sql
-- dimension_values を拡張
dimension_values
├── (既存カラム)
├── planning_scope        ← 'MTP' / 'GUIDELINE' / 'BOTH' / NULL
└── ...

-- または専用の紐付けテーブル
planning_scope_assignments
├── dimension_value_id
├── scope_type            ← 'MTP' / 'GUIDELINE'
└── ...
```

**メリット:**
- dimension_values は既に「経営粒度」として設計されている
- A事業部、B事業部などが dimension_values として存在する
- 予算入力時のディメンション展開と一貫性がある

**デメリット:**
- dimension_values が「分析軸の値」と「計画作成単位」の二重の役割を持つ

---

**整理すると、本質的な問いは:**

1. **「経営計画を作る単位」と「予算を入力する単位」は同じか別か？**
   - 同じなら departments を拡張
   - 別なら別モデルが必要

2. **「経営計画を作る単位」と「分析軸の値（dimension_values）」は同じか別か？**
   - 同じなら dimension_values を活用
   - 別なら organization_nodes のような専用モデル

**ご意見をお聞かせください:**
- 中計/ガイドラインを作成する「単位」は何だと考えますか？
  - 部門（departments）？
  - 事業部（dimension_values の一種）？
  - 別の概念（責任ユニット）？

**回答：**
- EPM/経営管理の本質から考えたい。プロの視点でどう思うか？

---

### Q4.6: EPM/経営管理の本質からの設計考察

**ITアーキテクトとしての見解:**

EPM（Enterprise Performance Management）の本質は「**経営責任単位（Responsibility Center）での計画・実績管理**」です。

```
【EPMの基本構造】
                        ┌─────────────────┐
                        │   経営責任単位    │
                        │ (Responsibility  │
                        │    Center)       │
                        └────────┬────────┘
                                 │
        ┌────────────────────────┼────────────────────────┐
        ▼                        ▼                        ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│ Cost Center   │      │ Profit Center │      │Investment Center│
│ (原価責任)     │      │ (利益責任)     │      │ (投資責任)      │
│ 例: 製造部門   │      │ 例: 事業部     │      │ 例: 本社/持株   │
└───────────────┘      └───────────────┘      └───────────────┘
```

**EPMにおける「計画作成単位」の本質:**

| 計画種別 | 責任の所在 | 典型的な単位 | 責任者 |
|----------|-----------|-------------|--------|
| 中期経営計画 | 投資・戦略責任 | 全社、事業セグメント | CEO、事業部長 |
| 予算ガイドライン | 利益責任の方針 | 事業部、地域 | CFO、事業部長 |
| 年度予算 | 収益・費用責任 | 部門、課 | 部門長、課長 |
| 見込 | 着地責任 | 部門 | 部門長 |

---

**重要な気づき:**

1. **departments（部門）≠ 経営責任単位**
   - departments は「予算入力の箱」であり「組織図上の単位」
   - 経営責任単位は「誰が何の責任を持つか」という概念
   - 例: 営業1課・営業2課（departments）→ 営業本部（利益責任単位）

2. **dimension_values ≒ 経営責任単位になりうる**
   - dimension_values は「経営粒度のGroup」として設計済み
   - 「A事業部」「北米地域」などは経営責任単位になりうる
   - **ただし、現状のdimension_valuesには「責任の種類」や「階層」の概念がない**

3. **IRセグメント（開示セグメント）との関係**
   - IRセグメントは dimension_values の一種として設計済み
   - 中計は基本的にIRセグメント単位で開示される
   - **IRセグメント = 経営責任単位の可能性が高い**

---

**設計方針の提案:**

**【G】dimension_values を「経営責任単位」として正式に位置づける**

```sql
dimension_values
├── (既存カラム)
├── responsibility_type     ← 'COST' / 'PROFIT' / 'INVESTMENT' / NULL
├── is_planning_unit: boolean  ← 計画作成単位か（中計/ガイドライン）
├── planning_owner_id       ← 責任者（employees.id）
└── ...
```

**考え方:**
- dimension_values は既に「経営粒度のGroup」として設計されている
- これに「責任の種類」「計画作成単位かどうか」を追加する
- 「A事業部」は dimension_values であり、かつ「利益責任単位」であり、かつ「中計/ガイドライン作成単位」

**fact_amounts との関係:**
```sql
fact_amounts
├── dimension_value_id   ← どの経営責任単位のデータか
├── scenario_type        ← MTP / GUIDELINE / BUDGET / FORECAST / ACTUAL
└── amount
```

---

**【H】departments の階層を活用（シンプル案）**

現状の departments は階層（parent_department_id）を持てる設計です。

```sql
departments
├── parent_department_id  ← 既存の階層
├── department_level      ← 'COMPANY' / 'DIVISION' / 'DEPARTMENT' / 'SECTION'
├── is_planning_unit      ← 計画作成単位か
└── ...
```

**考え方:**
- departments の上位階層（本部・事業部レベル）を計画作成単位とする
- シンプルだが、departments が「予算入力単位」と「計画単位」の二重役割になる

---

**私の推奨: 【G】dimension_values を経営責任単位として活用**

**理由:**

1. **概念の分離が明確**
   - departments = 予算入力の箱（月次・科目別の詳細入力）
   - dimension_values = 経営責任単位（中計・ガイドラインの計画単位）

2. **既存設計との整合性**
   - dimension_values は「経営粒度のGroup」として設計済み
   - IRセグメントも dimension_values として管理
   - fact_amounts はディメンション展開で dimension_values を参照

3. **柔軟性**
   - 「事業部」「地域」「製品」など、異なる軸の経営責任単位を統一的に扱える
   - 将来的にマトリクス組織（事業×地域）にも対応可能

4. **実務との一致**
   - 中計やガイドラインは「A事業部の中計」「北米地域のガイドライン」という形で作成される
   - これは dimension_values 単位での管理と自然に一致する

---

**【確認】この方向性で進めてよいですか？**

「dimension_values を経営責任単位として活用し、計画作成単位のフラグを追加する」

**回答：**
- 設定が面倒、実装が複雑になるリスクは？

---

### Q4.7: 実装・運用の現実性チェック

**正直な評価:**

ご指摘の通り、【G】案には以下のリスクがあります。

**【G案の問題点】**

| 観点 | 問題 |
|------|------|
| **設定の手間** | 「A事業部は計画単位です」「B事業部も計画単位です」と1つずつ設定が必要 |
| **初期設定** | dimension_values を登録後、さらに is_planning_unit を設定する2段階作業 |
| **責任者設定** | 事業部ごとに planning_owner_id を設定…現実的にはやらない可能性 |
| **実装複雑性** | 中計/ガイドライン入力時に「計画単位のdimension_valuesを取得」するロジックが必要 |
| **概念の混乱** | dimension_values が「分析軸の値」と「計画単位」の二重の意味を持つ |

---

**もっとシンプルな案を考え直す:**

**【I】イベント単位で dimension_id を指定 + 全値を対象（最シンプル案）**

```sql
mtp_events / guideline_events
├── dimension_id → dimensions.id  ← 「事業部」軸を選ぶだけ
└── ...

-- 入力時:
-- 「事業部」軸に属する全ての dimension_values が入力対象になる
-- A事業部、B事業部、C事業部 すべてが自動的に選択肢になる
```

**運用イメージ:**
1. 中計イベント作成時に「事業部」軸を選択
2. A事業部、B事業部、C事業部 が自動的に入力対象になる
3. 個別のフラグ設定は不要

**メリット:**
- 設定がほぼ不要（軸を選ぶだけ）
- 実装がシンプル（dimension_id で dimension_values を取得するだけ）
- 既存のディメンション設計をそのまま活用

**デメリット:**
- 「A事業部だけ中計対象、B事業部は対象外」ができない
- ただし、これは本当に必要か？

---

**【J】さらにシンプル: 会社レベルで「中計/ガイドライン用の軸」を固定**

```sql
companies
├── planning_dimension_id → dimensions.id  ← 「うちは事業部軸で計画を作る」
└── ...
```

**運用イメージ:**
1. 会社設定で「事業部」軸を1回設定するだけ
2. 全ての中計・ガイドラインがこの軸で作成される
3. イベント作成時の選択も不要

**メリット:**
- 設定が1回だけ（会社設定で完了）
- イベント作成時に軸を選ぶ必要がない
- 一貫性が保たれる

**デメリット:**
- 「今回の中計は地域軸で作りたい」ができない
- ただし、これは本当に必要か？

---

**私の再考後の推奨: 【J】会社レベルで軸を固定**

**理由:**

1. **現実の運用**: 多くの企業は「うちは事業部軸で管理」と決まっている。イベントごとに軸を変えるケースは稀
2. **設定の手間**: 会社設定で1回だけ
3. **実装のシンプルさ**: companies.planning_dimension_id を参照するだけ
4. **将来の柔軟性**: 必要になったら【I】案（イベント単位で上書き可能）に拡張できる

```sql
-- 最終案
companies
├── planning_dimension_id → dimensions.id  ← 計画で使う軸（事業部等）
└── ...

-- 中計/ガイドライン入力時
-- 1. companies.planning_dimension_id を取得
-- 2. その dimension_id に属する dimension_values を全て入力対象に
```

---

**比較まとめ:**

| 案 | 設定の手間 | 実装複雑度 | 柔軟性 |
|----|-----------|-----------|--------|
| 【G】dimension_values にフラグ | 高（1つずつ設定） | 中 | 高 |
| 【I】イベント単位で軸指定 | 低（イベント作成時に選択） | 低 | 中 |
| 【J】会社レベルで軸固定 | 最低（1回設定） | 最低 | 低（だが十分） |

**どちらがよいですか？**

**回答：**
- イベント単位で軸指定とは具体的に何を指定するのか？

---

### Q4.8: 「軸を指定する」の具体的な意味

**既存のディメンション設計の確認:**

```
dimensions（軸の定義）
├── id: DIM-001, dimension_name: "事業部"
├── id: DIM-002, dimension_name: "地域"
└── id: DIM-003, dimension_name: "製品カテゴリ"

dimension_values（軸に属する値 = Group）
├── dimension_id: DIM-001（事業部）
│   ├── id: DV-001, value_name: "A事業部"
│   ├── id: DV-002, value_name: "B事業部"
│   └── id: DV-003, value_name: "C事業部"
│
├── dimension_id: DIM-002（地域）
│   ├── id: DV-101, value_name: "北米"
│   ├── id: DV-102, value_name: "欧州"
│   └── id: DV-103, value_name: "アジア"
│
└── dimension_id: DIM-003（製品カテゴリ）
    ├── id: DV-201, value_name: "製品A"
    └── id: DV-202, value_name: "製品B"
```

---

**【I案】イベント単位で軸指定 の具体例:**

```sql
-- 中計イベント作成時
INSERT INTO mtp_events (
  event_code,
  event_name,
  dimension_id,      ← ここで「事業部」軸を選ぶ = DIM-001
  ...
) VALUES (
  'MTP2026',
  '2026年中期経営計画',
  'DIM-001',         ← dimensions.id を指定
  ...
);
```

**入力画面での動作:**
1. `mtp_events.dimension_id = DIM-001` を取得
2. `dimension_values WHERE dimension_id = DIM-001` を取得
3. → A事業部、B事業部、C事業部 が入力対象として表示される

```
【中計入力画面】
┌─────────────────────────────────────────────┐
│ 2026年中期経営計画                           │
├─────────────────────────────────────────────┤
│ [全社]         売上 ___億  営業利益 ___億   │
│ [A事業部]      売上 ___億  営業利益 ___億   │  ← dimension_values から自動取得
│ [B事業部]      売上 ___億  営業利益 ___億   │
│ [C事業部]      売上 ___億  営業利益 ___億   │
└─────────────────────────────────────────────┘
```

---

**【J案】会社レベルで軸固定 の具体例:**

```sql
-- 会社設定で1回だけ設定
UPDATE companies
SET planning_dimension_id = 'DIM-001'  ← 「事業部」軸を固定
WHERE id = 'COMPANY-001';
```

**入力画面での動作:**
1. `companies.planning_dimension_id = DIM-001` を取得
2. 以降は【I案】と同じ

---

**つまり「軸を指定する」とは:**

| 何を指定？ | 値の例 | 意味 |
|-----------|--------|------|
| `dimensions.id` | DIM-001 | 「事業部」という軸を選ぶ |

**結果として入力対象になるもの:**

| 軸（dimensions） | 入力対象（dimension_values） |
|-----------------|---------------------------|
| 事業部（DIM-001） | A事業部、B事業部、C事業部 |
| 地域（DIM-002） | 北米、欧州、アジア |
| 製品（DIM-003） | 製品A、製品B |

---

**補足: 全社はどう扱う？**

「全社」は dimension_values には含まれないので、別途扱う必要があります。

**選択肢:**
1. **暗黙的に全社を含める**: dimension_value_id = NULL で「全社」を表現
2. **dimension_values に「全社」を登録**: 各軸に「全社」というGroupを作る
3. **別フラグで制御**: `mtp_events.include_company_total = true`

**推奨: 選択肢1（NULL = 全社）**

```sql
fact_amounts
├── dimension_value_id = NULL   ← 全社
├── dimension_value_id = DV-001 ← A事業部
├── dimension_value_id = DV-002 ← B事業部
└── ...
```

---

**これで理解できましたか？**

改めて、【I】イベント単位 と 【J】会社レベル固定、どちらがよいですか？

**回答：**
- 組織ディメンションを新設し、部門マスタ（正）と紐付ける設計で進める

---

### Q5: 組織ディメンションの設計

Q4の議論を経て、以下の設計で合意。

**基本方針：**
- 部門マスタ（departments）が「正」の組織
- 組織ディメンション（dimensions + dimension_values）は中計用・ガイドライン用・汎用管理会計用
- 部門→組織ディメンションの紐付けは department_dimension_links で管理

**組織ディメンションの用途区分：**

| org_purpose | 用途 |
|-------------|------|
| MTP | 中計用 |
| GUIDELINE | ガイドライン用 |
| NULL | 汎用管理会計用（IR等含む、複数設定可能） |

**設計決定：**

1. `dimensions` に `dimension_type` と `org_purpose` を追加
2. `department_dimension_links` を新設（部門→組織ディメンション紐付け）
3. `companies` に `default_org_dimension_id` を追加（初期設定用）
4. 中計/ガイドラインイベントは dimension_id を持つ（イベント単位で軸指定）

---

## 確定事項まとめ

### 予算ガイドライン仕様

| 項目 | 決定内容 | 根拠 |
|------|---------|------|
| データ格納 | fact_amounts 共用、scenario_type = 'GUIDELINE' | Q2で決定。中計と同様のパターン |
| イベント管理 | guideline_events 新設 | Q3で決定。mtp_events と同パターン |
| レイアウト | report_layouts.layout_type = 'GUIDELINE' | Q1.5で決定 |
| 時間粒度 | 年度/半期/四半期すべて対応 | Q1で決定 |
| 科目粒度 | 主要PL科目のみ（レイアウト選択方式） | Q1で決定 |
| 入力者 | 事業部長レベル or 経営企画（権限設計に準拠） | Q1で決定 |
| 組織単位 | 組織ディメンション（dimension_values）単位で入力 | Q5で決定 |

### 組織ディメンション仕様

| 項目 | 決定内容 |
|------|---------|
| dimensions.dimension_type | 'ORGANIZATION' / 'ANALYSIS' |
| dimensions.org_purpose | 'MTP' / 'GUIDELINE' / NULL（汎用） |
| 部門紐付け | department_dimension_links（新規テーブル） |
| 会社設定 | companies.default_org_dimension_id |

### guideline_events テーブル設計

```sql
guideline_events
├── id: UUID
├── tenant_id: UUID
├── company_id: UUID
├── event_code: VARCHAR(50)       -- 例: 'FY2026_GL_Q1'
├── event_name: VARCHAR(200)      -- 例: 'FY2026 Q1ガイドライン'
├── fiscal_year: INTEGER          -- 対象年度
├── period_type: ENUM             -- 'ANNUAL' / 'HALF' / 'QUARTER'
├── period_no: INTEGER            -- 期番号（1, 2, 3, 4）
├── status: ENUM                  -- 'DRAFT' / 'CONFIRMED'
├── layout_id: UUID → report_layouts.id
├── dimension_id: UUID → dimensions.id  -- 使用する組織ディメンション
├── description: TEXT
├── created_at, updated_at, deleted_at
└── ...
```

### department_dimension_links テーブル設計

```sql
department_dimension_links
├── id: UUID (PK)
├── tenant_id: UUID
├── company_id: UUID
├── dimension_id: UUID             -- どの組織ディメンションか
├── department_stable_id: VARCHAR  -- 正の部門
├── dimension_value_id: UUID       -- 紐付け先（A事業部等）
├── effective_date: DATE           -- 有効開始
├── expiry_date: DATE              -- 有効終了（NULL=無期限）
├── created_at, updated_at
├── created_by, updated_by
└── ...

制約:
- FK(dimension_id, dimension_value_id) → dimension_values(dimension_id, id)
- UNIQUE(tenant_id, dimension_id, department_stable_id, effective_date)
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)
```

### データフロー

```
【正の組織】
departments（部門マスタ）
├── 営業1課、営業2課、製造部...
└── org_versions で版管理

【組織ディメンション】
dimensions（dimension_type='ORGANIZATION'）
├── DIM-ORG-MTP: 中計用組織（org_purpose='MTP'）
├── DIM-ORG-GL: ガイドライン用組織（org_purpose='GUIDELINE'）
└── DIM-ORG-IR: IRセグメント（org_purpose=NULL, 汎用）

dimension_values
├── A事業部、B事業部、全社...（各ディメンションに属する）

【紐付け】
department_dimension_links
├── 営業1課 → A事業部（中計用）
├── 営業1課 → セグメント1（IR用）
└── ...

【中計/ガイドライン入力】
→ dimension_values 単位で入力
→ fact_amounts に保存

【予算入力】
→ departments 単位で入力
→ fact_amounts に保存
→ 集計時は department_dimension_links 経由で組織ディメンションに集計
```

---

### Q6: 中計との参照関係

予算ガイドライン入力時に中計値を参照表示しますか？

**選択肢:**
- A) 参照表示なし（ガイドラインは独立）
- B) 参照表示あり（中計の該当年度の値を横に表示）
- C) 参照＋乖離率表示

**回答：**
- B) 参照表示あり

---

### Q7: 中計とガイドラインの粒度整合性

**ユーザー指摘:**
> 「中計と予算ガイドラインも粒度が異なる可能性ないですか」

**ITアーキテクトの回答:**

おっしゃる通りです。重要な指摘です。

現在の設計では：

| レイヤー | 入力粒度 | 使用ディメンション |
|---------|---------|-------------------|
| 中期経営計画 | 組織ディメンション値 | org_purpose='MTP' |
| 予算ガイドライン | 組織ディメンション値 | org_purpose='GUIDELINE' |
| 予算 | 部門 | - |

つまり、**中計とガイドラインも別の組織ディメンションを使う可能性がある**ため、粒度が異なる可能性があります。

例えば：
- 中計: 事業セグメント単位（A事業部、B事業部、C事業部）
- ガイドライン: 地域単位（国内、海外）や機能単位（営業、製造、管理）

**設計の選択肢:**

**選択肢A: 同一ディメンションを共有（推奨）**
- 中計とガイドラインで同じ組織ディメンションを使用
- イベント単位で dimension_id を指定するが、運用上は同じディメンションを使う
- 参照表示が容易

```
【運用例】
dimension: 事業部別（org_purpose = NULL または 'GENERAL'）
├── mtp_events: dimension_id → この事業部別ディメンション
├── guideline_events: dimension_id → この事業部別ディメンション
└── → 中計 vs ガイドラインの比較・参照が容易
```

**選択肢B: 異なるディメンションを許容**
- 中計用とガイドライン用で別の組織ディメンションを設定可能
- 粒度が異なる場合、参照表示は行わない（または「参照不可」と表示）
- 各レイヤーは独立して運用

```
【運用例】
dimension_A: 事業セグメント（中計用）
dimension_B: 地域別（ガイドライン用）
├── mtp_events: dimension_id → dimension_A
├── guideline_events: dimension_id → dimension_B
└── → 参照表示なし（粒度不一致のため）
```

**設計方針:**

1. **org_purpose は参考情報として残す**（中計用/ガイドライン用の意図を示す）
2. **実際の使用はイベント単位で dimension_id を指定**
3. **同じ組織ディメンションを複数イベントで共有可能**
4. **参照表示は dimension_id が一致する場合のみ有効**

```sql
-- 参照表示の判定ロジック
SELECT
  CASE
    WHEN gl.dimension_id = mtp.dimension_id THEN '参照可能'
    ELSE '粒度不一致のため参照不可'
  END AS reference_status
FROM guideline_events gl
LEFT JOIN mtp_events mtp
  ON gl.fiscal_year BETWEEN mtp.start_fiscal_year AND mtp.end_fiscal_year
  AND mtp.status = 'CONFIRMED';
```

**回答:**
- 同じディメンションなら比較表示する
- 異なるディメンションなら、タブで切り替えて確認はできる

**表示方式:**

| 状況 | 表示方法 |
|------|---------|
| 同じディメンション | 横並び比較表示（中計値とガイドライン値を同じ行に） |
| 異なるディメンション | タブ切り替えで確認可能（比較はしないが参照はできる） |

---

### Q8: 予算入力時のガイドライン参照

予算入力画面でガイドライン値を参照表示しますか？

**前提:**
- 予算入力: 部門（departments）単位
- ガイドライン: 組織ディメンション（dimension_values）単位
- → 粒度が異なる

**選択肢:**

**A) 集計表示**
- 入力中の部門が属する組織ディメンション値のガイドライン値を表示
- 例: 営業1課入力時 → 「A事業部ガイドライン: 売上40億」を表示
- department_dimension_links で紐付けを取得

**B) サマリー画面で別途表示**
- 予算入力画面では表示しない
- 別画面で「ガイドライン vs 予算集計」を確認

**C) 両方**
- 入力画面に参考表示 + サマリー画面で詳細比較

**推奨: C) 両方**

```
【予算入力画面】
┌──────────────────────────────────────────────────────────┐
│ 営業1課 予算入力                                         │
├──────────────────────────────────────────────────────────┤
│ ※ 所属: A事業部（ガイドライン売上: 40億）← 参考表示     │
├──────────────────────────────────────────────────────────┤
│ 科目        │ 4月  │ 5月  │ ...  │ 年計 │
│─────────────┼──────┼──────┼──────┼──────│
│ 売上高      │ ___  │ ___  │      │      │
└──────────────────────────────────────────────────────────┘

【サマリー画面（別途）】
┌──────────────────────────────────────────────────────────┐
│ A事業部 予算 vs ガイドライン                             │
├──────────────────────────────────────────────────────────┤
│ 科目    │ガイドライン│ 予算集計 │ 差額  │ 達成率 │
│─────────┼────────────┼──────────┼───────┼────────│
│ 売上高  │   40億     │  38億    │ -2億  │  95%   │
└──────────────────────────────────────────────────────────┘
```

どれがよいですか？

**回答:**
- C) 両方（入力画面に参考表示 + サマリー画面で詳細比較）

---

### Q9: ガイドラインのステータス管理

ガイドラインイベントのステータス遷移について確認します。

**中計と同様の設計案:**

| ステータス | 説明 | 編集可否 |
|-----------|------|---------|
| DRAFT | 作成中 | ○ |
| CONFIRMED | 確定済み | × |

**確認ポイント:**

1. **CONFIRMED後の修正は？**
   - A) 不可（新イベント作成で対応）
   - B) 可（上書き更新）
   - C) 新バージョン作成（DRAFT → CONFIRMED のサイクル）

2. **承認フローは？**
   - A) Phase 1では不要（ステータス切替のみ）
   - B) 簡易承認（上長承認で CONFIRMED に遷移）

**推奨:**
- CONFIRMED後の修正: A) 不可（新イベント作成）
- 承認フロー: A) Phase 1では不要

中計と同じシンプルな設計でよいですか？

**回答:**
- はい、シンプルでよい
- CONFIRMED後の修正: A) 不可（新イベント作成）
- 承認フロー: A) Phase 1では不要

---

### Q10: Phase 1 スコープ確認

予算ガイドラインのPhase 1スコープを確認します。

**Phase 1 に含める:**

| 機能 | 内容 |
|------|------|
| イベント作成 | guideline_events の CRUD |
| 数値入力 | 組織ディメンション値 × 科目 × 期間 |
| 中計参照表示 | 同じディメンションなら横並び、異なればタブ切替 |
| ステータス管理 | DRAFT / CONFIRMED |
| レイアウト選択 | layout_type = 'GUIDELINE' |

**Phase 2 以降:**

| 機能 | 内容 |
|------|------|
| 承認フロー | ワークフロー連携 |

**対象外（不要と判断）:**

| 機能 | 理由 |
|------|------|
| 配賦機能 | 手入力で十分、配賦ルール設計が複雑 |
| ガイドライン比較 | 個別に見れれば十分 |

**回答:**
- OK。Phase 1 スコープ確定

---

## 確定事項まとめ（最終版）

### 予算ガイドライン仕様

| 項目 | 決定内容 |
|------|---------|
| データ格納 | fact_amounts 共用、scenario_type = 'GUIDELINE' |
| イベント管理 | guideline_events 新設 |
| レイアウト | report_layouts.layout_type = 'GUIDELINE' |
| 時間粒度 | 年度/半期/四半期すべて対応 |
| 科目粒度 | 主要PL科目のみ（レイアウト選択方式） |
| 入力者 | 事業部長レベル or 経営企画 |
| 組織単位 | 組織ディメンション（dimension_values）単位 |
| ステータス | DRAFT / CONFIRMED（承認フローはPhase 2） |
| 中計参照 | 同じディメンション→横並び、異なる→タブ切替 |
| 予算参照 | 入力画面に参考表示 + サマリー画面で詳細比較 |

### guideline_events テーブル

```sql
guideline_events
├── id: UUID (PK)
├── tenant_id: UUID
├── company_id: UUID
├── event_code: VARCHAR(50)       -- 例: 'FY2026_GL_Q1'
├── event_name: VARCHAR(200)      -- 例: 'FY2026 Q1ガイドライン'
├── fiscal_year: INTEGER          -- 対象年度
├── period_type: ENUM             -- 'ANNUAL' / 'HALF' / 'QUARTER'
├── period_no: INTEGER            -- 期番号（1, 2, 3, 4）
├── status: ENUM                  -- 'DRAFT' / 'CONFIRMED'
├── layout_id: UUID → report_layouts.id
├── dimension_id: UUID → dimensions.id
├── description: TEXT
├── created_at, updated_at, deleted_at
└── ...
```

---

