# プロジェクト予算 仕様検討（2026-01-09）

## 検討背景

プロジェクト（PJ）別の予算管理について。PJ予算は通常の部門予算とは異なる性質を持ち、独自のレイアウト・管理体系が必要かどうかを検討。

---

## Q1: PJ予算の位置づけ

### 質問
PJ予算は「科目のディメンション展開」として扱うべきか、独立した予算体系として扱うべきか。

### 回答（ユーザー）
> 科目は同じものを使えばいいとおもうのです。ただ、PJ予算っていうのは、どの科目はPJ予算にするとかそういう概念ではなく、全部PJ別に予算きるので、他のディメンションの概念とは別かなとおもいました

### 整理

| 観点 | 通常のディメンション | PJ予算 |
|------|-------------------|--------|
| 適用範囲 | 特定科目のみ | 全科目がPJ別 |
| 主軸 | 科目 | プロジェクト |
| レイアウト | 科目の内訳 | PJ単位で予算全体 |

---

## Q2: スコープ

### 質問
PJ予算機能として何を入れるか。

### 回答（ユーザー）
> スコープとしてはいれたいです

> あとはシステム会社向けとかであれば、そのPJ予算や見込みのデータを集約して、本来の部門予算にマッピングしてたらずを追加したいしてシミュレーションしたいとおもうのです。それは空のPJをたてたりして予算にいれるとか

### 確定スコープ
1. PJ予算の入力・管理（予算・見込・実績）
2. PJ予算 → 部門予算への集約コピー
3. 空PJによる予備費管理
4. シミュレーション（PJ追加・削除の影響確認）

---

## Q3: データ構造 - 別テーブルか統合か

### 質問
PJ予算を別ファクトテーブル（fact_project_amounts）にするか、fact_amounts に統合するか。

### 回答（ユーザー）
> PJ予算は別ファクトテーブルにもって、予算・見込・実績をもてるようにしましょうか。

（後の議論で方針変更）

---

## Q4: 実績データの混在

### 質問
ERPからの実績で、同じ科目でもPJ別の実績とPJ紐付けなしの実績が混在する場合の扱い。

### 回答（ユーザー）
> 実績はPJ別に入ってくる実績もあれば、PJ別に入ってこない実績もあるとおもうのです。

### 選択肢
- A案: fact_amounts に project_id（nullable）を持たせる
- B案: fact_project_amounts + fact_amounts で分離
- C案: 取込時に両方に入れる（正本 + キャッシュ）

### 決定
> A案にしましょう。またファクトテーブルの持ち方かわりますけど、そこは修正しましょう。

---

## Q5: 予算レイアウト

### 質問
PJ予算用の専用レイアウトが必要か。

### 回答（ユーザー）
> 予算については、主幹部門別にPJ別予算をたてて、（予算レイアウトは一つ・ちなみにPJ予算に関わらず予算レイアウトは一つ）にしたいとおもいます。

### 決定
- 予算レイアウトは1つ（共通）
- PJ予算も部門予算も同じ科目体系・同じレイアウトを使用

---

## Q6: PJ → 部門への集約

### 質問
PJ予算を部門予算にどう反映するか。

### 回答（ユーザー）
> それを部門別予算のほうに集計値でコピーできる機能は本体の部門予算つくるときにできるようにしたいです。

### 決定
- 部門予算作成時に「PJ集約」機能を提供
- source_type = 'PROJECT_ROLLUP' で識別
- 主幹部門（projects.owner_department_stable_id）単位で集計

---

## 確定事項まとめ

| 項目 | 決定内容 |
|------|---------|
| データ構造 | fact_amounts に project_id（nullable）を追加 |
| PJ有無の混在 | 同じ科目・部門で project_id ありとNULLが共存可能 |
| 予算レイアウト | 1つ（共通） |
| 集約方式 | PJ集計 → 部門予算にコピー（source_type='PROJECT_ROLLUP'） |
| 空PJ | 予備費・調整用に使用可能 |

---

## エンティティ変更

### fact_amounts
- `project_id` カラム追加（uuid、nullable、FK to projects）
- 一意制約に `project_id` 追加
- `source_type` に `PROJECT_ROLLUP` 追加

### 設計思想（0.8）
- プロジェクトは固定列で保持（縦持ちディメンションとは別扱い）

---

## 次のアクション

- [x] fact_amounts に project_id 追加
- [x] 一意制約の更新
- [x] source_type に PROJECT_ROLLUP 追加
- [x] 変更履歴の更新
- [ ] PJ予算入力画面の設計（将来Feature）
- [ ] PJ集約機能の設計（将来Feature）

---

## 参加者

- ユーザー
- Claude Code

## 検討日

2026-01-09
