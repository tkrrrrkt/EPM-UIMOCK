# データ取込機能 仕様検討

> **ステータス**: 仕様検討中
> **作成日**: 2026-01-16
> **更新日**: 2026-01-16
> **コンセプト**: 経理部門が自走できるUX

---

## 1. 概要

### 1.1 目的

ERP・外部システムからの予算・見込・実績データを、**経理部門が自走で**取り込めるUI/UXを提供する。
IT部門に頼らず、経理担当者が日常業務として取込・確認・修正を完結できることを目指す。

### 1.2 ターゲット

| 区分 | 内容 |
|------|------|
| 企業規模 | 売上100億〜500億円（中堅〜準大手） |
| 主要ユーザー | 経理部門、経営企画部門 |
| 競合 | Loglass等のEPM SaaS |

### 1.3 対象データ

| データ種別 | 用途 | 頻度 | 主な入力方法 |
|-----------|------|------|-------------|
| 予算 | 予算策定時のインポート | 年次〜四半期 | SpreadJS直接入力/コピペ推奨、取込も可 |
| 見込 | 見込更新時のインポート | 月次 | SpreadJSコピペ or 取込 |
| 実績 | ERP連携、月次締め | 月次 | **取込が前提** |

---

## 2. 設計コンセプト

### 2.1 基本思想

```
「経理部門が自走できるUX」

1. 迷わない入口 - 1つの統合画面に何でも投げ込める
2. 賢い提案 - マッピングを自動提案、学習して次回から自動
3. Excel感覚 - SpreadJSで確認・修正、見慣れた操作感
4. 安心の確認 - エラーは明確に、修正も容易に
5. 簡単やり直し - 何度でもトライ＆エラー
```

### 2.2 運用方針

| 項目 | 方針 | 理由 |
|------|------|------|
| **部門指定** | 不要 | ファイル内の部門コードで自動判定。全社一括取込が基本 |
| **管理単位** | イベント単位 | 経理・企画・情シスが統括して集中管理 |
| **再取込** | DELETE + INSERT | 同一イベントに再取込する場合は上書き |
| **テンプレート** | 任意 | テンプレートなしでもマッピングできれば取込可能 |

### 2.3 入力画面からの導線

予算入力・見込入力画面からデータ取込画面への導線を設ける。

```
予算入力画面:
┌─────────────────────────────────────────────────────────────────────┐
│ 予算入力 - 2026年度予算                                              │
├─────────────────────────────────────────────────────────────────────┤
│ [保存] [Excel出力] [インポート]  ← クリックで取込画面へ遷移         │
│                                   （コンテキストを引き継ぐ）         │
├─────────────────────────────────────────────────────────────────────┤
│ (SpreadJS グリッド)                                                  │
└─────────────────────────────────────────────────────────────────────┘

「インポート」クリック時:
  → データ取込画面へ遷移
  → 種別: 予算、イベント: 2026年度予算 が自動選択された状態
```

### 2.4 アーキテクチャ方針

**「1つの画面、1つのステージング」**

```
┌─────────────────────────────────────────────────────────────────────┐
│                     統合データ取込画面                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   入口（どちらでもOK）                                               │
│   ┌─────────────────┐    ┌─────────────────┐                       │
│   │ Excelコピペ     │    │ ファイルドロップ │                       │
│   │ (Ctrl+V)        │    │ (.xlsx / .csv)   │                       │
│   └────────┬────────┘    └────────┬────────┘                       │
│            │                      │                                 │
│            └──────────┬───────────┘                                 │
│                       ▼                                             │
│            ┌─────────────────────┐                                  │
│            │  SpreadJS           │                                  │
│            │  ステージングエリア  │  ← すべてここに集約              │
│            └─────────────────────┘                                  │
│                       │                                             │
│                       ▼                                             │
│            マッピング → 検証 → 取込                                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**API連携は別レイヤー**（画面を経由しない自動化用途）

---

## 3. 処理フロー

### 3.1 全体フロー

```
┌─────────────────────────────────────────────────────────────────────┐
│                       データ取込 処理フロー                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  コピペ or ファイルドロップ                                          │
│            │                                                        │
│            ▼                                                        │
│     ┌──────────────┐                                                │
│     │ 行数判定     │                                                │
│     └──────┬───────┘                                                │
│            │                                                        │
│    ┌───────┴───────┐                                                │
│    ▼               ▼                                                │
│ 5,000行以下    5,000行超                                            │
│    │               │                                                │
│    ▼               ▼                                                │
│ SpreadJSに      ① ヘッダー解析                                      │
│ そのまま展開        │                                               │
│    │               ▼                                                │
│    │          ② コード抽出（サンプリング）                          │
│    │               │                                                │
│    │               ▼                                                │
│    │          ③ マッピング確認（事前）                              │
│    │             - 学習済み → 自動適用                              │
│    │             - 未知 → ユーザー選択                              │
│    │               │                                                │
│    │               ▼                                                │
│    │          ④ 集計処理                                            │
│    │             （年月×部門×科目×PJ×DIM×タグ）                      │
│    │               │                                                │
│    └───────┬───────┘                                                │
│            ▼                                                        │
│     SpreadJS ステージング                                           │
│            │                                                        │
│            ▼                                                        │
│     マッピング確認（少量の場合はここで）                             │
│            │                                                        │
│            ▼                                                        │
│     検証（エラー表示）                                               │
│            │                                                        │
│            ▼                                                        │
│     取込実行 → fact_amounts                                         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 大量データ処理（5,000行超）

大量データの場合、SpreadJSに展開する前にサーバー側で処理する。

```
① ファイルドロップ
     ↓
② ヘッダー解析（どの列が科目？部門？金額？）
     ↓
③ コードのサンプリング抽出
   - 全行を読まずに、ユニークな科目コード・部門コード一覧を抽出
     ↓
④ マッピング確認（事前）
   ┌─────────────────────────────────────────────────────┐
   │ 「4100」→「売上高」      ✓ 学習済み               │
   │ 「4200」→「売上原価」    ✓ 学習済み               │
   │ 「9999」→ ???           ⚠ 未設定 [選択 ▼]        │
   └─────────────────────────────────────────────────────┘
     ↓ すべてマッピング確定
⑤ 集計処理
   - EPMコードに変換しながら、指定軸で集計
   - 集計軸: 年月 × 部門 × 科目 × PJ × ディメンション × タグ
   - ファイル内にある軸の範囲で集計
     ↓
⑥ SpreadJSに集計結果を展開（5,000行以下になる想定）
```

**ポイント**:
- マッピングを確定してからでないと、正しい軸で集計できない
- 学習済みコードは自動マッピングされるので、ユーザー操作は最小限

### 3.3 閾値

| 項目 | 値 | 備考 |
|------|-----|------|
| SpreadJS展開の閾値 | **5,000行** | 初期値、実装時にチューニング |

---

## 4. 取込チャネル

### 4.1 画面（統合）

| 入力方法 | 説明 |
|---------|------|
| **コピペ** | Excelからコピーして Ctrl+V で貼り付け |
| **ファイルドロップ** | .xlsx / .csv をドラッグ＆ドロップ |

どちらも同じ画面、同じステージングエリアに展開される。

### 4.2 API連携（別レイヤー）

画面を経由しない自動化用途。

```
POST /api/v1/imports/budget
POST /api/v1/imports/forecast
POST /api/v1/imports/actual

リクエスト例:
{
  "eventId": "uuid",
  "versionId": "uuid",
  "data": [
    {
      "subjectCode": "SALES",
      "departmentCode": "D001",
      "period": "2026-04",
      "amount": 10000000
    }
  ],
  "options": {
    "overwrite": true,
    "validateOnly": false
  }
}
```

### 4.3 将来拡張

| チャネル | Phase | 用途 |
|---------|-------|------|
| SFTP | Phase 2 | バッチ連携（大企業向け） |
| クラウドストレージ | Phase 2 | S3/GCS/Azure Blob連携 |

---

## 5. テンプレート機能

### 5.1 テンプレートの役割

「型」を定義しておくことで、コピペ時の列マッピングを省略できる。

### 5.2 テンプレートの種類

| 種類 | 提供元 | 説明 |
|------|--------|------|
| システム提供 | EPM | 標準形式、主要ERP形式 |
| ユーザー作成 | 各社 | 自社ERP形式、独自形式 |

### 5.3 システム提供テンプレート例

| テンプレート | 列構成 | 用途 |
|-------------|--------|------|
| 標準（横持ち） | 科目CD, 部門CD, 4月, 5月, ... 3月 | 一般的な予算・見込 |
| 標準（縦持ち） | 科目CD, 部門CD, 年月, 金額 | ERPの出力形式に多い |
| SAP FI/CO | SAP標準出力形式 | SAP連携用 |
| Oracle GL | Oracle標準出力形式 | Oracle連携用 |
| 勘定奉行 | 勘定奉行出力形式 | 勘定奉行連携用 |

### 5.4 テンプレート管理

ユーザーが自社向けテンプレートを作成・管理できる。

```
テンプレート管理画面:
┌─────────────────────────────────────────────────────────────────┐
│ 取込テンプレート管理                          [+ 新規作成]      │
├─────────────────────────────────────────────────────────────────┤
│ 名前              │ 形式   │ 作成者     │ 最終使用   │         │
├───────────────────┼────────┼────────────┼────────────┼─────────┤
│ 標準（横持ち）    │ システム│ -          │ 2026-01-15 │         │
│ 標準（縦持ち）    │ システム│ -          │ 2026-01-10 │         │
│ 自社ERP形式       │ カスタム│ 山田太郎   │ 2026-01-14 │ [編集]  │
│ 営業部向け簡易版  │ カスタム│ 田中花子   │ 2026-01-12 │ [編集]  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. マッピング学習機能

### 6.1 学習対象

| 学習対象 | 説明 | 例 |
|---------|------|-----|
| 科目コード | 外部コード→EPM科目 | 「4100」→「売上高」 |
| 部門コード | 外部コード→EPM部門 | 「D001」→「営業1課」 |
| 列名 | ヘッダー名→フィールド | 「勘定科目」→「subject_code」 |

### 6.2 学習フロー

```
初回取込時:
┌─────────────────────────────────────────────────────┐
│ 科目マッピング                                       │
├─────────────────────────────────────────────────────┤
│ ERP科目「4100」が見つかりません                      │
│                                                     │
│ EPM科目を選択してください:                          │
│ ┌─────────────────────────────────────────────────┐│
│ │ 🔍 科目を検索...                                ││
│ ├─────────────────────────────────────────────────┤│
│ │ ○ 売上高 (SALES)        ← おすすめ             ││
│ │ ○ 売上高（国内） (SALES_DOM)                   ││
│ │ ○ 売上高（海外） (SALES_OVS)                   ││
│ └─────────────────────────────────────────────────┘│
│                                                     │
│ ☑ このマッピングを記憶する                          │
│                                                     │
│                              [キャンセル] [適用]    │
└─────────────────────────────────────────────────────┘

2回目以降:
「4100」→「売上高」に自動マッピング（学習済み）
```

### 6.3 マッピングルール管理画面

```
┌─────────────────────────────────────────────────────────────────┐
│ マッピングルール管理                                             │
├─────────────────────────────────────────────────────────────────┤
│ [科目] [部門] [列名]                           [+ ルール追加]   │
├─────────────────────────────────────────────────────────────────┤
│ 外部コード    │ EPM科目       │ 連携元   │ 最終使用   │        │
├───────────────┼───────────────┼──────────┼────────────┼────────┤
│ 4100          │ 売上高        │ SAP      │ 2026-01-15 │ [削除] │
│ 4110          │ 売上高（国内）│ SAP      │ 2026-01-15 │ [削除] │
│ 4120          │ 売上高（海外）│ SAP      │ 2026-01-10 │ [削除] │
│ REV001        │ 売上高        │ Oracle   │ 2026-01-05 │ [削除] │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 画面詳細

### 7.1 取込開始画面（IMP-1）

```
┌─────────────────────────────────────────────────────────────────────┐
│ データ取込                                                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  取込先                                                             │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 種別: [予算 ▼]                                              │   │
│  │                                                             │   │
│  │ イベント: [2026年度予算 ▼]                                  │   │
│  │                                                             │   │
│  │ ※ 見込の場合: バージョン選択も表示                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  データ入力                                                         │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                                                             │   │
│  │                                                             │   │
│  │         📄 ファイルをドラッグ＆ドロップ                      │   │
│  │            または クリックして選択                          │   │
│  │                                                             │   │
│  │         ─────────── または ───────────                      │   │
│  │                                                             │   │
│  │         📋 Excelからコピーして Ctrl+V で貼り付け            │   │
│  │                                                             │   │
│  │                                                             │   │
│  │  対応形式: .xlsx / .csv                                     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  テンプレート: [前回使用した形式 ▼]  [テンプレート管理...]          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 SpreadJSステージング画面（IMP-2）

```
┌─────────────────────────────────────────────────────────────────────┐
│ データ取込 - ステージング                                            │
├─────────────────────────────────────────────────────────────────────┤
│ 取込先: 予算 / 2026年度予算                                          │
│ テンプレート: [標準（横持ち） ▼]                                     │
├─────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │     │     │ A        │ B        │ C        │ D        │ E     │...│
│ ├─────┼─────┼──────────┼──────────┼──────────┼──────────┼───────┼───┤
│ │     │ ☑  │ 科目CD   │ 部門CD   │ 2026/04  │ 2026/05  │2026/06│   │
│ │  2  │ ☑  │ 4100     │ D001     │ 1000000  │ 1100000  │1200000│ ✓ │
│ │  3  │ ☑  │ 4100     │ D002     │  800000  │  850000  │ 900000│ ✓ │
│ │  4  │ ☑  │ 4200     │ D001     │  600000  │  650000  │ 700000│ ✓ │
│ │  5  │ ☐  │ XXXX     │ D001     │  500000  │  550000  │ 600000│除外│ ← 除外した行
│ │  6  │ ☑  │ 4200     │ D002     │  400000  │  420000  │ 440000│ ✓ │
│ │ ... │    │          │          │          │          │       │   │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                     │
│ 件数: 150行 / 取込対象: 149行 / 除外: 1行 / エラー: 0件              │
│                                                                     │
│ [マッピング確認]  [検証]  [取込実行]                                 │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2.1 行の操作

| 操作 | 可否 | 説明 |
|------|------|------|
| **行の除外** | ○ | チェックボックスをOFFにして取込対象から除外 |
| **行の編集** | ○ | セルの値を直接編集可能 |
| **行の削除** | ✗ | 削除は不可（除外で対応） |
| **行の追加** | ✗ | 追加は不可（入力画面で対応） |

**除外フラグ方式の利点:**
- 元データを保持したまま、特定行を取込対象から外せる
- 何を除外したか明確に分かる
- 後で元ファイルを修正して再取込すればOK

### 7.3 マッピング確認画面（IMP-3）

#### 7.3.1 表示タイミング

| ケース | 表示タイミング | 目的 |
|--------|---------------|------|
| **通常（5,000行以下）** | ステージング画面から「マッピング確認」クリック時 | 事後確認・修正 |
| **大量データ（5,000行超）** | ファイル解析直後（ステージング表示前） | 事前確認（集計の前提） |

#### 7.3.2 画面レイアウト

```
┌─────────────────────────────────────────────────────────────────────┐
│ マッピング確認                                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│ ■ 列マッピング                                    [すべてOK ✓]      │
│   ┌────────────────────────────────────────────────────────────┐   │
│   │ 列   │ ヘッダー名    │ マッピング先                │ 変更 │   │
│   ├──────┼───────────────┼─────────────────────────────┼──────┤   │
│   │ A    │ 科目CD        │ 科目コード        ✓ 学習済み│ [▼] │   │
│   │ B    │ 部門CD        │ 部門コード        ✓ 学習済み│ [▼] │   │
│   │ C    │ 2026/04       │ 2026年4月                   │ [▼] │   │
│   │ D    │ 2026/05       │ 2026年5月                   │ [▼] │   │
│   │ E    │ 2026/06       │ 2026年6月                   │ [▼] │   │
│   │ ...  │               │                             │      │   │
│   └────────────────────────────────────────────────────────────┘   │
│                                                                     │
│ ■ 科目コード                                        [1件要確認 ⚠]  │
│   ┌────────────────────────────────────────────────────────────┐   │
│   │ 外部コード │ 件数 │ マッピング先           │ ステータス    │   │
│   ├────────────┼──────┼────────────────────────┼───────────────┤   │
│   │ 4100       │  45  │ 売上高                 │ ✓ 学習済み    │   │
│   │ 4200       │  45  │ 売上原価               │ ✓ 学習済み    │   │
│   │ 4300       │  30  │ 販管費                 │ ✓ 学習済み    │   │
│   │ XXXX       │   5  │ [選択してください ▼]   │ ⚠ 未設定      │   │
│   └────────────────────────────────────────────────────────────┘   │
│                                                                     │
│ ■ 部門コード                                        [すべてOK ✓]   │
│   ┌────────────────────────────────────────────────────────────┐   │
│   │ 外部コード │ 件数 │ マッピング先           │ ステータス    │   │
│   ├────────────┼──────┼────────────────────────┼───────────────┤   │
│   │ D001       │  40  │ 営業1課                │ ✓ 学習済み    │   │
│   │ D002       │  35  │ 営業2課                │ ✓ 学習済み    │   │
│   │ D003       │  50  │ 開発部                 │ ✓ 学習済み    │   │
│   └────────────────────────────────────────────────────────────┘   │
│                                                                     │
│ □ 全てのマッピングを記憶する                                        │
│                                                                     │
│                        [キャンセル] [適用して続行]                   │
└─────────────────────────────────────────────────────────────────────┘
```

#### 7.3.3 未設定コードの選択UI

「選択してください」をクリックすると、候補選択ポップオーバーが表示される。

```
┌────────────────────────────────────────────────────────────────────────┐
│ XXXX をマッピング                                                      │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ 🔍 科目を検索...                                                       │
│ ┌────────────────────────────────────────────────────────────────────┐ │
│ │ おすすめ（名称の類似度が高い科目）                                  │ │
│ │ ┌────────────────────────────────────────────────────────────────┐ │ │
│ │ │ ○ 雑費 (MISC)                                                  │ │ │
│ │ │ ○ その他経費 (OTHER_EXP)                                       │ │ │
│ │ └────────────────────────────────────────────────────────────────┘ │ │
│ │                                                                    │ │
│ │ すべての科目                                                        │ │
│ │ ┌────────────────────────────────────────────────────────────────┐ │ │
│ │ │ ▼ 売上                                                         │ │ │
│ │ │   ○ 売上高 (SALES)                                             │ │ │
│ │ │   ○ 売上高（国内） (SALES_DOM)                                 │ │ │
│ │ │   ○ 売上高（海外） (SALES_OVS)                                 │ │ │
│ │ │ ▼ 原価                                                         │ │ │
│ │ │   ○ 売上原価 (COGS)                                            │ │ │
│ │ │   ○ 材料費 (MAT)                                               │ │ │
│ │ │ ▶ 販管費                                                       │ │ │
│ │ │ ▶ 営業外                                                       │ │ │
│ │ └────────────────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────────────────┘ │
│                                                                        │
│ ☑ このマッピングを記憶する                                             │
│                                                                        │
│                                               [キャンセル] [適用]       │
└────────────────────────────────────────────────────────────────────────┘
```

#### 7.3.4 列マッピングの変更UI

列のマッピング先を変更する場合のドロップダウン。

```
[▼] をクリック:
┌────────────────────────────────────┐
│ ○ 科目コード                       │
│ ○ 部門コード                       │
│ ● 2026年4月        ← 現在の選択    │
│ ○ 2026年5月                        │
│ ○ 2026年6月                        │
│ ...                                │
│ ○ 金額（縦持ちの場合）             │
│ ○ 無視（取込対象外）               │
└────────────────────────────────────┘
```

#### 7.3.5 マッピング適用時の動作

| 状態 | 「適用して続行」ボタン | 動作 |
|------|----------------------|------|
| 未設定あり | 無効（グレーアウト） | - |
| すべて設定済み | 有効 | 通常：ステージングに戻る / 大量データ：集計処理開始 |

#### 7.3.6 大量データ時の集計進捗表示

5,000行超のデータで「適用して続行」をクリックした場合、集計処理中の進捗を表示。

```
┌─────────────────────────────────────────────────────────────────────┐
│ データ集計中...                                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ████████████████████████░░░░░░░░░░  72%                            │
│                                                                     │
│  処理中: 15,234 / 21,000 行                                         │
│                                                                     │
│  集計軸: 年月 × 部門 × 科目                                         │
│                                                                     │
│  ※ マッピングを適用しながら集計しています                           │
│  ※ 完了後、集計結果をステージングに表示します                       │
│                                                                     │
│                                                      [キャンセル]   │
└─────────────────────────────────────────────────────────────────────┘
```

集計完了後:

```
┌─────────────────────────────────────────────────────────────────────┐
│ 集計完了                                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ✓ 21,000行 → 847行 に集計されました                               │
│                                                                     │
│  集計軸: 年月 × 部門 × 科目                                         │
│                                                                     │
│                                            [ステージングを表示]      │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.4 検証結果・エラー表示

#### 7.4.1 エラー表示の基本レイアウト

```
SpreadJS上でのエラー表示:
┌─────────────────────────────────────────────────────────────────────┐
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │     │ ☑  │ A        │ B        │ C        │ D        │ E    │St│ │
│ ├─────┼─────┼──────────┼──────────┼──────────┼──────────┼──────┼──┤ │
│ │  1  │     │ 科目     │ 部門     │ 2026/04  │ 2026/05  │06    │  │ │
│ │  2  │ ☑   │ 売上高   │ 営業1課  │ 1,000,000│ 1,100,000│120万 │ ✓│ │
│ │  3  │ ☑   │ 売上高   │ 営業2課  │   800,000│   850,000│ 90万 │ ✓│ │
│ │  4  │ ☑   │ 売上原価 │ 営業1課  │   600,000│   650,000│ 70万 │ ✓│ │
│ │  5  │ ☑   │ ████████ │ 営業1課  │   500,000│   550,000│ 60万 │ ⚠│ │
│ │  6  │ ☑   │ 売上原価 │ 営業2課  │   480,000│   510,000│██████│ ✗│ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                     │
│ ステータス: 150行中 148件OK / 1件警告 / 1件エラー                    │
│                                                                     │
│ [すべて表示] [エラーのみ] [警告含む]                                 │
│                                                                     │
│ ┌───────────────────────────────────────────────────────────────┐   │
│ │ エラー・警告一覧                                        [縮小]│   │
│ ├───────────────────────────────────────────────────────────────┤   │
│ │ ✗ 行6 E6: 数値ではありません（値: "1,200,00"）      [移動][修正]│  │
│ │ ⚠ 行5 A5: 科目「XXXX」が未マッピング               [移動][設定]│  │
│ └───────────────────────────────────────────────────────────────┘   │
│                                                                     │
│ [マッピング確認]  [再検証]  [取込実行]  ← エラー時は無効            │
└─────────────────────────────────────────────────────────────────────┘
```

#### 7.4.2 セルレベルのエラー表示

エラーのあるセルをクリックすると、ツールチップでエラー詳細と修正アクションを表示。

```
エラーセルをクリック:
┌────────────────────────────────────────────────────────────────────┐
│ ████████████   ← 赤背景のセル                                      │
│ ┌────────────────────────────────────────────────────────────────┐ │
│ │ ✗ エラー: 数値ではありません                                   │ │
│ │                                                                │ │
│ │ 現在の値: "1,200,00"                                          │ │
│ │ 期待: 数値（カンマ・小数点対応）                              │ │
│ │                                                                │ │
│ │ 提案: "1,200,000" に修正しますか？                            │ │
│ │                                                                │ │
│ │ [この値で修正] [直接編集する] [この行を除外]                   │ │
│ └────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────┘

警告セルをクリック:
┌────────────────────────────────────────────────────────────────────┐
│ ████████████   ← 黄背景のセル                                      │
│ ┌────────────────────────────────────────────────────────────────┐ │
│ │ ⚠ 警告: 科目コードがマッピングされていません                   │ │
│ │                                                                │ │
│ │ 外部コード: "XXXX"                                            │ │
│ │                                                                │ │
│ │ [マッピングを設定] [この行を除外]                             │ │
│ └────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────┘
```

#### 7.4.3 一括修正機能

同じエラーが複数行にある場合、一括で修正できる。

```
エラー一覧の「修正」クリック時:
┌────────────────────────────────────────────────────────────────────┐
│ エラーの一括修正                                                    │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│ エラー: 科目コード「XXXX」が未マッピング                           │
│ 該当行: 5行                                                        │
│                                                                    │
│ 対処方法を選択:                                                    │
│                                                                    │
│ ○ マッピングを設定する                                            │
│   「XXXX」→ [売上高 ▼] にマッピング                                │
│   ☑ このマッピングを記憶する                                      │
│                                                                    │
│ ○ 該当行をすべて除外する                                          │
│   5行を取込対象から除外                                            │
│                                                                    │
│                                             [キャンセル] [適用]    │
└────────────────────────────────────────────────────────────────────┘
```

#### 7.4.4 エラー種別と表示色

| エラー種別 | 背景色 | 枠線 | アイコン | 取込可否 |
|-----------|--------|------|----------|---------|
| **エラー** | `#FEE2E2` (赤薄) | `#EF4444` (赤) | ✗ | 不可 |
| **警告** | `#FEF3C7` (黄薄) | `#F59E0B` (黄) | ⚠ | 可能（確認推奨） |
| **OK** | なし | なし | ✓ | - |
| **除外** | `#F3F4F6` (灰薄) | `#9CA3AF` (灰) | - | 対象外 |

#### 7.4.5 エラーナビゲーション

エラー一覧からセルへのジャンプ、次のエラーへの移動機能。

```
エラー一覧:
┌───────────────────────────────────────────────────────────────────┐
│ ✗ エラー: 2件  ⚠ 警告: 3件                   [前へ] [次へ] (1/5) │
├───────────────────────────────────────────────────────────────────┤
│ ▼ ✗ 形式エラー（2件）                                            │
│   ├─ 行6 E6: 数値ではありません              [移動] [修正]        │
│   └─ 行12 E12: 数値ではありません            [移動] [修正]        │
│ ▼ ⚠ マッピング未設定（3件）                                      │
│   ├─ 行5 A5: 科目「XXXX」                   [移動] [設定]        │
│   ├─ 行8 A8: 科目「XXXX」                   [移動] [設定]        │
│   └─ 行15 B15: 部門「ZZZZ」                 [移動] [設定]        │
└───────────────────────────────────────────────────────────────────┘

キーボードショートカット:
- F8: 次のエラー/警告へ移動
- Shift+F8: 前のエラー/警告へ移動
```

#### 7.4.6 自動修正提案

システムが推測できる修正を自動提案。

| エラー種別 | 提案内容 | 例 |
|-----------|---------|-----|
| カンマ位置ミス | 正しい数値 | "1,200,00" → "1,200,000" |
| 全角数字 | 半角変換 | "１２３" → "123" |
| 空白混入 | 空白除去 | "1 000" → "1000" |
| 日付形式 | 標準形式 | "2026/4" → "2026/04" |

```
提案表示:
┌────────────────────────────────────────────────────────────────────┐
│ 💡 自動修正の提案があります                                        │
│                                                                    │
│ 以下の修正を適用しますか？                                        │
│                                                                    │
│ ☑ 行6 E6: "1,200,00" → "1,200,000"                               │
│ ☑ 行12 D12: "１２３" → "123"                                     │
│ ☐ 行8 C8: "2026/4" → "2026/04"（確認推奨）                       │
│                                                                    │
│ [選択した修正を適用] (2件)                        [キャンセル]     │
└────────────────────────────────────────────────────────────────────┘
```

### 7.5 取込完了モーダル

取込実行後、完了モーダルを表示する。

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│                        ✓ 取込が完了しました                      │
│                                                                 │
│  ────────────────────────────────────────────────────────────   │
│                                                                 │
│  149件のデータを取り込みました                                   │
│                                                                 │
│  対象: 予算 / 2026年度予算                                       │
│  除外: 1件                                                       │
│                                                                 │
│  ────────────────────────────────────────────────────────────   │
│                                                                 │
│   [予算入力画面で確認]    [取込履歴]    [閉じる]                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

| ボタン | 動作 |
|--------|------|
| **予算入力画面で確認** | 予算/見込入力画面へ遷移（取込データを確認） |
| **取込履歴** | 取込履歴画面へ遷移 |
| **閉じる** | モーダルを閉じ、取込画面に戻る（ステージングはクリア、コンテキストは維持） |

---

## 8. バリデーションとエラー処理

### 8.1 バリデーション方針

```
「全件OK or 全件NG」

- 1件でもエラーがあれば取込不可
- 警告は取込可能（確認を促す）
- エラーは行単位・セル単位で明確に表示
- 修正→再検証→取込のサイクル
```

### 8.2 バリデーション項目

| カテゴリ | チェック項目 | 重要度 |
|---------|-------------|-------|
| 必須 | 科目コード必須 | エラー |
| 必須 | 部門コード必須 | エラー |
| 必須 | 金額必須 | エラー |
| 形式 | 金額が数値 | エラー |
| 形式 | 期間が有効 | エラー |
| 参照 | 科目コードがマッピング済み | エラー |
| 参照 | 部門コードがマッピング済み | エラー |
| 整合 | 期間が対象範囲内 | 警告 |
| 整合 | 金額が異常値でない | 警告 |

### 8.3 エラー表示

```
エラーレベル:

✗ エラー（取込不可）
  - 必須項目の欠落
  - 形式不正（数値でない等）
  - マッピング未設定（修正するまで進めない）

⚠ 警告（取込可能、確認推奨）
  - 金額が前回比で大幅に異なる
  - 期間が想定範囲外

✓ OK
  - 問題なし
```

---

## 9. 再取込（上書き）

### 9.1 方針

```
「シンプルに上書き」

- 同一キー（科目×部門×期間）のデータは上書き
- 取込範囲外のデータは影響なし
- 複雑な差分管理は行わない
```

### 9.2 上書きルール

```
取込対象: 予算 / イベントA / 部門X

既存データ:
┌─────────┬─────────┬─────────┬─────────┐
│ 科目    │ 2026/04 │ 2026/05 │ 2026/06 │
├─────────┼─────────┼─────────┼─────────┤
│ 売上高  │ 100     │ 110     │ 120     │ ← 上書き対象
│ 売上原価│  60     │  65     │  70     │ ← 上書き対象
│ 販管費  │  20     │  22     │  24     │ ← 取込ファイルになければ保持
└─────────┴─────────┴─────────┴─────────┘

取込ファイル:
┌─────────┬─────────┬─────────┬─────────┐
│ 科目    │ 2026/04 │ 2026/05 │ 2026/06 │
├─────────┼─────────┼─────────┼─────────┤
│ 売上高  │ 105     │ 115     │ 125     │ ← 上書き
│ 売上原価│  62     │  67     │  72     │ ← 上書き
└─────────┴─────────┴─────────┴─────────┘

結果:
┌─────────┬─────────┬─────────┬─────────┐
│ 科目    │ 2026/04 │ 2026/05 │ 2026/06 │
├─────────┼─────────┼─────────┼─────────┤
│ 売上高  │ 105     │ 115     │ 125     │ ← 更新
│ 売上原価│  62     │  67     │  72     │ ← 更新
│ 販管費  │  20     │  22     │  24     │ ← 保持
└─────────┴─────────┴─────────┴─────────┘
```

---

## 10. 取込履歴

### 10.1 記録内容

| 項目 | 説明 |
|------|------|
| 取込日時 | いつ |
| 実行ユーザー | 誰が |
| 取込種別 | 予算/見込/実績 |
| 対象 | イベント/部門 |
| 件数 | 何件 |
| 結果 | 成功/失敗 |
| ファイル名 | 元ファイル（参考） |

### 10.2 履歴画面

```
┌─────────────────────────────────────────────────────────────────────────┐
│ データ取込履歴                                                           │
├─────────────────────────────────────────────────────────────────────────┤
│ [予算] [見込] [実績] [すべて]              期間: [2026-01 ▼]〜[2026-01 ▼]│
├─────────────────────────────────────────────────────────────────────────┤
│ 日時            │ 種別 │ 対象                │ 件数 │ 結果   │ 実行者  │
├─────────────────┼──────┼─────────────────────┼──────┼────────┼─────────┤
│ 2026-01-16 10:30│ 実績 │ 2026年1月 / 全社    │  523 │ ✓ 成功 │ 山田太郎│
│ 2026-01-15 15:20│ 見込 │ 2026年度1月版 / 営業│  156 │ ✓ 成功 │ 田中花子│
│ 2026-01-15 14:00│ 見込 │ 2026年度1月版 / 営業│  156 │ ✗ 失敗 │ 田中花子│
│ 2026-01-10 09:00│ 予算 │ 2026年度予算 / 全社 │ 1,245│ ✓ 成功 │ 佐藤一郎│
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 11. 画面一覧

### 11.1 取込系画面

| ID | 画面名 | 概要 |
|----|--------|------|
| IMP-1 | データ取込 | 統合取込画面（入口） |
| IMP-2 | ステージング | SpreadJSでのデータ確認・編集 |
| IMP-3 | マッピング確認 | 列・コードのマッピング設定 |
| IMP-4 | 取込履歴 | 過去の取込履歴一覧 |

### 11.2 設定系画面

| ID | 画面名 | 概要 |
|----|--------|------|
| IMP-S1 | マッピングルール管理 | 科目・部門・列名のマッピング設定 |
| IMP-S2 | テンプレート管理 | 取込テンプレートの作成・編集 |
| IMP-S3 | API設定 | API連携の認証・エンドポイント設定 |

---

## 12. データ構造

### 12.1 既存テーブル（活用）

```
budget_import_staging  - 予算取込ステージング
actual_import_staging  - 実績取込ステージング
fact_amounts          - 月次集約ファクト（取込先）
fact_journal_lines    - 仕訳明細（実績詳細）
```

### 12.2 追加テーブル（案）

```sql
-- 取込バッチ管理
CREATE TABLE import_batches (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  import_type varchar(20) NOT NULL,  -- BUDGET/FORECAST/ACTUAL
  event_id uuid,                      -- 予算・見込イベント
  version_id uuid,                    -- 見込バージョン
  status varchar(20) NOT NULL,        -- PENDING/VALIDATING/VALIDATED/IMPORTING/COMPLETED/FAILED
  source_type varchar(20) NOT NULL,   -- PASTE/EXCEL/CSV/API
  source_filename varchar(500),
  original_rows int,                  -- 元データの行数
  aggregated_rows int,                -- 集計後の行数（大量データの場合）
  valid_rows int,
  error_rows int,
  warning_rows int,
  created_by uuid NOT NULL,
  created_at timestamptz NOT NULL,
  completed_at timestamptz
);

-- マッピングルール
CREATE TABLE import_mapping_rules (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  mapping_type varchar(20) NOT NULL,  -- SUBJECT/DEPARTMENT/COLUMN
  source_system varchar(50),          -- SAP/Oracle/freee等（省略可）
  source_value varchar(200) NOT NULL, -- 外部コード・列名
  target_type varchar(50) NOT NULL,   -- subject_id/department_id/field_name
  target_value varchar(200) NOT NULL, -- EPM側の値
  is_active boolean DEFAULT true,
  created_at timestamptz NOT NULL,
  updated_at timestamptz NOT NULL,
  last_used_at timestamptz,

  UNIQUE(tenant_id, company_id, mapping_type, source_system, source_value)
);

-- 取込テンプレート
CREATE TABLE import_templates (
  id uuid PRIMARY KEY,
  tenant_id uuid,                     -- NULLは共通テンプレート
  company_id uuid,
  template_code varchar(50) NOT NULL,
  template_name varchar(200) NOT NULL,
  description text,
  format_type varchar(20) NOT NULL,   -- HORIZONTAL/VERTICAL（横持ち/縦持ち）
  column_mappings jsonb NOT NULL,     -- 列マッピング定義
  options jsonb,                      -- 追加オプション
  is_system boolean DEFAULT false,    -- システム提供テンプレート
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamptz NOT NULL,
  updated_at timestamptz NOT NULL
);

-- 取込履歴
CREATE TABLE import_history (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  batch_id uuid NOT NULL,
  import_type varchar(20) NOT NULL,
  event_id uuid,
  version_id uuid,
  total_rows int NOT NULL,
  source_type varchar(20) NOT NULL,
  source_filename varchar(500),
  result varchar(20) NOT NULL,        -- SUCCESS/FAILED
  error_summary text,
  created_by uuid NOT NULL,
  created_at timestamptz NOT NULL,

  FOREIGN KEY (batch_id) REFERENCES import_batches(id)
);
```

---

## 13. BFF Contracts

```typescript
// ================================
// データ取込 BFF Contracts
// ================================

// --- 取込開始（ファイル用） ---
interface BffImportStartRequest {
  importType: 'BUDGET' | 'FORECAST' | 'ACTUAL';
  eventId?: string;
  versionId?: string;
  templateCode?: string;
}

interface BffImportStartResponse {
  batchId: string;
  uploadUrl: string;
}

// --- 取込開始（コピペ用） ---
interface BffImportPasteRequest {
  importType: 'BUDGET' | 'FORECAST' | 'ACTUAL';
  eventId?: string;
  versionId?: string;
  templateCode?: string;
  data: string[][];  // 2次元配列（SpreadJSから）
}

interface BffImportPasteResponse {
  batchId: string;
  rowCount: number;
  needsAggregation: boolean;  // 5000行超の場合true
}

// --- 大量データの事前マッピング確認 ---
interface BffImportPreMappingRequest {
  batchId: string;
}

interface BffImportPreMappingResponse {
  batchId: string;
  columnMappings: BffColumnMapping[];
  subjectCodes: BffCodeMapping[];    // ユニークな科目コード一覧
  departmentCodes: BffCodeMapping[]; // ユニークな部門コード一覧
}

interface BffCodeMapping {
  sourceValue: string;
  targetId?: string;
  targetCode?: string;
  targetName?: string;
  status: 'MAPPED' | 'UNMAPPED';
  isLearned: boolean;
}

// --- マッピング適用＆集計実行 ---
interface BffImportAggregateRequest {
  batchId: string;
  mappings: BffMappingUpdate[];
  rememberMappings: boolean;
}

interface BffImportAggregateResponse {
  batchId: string;
  originalRows: number;
  aggregatedRows: number;
  stagingData: string[][];  // SpreadJS用の2次元配列
}

// --- ステージングデータ取得 ---
interface BffImportStagingRequest {
  batchId: string;
}

interface BffImportStagingResponse {
  batchId: string;
  columns: BffStagingColumn[];
  data: string[][];
  rowCount: number;
}

interface BffStagingColumn {
  key: string;
  label: string;
  type: 'SUBJECT' | 'DEPARTMENT' | 'PERIOD' | 'AMOUNT' | 'OTHER';
  width?: number;
}

// --- 検証 ---
interface BffImportValidateRequest {
  batchId: string;
  data: string[][];  // SpreadJSから（編集後）
}

interface BffImportValidateResponse {
  batchId: string;
  status: 'VALID' | 'HAS_ERRORS' | 'HAS_WARNINGS';
  summary: {
    totalRows: number;
    validRows: number;
    errorRows: number;
    warningRows: number;
  };
  errors: BffValidationError[];
}

interface BffValidationError {
  row: number;
  column: string;
  errorType: 'REQUIRED' | 'FORMAT' | 'MAPPING' | 'RANGE';
  severity: 'ERROR' | 'WARNING';
  message: string;
  currentValue?: string;
  suggestion?: string;
}

// --- 取込実行 ---
interface BffImportExecuteRequest {
  batchId: string;
  data: string[][];
  overwrite: boolean;
}

interface BffImportExecuteResponse {
  batchId: string;
  status: 'COMPLETED' | 'FAILED';
  importedRows: number;
  message?: string;
}

// --- 取込履歴 ---
interface BffImportHistoryRequest {
  importType?: 'BUDGET' | 'FORECAST' | 'ACTUAL';
  fromDate?: string;
  toDate?: string;
  offset?: number;
  limit?: number;
}

interface BffImportHistoryResponse {
  items: BffImportHistoryItem[];
  pagination: {
    total: number;
    offset: number;
    limit: number;
  };
}

interface BffImportHistoryItem {
  id: string;
  importType: 'BUDGET' | 'FORECAST' | 'ACTUAL';
  eventName?: string;
  versionName?: string;
  totalRows: number;
  sourceType: 'PASTE' | 'EXCEL' | 'CSV' | 'API';
  sourceFilename?: string;
  result: 'SUCCESS' | 'FAILED';
  createdByName: string;
  createdAt: string;
}

// --- マッピングルール管理 ---
interface BffMappingRuleListRequest {
  mappingType?: 'SUBJECT' | 'DEPARTMENT' | 'COLUMN';
}

interface BffMappingRuleListResponse {
  rules: BffMappingRule[];
}

interface BffMappingRule {
  id: string;
  mappingType: 'SUBJECT' | 'DEPARTMENT' | 'COLUMN';
  sourceSystem?: string;
  sourceValue: string;
  targetCode: string;
  targetName: string;
  lastUsedAt?: string;
}

// --- テンプレート管理 ---
interface BffTemplateListResponse {
  templates: BffTemplate[];
}

interface BffTemplate {
  id: string;
  templateCode: string;
  templateName: string;
  description?: string;
  formatType: 'HORIZONTAL' | 'VERTICAL';
  isSystem: boolean;
  createdByName?: string;
  lastUsedAt?: string;
}
```

---

## 14. Phase分け

### Phase 1（MVP）

- [ ] 統合取込画面（コピペ/ファイル両対応）
- [ ] SpreadJSステージング
- [ ] 大量データの事前マッピング＆集計（5,000行閾値）
- [ ] マッピング学習（科目・部門・列名）
- [ ] 全件OK/NGバリデーション
- [ ] 上書き取込
- [ ] 取込履歴（シンプル版）
- [ ] REST API連携（予算・見込・実績）

### Phase 2

- [ ] ERPテンプレート（SAP/Oracle/勘定奉行等）
- [ ] ユーザー作成テンプレート
- [ ] SFTP連携
- [ ] クラウドストレージ連携
- [ ] 取込スケジュール設定

### Phase 3（将来）

- [ ] AI推論マッピング（列内容から推定）
- [ ] 差分取込オプション
- [ ] 取込前後比較レポート
- [ ] 仕訳明細取込（fact_journal_lines）

---

## 15. 未確定事項

| 項目 | 状態 | 備考 |
|------|------|------|
| API認証方式 | 要検討 | APIキー / OAuth2 |
| ファイルサイズ上限 | 要検討 | 10MB? 50MB? |
| 同時取込の排他制御 | 要検討 | 同一対象への同時取込防止 |
| マッピング提案のロジック | 要詳細化 | 類似度算出アルゴリズム |
| テンプレート作成UIの詳細 | 要詳細化 | Phase 2で設計 |

---

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2026-01-16 | 初版作成 |
| 2026-01-16 | 統合画面方式に変更、SpreadJSステージング採用、大量データ処理フロー追加（5,000行閾値） |
| 2026-01-16 | 運用方針（部門指定不要、テンプレート任意）、入力画面からの導線、行操作（除外フラグ方式）、取込完了モーダル追加 |
| 2026-01-16 | マッピング確認画面詳細化（表示タイミング、未設定コード選択UI、列変更UI、大量データ集計進捗）、エラー表示・修正詳細化（セルレベル表示、一括修正、エラーナビゲーション、自動修正提案） |
