# 月次締処理状況の管理機能 仕様検討

## 検討日: 2026-01-12

## 概要

会計期間（accounting_periods）の close_status を管理し、月次締め処理の進捗を可視化・制御する機能。

---

## 1. 現状確認

### 1.1 既存エンティティ: accounting_periods

```
|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|AP-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies(tenant_id,id) 複合FK|
|fiscal_year|int|NO|2025|FY|
|period_kind|varchar(10)|NO|"MONTH"|MONTH / ADJ|
|period_no|smallint|NO|1|MONTH:1-12, ADJ:13..|
|close_status|varchar(20)|NO|"OPEN"|OPEN/SOFT_CLOSED/HARD_CLOSED|
|closed_at|timestamptz|YES|||
```

### 1.2 close_statusの意味（既存定義）

| close_status | 意味 | 説明 |
|--------------|------|------|
| OPEN | 未締め | 入力可 |
| SOFT_CLOSED | 仮締め | 原則不可（権限者のみ可） |
| HARD_CLOSED | 本締め | 完全不可 |

---

## 2. 検討ポイント

### Q1. 締め処理のフローはどうなるか？

**想定フロー案**:
```
OPEN → SOFT_CLOSED → HARD_CLOSED
 ↑         ↓
 └─────────┘ (差し戻し可能)
```

- OPEN → SOFT_CLOSED: 仮締め実行
- SOFT_CLOSED → HARD_CLOSED: 本締め確定
- SOFT_CLOSED → OPEN: 差し戻し（権限者のみ）
- HARD_CLOSED → 戻せない（不可逆）？

**確認事項**:
- HARD_CLOSEDからの差し戻しは可能か？
- 差し戻しに条件はあるか？（例: 翌月が未締めの場合のみ）

### Q2. 誰が締め処理を実行するか？

**想定ロール**:
| 操作 | 実行者 |
|------|-------|
| OPEN → SOFT_CLOSED | 経理担当者 / 部門長 |
| SOFT_CLOSED → HARD_CLOSED | 経理部長 / 管理者 |
| 差し戻し（SOFT → OPEN） | 経理部長 / 管理者 |
| 差し戻し（HARD → SOFT？） | システム管理者のみ？ |

### Q3. 締め対象の単位は？

| 単位 | 説明 |
|------|------|
| 会社×月 | 標準。会社ごとに月次締めを管理 |
| 部門×月 | 部門単位で締め進捗を管理（オプション） |
| シナリオ×月 | 予算/見込/実績で別々に締める？ |

**現状のエンティティ設計**: 会社×月 単位

**確認事項**:
- 部門単位の締め管理は必要か？
- 予算/見込/実績で締めタイミングは異なるか？

### Q4. 締め処理に伴う自動処理は？

**想定される自動処理**:
1. **見込の実績置換**: HARD_CLOSED時、見込値を実績値で上書き
2. **入力制御の変更**: 締め状態に応じたUI制御
3. **ログ記録**: 締め操作の監査ログ

### Q5. 締め処理のチェック条件は？

**仮締め（SOFT_CLOSED）時のチェック**:
- [ ] 前月がHARD_CLOSED済みか？
- [ ] 実績取込が完了しているか？
- [ ] 調整入力が完了しているか？
- [ ] 必須入力チェック？

**本締め（HARD_CLOSED）時のチェック**:
- [ ] SOFT_CLOSED状態か？
- [ ] 承認が完了しているか？（ワークフローがある場合）

---

## 3. UI設計案

### 3.1 画面構成案

```
┌───────────────────────────────────────────────────────────────────────────┐
│ 月次締処理状況                                        [会社: ABC株式会社 ▼]│
├───────────────────────────────────────────────────────────────────────────┤
│ 年度: [2026 ▼]                                                            │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐│
│  │ 4月 │ 5月 │ 6月 │ 7月 │ 8月 │ 9月 │10月 │11月 │12月 │ 1月 │ 2月 │ 3月 ││
│  ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤│
│  │ ●  │ ●  │ ●  │ ◐  │ ○  │ ○  │ ○  │ ○  │ ○  │ ○  │ ○  │ ○  ││
│  │本締 │本締 │本締 │仮締 │未締 │未締 │未締 │未締 │未締 │未締 │未締 │未締 ││
│  └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘│
│                                                                           │
│  凡例: ● 本締め完了(HARD)  ◐ 仮締め(SOFT)  ○ 未締め(OPEN)               │
│                                                                           │
├───────────────────────────────────────────────────────────────────────────┤
│ 7月の締め操作                                                              │
│ ┌─────────────────────────────────────────────────────────────────────┐  │
│ │ 現在の状態: 仮締め (SOFT_CLOSED)                                     │  │
│ │ 仮締め日時: 2026-08-05 10:30                                         │  │
│ │ 操作者: 経理部 山田太郎                                              │  │
│ │                                                                      │  │
│ │ [本締めを実行] [仮締めを解除（差し戻し）]                            │  │
│ └─────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
│ 8月の締め操作                                                              │
│ ┌─────────────────────────────────────────────────────────────────────┐  │
│ │ 現在の状態: 未締め (OPEN)                                            │  │
│ │                                                                      │  │
│ │ 締め前チェック:                                                      │  │
│ │ ✓ 前月が本締め済み                                                   │  │
│ │ ✓ 実績取込完了                                                       │  │
│ │ △ 調整入力: 3件未完了                                                │  │
│ │                                                                      │  │
│ │ [仮締めを実行] (※調整入力の確認が必要です)                          │  │
│ └─────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────┘
```

### 3.2 操作ボタン

| ボタン | 表示条件 | 動作 |
|--------|---------|------|
| 仮締めを実行 | OPEN状態 | SOFT_CLOSEDに変更 |
| 本締めを実行 | SOFT_CLOSED状態 | HARD_CLOSEDに変更 |
| 仮締めを解除 | SOFT_CLOSED状態 + 権限あり | OPENに戻す |
| 本締めを解除 | HARD_CLOSED状態 + 特権 | SOFT_CLOSEDに戻す（要確認） |

---

## 4. エンティティ拡張案

### 4.1 締め操作ログ（新規テーブル案）

```sql
-- period_close_logs: 締め操作の監査ログ
CREATE TABLE period_close_logs (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  accounting_period_id uuid NOT NULL,
  action varchar(20) NOT NULL,  -- 'SOFT_CLOSE' / 'HARD_CLOSE' / 'REOPEN' / 'REVERT_TO_SOFT'
  from_status varchar(20) NOT NULL,
  to_status varchar(20) NOT NULL,
  operated_by uuid NOT NULL,  -- 操作者
  operated_at timestamptz NOT NULL,
  notes text,  -- 理由等
  FOREIGN KEY (tenant_id, company_id, accounting_period_id)
    REFERENCES accounting_periods(tenant_id, company_id, id)
);
```

### 4.2 部門単位の締め状態（オプション案）

部門単位で締め進捗を管理する場合:

```sql
-- department_close_status: 部門単位の締め進捗
CREATE TABLE department_close_status (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  accounting_period_id uuid NOT NULL,
  department_stable_id uuid NOT NULL,
  actual_entry_status varchar(20) DEFAULT 'PENDING',  -- PENDING / COMPLETED
  adjustment_status varchar(20) DEFAULT 'PENDING',
  approval_status varchar(20) DEFAULT 'PENDING',
  updated_at timestamptz NOT NULL,
  updated_by uuid
);
```

---

## 5. 連携機能

### 5.1 実績入力との連携

- HARD_CLOSED月: 実績入力不可（グレーアウト）
- SOFT_CLOSED月: 警告表示、権限者のみ編集可

### 5.2 見込入力との連携

- HARD_CLOSED月: 実績値を自動表示（見込値を上書き）
- 新規見込作成時: HARD_CLOSED月は実績コピー

### 5.3 予算入力との連携

- 締め状態は予算入力に影響しない（予算は年度単位で管理）

---

## 6. 決定事項

（QA壁打ち後に記録）

| 項目 | 決定内容 | 決定日 |
|------|---------|-------|
| - | - | - |

---

## 7. 次のアクション

1. [ ] 締め処理フローの確定
2. [ ] 権限設計の詳細化
3. [ ] 締め前チェック項目の洗い出し
4. [ ] エンティティ設計の確定
5. [ ] UI設計の詳細化
6. [ ] BFF Contracts定義

---

## 8. 関連仕様

- `.kiro/specs/entities/01_各種マスタ.md` - accounting_periodsエンティティ
- `.kiro/specs/仕様概要/実績入力機能.md` - 実績入力との連携
- `.kiro/specs/仕様概要/見込入力機能.md` - 見込入力との連携
