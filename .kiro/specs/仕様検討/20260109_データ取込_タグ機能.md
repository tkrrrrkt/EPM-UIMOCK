# データ取込・タグ機能 仕様検討（2026-01-09）

## 検討背景

予算・実績データの取込アーキテクチャと、仕訳明細に対する軽量タグ機能の設計。

---

## Q1: 取込用ワークテーブルの分離

### 質問
予算と実績の取込用ワークテーブルを分けるか、統一するか。

### 回答（ユーザー）
> 取り込みワークはパフォーマンス考えて分けようかなとおもいます。予算/実績

### 決定
**分離**: budget_import_staging と actual_import_staging を別テーブルとする

### 理由
- パフォーマンス確保（大量データ取込時の排他競合回避）
- 予算と実績で取込タイミング・頻度が異なる
- バリデーションルールも一部異なる（予算はplan_event/version必須等）

---

## Q2: 仕訳明細の借方/貸方フォーマット

### 質問
ERPから取り込む仕訳明細のフォーマットについて。借方/貸方の表現方法。

### 選択肢
1. **SINGLE形式**: debit_amount / credit_amount を別列で持つ
2. **DOUBLE形式**: debit_credit フラグ（D/C）+ amount（金額）で1列

### 回答（ユーザー）
> 両方のパターンに対応できるようにしておくっていけますか

### 決定
**両形式対応**: line_format カラムで形式を判別し、両方の列を持つ

```
line_format = 'SINGLE' → debit_amount, credit_amount を使用
line_format = 'DOUBLE' → debit_credit, amount を使用
```

### 理由
- ERPによって出力形式が異なる
- データ移行時の柔軟性確保
- 集計時は統一的に処理可能（View/バッチで吸収）

---

## Q3: 軽量タグ機能の設計

### 質問
仕訳明細に付随する補足情報（顧客名、プロジェクト名等）をどう持つか。

### 選択肢
1. **ディメンションとして扱う**: dimension_values に登録、fact_dimension_links でリンク
2. **軽量タグ**: 固定列（tag1〜tag5）で値のみ保持

### 回答（ユーザー）
> タグ・ラベルは、さっきのディメンションよりかるいやつで、分析軸というよりは、取り込んだものを検索するため。（中略）コードは持たない。値だけでいい。何個までとかあれば教えてください

### 決定
**軽量タグ方式**: 5つの固定列（tag1〜tag5）、値のみ保持

### 設計詳細
- **値の保持場所**: fact_journal_lines.tag1〜tag5（varchar(200)）
- **ラベルの定義場所**: companies.tag1_label〜tag5_label（varchar(50)）
- **コード管理**: なし（値のみ、マスタ参照なし）

### 理由
- ディメンション（経営粒度）ではなく、検索・参照用途
- 値のゆらぎがあっても運用上許容
- 5個あれば実務上十分（顧客名、案件、担当者、備考等）
- シンプルな構造でパフォーマンス確保

---

## Q4: タグのゆらぎ許容

### 質問
タグの値にゆらぎ（表記ゆれ）があった場合の扱い。

### 回答（ユーザー）
> まあ、そこはゆらぎがあるかないかは、実績側の運用なので、値だけ保持したいとおもいます

### 決定
- 値のゆらぎは許容（正規化しない）
- 検索時は部分一致等で対応
- 必要に応じてView等で正規化表示

---

## 確定事項まとめ

| 項目 | 決定内容 |
|------|---------|
| 取込ステージング | 予算/実績を分離（budget_import_staging / actual_import_staging） |
| 仕訳形式 | SINGLE/DOUBLE両対応（line_format で判別） |
| タグ数 | 5個固定（tag1〜tag5） |
| タグ内容 | 値のみ（コード・マスタ参照なし） |
| タグラベル | companies テーブルで会社別に定義 |

---

## 追加エンティティ

1. **budget_import_staging**（12.3）: 予算取込ステージング
2. **actual_import_staging**（12.4）: 実績取込ステージング
3. **fact_journal_lines**（12.5）: 仕訳明細ファクト

---

## 次のアクション

- [x] companies エンティティに tag1_label〜tag5_label を追加
- [x] budget_import_staging エンティティ作成
- [x] actual_import_staging エンティティ作成
- [x] fact_journal_lines エンティティ作成
- [ ] 仕様概要ドキュメント作成

---

## 参加者

- ユーザー
- Claude Code

## 検討日

2026-01-09
