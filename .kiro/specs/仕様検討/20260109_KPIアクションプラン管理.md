# KPIアクションプラン管理 仕様検討

## 検討日

2026-01-09

## 参加者

- ユーザー
- Claude Code

## 検討背景

KPI目標達成のための施策管理機能。KPIの予算・実績と連動して、アクションプランのタスク・スケジュールを管理する。Trelloのようなカンバン形式やWBS/ガントチャート形式での管理を提供。

**競合差別化ポイント**：Loglass・DIGGLEともにWBS管理・カンバンボード機能は**未対応**（企画書P.22）

---

## 1. 機能概要（企画書から確認）

### 1.1 企画書記載内容

**P.15 KGI/KPI管理**
- 階層構造でKPI管理、進捗表示
- 各KPIに「アクションプラン」が紐づく

**P.16 アクションプラン管理**
- ESG、SDGs等の企業レベルのタスクを管理可能
- 進捗はカンバン・WBS形式どちらも可能

**P.22 想定機能一覧**
| 機能名 | 概要 |
|--------|------|
| アクションプラン登録 | KPIの達成を実現するためのアクションプランの登録（アラートメール通知含む） |
| WBS管理 | WBSの登録、ガントチャートの登録 |
| タスク管理かんばんボード | - |
| KGI/KPIダッシュボード | レイアウトは固定の形態、予算実績値を表示する機能 |

### 1.2 ユーザー要件

> レイアウトの予算実績照会画面から、もしくはメニューから、KPI選択して、そのKPI設定に対しての、
> - タスク・スケジュール管理　それに応じて、予算実績の達成状況や推移がみれる。数値やグラフで。
> - そのタスクやスケジュールは、Trelloなどの看板形式で登録管理できる、もしくは簡単なWBSのイメージで管理できる

---

## 2. 決定事項

### 2.1 基本方針

| 項目 | 決定 |
|------|------|
| KPIとアクションプランの関係 | **1:N**（1つのKPIに複数のアクションプラン） |
| 階層構造 | **3階層**（アクションプラン → WBS → タスク） |
| ステータス管理 | **カスタマイズ可能**（会社ごとにステータス定義） |
| カンバンボード | **必須**（Phase 1） |
| ガントチャート | **必須**（Phase 1、有償ライブラリ活用前提） |

### 2.2 画面構成

| 画面 | 用途 | 対象エンティティ |
|------|------|-----------------|
| ガントチャート | WBS項目のスケジュール管理 | wbs_items |
| カンバンボード | タスクのステータス管理 | action_plan_tasks |
| KPI連携ダッシュボード | KPI予実 + アクションプラン進捗を並べて表示 | subjects + fact_amounts + action_plans |

### 2.3 ライブラリ方針

| 機能 | ライブラリ候補 | 備考 |
|------|--------------|------|
| ガントチャート | dhtmlxGantt / Bryntum Gantt / Syncfusion | 有償ライブラリ活用 |
| カンバンボード | react-beautiful-dnd / dnd-kit | OSS |

---

## 3. エンティティ設計

### 3.1 データ構造概要

```
subjects (KPI科目)
    │
    └── action_plans (アクションプラン)
            │
            └── wbs_items (WBS項目) ← ガントチャート用、階層持ち
                    │
                    └── action_plan_tasks (タスク) ← カンバン用
```

### 3.2 新規エンティティ一覧

| エンティティ | 役割 |
|-------------|------|
| action_plans | アクションプラン（KPIに紐付く施策） |
| wbs_items | WBS項目（ガントチャート用、階層構造） |
| action_plan_tasks | タスク（カンバン用） |
| task_statuses | ステータス定義（会社ごとにカスタマイズ） |

### 3.3 エンティティ詳細

#### action_plans（アクションプラン）

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| company_id | uuid | NO | | FK |
| subject_id | uuid | NO | | FK to subjects (KPI科目) |
| plan_code | varchar(50) | NO | "AP-2026-001" | 会社内一意 |
| plan_name | varchar(200) | NO | "働き方改革の推進" | |
| description | text | YES | | |
| owner_department_stable_id | varchar(50) | YES | | 責任部門 |
| owner_employee_id | uuid | YES | | FK to employees |
| start_date | date | YES | | |
| due_date | date | YES | | |
| status | varchar(20) | NO | "IN_PROGRESS" | NOT_STARTED/IN_PROGRESS/COMPLETED/CANCELLED |
| progress_rate | smallint | YES | 40 | 0-100 |
| priority | varchar(10) | YES | "HIGH" | HIGH/MEDIUM/LOW |
| is_active | boolean | NO | true | |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |
| created_by | uuid | YES | | 監査 |
| updated_by | uuid | YES | | 監査 |

#### wbs_items（WBS項目）

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| action_plan_id | uuid | NO | | FK to action_plans |
| parent_wbs_id | uuid | YES | | 自己参照（階層） |
| wbs_code | varchar(50) | NO | "1.1.1" | WBS番号 |
| wbs_name | varchar(200) | NO | "要件定義" | |
| description | text | YES | | |
| assignee_department_stable_id | varchar(50) | YES | | 担当部門 |
| assignee_employee_id | uuid | YES | | FK to employees |
| start_date | date | YES | | ガントチャート用 |
| due_date | date | YES | | ガントチャート用 |
| actual_start_date | date | YES | | 実績 |
| actual_end_date | date | YES | | 実績 |
| progress_rate | smallint | YES | 0 | 0-100 |
| predecessor_wbs_id | uuid | YES | | 先行WBS（依存関係） |
| sort_order | int | NO | 1 | 表示順 |
| is_milestone | boolean | NO | false | マイルストーンフラグ |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |

#### action_plan_tasks（タスク）

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| wbs_item_id | uuid | NO | | FK to wbs_items |
| task_name | varchar(200) | NO | "ヒアリング実施" | |
| description | text | YES | | |
| assignee_employee_id | uuid | YES | | FK to employees |
| status_id | uuid | NO | | FK to task_statuses |
| due_date | date | YES | | |
| sort_order | int | NO | 1 | カンバン内の並び順 |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |

#### task_statuses（ステータス定義）

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| company_id | uuid | NO | | FK |
| status_code | varchar(30) | NO | "IN_PROGRESS" | |
| status_name | varchar(50) | NO | "進行中" | 表示名 |
| color_code | varchar(7) | YES | "#3B82F6" | カンバン表示色 |
| sort_order | int | NO | 2 | カンバンの左から順 |
| is_default | boolean | NO | false | 新規タスクのデフォルト |
| is_completed | boolean | NO | false | 完了扱いフラグ |
| is_active | boolean | NO | true | |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |

---

## 4. 画面設計

### 4.1 エントリーポイント

```
1. メニューから直接
   [メニュー] → [KPI/KGI] → [アクションプラン管理]

2. KPIダッシュボードから
   [KPIダッシュボード] → [KPI選択] → [アクションプラン追加]

3. 予算実績照会画面から
   [予算実績照会] → [KPI行クリック] → [アクションプラン表示]
```

### 4.2 カンバンボードイメージ

```
┌─────────────────────────────────────────────────────────────┐
│ 省エネ設備の導入 - かんばんボード                            │
│ WBS: 1.2 設備導入                                           │
├─────────────┬─────────────┬─────────────┬─────────────────┤
│ 未着手       │ 進行中       │ レビュー中   │ 完了            │
├─────────────┼─────────────┼─────────────┼─────────────────┤
│ ┌─────────┐│ ┌─────────┐│ ┌─────────┐│ ┌─────────┐      │
│ │効果測定  ││ │導入計画  ││ │予算申請  ││ │省エネ設備│      │
│ │         ││ │の策定    ││ │・承認    ││ │の調査    │      │
│ │担当:村本 ││ │担当:柏木 ││ │担当:中村 ││ │担当:村本 │      │
│ │期限:6/30││ │期限:5/15 ││ │期限:4/15 ││ │完了:5/15 │      │
│ └─────────┘│ └─────────┘│ └─────────┘│ └─────────┘      │
└─────────────┴─────────────┴─────────────┴─────────────────┘
```

### 4.3 ガントチャートイメージ

```
┌─────────────────────────────────────────────────────────────┐
│ 省エネ設備の導入 - ガントチャート                            │
├─────────────────────────────────────────────────────────────┤
│ WBS項目          │ 4月    │ 5月    │ 6月    │ 7月    │     │
├──────────────────┼────────┴────────┴────────┴────────┤     │
│ 1. 調査・企画    │ ████████                          │ 40% │
│   1.1 設備調査   │ ████                              │100% │
│   1.2 要件定義   │     ████                          │ 60% │
│ 2. 設備導入      │         ████████████              │ 20% │
│   2.1 予算申請   │         ████                      │ 50% │
│   2.2 導入工事   │             ████████              │  0% │
│ 3. 効果測定      │                     ████          │  0% │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 KPI連携ダッシュボード

```
┌─────────────────────────────────────────────────────────────┐
│ KPI: CO2排出量                                              │
├─────────────────────────────────────────────────────────────┤
│ 【目標・実績】                                              │
│ ┌─────────────────────────────────────────────────────────┐│
│ │ 目標: 1000t以下   実績: 1150t   達成率: 87%             ││
│ │                                                         ││
│ │ [推移グラフ]                                            ││
│ │ 1200 ●───●                                              ││
│ │ 1100     ●───●───●                                      ││
│ │ 1000 ─────────────────────────────────── 目標           ││
│ │      4月  5月  6月  7月  8月                             ││
│ └─────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────┤
│ 【アクションプラン】                                        │
│ ┌───────────────────────┬─────────┬─────────┬───────────┐ │
│ │ プラン名              │ 担当    │ 期限    │ 進捗      │ │
│ ├───────────────────────┼─────────┼─────────┼───────────┤ │
│ │ 省エネ設備の導入      │ 総務部  │ 9/30    │ ██░░ 40%  │ │
│ │ 社用車EV化推進        │ 管理部  │ 12/31   │ █░░░ 20%  │ │
│ └───────────────────────┴─────────┴─────────┴───────────┘ │
│                                    [+ アクションプラン追加] │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. UI操作詳細（Trello準拠）

### 5.1 カンバンボード操作

#### 基本操作

| 操作 | 挙動 | 備考 |
|------|------|------|
| タスクカードのドラッグ&ドロップ（列間） | ステータス変更 | **即時保存** |
| タスクカードのドラッグ&ドロップ（同一列内） | 並び順変更（sort_order更新） | **即時保存** |
| タスクカードクリック | 詳細モーダル表示 | |
| タスクカード上でのインライン編集 | タスク名等の簡易編集 | |
| 「+」ボタン | 新規タスク追加（デフォルトステータス列） | |

#### タスク編集方式

**両方対応**:
- **インライン編集**: タスク名、担当者等の簡易編集
- **モーダル編集**: 詳細情報（説明、チェックリスト、コメント等）

#### タスクカード表示要素

```
┌─────────────────────────┐
│ 🏷️ ラベル（色）         │
│ タスク名                │
│ ☑ 2/5（チェックリスト） │
│ 👤 担当者（複数可）      │
│ 📅 期限                 │
└─────────────────────────┘
```

### 5.2 ガントチャート操作

#### 基本操作

| 操作 | 挙動 | 備考 |
|------|------|------|
| バーの左右ドラッグ | 開始日/終了日変更 | **即時保存** |
| バーの伸縮（端をドラッグ） | 期間変更 | **即時保存** |
| 左側グリッドでのインライン編集 | WBS名、担当者等の編集 | ライブラリ依存 |
| 行クリック | WBS詳細モーダル表示 | |
| 依存線のドラッグ | 先行タスク設定（predecessor_wbs_id） | |
| 階層の展開/折りたたみ | 子WBSの表示切替 | |
| WBS行ダブルクリック | カンバンボードへドリルダウン | 該当WBSで絞り込み |

#### 進捗率（progress_rate）更新方式

**両方選択可能**:
- **手動入力**: ユーザーが%を直接入力
- **自動計算**: 配下タスクの完了率から自動算出（完了タスク数/全タスク数）

設定で切り替え可能とする。

### 5.3 画面遷移

```
┌────────────────────────────────────────────────────┐
│ アクションプラン一覧                                │
├────────────────────────────────────────────────────┤
│ プラン名              │ 担当  │ 期限  │ 操作      │
│ 省エネ設備の導入      │ 総務部│ 9/30  │[ガント][カンバン]│
└────────────────────────────────────────────────────┘
         ↓ [ガント]              ↓ [カンバン]
┌─────────────────────────┐    ┌─────────────────────────┐
│ ガントチャート画面       │    │ カンバンボード画面       │
│ WBS全体を表示           │    │ 全タスク表示             │
│                         │    │ （WBS絞り込み可）        │
│ WBS行ダブルクリック ────┼───→│ 該当WBSで絞り込み        │
└─────────────────────────┘    └─────────────────────────┘
```

### 5.4 カンバン表示範囲

**切替可能**:
- **全体表示**: プラン配下の全WBSのタスクを表示
- **WBS絞り込み**: 特定WBSのタスクのみ表示（ガントからのドリルダウン時）

### 5.5 フィルタ・検索（Phase 1 必須）

#### カンバンボード

| フィルタ項目 | 対象カラム |
|------------|-----------|
| 担当者 | assignee_employee_ids（複数対応） |
| 期限（今週/今月/期限切れ） | due_date |
| WBS項目 | wbs_item_id |
| ラベル | task_labels |

#### ガントチャート

| フィルタ項目 | 対象カラム |
|------------|-----------|
| 担当部門 | assignee_department_stable_id |
| マイルストーンのみ | is_milestone = true |
| 表示期間 | 月/四半期/年 |

### 5.6 同時編集時の挙動

**Phase 1: 楽観的ロック方式**
- 後勝ち（Last Write Wins）
- 競合検知時にエラー表示、リロード促進
- updated_at による楽観的ロック実装

**Phase 2: リアルタイム同期（将来）**
- WebSocket等で即時反映

### 5.7 Trello準拠機能（Phase 1）

| 機能 | Phase 1 対応 | 備考 |
|------|-------------|------|
| カード色ラベル | ✅ | task_labels テーブル追加 |
| チェックリスト | ✅ | task_checklist_items テーブル追加 |
| コメント | ✅ | task_comments テーブル追加 |
| 複数メンバーアサイン | ✅ | task_assignees 中間テーブル |
| 添付ファイル | ❌ Phase 2 | |
| アクティビティログ | ❌ Phase 2 | |

---

## 6. 工数見積（参考）

### 6.1 ライブラリ活用前提

| フェーズ | 工数（AI活用 + ライブラリ） |
|----------|---------------------------|
| エンティティ設計・実装 | 0.5日 |
| API (CRUD) | 1日 |
| ガントチャート画面 | 1〜2日（有償ライブラリ活用） |
| カンバン画面 | 1〜2日（OSS活用） |
| KPI連携ダッシュボード | 1日 |
| ステータス設定画面 | 0.5日 |
| テスト・調整 | 1〜2日 |
| **合計** | **6〜9日** |

### 6.2 ライブラリ費用（参考）

| ライブラリ | 価格帯 |
|-----------|--------|
| dhtmlxGantt | $599〜 |
| Bryntum Gantt | $395〜 |
| Syncfusion | $995〜/年 |

---

## 7. 残検討事項

| 項目 | 状態 | 備考 |
|------|------|------|
| ガントチャートライブラリ選定 | 未確定 | 導入時に比較検討 |
| アラート・通知機能 | Phase 2 | 期限超過通知等 |
| 権限設計 | 別途検討 | 誰がどのアクションプランを編集できるか |
| 添付ファイル | Phase 2 | ストレージ設計が必要 |
| アクティビティログ | Phase 2 | 操作履歴の保存・表示 |

---

## 関連ドキュメント

- `.kiro/specs/仕様検討/20260109_KPI管理機能.md` - KPI管理機能の仕様
- `.kiro/specs/仕様概要/KPI管理機能.md` - KPI管理機能仕様概要
- `.kiro/specs/entities/01_各種マスタ.md` - エンティティ定義
- `doc/business/EPM企画書.pdf` - 企画書（P.15-16, P.22）
