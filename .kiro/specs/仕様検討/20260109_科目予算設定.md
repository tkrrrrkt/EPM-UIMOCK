# 科目予算設定

## 検討日
2026-01-09

## 参加者
- ユーザー
- Claude Code (Claude Opus 4.5)

## 検討背景

予算入力機能において、科目によって予算作成の粒度が異なる要件がある：
- **パターンA**: 科目 × 部門 のみで予算を作成（人件費、一般管理費など）
- **パターンB**: 科目 × 部門 × ディメンション で予算を作成（プロジェクト別原価など）

この設定を管理するマスタと、予算イベント作成時のスナップショット方式を検討した。

## 議論内容

### Q1: 設定の粒度は？

**回答**: 科目 × 部門 単位で設定する。

### Q2: ディメンションの選択は？

**回答**: 1科目につき最大1ディメンションまで設定可能。

### Q3: スナップショットの保持方法は？

**選択肢:**
- A案: 別テーブルに複製（シンプル、イベントごとに独立）
- B案: 履歴管理（効率的だが複雑）

**回答**: A案を採用。理由：
- 予算イベントの独立性が明確
- シンプルな実装
- デバッグしやすい
- EPMの実務に適合（年次サイクルで確実性が重要）

### Q4: ファクトテーブルのディメンション設計は？

**背景**: 当初、プロジェクトとIRセグメントは `fact_amounts` に横持ち（固定列）で設計していた。

**決定**: 横持ちせず、全ディメンションを `fact_dimension_links` で縦持ち統一とする。

理由：
- 設定次第でどの科目にどのディメンションを使うか柔軟に変更可能
- ディメンションの種類が増えても `fact_amounts` のスキーマ変更不要
- 一貫した設計

### Q5: レイアウトマスタとの関係は？

**確認内容:**
- 予算イベント作成時にレイアウトマスタを選択
- レイアウトに従った科目一覧が表示される
- 科目によってはディメンションバリュー単位で展開入力
- 保存時に `fact_amounts` + `fact_dimension_links` に登録

## 決定事項

### 新規エンティティ

#### subject_budget_settings（マスタ）
| カラム | 型 | NULL | 補足 |
|--------|-----|------|------|
| id | uuid | NO | PK |
| tenant_id | uuid | NO | RLS |
| company_id | uuid | NO | 会社 |
| subject_id | uuid | NO | 科目 |
| entity_id | uuid | NO | 部門 |
| use_dimension | boolean | NO | ディメンション使用フラグ |
| dimension_id | uuid | YES | 使用するディメンション（1つまで） |
| created_at | timestamptz | NO | |
| updated_at | timestamptz | NO | |

- UNIQUE(tenant_id, company_id, subject_id, entity_id)

#### scenario_subject_settings（スナップショット）
| カラム | 型 | NULL | 補足 |
|--------|-----|------|------|
| id | uuid | NO | PK |
| tenant_id | uuid | NO | RLS |
| company_id | uuid | NO | 会社 |
| scenario_id | uuid | NO | 予算イベント |
| subject_id | uuid | NO | 科目 |
| entity_id | uuid | NO | 部門 |
| use_dimension | boolean | NO | ディメンション使用フラグ |
| dimension_id | uuid | YES | 使用するディメンション |
| copied_at | timestamptz | NO | コピー日時 |
| created_at | timestamptz | NO | |
| updated_at | timestamptz | NO | |

- UNIQUE(tenant_id, company_id, scenario_id, subject_id, entity_id)

### fact_amounts の変更

以下のカラムを削除：
- `project_id`
- `project_key`
- `ir_segment_value_id`
- `ir_segment_key`

ユニーク制約も対応して変更。

### 運用フロー

```
1. マスタ設定（subject_budget_settings）
   - 科目×部門ごとにディメンション使用/不使用を設定

2. 予算イベント作成
   - レイアウトマスタを選択
   - subject_budget_settings → scenario_subject_settings にコピー
   - 以後、バージョンが変わっても構成は固定

3. 予算入力
   - 部門を選択
   - レイアウトに従った科目一覧表示
   - 科目によってはディメンションバリュー単位で展開入力

4. 保存
   - fact_amounts に登録
   - ディメンション使用科目は fact_dimension_links にも登録
```

## 未決事項・次回検討

- レイアウトマスタとの詳細な連携仕様
- 予算イベントエンティティの修正内容詳細

## 関連ドキュメント

- `.kiro/specs/entities/01_各種マスタ.md` - fact_amounts, fact_dimension_links
- `.kiro/specs/仕様検討/ディメンション構造_20260109.md` - ディメンション3層構造
