# ディメンション構造

## 検討日
2026-01-09

## 参加者
- ユーザー
- Claude Code (Claude Opus 4.5)

## 検討背景
予算入力機能（budget-entry）の設計にあたり、ファクトテーブル（fact_amounts）とディメンションテーブル群の関係性を明確にする必要があった。特に、以下の点について理解を深める必要があった：
- dimension_members と dimension_member_groups の役割の違い
- dimension_values との関係性
- fact_amounts と各ディメンションテーブルの接続方法

## 議論内容

### Q1: ディメンションメンバーグループとは、ディメンションバリューの詳細な値を保持する場合の想定のエンティティですか？

A1: いいえ、逆です。

**dimension_member_groups** は「Leaf（詳細）→ Group（集約）」の分類テーブルです。

構造：
```
dimension_members (Leaf: 大量の個別コード)
    ↓ 分類
dimension_member_groups (分類マッピング)
    ↓ 所属先
dimension_values (Group: 経営粒度の集約単位)
```

例：
- dimension_members: 社員コード「E001」「E002」「E003」...（数千件）
- dimension_values: 部門「営業部」「開発部」（数十件）
- dimension_member_groups: E001 → 営業部, E002 → 開発部（分類）

このテーブルには期間管理（valid_from, valid_to）があり、時点によって分類が変わることに対応。

### Q2: ディメンションメンバーは、実績データからの情報の保持・蓄積テーブルみたいなものの想定でしたか？

A2: はい、その理解で正確です。

**dimension_members** の役割：
1. **実績データからの蓄積**: 外部システムから取り込んだ実績データに含まれるコード（社員コード、プロジェクトコード等）を保持
2. **Leaf レベルの粒度**: 最も細かい粒度のマスタデータ
3. **Group への分類元**: dimension_member_groups を通じて dimension_values（Group）に分類される

データフロー：
```
外部システム（会計、人事等）
    ↓ データ取込
fact_amounts（実績ファクト）
    ↓ コード抽出・登録
dimension_members（Leaf 蓄積）
    ↓ 分類設定
dimension_member_groups（Leaf→Group マッピング）
    ↓ 集計軸
dimension_values（Group: 経営レポート軸）
```

## 決定事項

### 3層ディメンション構造

| レイヤー | テーブル | 役割 | データ量 |
|---------|---------|------|---------|
| 軸定義 | dimensions | ディメンション軸の定義 | 少（10件程度） |
| Group | dimension_values | 経営粒度の集約単位 | 中（数百件） |
| Leaf | dimension_members | 外部システムからの詳細コード | 多（数千〜数万件） |

### テーブル間リレーション

```
dimensions (軸定義)
    │
    ├── dimension_values (Group: 経営粒度)
    │       │
    │       └── dimension_member_groups (Leaf→Group 分類)
    │               │
    │               └── dimension_members (Leaf: 詳細コード)
    │
    └── fact_dimension_links (ファクト→Group 付与)
            │
            └── fact_amounts (ファクトテーブル)
```

### fact_amounts とディメンションの関係

- **fact_amounts** は **dimension_values（Group）** に直接リンク（fact_dimension_links 経由）
- **Leaf レベル（dimension_members）** はファクトに直接リンクしない
- 実績取込時に Leaf を蓄積し、Group への分類を設定することで集計可能にする

### fact_amounts のユニーク制約（改訂後）

```sql
UNIQUE (
  tenant_id, company_id,
  accounting_period_id,
  scenario_type, plan_version_id,
  source_type,
  subject_id,
  org_version_id, department_stable_id
)
```

> **注記（2026-01-09）**: project_id, ir_segment_value_id 等の固定列は削除され、全ディメンションは fact_dimension_links で縦持ち統一となった。詳細は `科目予算設定_20260109.md` を参照。

## MVP 除外事項（2026-01-09 追記）

以下はエンティティ定義は作成するが、MVP（1次リリース）では機能を作成しない：

| エンティティ | 理由 |
|-------------|------|
| dimension_members | 実績取込機能が Phase 2 以降のため |
| dimension_member_groups | Leaf→Group 分類機能は実績取込と同時に対応 |

これらは将来の実績取込機能の実装時に再検討する。

## 未決事項・次回検討

- dimension_members への実績データ取込の具体的なフロー
- dimension_member_groups の期間管理（valid_from, valid_to）の運用ルール
- Leaf → Group 分類の変更時の過去データへの影響

## 関連ドキュメント

- `.kiro/specs/entities/01_各種マスタ.md` - エンティティ定義（dimensions, dimension_values, dimension_members, dimension_member_groups, fact_amounts, fact_dimension_links）
- `.kiro/specs/planning/budget-entry/` - 予算入力機能仕様
