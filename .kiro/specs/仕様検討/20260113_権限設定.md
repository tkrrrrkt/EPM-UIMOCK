# 権限設定 仕様検討

## 検討日: 2026-01-13

## 概要

EPM SaaS における機能ベースの権限管理システム。会社単位でメニュー（機能）とロールを管理し、社員にロールを割り当てることでアクセス制御を行う。親会社・子会社は完全分離し、連結機能は主会社のみが使用可能。

---

## 1. 検討の背景

### 1.1 要件

- 親会社と子会社が存在するが、データアクセスは完全分離
- 機能（メニュー）ベースの権限管理
- ロールに応じた権限設定
- データスコープ（参照可能な部門範囲）の制御

### 1.2 ゴール

- シンプルで運用しやすい権限モデル
- 会社ごとに独立した権限管理
- 連結機能は主会社のみに制限

---

## 2. 設計方針の検討

### 2.1 会社スコープの権限

| 方式 | 説明 | 採否 |
|------|------|------|
| グループ全社アクセス | 1ユーザーが複数会社にアクセス可能 | ✗ 不採用 |
| 会社単位アクセス | 1ユーザーは1会社のみ | ✓ 採用 |

**決定**: 1社員 = 1会社（employees.company_id）

### 2.2 親会社・子会社の関係

| 方式 | 説明 | 採否 |
|------|------|------|
| 親会社が子会社データ参照可能 | 連結用に子会社データ閲覧 | ✗ 不採用 |
| 完全分離 | 親子で完全に独立したデータ | ✓ 採用 |

**決定**: 親会社と子会社は完全分離。連結機能は「主会社」のみが使用可能。

### 2.3 主会社（Primary Company）の概念

- テナントに `primary_company_id` を追加
- 連結関係の機能は主会社に所属する社員のみ割当可能
- 子会社の社員には連結メニューは表示されない

### 2.4 権限モデル

| 方式 | 説明 | 採否 |
|------|------|------|
| 機能単位の直接割当 | 社員ごとに機能を割当 | ✗ 複雑 |
| ロールベース（RBAC） | ロールに権限を設定、社員にロール割当 | ✓ 採用 |

**決定**: ロールベースの権限管理

### 2.5 アクセスレベル

| 方式 | 説明 | 採否 |
|------|------|------|
| 多段階（参照/作成/編集/削除/承認） | 細かい制御 | ✗ 過剰 |
| シンプル3段階（A/B/C） | フル/参照のみ/アクセス不可 | ✓ 採用 |

**決定**:
- A: フル権限（参照・編集・削除）
- B: 参照のみ
- C: アクセス不可

### 2.6 データスコープ

| 方式 | 説明 | 採否 |
|------|------|------|
| ロール単位でスコープ設定 | ロールごとに固定スコープ | ✗ 柔軟性不足 |
| 機能単位でスコープ設定 | 機能ごとにスコープを設定 | ✓ 採用 |

**決定**: 機能（メニュー）単位でデータスコープを設定

スコープ種別:
- ALL: 全社データ参照可能
- HIERARCHY: 所属部門と配下部門のみ
- ASSIGNED: 指定部門のみ

### 2.7 複数ロール割当

| 方式 | 説明 | 採否 |
|------|------|------|
| 複数ロール可（最大権限適用） | 権限マージのロジック必要 | ✗ 複雑 |
| 1社員1ロール | UIで制御 | ✓ 採用 |

**決定**: 1社員 = 1ロール（UIで重複登録を防止）

---

## 3. エンティティ設計

### 3.1 menus（機能マスタ）

```sql
CREATE TABLE menus (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  menu_code varchar(50) NOT NULL,
  menu_name varchar(200) NOT NULL,
  menu_category varchar(50),           -- 任意（グルーピング用）
  menu_type varchar(50),               -- 任意（分類用: master/transaction/report/admin）
  parent_menu_id uuid,                 -- 階層メニュー用
  url_path varchar(500),
  icon_name varchar(100),
  sort_order int NOT NULL DEFAULT 0,
  is_consolidation boolean NOT NULL DEFAULT false,  -- 連結専用機能フラグ
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),

  UNIQUE(tenant_id, company_id, menu_code),
  FOREIGN KEY (tenant_id, company_id) REFERENCES companies(tenant_id, id),
  FOREIGN KEY (parent_menu_id) REFERENCES menus(id)
);
```

### 3.2 roles（ロール定義）

```sql
CREATE TABLE roles (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  role_code varchar(50) NOT NULL,
  role_name varchar(200) NOT NULL,
  role_description text,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),

  UNIQUE(tenant_id, company_id, role_code),
  FOREIGN KEY (tenant_id, company_id) REFERENCES companies(tenant_id, id)
);
```

### 3.3 role_menu_permissions（ロール×機能 権限設定）

```sql
CREATE TABLE role_menu_permissions (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  role_id uuid NOT NULL,
  menu_id uuid NOT NULL,
  access_level char(1) NOT NULL CHECK (access_level IN ('A', 'B', 'C')),
  data_scope varchar(20) NOT NULL CHECK (data_scope IN ('ALL', 'HIERARCHY', 'ASSIGNED')),
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),

  UNIQUE(tenant_id, role_id, menu_id),
  FOREIGN KEY (tenant_id, company_id) REFERENCES companies(tenant_id, id),
  FOREIGN KEY (role_id) REFERENCES roles(id),
  FOREIGN KEY (menu_id) REFERENCES menus(id)
);
```

### 3.4 role_menu_department_assignments（ASSIGNED時の部門指定）

```sql
CREATE TABLE role_menu_department_assignments (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  role_menu_permission_id uuid NOT NULL,
  department_stable_id varchar(50) NOT NULL,  -- departments.stable_id
  include_children boolean NOT NULL DEFAULT false,  -- 配下部門を含むか
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),

  UNIQUE(tenant_id, role_menu_permission_id, department_stable_id),
  FOREIGN KEY (tenant_id, company_id) REFERENCES companies(tenant_id, id),
  FOREIGN KEY (role_menu_permission_id) REFERENCES role_menu_permissions(id)
);
```

### 3.5 employee_roles（社員ロール割当）

```sql
CREATE TABLE employee_roles (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  company_id uuid NOT NULL,
  employee_id uuid NOT NULL,
  role_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),

  UNIQUE(tenant_id, employee_id),  -- 1社員1ロール制約
  FOREIGN KEY (tenant_id, company_id) REFERENCES companies(tenant_id, id),
  FOREIGN KEY (employee_id) REFERENCES employees(id),
  FOREIGN KEY (role_id) REFERENCES roles(id)
);
```

### 3.6 tenants（既存テーブルへの追加）

```sql
ALTER TABLE tenants ADD COLUMN primary_company_id uuid;
ALTER TABLE tenants ADD CONSTRAINT fk_tenants_primary_company
  FOREIGN KEY (primary_company_id) REFERENCES companies(id);
```

---

## 4. 制御ロジック

### 4.1 連結機能の制御

```typescript
// BFF層：権限設定画面でメニュー一覧取得時
const availableMenus = allMenus.filter(menu => {
  // 連結メニューは primary_company のみ
  if (menu.is_consolidation) {
    return user.companyId === tenant.primaryCompanyId;
  }
  return true;
});
```

### 4.2 データスコープの適用

```typescript
// BFF層：データ取得時のフィルタ
function applyDataScope(
  query: Query,
  dataScope: 'ALL' | 'HIERARCHY' | 'ASSIGNED',
  userDepartmentId: string,
  assignedDepartments?: AssignedDepartment[]
): Query {
  switch (dataScope) {
    case 'ALL':
      // フィルタなし（会社内全データ）
      return query;

    case 'HIERARCHY':
      // ユーザーの所属部門と配下部門
      const hierarchyDepts = getDepartmentHierarchy(userDepartmentId);
      return query.whereIn('department_stable_id', hierarchyDepts);

    case 'ASSIGNED':
      // 指定部門のみ
      const assignedDepts = expandAssignedDepartments(assignedDepartments);
      return query.whereIn('department_stable_id', assignedDepts);
  }
}
```

### 4.3 ユーザーの所属部門

- ログイン時に取得してフロントエンドの状態管理で保持
- 部門階層は `departments.parent_department_stable_id` を使用

---

## 5. 決定事項サマリー

| 項目 | 決定内容 | 決定日 |
|------|---------|-------|
| 会社スコープ | 1社員 = 1会社 | 2026-01-13 |
| 親子会社関係 | 完全分離 | 2026-01-13 |
| 連結機能制御 | 主会社のみ（tenants.primary_company_id） | 2026-01-13 |
| 権限モデル | ロールベース（RBAC） | 2026-01-13 |
| アクセスレベル | A/B/C（3段階） | 2026-01-13 |
| データスコープ | 機能単位で設定（ALL/HIERARCHY/ASSIGNED） | 2026-01-13 |
| スコープ設定単位 | ロール × 機能 ごと | 2026-01-13 |
| 複数ロール | 不可（1社員1ロール、UIで制御） | 2026-01-13 |
| ロール割当先 | 社員マスタ（employee_roles） | 2026-01-13 |
| include_children | ASSIGNED時の配下含むオプション、必要 | 2026-01-13 |

---

## 6. 次のアクション

1. [ ] 仕様概要ファイルの作成
2. [ ] エンティティ定義ファイル（01_各種マスタ.md）への追記
3. [ ] メニュー一覧の洗い出し
4. [ ] 典型的なロールパターンの定義
5. [ ] 権限管理画面の設計

---

## 7. 関連仕様

- `.kiro/specs/entities/01_各種マスタ.md` - 既存エンティティ定義
- `.kiro/steering/tech.md` - RBAC・マルチテナント方針

---

## 8. 未確定事項

| 項目 | 状態 | 備考 |
|------|------|------|
| menu_type の区分値 | 後日確定 | メニュー構成確定後 |
| 初期ロールパターン | 後日検討 | 管理者/一般等の典型パターン |
| 承認ワークフロー | 別途検討 | 権限とは切り離して後日 |
