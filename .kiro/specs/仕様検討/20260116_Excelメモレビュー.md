# Excelメモ レビュー結果

**レビュー日**: 2026年1月16日
**対象**: 科目予算設定・マスタ・予算入力画面レビュー時のExcelメモ
**記録者**: 小泉

---

## 1. メモ内容の整理

### 1.1 部門別予算レイアウト関連

| メモ内容 | 解釈 | 既存仕様との関係 | 対応要否 |
|---------|------|-----------------|---------|
| 部門に社員数をいれる | `departments.headcount` で対応済み | entities/01_各種マスタ.md §3.2 | ✅ 対応済み |
| KPI（非財務指標） | `subjects.subject_type='KPI'` で対応 | entities/01_各種マスタ.md §5 | ✅ 対応済み |
| 勘定科目（財務・KPI統合） | 同上 | 同上 | ✅ 対応済み |
| 計算式をどこまで設定できるようにするか | `metrics` テーブルで式定義 | entities/01_各種マスタ.md §7 | ✅ 対応済み |
| レポート/多次元分析/ダッシュボード | report_layouts で対応 | entities/01_各種マスタ.md §6 | ✅ 対応済み |
| スプレッドJSの入力とレイアウトマスタの関係 | Phase 1はカスタムグリッド、Phase 2でSpreadJS検討 | 仕様概要/予算入力機能.md | ✅ 方針確定済み |

### 1.2 ディメンション関連

| メモ内容 | 解釈 | 既存仕様との関係 | 対応要否 |
|---------|------|-----------------|---------|
| TG(得意先グループ)、PG(商品グループ)、EG(担当者)、CDG(管理会計用部門) | 3層ディメンション構造で対応 | entities/01_各種マスタ.md §4 | ✅ 対応済み |
| 設定は科目×部門をキーに一つ | `subject_budget_settings` で対応 | entities/01_各種マスタ.md | ✅ 対応済み |
| 会社で一つ設定を入れる場所が必要 | **要検討**: 会社単位のディメンション設定場所 | - | ⚠️ 要確認 |
| タグはファクトで固定5こまでよこもち | `fact_amounts.tag1~tag5` ではなく `fact_tags` テーブルで縦持ち | entities/02_トランザクション・残高.md | ✅ 設計変更済み |
| ファクト→明細 の構成を考える | `fact_amounts`（集約）+ `fact_journal_lines`（明細）で対応 | entities/01_各種マスタ.md | ⚠️ 要確認 |
| PJコードはディメンションとは別で固定いち | `fact_amounts.project_id` として固定列で保持 | entities/01_各種マスタ.md | ✅ 対応済み |

### 1.3 予算管理関連

| メモ内容 | 解釈 | 既存仕様との関係 | 対応要否 |
|---------|------|-----------------|---------|
| ローデータのTBL | `fact_amounts` + `fact_dimension_links` + `fact_tags` | entities/02_トランザクション・残高.md | ✅ 対応済み |
| 配賦（家賃の例：本社→SAP/Ent/OB按分） | `allocation_*` テーブル群で対応 | entities/01_各種マスタ.md §13 | ✅ 対応済み |
| 配賦前・配賦後のテーブルの持ち方 | `source_type` (INPUT/ALLOC) で区別、同一テーブル | entities/02_トランザクション・残高.md | ✅ 対応済み |
| かくどをもつかどうかをイベントに持つ必要 | `plan_events.allocation_check_mode` | entities/01_各種マスタ.md | ✅ 対応済み |

### 1.4 経営戦略・計画関連

| メモ内容 | 解釈 | 既存仕様との関係 | 対応要否 |
|---------|------|-----------------|---------|
| 中期経営計画（2026-2028） | `mtp_events` + `fact_amounts(scenario_type='MTP')` | 仕様概要/中期経営計画.md | ✅ 対応済み |
| 予算ガイドライン | `guideline_events` + `fact_amounts(scenario_type='GUIDELINE')` | 仕様概要/予算ガイドライン.md | ✅ 対応済み |
| 予算を作成する | `plan_events` + `fact_amounts(scenario_type='BUDGET')` | 仕様概要/予算入力機能.md | ✅ 対応済み |
| 実績かくつき（まだきていない月は見込みを入力） | 見込入力機能で対応 | 仕様概要/見込入力機能.md | ✅ 対応済み |
| 通気の見通しをみえるようにする | 見込サマリー（達成率表示）で対応 | 仕様概要/見込入力機能.md | ✅ 対応済み |

### 1.5 予算入力詳細

| メモ内容 | 解釈 | 既存仕様との関係 | 対応要否 |
|---------|------|-----------------|---------|
| 固定割合 vs ドライバー値入力 | `allocation_drivers` (FIXED/HEADCOUNT/SUBJECT_AMOUNT等) | allocation-master/design.md | ✅ 対応済み |
| 比率を予算時と途中で履歴管理 | `allocation_events` 単位で管理、履歴は別イベントで対応 | allocation-master/design.md | ⚠️ 要確認 |
| 確定した予算に対して見込・実績を入力 | `plan_events` + `plan_versions` で紐付け | entities/01_各種マスタ.md | ✅ 対応済み |
| 集計科目に直接予算値をいれれるようにするか | 現状AGGREGATE科目は入力不可（自動計算） | 仕様概要/予算入力機能.md | ⚠️ 要確認 |
| 予算入力は入力と比較、集計結果はレポートへ | 現状の設計方針と合致 | 仕様概要/予算入力機能.md | ✅ 方針確定済み |
| 見込入力のコメント機能 | Phase 2 検討事項 | 仕様概要/見込入力機能.md | 📝 Phase 2 |

### 1.6 社員・人員計画関連

| メモ内容 | 解釈 | 既存仕様との関係 | 対応要否 |
|---------|------|-----------------|---------|
| 社員マスタにランクもつ？ | `employees.employee_grade` で対応可能 | entities/01_各種マスタ.md §3.4 | ⚠️ 要確認 |
| 組織と紐付けたら人員計画の入力が基本データ収集 | `employee_affiliations` で所属管理 | entities/01_各種マスタ.md §3.5 | ✅ 対応済み |
| ログインする人だけでなく社員は全員登録 | `employees` と `login_accounts` は分離設計 | entities/01_各種マスタ.md | ✅ 対応済み |
| 職種とかますたかする？ | **要検討**: 職種マスタの要否 | - | ⚠️ 要確認 |
| 労務費設定の対象かもくかどうかの属性 | `subjects.is_labor_cost` 等の属性追加？ | - | ⚠️ 要確認 |
| 外注ふくめ労務費単価は人月のみにする | `labor_cost_rates` で対応 | entities/01_各種マスタ.md | ✅ 対応済み |

---

## 2. 要確認事項

### 2.1 会社単位のディメンション設定場所

**メモ内容**: 「会社で一つ →この設定を入れる場所が必要」

**現状**:
- `subject_budget_settings` は科目×部門単位
- 会社全体でのディメンション有効化設定がない

**質問**:
- 「PG(商品グループ)は会社で一つ設定」とは、会社全体で使う/使わないの設定？
- それとも会社ごとにどのディメンションを利用可能にするかの設定？

---

### 2.2 ファクト→明細の構成

**メモ内容**: 「ファクト→明細 の構成を考える。ファクトのエンティティを固める」

**現状**:
- `fact_amounts`: 集約型ファクト（月次・部門・科目単位）
- `fact_journal_lines`: 明細（仕訳明細レベル）は別途定義予定

**質問**:
- 明細レベルのデータ保持は必要ですか？
- それとも集約データのみで十分？

---

### 2.3 配賦比率の履歴管理

**メモ内容**: 「比率を予算時と、途中、履歴管理などもう少し考える → 当時の配布比率はいるのでは」

**現状**:
- `allocation_events` 単位で配賦ルールを管理
- 同一ルールを別イベントで複製して履歴的に管理

**質問**:
- 配賦実行時点の比率をファクトと一緒に保存する必要がありますか？
- それとも `allocation_events` のコピー機能で十分？

---

### 2.4 集計科目への直接入力

**メモ内容**: 「集計科目に直接予算値をいれれるようにするかどうか」

**現状**:
- AGGREGATE科目は自動計算（子科目の合計）
- 直接入力は不可

**質問**:
- 営業利益などの集計科目に直接目標値を入力したいケースはありますか？
- その場合、子科目との整合性チェックは必要？

---

### 2.5 社員マスタのランク・職種

**メモ内容**:
- 「社員マスタにランクもつ？」
- 「職種とかますたかする？」

**現状**:
- `employees` に `employee_grade`（等級）はあるが、職種は未定義
- 人員計画では `resource_plans` で職種×等級の組み合わせを管理

**質問**:
- 職種マスタ（job_types等）を独立テーブルで持つ必要がありますか？
- それとも人員計画内でのみ管理で十分？

---

### 2.6 外注費の単価管理

**メモ内容**: 「外注ふくめ労務費単価は人月のみにする」

**補足（2026-01-16）**:
- 外注費の単価は、会社で平均単価を1つ持つ程度でよいのでは？
- または外注単価の平均パターンを3つ程度登録しておく
- 外注会社ごとの管理までは不要

**現状**:
- `labor_cost_rates` で社員・外注の単価を管理
- 外注は `employee_type='OUTSOURCE'` で区別

**方針案**:
- 外注単価は「会社平均」または「ランク別（3パターン程度）」で十分
- 外注先会社マスタは不要

---

### 2.7 明細レベルのデータ保持

**メモ内容**: 「ファクト→明細 の構成を考える」

**補足（2026-01-16）**:
- 明細レベルデータ保持が必要かは検討中

**現状**:
- `fact_amounts`: 集約型ファクト（月次・部門・科目単位）
- 明細テーブル（`fact_journal_lines`等）は未実装

**検討ポイント**:
- ERPからの取込時に明細を保持するか？
- 集約データのみで監査・ドリルダウンは十分か？

---

### 2.8 集計科目への直接入力

**メモ内容**: 「集計科目に直接予算値をいれれるようにするかどうか」

**補足（2026-01-16）**:
- 集計科目への直接入力を許すかどうかの検討

**現状**:
- AGGREGATE科目は自動計算（子科目の合計）
- 直接入力は不可

**検討ポイント**:
- 営業利益などの集計科目に直接目標値を入力したいケース
- 入力した場合、子科目との整合性チェックをどうするか？
- トップダウン予算（目標→配分）のユースケース

---

### 2.9 職種等の属性管理

**メモ内容**: 「職種とかますたかする？」

**補足（2026-01-16）**:
- 職種などの属性は汎用コードマスタで持つことを検討

**現状**:
- 職種マスタは未定義
- 人員計画では `resource_plans` で職種×等級の組み合わせを管理

**方針案**:
- 汎用コードマスタ（`code_masters` / `code_values`）を作成
- 職種、等級、その他の属性を統一的に管理

---

### 2.10 労務費対象科目のフラグ

**メモ内容**: 「労務費設定の対象かもくかどうかの属性」

**補足（2026-01-16）**:
- 科目にフラグを持って、単価設定の内訳科目を登録するときに絞り込みたい

**現状**:
- `subjects` に労務費対象フラグは未定義

**方針案**:
- `subjects.is_labor_cost_target` フラグを追加
- 単価設定画面で内訳科目を選択する際に、このフラグでフィルタリング

---

## 3. 対応済み事項サマリー

以下は既存設計で対応済みであることを確認しました：

| カテゴリ | 対応済み項目 |
|---------|-------------|
| ディメンション | 3層構造（dimensions/dimension_values/dimension_members）、縦持ち（fact_dimension_links）、ディメンション vs タグの使い分け |
| 予算管理 | scenario_type（BUDGET/FORECAST/ACTUAL/MTP/GUIDELINE）、source_type（INPUT/ADJUST/ALLOC）、バージョン管理 |
| 配賦 | allocation_events/steps/targets/drivers、配賦基準（FIXED/HEADCOUNT等） |
| 組織 | 版管理（organization_versions）、stable_id、社員・所属分離 |
| 中期経営計画 | mtp_events、戦略テーマ、組織ディメンション連携 |
| 予算ガイドライン | guideline_events、中計参照表示 |

---

## 4. 次のアクション

上記の要確認事項（2.1〜2.6）について、方針を決定後、必要に応じて以下のドキュメントを更新します：

- `.kiro/specs/entities/01_各種マスタ.md`
- `.kiro/specs/仕様概要/*.md`
- `.kiro/specs/仕様検討/20260109_科目予算設定.md`

どの項目から確認しますか？
