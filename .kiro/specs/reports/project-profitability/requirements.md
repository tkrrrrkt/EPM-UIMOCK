# Requirements Document

## Introduction

本ドキュメントは、PJ採算照会（Project Profitability Report）機能の要件定義書である。
プロジェクト単位での予算・実績・見込データを照会し、採算状況を可視化するレポート機能として、
経営層・事業部長・PM・経理担当が会計レベルでのPJ収益性を把握できることを目的とする。

---

## Spec Reference（INPUT情報）

本要件を作成するにあたり、以下の情報を確認した：

### 仕様概要（確定済み仕様）
- **参照ファイル**: 本機能は新規検討のため、仕様概要は未作成
- **確認日**: 2026-01-16
- **主要な仕様ポイント**:
  - Q&Aセッションにてユースケース・画面構成・主要指標を検討済み
  - 会社マスタへの主要科目ID（8件）追加済み

### 仕様検討（経緯・背景）※参考
- **参照ファイル**: 会話ログ（2026-01-15〜16）
- **経緯メモ**: PJ管理ツールとは別に、会計レベルでの予算実績管理に特化したレポート機能として検討

---

## Entity Reference（必須）

本機能で使用するエンティティ定義を `.kiro/specs/entities/*.md` から確認し、以下を記載する：

### 対象エンティティ
- `projects`: `.kiro/specs/entities/01_各種マスタ.md` セクション 4.7
- `companies`: `.kiro/specs/entities/01_各種マスタ.md` セクション 4.1（主要科目ID定義）
- `fact_amounts`: `.kiro/specs/entities/01_各種マスタ.md` セクション 12.1
- `subjects`: `.kiro/specs/entities/01_各種マスタ.md` セクション 5.1

### エンティティ整合性確認
- [x] 対象エンティティのカラム・型・制約を確認した
- [x] エンティティ補足のビジネスルールを要件に反映した
- [x] スコープ外の関連エンティティを Out of Scope に明記した

---

## INPUT整合性チェック

| チェック項目 | 確認結果 |
|-------------|---------|
| 仕様概要との整合性 | 要件が仕様概要の内容と矛盾しない: ✅ |
| エンティティとの整合性 | 要件がエンティティ定義と矛盾しない: ✅ |
| 仕様検討の背景理解 | 必要に応じて経緯を確認した: ✅ |

---

## Requirements

### Requirement 1: PJ一覧表示

**Objective:** As a 経営層・事業部長・PM, I want PJの一覧を採算状況とともに確認できる機能, so that 採算悪化PJを早期発見し、対策検討の優先順位付けができる

#### Acceptance Criteria

1.1. When ユーザーがPJ採算照会画面を開いた場合, the PJ採算照会画面 shall 当該テナント・会社に属するPJ一覧を表示する

1.2. The PJ採算照会画面 shall 各PJについて以下のサマリ情報を一覧表示する：PJコード、PJ名、責任部門名、ステータス、売上予算、売上着地予測、粗利率

1.3. When ユーザーが部門フィルターを選択した場合, the PJ採算照会画面 shall 選択された部門に属するPJのみを表示する

1.4. When ユーザーがステータスフィルターを選択した場合, the PJ採算照会画面 shall 選択されたステータス（PLANNED/ACTIVE/ON_HOLD/CLOSED）のPJのみを表示する

1.5. When ユーザーがキーワード検索を実行した場合, the PJ採算照会画面 shall PJコード・PJ名に部分一致するPJを表示する

1.6. When ユーザーがソート列を選択した場合, the PJ採算照会画面 shall 選択された列（売上予算、売上着地予測、粗利率、PJ名、部門名）で昇順・降順ソートを切り替える

1.7. If PJの着地予測粗利がマイナスの場合, then the PJ採算照会画面 shall 当該PJに警告アイコンを表示する

1.8. The PJ採算照会画面 shall ページネーションにより大量PJを分割表示する（デフォルト20件/ページ）

---

### Requirement 2: PJ詳細表示

**Objective:** As a PM・経理担当, I want 選択したPJの詳細な採算情報を確認できる機能, so that 予算消化状況・着地見通しを正確に把握できる

#### Acceptance Criteria

2.1. When ユーザーが一覧からPJを選択（行クリック）した場合, the システム shall PJ詳細画面（別ページ）へ遷移し、当該PJの詳細情報を表示する

2.2. The PJ採算照会画面 shall PJ基本情報として以下を表示する：PJコード、PJ名、責任部門、責任者、期間（開始日〜終了日）、ステータス

2.3. The PJ採算照会画面 shall 主要指標サマリとして以下の比較表を表示する：

| 指標 | 予算 | 実績 | 見込 | 着地予測 | 予算差異 |
|------|------|------|------|----------|----------|
| 売上高 | ○ | ○ | ○ | ○ | ○ |
| 売上原価 | ○ | ○ | ○ | ○ | ○ |
| 粗利 | ○ | ○ | ○ | ○ | ○ |
| 営業利益 | ○ | ○ | ○ | ○ | ○ |

2.4. The PJ採算照会画面 shall 着地予測を「実績累計 + 残期間見込」として算出する

2.5. The PJ採算照会画面 shall 予算差異を「着地予測 - 予算」として算出し、マイナスの場合は赤字表示する

2.6. The PJ採算照会画面 shall 主要KPIとして以下を表示する：売上進捗率（実績/予算）、予算消化率（実績コスト/予算コスト）、粗利率（粗利/売上）

2.7. If 着地予測の営業利益がマイナスの場合, then the PJ採算照会画面 shall 赤字警告を表示する

---

### Requirement 3: 直接原価計算対応

**Objective:** As a 経理・管理会計担当, I want 直接原価計算（変動費/限界利益/固定費）の指標も確認できる機能, so that 限界利益ベースでの採算分析ができる

#### Acceptance Criteria

3.1. Where 会社マスタに直接原価計算用の科目ID（variable_cost_subject_id, marginal_profit_subject_id, fixed_cost_subject_id）が設定されている場合, the PJ採算照会画面 shall 直接原価計算の指標も表示する

3.2. The PJ採算照会画面 shall 直接原価計算として以下の指標を表示可能とする：変動費、限界利益（売上-変動費）、固定費、貢献利益

3.3. The PJ採算照会画面 shall 限界利益率（限界利益/売上）をKPIとして表示する

---

### Requirement 4: 月別推移表示（オプション）

**Objective:** As a PM・経営層, I want PJの月別推移を確認できる機能, so that 時系列での採算変化を把握できる

#### Acceptance Criteria

4.1. When ユーザーが月別推移の表示を要求した場合, the PJ採算照会画面 shall 当該PJの月別データ（予算/実績/見込）を表示する

4.2. The PJ採算照会画面 shall 月別推移をテーブル形式で表示する（行：科目、列：月）

4.3. Where グラフ表示が有効な場合, the PJ採算照会画面 shall 月別推移を折れ線グラフでも表示可能とする

---

### Requirement 5: データ取得・表示性能

**Objective:** As a ユーザー, I want レポートが高速に表示される, so that 待ち時間なく分析作業ができる

#### Acceptance Criteria

5.1. The PJ採算照会画面 shall PJ一覧の初期表示を3秒以内に完了する（100件以下の場合）

5.2. The PJ採算照会画面 shall PJ詳細の表示を1秒以内に完了する

5.3. The PJ採算照会画面 shall フィルター・ソート操作に対して即座に応答する（1秒以内）

---

### Requirement 6: マルチテナント・権限制御

**Objective:** As a システム管理者, I want テナント・権限に基づいたデータアクセス制御, so that セキュリティとデータ分離が担保される

#### Acceptance Criteria

6.1. The PJ採算照会画面 shall ログインユーザーのtenant_id・company_idに属するPJのみを表示する

6.2. The BFF shall すべてのAPI呼び出しにtenant_id・user_idを伝搬し、Domain APIのRLSを有効にする

6.3. If ユーザーがPJ採算照会の閲覧権限（epm.project.read）を持たない場合, then the システム shall 当該画面へのアクセスを拒否する

6.4. The PJ採算照会画面 shall 部門フィルターにおいて、ユーザーの閲覧可能範囲の部門のみを選択肢として表示する

---

## Out of Scope

以下は本要件のスコープ外とする：

1. **PJ管理機能**: タスク管理、進捗管理、ガントチャート等はPJ管理ツールの領域であり、本機能では扱わない
2. **データ入力・編集**: 本機能は照会専用であり、予算・実績・見込データの入力・編集は別機能（budget-entry, forecast-entry, actual-import）で行う
3. **PJマスタ管理**: PJの作成・編集・削除は別機能（project-master）で行う
4. **Excel/CSVエクスポート**: 将来検討事項とし、初期リリースでは対象外
5. **グラフ表示**: 月別推移のグラフ表示は優先度低として、初期リリースではテーブル表示のみとする

---

## Glossary

| 用語 | 定義 |
|------|------|
| 着地予測 | 実績累計 + 残期間見込。通期の最終着地見込みを示す |
| 予算差異 | 着地予測 - 予算。プラスは予算超過、マイナスは予算未達を示す |
| 粗利（売上総利益） | 売上高 - 売上原価。全部原価計算における利益指標 |
| 限界利益 | 売上高 - 変動費。直接原価計算における利益指標 |
| 貢献利益 | 限界利益 - 直接固定費。事業部門の収益貢献度を示す |
| 売上進捗率 | 実績売上 / 予算売上。予算に対する売上達成度 |
| 予算消化率 | 実績コスト / 予算コスト。予算に対するコスト消化度 |

---

## Change History

| 日付 | 変更内容 | 変更者 |
|------|----------|--------|
| 2026-01-16 | 初版作成 | Claude Code |
| 2026-01-16 | 要件2.1: 詳細表示を「右ペイン」から「別画面遷移」に変更 | Claude Code |
