# Requirements Document

## Introduction

本ドキュメントは、EPM SaaS における業績レポート機能（Budget Actual Report）の要件を定義する。経営層から現場管理者まで、様々なユーザーが予算と実績+見込の比較、前回見込比較、前年比較を通じて経営状況を把握できるレポート機能を提供する。

---

## Spec Reference（INPUT情報）

本要件を作成するにあたり、以下の情報を確認した：

### 仕様概要（確定済み仕様）
- **参照ファイル**: `apps/web/_v0_drop/forecast-input-feature/` (v0モック)
- **確認日**: 2026-01-13
- **主要な仕様ポイント**:
  - 2タブ構成: 組織別レポート、マトリックス分析
  - 見通し = 実績済み + 残見込
  - 組織ツリー選択 + 月次データグリッド
  - マトリクス表示（行: 科目、列: 組織階層）
  - 比較モード3パターン（予算vs実績+見込、今回vs前回見込、当年vs前年）

### 仕様検討（経緯・背景）※参考
- **経緯メモ**: 経理部門・事業部長・経営層など異なる視点のユーザーが同一レポートを使用。組織ツリーからの選択と、マトリクス表示でのドリルダウンの2つのアプローチを提供。Phase 1では基本機能に集中し、ウォーターフォール差異分析やAIインサイトはPhase 2以降とする。

---

## Entity Reference（必須）

本機能で使用するエンティティ定義を `.kiro/specs/entities/*.md` から確認し、以下を記載する：

### 対象エンティティ
- **ReportLayout**: `.kiro/specs/master-data/report-layout/design.md` - 行軸の表示構造
- **Subject**: `.kiro/specs/master-data/subject-master/design.md` - 科目階層
- **Organization**: `.kiro/specs/master-data/organization-master/` - 列軸の組織階層
- **PlanEvent**: `.kiro/specs/planning/` - 予算イベント（期初予算、修正予算）
- **SubjectBalance**: 科目残高データ（予算・実績・見込）

### エンティティ整合性確認
- [x] 対象エンティティのカラム・型・制約を確認した
- [x] エンティティ補足のビジネスルールを要件に反映した
- [x] スコープ外の関連エンティティを Out of Scope に明記した

---

## INPUT整合性チェック

| チェック項目 | 確認結果 |
|-------------|---------|
| v0モックとの整合性 | 要件がv0モックの内容と矛盾しない: ✅ |
| エンティティとの整合性 | 要件がエンティティ定義と矛盾しない: ✅ |
| 仕様検討の背景理解 | 必要に応じて経緯を確認した: ✅ |

---

## Requirements

### Requirement 1: 共通ヘッダー（レポート条件選択）

**Objective:** As a レポート利用者, I want レポートの表示条件（年度、比較モード）を選択, so that 目的に応じたデータを表示できる

#### Acceptance Criteria
1.1. When ユーザーがレポート画面を開いた時, the システム shall 共通ヘッダーにタイトル「業績レポート」、年度選択、比較モード選択を表示する
1.2. The システム shall 年度選択ドロップダウンを提供する（2024年度、2023年度、2022年度等）
1.3. The システム shall 比較モード選択ドロップダウンを提供する:
  - 予算 vs 実績+見込
  - 今回見込 vs 前回見込
  - 当年 vs 前年
1.4. When 条件が変更された時, the システム shall 全タブのデータを選択条件に基づいて再取得・再表示する
1.5. The システム shall 初期表示時にデフォルト値（現在年度、「予算 vs 実績+見込」モード）を設定する
1.6. The システム shall ヘッダー右側に以下のアクションボタンを表示する:
  - 期間選択ボタン
  - 更新ボタン
  - エクスポートボタン
  - 設定ボタン

---

### Requirement 2: サマリーカード表示

**Objective:** As a 経営層・管理者, I want 主要指標のサマリーを一目で把握, so that 迅速に経営判断できる

#### Acceptance Criteria
2.1. When 組織別レポートタブが表示された時, the システム shall データグリッド上部に4つのサマリーカードを表示する
2.2. The システム shall 以下の指標をカードで表示する:
  - 通期予算（金額）
  - 実績+見込（金額 + 予算比%）
  - 前回見込（金額）
  - 前回比（差異金額 + %）
2.3. The システム shall 差異がプラスの場合は緑色、マイナスの場合は赤色で表示する
2.4. The システム shall 率表示切替ボタンを提供する

---

### Requirement 3: 組織別レポートタブ（ツリー + データグリッド）

**Objective:** As a 経理担当・事業部長, I want 組織を選択して月次データを確認, so that 特定組織の詳細な数値分析ができる

#### Acceptance Criteria
3.1. The システム shall 画面左側に組織ツリーパネル（幅320px）を表示する
3.2. The システム shall 組織ツリーを階層表示する（会社 > 本部 > 部門）
3.3. When ユーザーが組織ツリーの展開アイコンをクリックした時, the システム shall 下位組織を展開/折りたたみする
3.4. When ユーザーが組織を選択した時, the システム shall 該当組織のデータをデータグリッドに表示する
3.5. The システム shall 選択中の組織をハイライト表示する

---

### Requirement 4: 月次データグリッド

**Objective:** As a レポート利用者, I want 12ヶ月の月次データを科目別に確認, so that 月次推移を把握できる

#### Acceptance Criteria
4.1. The システム shall 行軸に科目、列軸に12ヶ月（1月〜12月）を配置したグリッドを表示する
4.2. The システム shall 各月に以下のデータ列を表示する:
  - 予算
  - 実績（または見込）
  - 差異
  - %（率表示ON時のみ）
4.3. The システム shall 科目行の展開/折りたたみ機能を提供する
4.4. When ユーザーが科目行の展開アイコンをクリックした時, the システム shall 下位科目を展開する
4.5. The システム shall 親科目行を背景色で区別する（bg-secondary/20）
4.6. The システム shall 差異がプラスの場合は緑色、マイナスの場合は赤色で数値を表示する
4.7. The システム shall 実績確定月と見込月を背景色で区別する
4.8. The システム shall 科目列をスティッキー（固定）表示する

---

### Requirement 5: マトリックス分析タブ

**Objective:** As a 経理担当・事業部長, I want 組織×科目のマトリクス形式で予算実績を確認, so that 組織横断的な分析ができる

#### Acceptance Criteria
5.1. The システム shall 行軸に科目、列軸に組織を配置したマトリクス表を表示する
5.2. The システム shall 列の先頭に「合計」列を表示する
5.3. When 初期表示時, the システム shall 全社 + 第1階層（本部）を列に表示する
5.4. The システム shall 各組織列に以下のデータを表示する:
  - 予算
  - 実績
  - 差異
  - %
5.5. The システム shall 親科目行を背景色で区別する
5.6. The システム shall 差異がプラスの場合は緑色、マイナスの場合は赤色で表示する

---

### Requirement 6: マトリックス列ドリルダウン

**Objective:** As a レポート利用者, I want 組織階層をドリルダウン, so that 特定組織の詳細を確認できる

#### Acceptance Criteria
6.1. When ユーザーが組織ヘッダーをクリックした時, the システム shall 列を置換方式でドリルダウンする
6.2. The システム shall ドリルダウン可能な組織ヘッダーにChevronアイコンを表示する
6.3. When ドリルダウン後, the システム shall パンくずナビゲーションを表示する（例: 全社 > 営業本部）
6.4. When ユーザーがパンくずをクリックした時, the システム shall 該当階層まで戻る
6.5. The システム shall ドリルダウン先組織の「計」列を合計列として表示する

---

### Requirement 7: 行ドリルダウン（科目展開）

**Objective:** As a レポート利用者, I want 科目を展開/折りたたみ, so that 必要な粒度で数値を確認できる

#### Acceptance Criteria
7.1. When ユーザーが科目行の展開アイコン（▶）をクリックした時, the システム shall 下位科目をツリー展開する
7.2. When ユーザーが科目行の折りたたみアイコン（▼）をクリックした時, the システム shall 下位科目を非表示にする
7.3. The システム shall 展開可能な科目行には展開/折りたたみアイコンを表示する
7.4. The システム shall インデントレベルに応じて左パディングを増やす

---

### Requirement 8: 見通し計算

**Objective:** As a システム, I want 見通し（実績+見込）を正確に計算, so that 予算達成見込みを正しく表示できる

#### Acceptance Criteria
8.1. The システム shall 実績+見込を「実績済み金額 + 残見込金額」として計算する
8.2. The システム shall 実績済み金額を締め処理完了月のデータから取得する
8.3. The システム shall 残見込金額を未来月の見込入力データから取得する
8.4. The システム shall 差異を「実績+見込 - 予算」として計算する
8.5. The システム shall 差異率を「差異 ÷ 予算 × 100」として計算する

---

### Requirement 9: Excelエクスポート

**Objective:** As a レポート利用者, I want 表示中のデータをExcelでエクスポート, so that 社内資料や追加分析に活用できる

#### Acceptance Criteria
9.1. When ユーザーがエクスポートボタンをクリックした時, the システム shall 現在表示中のタブのデータをExcel形式（.xlsx）でダウンロードする
9.2. The システム shall 適用中のフィルタ・ドリルダウン状態を反映したデータをエクスポートする
9.3. The システム shall 数値フォーマット（千円単位、%表示等）を維持してエクスポートする

---

### Requirement 10: データ取得・パフォーマンス

**Objective:** As a システム, I want レポートデータを効率的に取得, so that ユーザーに快適な操作体験を提供できる

#### Acceptance Criteria
10.1. The システム shall 初期表示を3秒以内に完了する
10.2. The システム shall ドリルダウン操作のレスポンスを1秒以内に完了する
10.3. The システム shall 大量データ（1000行以上）の場合、仮想スクロールを適用する
10.4. The システム shall スティッキーヘッダー・スティッキー列を実装する

---

### Requirement 11: マルチテナント・セキュリティ

**Objective:** As a システム, I want テナント分離とデータセキュリティを保証, so that 他テナントのデータが漏洩しない

#### Acceptance Criteria
11.1. The システム shall 全てのデータ取得にtenant_idフィルタを適用する
11.2. The システム shall RLS（Row Level Security）を有効にしてデータアクセスを制御する
11.3. When 異なるテナントのデータにアクセスしようとした場合, the システム shall アクセスを拒否しエラーを返す

---

## Out of Scope（Phase 2以降）

以下の機能はPhase 1のスコープ外とし、Phase 2以降で検討する：

1. **ウォーターフォール差異分析**: 利益増減要因の視覚化
2. **推移分析グラフ**: 折れ線グラフによる時系列表示
3. **部門配下制御（インサイダー対応）**: ユーザー所属部門配下のみ閲覧可能とする制御
4. **数量単価金額（P/V/M）差異分析**: 物販的な差異分解
5. **AIインサイト**: 差異に対する自動コメント生成
6. **ダッシュボード統合**: 全社ダッシュボードへの組み込み
7. **アラート閾値のユーザー設定**: 現在は固定閾値

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-12 | 初版作成（4タブ構成） |
| 2026-01-13 | v0モックに基づき2タブ構成にリバース更新 |
