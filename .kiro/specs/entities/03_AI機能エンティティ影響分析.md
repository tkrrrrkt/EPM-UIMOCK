# AI機能エンティティ 影響分析

## 作成日

2026-01-28

## 分析目的

AIシミュレーション機能（5機能）の実装に必要な新規エンティティと、既存エンティティへの影響を評価し、Prisma Schema への追加方針を確定する。

---

## 1. 新規エンティティ一覧

### 1.1 ai_conversations（会話履歴）

**目的**: 自然言語Q&A、経営参謀Bot の対話履歴を保存

```prisma
model ai_conversations {
  id                String   @id @default(uuid()) @db.Uuid
  tenant_id         String   @db.Uuid
  user_id           String   @db.Uuid
  session_id        String   @db.Uuid
  feature           String   @db.VarChar(50)  // 'nlq' | 'chat_bot' | 'variance_analysis'
  message_type      String   @db.VarChar(20)  // 'user' | 'assistant' | 'system'
  message_content   String   @db.Text
  message_metadata  Json?                     // {intent, entities, confidence}
  parent_message_id String?  @db.Uuid
  created_at        DateTime @default(now()) @db.Timestamptz(6)

  // Relations (将来実装時)
  // parent_message ai_conversations? @relation("ConversationThread", fields: [parent_message_id], references: [id])
  // replies        ai_conversations[] @relation("ConversationThread")

  @@unique([tenant_id, id])
  @@index([tenant_id, session_id, created_at])
  @@index([tenant_id, user_id, created_at])
  @@map("ai_conversations")
}
```

**依存関係**:
- `tenant_id`: tenants テーブル（未実装）への FK
- `user_id`: login_accounts テーブル（未実装）への FK

### 1.2 ai_knowledge_base（RAG用知識ベース）

**目的**: 科目定義、KPI定義、過去コメント等をベクトル化してRAG検索に使用

```prisma
model ai_knowledge_base {
  id              String   @id @default(uuid()) @db.Uuid
  tenant_id       String   @db.Uuid
  company_id      String?  @db.Uuid
  source_type     String   @db.VarChar(50)  // 'subject_definition' | 'kpi_definition' | 'comment' | 'meeting_minutes'
  source_id       String?  @db.Uuid
  title           String?  @db.VarChar(500)
  content         String   @db.Text
  content_summary String?  @db.Text
  embedding       Unsupported("vector(1536)")?  // pgvector型（Prisma未サポート）
  metadata        Json?                          // {fiscal_year, period_id, department_id, subject_id}
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  companies companies? @relation(fields: [tenant_id, company_id], references: [tenant_id, id])

  @@unique([tenant_id, id])
  @@index([tenant_id, is_active])
  @@map("ai_knowledge_base")
}
```

**依存関係**:
- `tenant_id`: tenants テーブル（未実装）への FK
- `company_id`: companies テーブル（実装済み、ただし tenant_id 複合FK未対応）

**技術的課題**:
- **pgvector 型**: Prisma は現時点で vector 型をサポートしていない
  - 対策: `Unsupported("vector(1536)")` で定義し、生SQLまたはマイグレーションファイルで型を指定
  - ベクター検索は Prisma.$queryRaw で実行

### 1.3 ai_audit_logs（監査ログ）

**目的**: AI機能の利用履歴、質問内容、参照データ、コストを記録

```prisma
model ai_audit_logs {
  id                String   @id @default(uuid()) @db.Uuid
  tenant_id         String   @db.Uuid
  user_id           String   @db.Uuid
  session_id        String   @db.Uuid
  feature           String   @db.VarChar(50)
  query             String   @db.Text
  intent            String?  @db.VarChar(200)
  entities          Json?                        // {period, department, subject}
  data_accessed     Json?                        // {tables, record_count}
  response_summary  String?  @db.Text
  llm_model         String?  @db.VarChar(100)
  llm_tokens        Int?
  execution_time_ms Int?
  user_feedback     String?  @db.VarChar(20)    // 'positive' | 'negative' | 'neutral'
  created_at        DateTime @default(now()) @db.Timestamptz(6)

  @@unique([tenant_id, id])
  @@index([tenant_id, user_id, created_at])
  @@index([tenant_id, feature, created_at])
  @@map("ai_audit_logs")
}
```

**依存関係**:
- `tenant_id`: tenants テーブル（未実装）への FK
- `user_id`: login_accounts テーブル（未実装）への FK

### 1.4 ai_anomaly_alerts（異常値アラート）

**目的**: 実績入力時・月次締め時に検知した異常値を記録

```prisma
model ai_anomaly_alerts {
  id                    String   @id @default(uuid()) @db.Uuid
  tenant_id             String   @db.Uuid
  company_id            String   @db.Uuid
  accounting_period_id  String   @db.Uuid
  subject_id            String   @db.Uuid
  department_stable_id  String   @db.VarChar(50)
  fact_amount_id        String?  @db.Uuid
  anomaly_type          String   @db.VarChar(50)    // 'threshold' | 'statistical' | 'trend_deviation'
  severity              String   @db.VarChar(20)    // 'low' | 'medium' | 'high'
  detected_amount       Decimal  @db.Decimal(20,4)
  expected_amount       Decimal? @db.Decimal(20,4)
  variance_amount       Decimal? @db.Decimal(20,4)
  variance_pct          Decimal? @db.Decimal(10,2)
  message               String   @db.Text
  detection_metadata    Json?                        // {z_score, prev_month, history_mean}
  status                String   @default("pending") @db.VarChar(20)  // 'pending' | 'confirmed' | 'ignored'
  confirmed_by          String?  @db.Uuid
  confirmed_at          DateTime? @db.Timestamptz(6)
  notes                 String?  @db.Text
  created_at            DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  companies companies @relation(fields: [tenant_id, company_id], references: [tenant_id, id])

  @@unique([tenant_id, id])
  @@index([tenant_id, company_id, status, created_at])
  @@index([tenant_id, accounting_period_id])
  @@map("ai_anomaly_alerts")
}
```

**依存関係**:
- `tenant_id`: tenants テーブル（未実装）への FK
- `company_id`: companies テーブル（実装済み、ただし tenant_id 複合FK未対応）
- `accounting_period_id`: accounting_periods テーブル（未実装）への FK
- `subject_id`: subjects テーブル（実装済み、ただし tenant_id 複合FK未対応）
- `fact_amount_id`: fact_amounts テーブル（未実装）への FK
- `confirmed_by`: login_accounts テーブル（未実装）への FK

---

## 2. 既存エンティティとの関係

### 2.1 現在のPrisma Schema状況

**実装済み**:
- companies
- employees
- subjects
- metrics
- kpi_master_events
- kpi_master_items
- kpi_definitions
- kpi_fact_amounts
- kpi_target_values
- action_plans
- dashboards
- dashboard_widgets

**未実装（エンティティ定義書には存在）**:
- tenants
- accounting_periods
- login_accounts
- departments
- organization_versions
- fact_amounts
- dimensions
- dimension_values
- その他多数

### 2.2 AI機能が依存する既存エンティティ

| エンティティ | AI機能での用途 | 実装状況 | 対応方針 |
|------------|--------------|---------|---------|
| tenants | RLS境界、全テーブルの tenant_id FK | ❌ 未実装 | Phase 1で実装必須 |
| companies | テナント分離、会社別設定 | ⚠️ 部分実装 | tenant_id 複合FK追加 |
| login_accounts | ユーザー識別、権限制御 | ❌ 未実装 | Phase 1で実装必須 |
| accounting_periods | 期間解決、トレンド分析 | ❌ 未実装 | Phase 1で実装必須 |
| subjects | セマンティックレイヤー、科目検索 | ⚠️ 部分実装 | メタデータ拡張必要 |
| departments | セマンティックレイヤー、部門検索 | ❌ 未実装 | Phase 1で実装必須 |
| fact_amounts | データ集計、差異分析 | ❌ 未実装 | Phase 1で実装必須 |
| metrics | KPI定義、計算式 | ⚠️ 部分実装 | メタデータ拡張必要 |

### 2.3 セマンティックレイヤーに必要な拡張

AI機能が正確にデータを理解するために、既存マスタテーブルに以下の拡張が必要:

#### subjects テーブル拡張案

```prisma
model subjects {
  // 既存フィールド
  id           String   @id @default(uuid()) @db.Uuid
  tenant_id    String   @db.Uuid
  subject_code String   @db.VarChar(50)
  subject_name String   @db.VarChar(200)
  kpi_managed  Boolean  @default(false)
  is_active    Boolean  @default(true)
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @updatedAt @db.Timestamptz(6)

  // AI機能のために追加が必要なフィールド（エンティティ定義書に記載あり）
  description           String?  @db.Text          // 科目説明（RAG用）
  aliases               String[] @db.VarChar(100)  // 別名（「売上高」「Revenue」「トップライン」）
  data_type             String?  @db.VarChar(20)   // 'monetary' | 'quantity' | 'ratio'
  unit                  String?  @db.VarChar(30)   // 単位（「円」「件」「%」）
  aggregation_method    String?  @db.VarChar(20)   // 'SUM' | 'AVG' | 'EOP'
  parent_subject_id     String?  @db.Uuid          // 階層構造

  @@unique([tenant_id, id])
  @@unique([tenant_id, subject_code])
  @@index([tenant_id])
  @@map("subjects")
}
```

#### metrics テーブル拡張案

```prisma
model metrics {
  // 既存フィールド
  id          String   @id @default(uuid()) @db.Uuid
  tenant_id   String   @db.Uuid
  metric_code String   @db.VarChar(50)
  metric_name String   @db.VarChar(200)
  kpi_managed Boolean  @default(false)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @updatedAt @db.Timestamptz(6)

  // AI機能のために追加が必要なフィールド（エンティティ定義書に記載あり）
  description String?  @db.Text          // KPI説明（RAG用）
  formula     String?  @db.Text          // 計算式（「売上高 / 従業員数」）
  components  String[] @db.VarChar(100)  // 構成要素（["売上高", "従業員数"]）
  unit        String?  @db.VarChar(30)   // 単位

  @@unique([tenant_id, id])
  @@unique([tenant_id, metric_code])
  @@index([tenant_id])
  @@map("metrics")
}
```

---

## 3. PostgreSQL pgvector 拡張の要件

### 3.1 pgvector のインストール

ai_knowledge_base テーブルの embedding カラムは PostgreSQL の vector 型を使用する。

**必要な作業**:

```sql
-- PostgreSQLに pgvector 拡張をインストール
CREATE EXTENSION IF NOT EXISTS vector;
```

**Prisma マイグレーション**:

Prisma は vector 型を直接サポートしていないため、マイグレーションファイルを手動編集する必要がある。

```sql
-- マイグレーションファイル内で手動追加
CREATE TABLE ai_knowledge_base (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  company_id UUID,
  source_type VARCHAR(50) NOT NULL,
  source_id UUID,
  title VARCHAR(500),
  content TEXT NOT NULL,
  content_summary TEXT,
  embedding VECTOR(1536),  -- ここを手動で追加
  metadata JSONB,
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ベクター検索用インデックス（IVFFlat）
CREATE INDEX idx_ai_knowledge_embedding ON ai_knowledge_base
  USING ivfflat (embedding vector_cosine_ops)
  WITH (lists = 100);
```

### 3.2 ベクター検索の実装

Prisma Client では生SQLを使用する:

```typescript
// ベクター検索のサンプル
const similarDocuments = await prisma.$queryRaw`
  SELECT
    id,
    title,
    content,
    1 - (embedding <=> ${queryEmbedding}::vector) AS similarity
  FROM ai_knowledge_base
  WHERE tenant_id = ${tenantId}
    AND is_active = true
  ORDER BY embedding <=> ${queryEmbedding}::vector
  LIMIT 5
`;
```

---

## 4. 実装順序と依存関係

### Phase 0: 基盤エンティティ実装（AI機能の前提条件）

AI機能を実装する前に、以下のエンティティを優先実装する必要がある:

```
優先度 HIGH（必須）:
1. tenants
2. login_accounts
3. accounting_periods
4. departments
5. organization_versions
6. fact_amounts

優先度 MEDIUM（セマンティックレイヤー用）:
7. subjects の拡張（description, aliases, data_type, unit, aggregation_method）
8. metrics の拡張（description, formula, components, unit）
```

### Phase 1: AI基盤エンティティ実装（Month 1）

基盤エンティティが揃った後、AI専用テーブルを実装:

```
1. ai_knowledge_base（pgvector設定含む）
2. ai_conversations
3. ai_audit_logs
4. ai_anomaly_alerts
```

### Phase 2: セマンティックレイヤー構築（Month 1-2）

エンティティ実装後、メタデータを自動生成:

```
1. subjects/metrics/departments から JSON Schema 生成
2. ai_knowledge_base への初期データ投入
3. 埋め込みベクトル生成バッチ実装
```

---

## 5. Prisma Schema 追加方針

### 5.1 段階的追加アプローチ

**ステップ1: 基盤エンティティの追加**

```prisma
// packages/db/prisma/schema.prisma に追加

model tenants {
  id                  String   @id @default(uuid()) @db.Uuid
  tenant_code         String   @unique @db.VarChar(50)
  tenant_name         String   @db.VarChar(200)
  primary_company_id  String?  @db.Uuid
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  updated_at          DateTime @updatedAt @db.Timestamptz(6)

  @@map("tenants")
}

model login_accounts {
  id                  String    @id @default(uuid()) @db.Uuid
  tenant_id           String    @db.Uuid
  employee_id         String    @db.Uuid
  employee_code       String    @db.VarChar(30)
  login_id            String    @db.VarChar(100)
  email_login         String?   @db.VarChar(255)
  password_hash       String?   @db.Text
  auth_provider       String    @db.VarChar(30)
  status              String    @db.VarChar(20)
  last_login_at       DateTime? @db.Timestamptz(6)
  failed_login_count  Int       @default(0)
  locked_until        DateTime? @db.Timestamptz(6)
  created_at          DateTime  @default(now()) @db.Timestamptz(6)
  updated_at          DateTime  @updatedAt @db.Timestamptz(6)

  @@unique([tenant_id, login_id])
  @@unique([tenant_id, employee_id])
  @@index([tenant_id])
  @@map("login_accounts")
}

model accounting_periods {
  id            String    @id @default(uuid()) @db.Uuid
  tenant_id     String    @db.Uuid
  company_id    String    @db.Uuid
  fiscal_year   Int
  period_kind   String    @db.VarChar(10)
  period_no     Int       @db.SmallInt
  quarter_no    Int?      @db.SmallInt
  start_date    DateTime  @db.Date
  end_date      DateTime  @db.Date
  is_adjustment Boolean   @default(false)
  close_status  String    @db.VarChar(20)
  closed_at     DateTime? @db.Timestamptz(6)
  period_code   String    @db.VarChar(32)
  display_label String?   @db.VarChar(64)
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @updatedAt @db.Timestamptz(6)

  @@unique([tenant_id, company_id, fiscal_year, period_kind, period_no])
  @@unique([tenant_id, company_id, period_code])
  @@index([tenant_id, company_id])
  @@index([tenant_id, fiscal_year])
  @@map("accounting_periods")
}
```

**ステップ2: AI専用エンティティの追加**

上記 1.1 〜 1.4 のモデル定義を追加。

**ステップ3: マイグレーション実行**

```bash
# Prisma マイグレーション生成
cd packages/db
npx prisma migrate dev --name add_ai_entities

# マイグレーションファイルを編集して pgvector 設定を手動追加
# packages/db/prisma/migrations/YYYYMMDDHHMMSS_add_ai_entities/migration.sql

# 再度マイグレーション適用
npx prisma migrate deploy
```

### 5.2 FK制約の追加方針

現在の Prisma Schema では tenant_id を含む複合FK が未実装の箇所が多い。AI機能実装時に段階的に追加:

**優先度 HIGH**:
- ai_conversations.user_id → login_accounts(tenant_id, id)
- ai_audit_logs.user_id → login_accounts(tenant_id, id)
- ai_anomaly_alerts.accounting_period_id → accounting_periods(tenant_id, company_id, id)
- ai_anomaly_alerts.confirmed_by → login_accounts(tenant_id, id)

**優先度 MEDIUM**:
- ai_knowledge_base.company_id → companies(tenant_id, id)
- ai_anomaly_alerts.subject_id → subjects(tenant_id, id)

---

## 6. リスクと対策

### 6.1 リスク: 基盤エンティティ未実装

**影響**: AI機能実装が開始できない

**対策**:
1. Phase 0 として基盤エンティティを優先実装
2. モックデータでAI機能のプロトタイプ開発を並行実施
3. 基盤エンティティ実装完了後に結合

### 6.2 リスク: pgvector 型のPrismaサポート不足

**影響**: ORM経由でのベクター検索が困難

**対策**:
1. Unsupported("vector(1536)") で型定義
2. ベクター検索は prisma.$queryRaw で実装
3. 型安全性はTypeScriptの型定義で補完

### 6.3 リスク: セマンティックレイヤー構築の複雑性

**影響**: メタデータ不足でAI精度が低下

**対策**:
1. subjects/metrics/departments の拡張を優先実施
2. 段階的にメタデータを充実化（初期は最小限でMVP）
3. β版で精度検証し、メタデータを追加

### 6.4 リスク: マイグレーション失敗

**影響**: 本番環境でのAI機能提供不可

**対策**:
1. ステージング環境で十分にテスト
2. マイグレーションのロールバック手順を事前準備
3. pgvector 拡張のインストールを事前確認

---

## 7. 実装チェックリスト

### 7.1 Phase 0: 基盤エンティティ実装

- [ ] tenants テーブル実装
- [ ] login_accounts テーブル実装
- [ ] accounting_periods テーブル実装
- [ ] departments テーブル実装
- [ ] organization_versions テーブル実装
- [ ] fact_amounts テーブル実装
- [ ] subjects テーブル拡張（description, aliases, data_type, unit, aggregation_method）
- [ ] metrics テーブル拡張（description, formula, components, unit）
- [ ] Prisma Client 生成確認
- [ ] マイグレーション実行確認

### 7.2 Phase 1: AI専用エンティティ実装

- [ ] PostgreSQL に pgvector 拡張インストール確認
- [ ] ai_knowledge_base テーブル実装（vector型含む）
- [ ] ai_conversations テーブル実装
- [ ] ai_audit_logs テーブル実装
- [ ] ai_anomaly_alerts テーブル実装
- [ ] ベクター検索インデックス作成確認
- [ ] Prisma Client 生成確認
- [ ] マイグレーション実行確認
- [ ] FK制約の動作確認

### 7.3 Phase 2: セマンティックレイヤー構築

- [ ] メタデータ自動生成スクリプト実装
- [ ] JSON Schema 生成確認
- [ ] ai_knowledge_base への初期データ投入
- [ ] 埋め込みベクトル生成バッチ実装
- [ ] ベクター検索の動作確認

---

## 8. まとめ

### 8.1 結論

AI機能実装のためには、以下の順序でエンティティを整備する必要がある:

1. **Phase 0（必須）**: 基盤エンティティ実装
   - tenants, login_accounts, accounting_periods, departments, fact_amounts 等
   - subjects/metrics の拡張
2. **Phase 1（AI基盤）**: AI専用エンティティ実装
   - ai_knowledge_base, ai_conversations, ai_audit_logs, ai_anomaly_alerts
   - pgvector 設定
3. **Phase 2（セマンティックレイヤー）**: メタデータ構築
   - 自動生成スクリプト、初期データ投入

### 8.2 次のアクション

1. **基盤エンティティ実装の優先順位確定**
   - tenants, login_accounts, accounting_periods を Phase 0 として実装
   - AI機能と並行開発可能な部分を切り出し
2. **Prisma Schema への追加計画**
   - 段階的マイグレーション計画の策定
   - ロールバック手順の準備
3. **pgvector 環境準備**
   - 開発環境・ステージング環境での pgvector インストール確認
   - ベクター検索の動作検証

---

## 関連ドキュメント

- `.kiro/specs/仕様検討/20260128_AIシミュレーション機能.md` - 詳細仕様検討
- `.kiro/specs/仕様概要/AIシミュレーション機能.md` - 仕様概要
- `.kiro/specs/entities/01_各種マスタ.md` - エンティティ定義（完全版）
- `.kiro/specs/entities/02_トランザクション・残高.md` - ファクトエンティティ定義
- `packages/db/prisma/schema.prisma` - 現在のPrisma Schema

---

**作成日**: 2026-01-28
**ステータス**: 影響分析完了、Phase 0 実装待ち
**次回アクション**: 基盤エンティティ実装計画の策定
