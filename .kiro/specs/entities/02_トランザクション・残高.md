# 予算・見込・実績ファクト定義（v2）

## 1. 概要（Purpose）

本章では、EPM（予算・見込・実績）における数値管理の中核となるファクトテーブル設計を定義する。

本ファクトは以下を満たすことを目的とする：

- 予算・見込・実績を**同一構造**で管理する
- 組織改編・分析軸追加に耐える長期運用設計
- 財務・非財務（KPI）を統合的に扱う
- 配賦前／配賦後、調整履歴を追跡可能とする

---

## 2. 設計方針（Policy）

### 2.1 基本思想

- **集約型ファクト**を基本とし、明細粒度は外部連携またはリンクで補完
- 組織は `org_version_id`（当時版）と `department_stable_id`（不変ID）の二刀流
- **分析軸は全て縦持ち（fact_dimension_links）** で統一
- 1ディメンション1値を原則とし、多値はv1では非対応

### 2.2 対象データ

- 予算（BUDGET）
- 見込（FORECAST）
- 実績（ACTUAL）

### 2.3 ディメンション vs タグ の使い分け

本設計では「ディメンション」と「タグ」を明確に区別する。

| 観点 | ディメンション | タグ |
|------|----------------|------|
| **目的** | 集計軸（Rollup/Drill-down） | 内訳分類・フィルタ |
| **予算入力** | する（軸として展開） | しない（科目単位で入力） |
| **実績収集** | する（キー項目） | する（属性項目） |
| **予実比較** | できる | できない（実績のみ） |
| **排他性** | 1ファクト = 1ディメンション1値 | 1ファクト = 複数タグ可能 |
| **一意制約** | 参加する | 参加しない |
| **レポート表示** | 行/列に展開 | ドリルダウン内訳 |
| **例** | 得意先グループ、商品カテゴリ、プロジェクト、IRセグメント | 広告内訳、施策種別 |

**判断基準**：
- 「この分類で予算を入力したい」→ ディメンション
- 「実績の内訳として見たいだけ」→ タグ

---

## 3. エンティティ一覧

### 3.1 fact_amounts（数値ファクト）

ファクトの本体。分析軸（ディメンション）は全て fact_dimension_links で縦持ちする。

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 主キー |
| tenant_id | UUID | ○ | テナントID（RLS境界） |
| company_id | UUID | ○ | 会社ID |
| accounting_period_id | UUID | ○ | 会計期間（月次） |
| scenario_type | ENUM | ○ | BUDGET / FORECAST / ACTUAL |
| plan_event_id | UUID | ○ | 予算・見込・実績イベント |
| plan_version | INT | ○ | バージョン番号 |
| source_type | ENUM | ○ | INPUT / ACTUAL_RAW / ACTUAL_ADJUST / ALLOC |
| subject_id | UUID | ○ | 科目ID（財務・KPI共通） |
| org_version_id | UUID | ○ | 組織版ID（当時） |
| department_stable_id | UUID | ○ | 部門不変ID |
| amount | DECIMAL(20,4) | ○ | 数値 |
| currency_code | VARCHAR(3) | △ | 通貨コード（財務用、ISO 4217） |
| uom | VARCHAR(30) | △ | 単位（KPI用） |
| trace_id | UUID | △ | 配賦・調整トレースID |
| memo | TEXT | △ | メモ・備考 |
| is_active | BOOLEAN | ○ | 有効フラグ（デフォルト true） |
| created_at | TIMESTAMPTZ | ○ | 作成日時 |
| updated_at | TIMESTAMPTZ | ○ | 更新日時 |
| created_by | UUID | ○ | 作成者 |
| updated_by | UUID | ○ | 更新者 |

**補足**：
- `project_id`, `ir_segment_value_id` 等の分析軸は fact_dimension_links で管理（横持ちしない）
- 部門（department_stable_id）のみ固定列として保持（全ファクトに必須のため）

---

### 3.2 fact_dimension_links（ファクト-ディメンションリンク）

ファクトとディメンション値を紐付ける。予算入力軸・集計軸として使用。

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 主キー |
| tenant_id | UUID | ○ | テナントID（RLS境界） |
| fact_amount_id | UUID | ○ | fact_amounts.id 参照 |
| dimension_id | UUID | ○ | dimensions.id 参照 |
| dimension_value_id | UUID | ○ | dimension_values.id 参照 |
| created_at | TIMESTAMPTZ | ○ | 作成日時 |

**制約**：
- `UNIQUE(fact_amount_id, dimension_id)` — 1ファクトにつき1ディメンション1値
- FK: fact_amount_id → fact_amounts(id) ON DELETE CASCADE
- FK: dimension_id → dimensions(id)
- FK: dimension_value_id → dimension_values(id)

**使用例**：
- プロジェクト別予算 → dimension_id = "プロジェクト", dimension_value_id = "ProjectX"
- IRセグメント別 → dimension_id = "IRセグメント", dimension_value_id = "国内事業"
- 得意先グループ別 → dimension_id = "得意先グループ", dimension_value_id = "大口A"
- 商品カテゴリ別 → dimension_id = "商品カテゴリ", dimension_value_id = "製品群A"
- 担当社員別 → dimension_id = "担当社員", dimension_value_id = "山田太郎"

---

### 3.3 tag_categories（タグカテゴリ）

タグのカテゴリ（分類軸）を定義する。

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 主キー |
| tenant_id | UUID | ○ | テナントID（RLS境界） |
| company_id | UUID | △ | 会社ID（NULL=テナント共通） |
| category_code | VARCHAR(50) | ○ | カテゴリコード |
| category_name | VARCHAR(200) | ○ | カテゴリ名 |
| description | TEXT | △ | 説明 |
| target_subject_ids | UUID[] | △ | 対象科目ID配列（NULL=全科目対象） |
| is_active | BOOLEAN | ○ | 有効フラグ |
| created_at | TIMESTAMPTZ | ○ | 作成日時 |
| updated_at | TIMESTAMPTZ | ○ | 更新日時 |
| created_by | UUID | ○ | 作成者 |
| updated_by | UUID | ○ | 更新者 |

**制約**：
- `UNIQUE(tenant_id, company_id, category_code)` — 会社内でカテゴリコード一意

**使用例**：
- 広告内訳（広告宣伝費の内訳用）
- 施策種別（オンライン/オフライン等）
- キャンペーン区分

---

### 3.4 tag_values（タグ値）

各カテゴリに属するタグ値を定義する。

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 主キー |
| tenant_id | UUID | ○ | テナントID（RLS境界） |
| tag_category_id | UUID | ○ | tag_categories.id 参照 |
| tag_code | VARCHAR(50) | ○ | タグコード |
| tag_name | VARCHAR(200) | ○ | タグ名 |
| sort_order | INT | ○ | 表示順 |
| is_active | BOOLEAN | ○ | 有効フラグ |
| created_at | TIMESTAMPTZ | ○ | 作成日時 |
| updated_at | TIMESTAMPTZ | ○ | 更新日時 |
| created_by | UUID | ○ | 作成者 |
| updated_by | UUID | ○ | 更新者 |

**制約**：
- `UNIQUE(tenant_id, tag_category_id, tag_code)` — カテゴリ内でタグコード一意
- FK: tag_category_id → tag_categories(id)

**使用例**：
- 広告内訳カテゴリ → Web広告, TV-CM, 展示会, SNS広告, その他

---

### 3.5 fact_tags（ファクト-タグリンク）

ファクトとタグ値を紐付ける。実績の内訳管理・フィルタ用。

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 主キー |
| tenant_id | UUID | ○ | テナントID（RLS境界） |
| fact_amount_id | UUID | ○ | fact_amounts.id 参照 |
| tag_category_id | UUID | ○ | tag_categories.id 参照 |
| tag_value_id | UUID | ○ | tag_values.id 参照 |
| amount | DECIMAL(20,4) | △ | 内訳金額（タグ単位の金額） |
| created_at | TIMESTAMPTZ | ○ | 作成日時 |

**制約**：
- 排他制約なし（同一カテゴリで複数タグ付与可能）
- FK: fact_amount_id → fact_amounts(id) ON DELETE CASCADE
- FK: tag_category_id → tag_categories(id)
- FK: tag_value_id → tag_values(id)

**補足**：
- `amount` は内訳金額。NULL の場合はタグのみ付与（金額配分なし）
- 同一カテゴリで複数タグを付与可能（例：Web広告 + SNS広告）
- 内訳金額の合計がファクト金額と一致する必要はない（運用ルール）

---

## 4. 制約条件（Constraints）

### 4.1 fact_amounts の一意制約

fact_amounts 本体の一意制約（ディメンション除く）：

```sql
UNIQUE(
  tenant_id,
  company_id,
  accounting_period_id,
  scenario_type,
  plan_event_id,
  plan_version,
  source_type,
  subject_id,
  department_stable_id
)
```

### 4.2 ディメンションを含む論理一意性

fact_amounts + fact_dimension_links の組み合わせで論理的に一意となる。

同じ `fact_amounts` の基本キーでも、異なるディメンション値であれば別レコードとして登録される。

**例**：
```
期間: 2024/04, 科目: 売上高, 部門: 営業1課
├── 得意先G: 大口A  → fact_amounts(id=1), fact_dimension_links(fact_id=1, dim=得意先, val=大口A)
├── 得意先G: 大口B  → fact_amounts(id=2), fact_dimension_links(fact_id=2, dim=得意先, val=大口B)
└── 得意先G: なし   → fact_amounts(id=3), fact_dimension_links なし
```

### 4.3 外部キー制約

**fact_amounts**:
- tenant_id → tenants(id)
- company_id → companies(id)
- accounting_period_id → accounting_periods(id)
- subject_id → subjects(id)
- org_version_id → organization_versions(id)
- department_stable_id → departments(stable_id)

**fact_dimension_links**:
- fact_amount_id → fact_amounts(id) ON DELETE CASCADE
- dimension_id → dimensions(id)
- dimension_value_id → dimension_values(id)

**fact_tags**:
- fact_amount_id → fact_amounts(id) ON DELETE CASCADE
- tag_category_id → tag_categories(id)
- tag_value_id → tag_values(id)

---

## 5. 配賦（Allocation）設計との関係

- 配賦結果は `source_type = ALLOC` として fact_amounts に格納
- 配賦元はマイナス行、配賦先はプラス行で表現
- 同一配賦処理は `trace_id` で紐づける
- 配賦先のディメンション値は fact_dimension_links で表現

---

## 6. 実績運用ルール

### 6.1 source_type の使い分け

| source_type | 説明 | 上書き可否 |
|-------------|------|------------|
| INPUT | 予算・見込の手入力 | 可 |
| ACTUAL_RAW | 基幹システムからの実績取込 | 可（再取込で上書き） |
| ACTUAL_ADJUST | 決算調整・管理調整 | 可 |
| ALLOC | 配賦結果 | 不可（再配賦で再生成） |

### 6.2 実績データの取込粒度

- 基幹システムから**月次・部門・科目・ディメンション値別**の集約済みデータを受領
- タグ情報がある場合は fact_tags として同時取込
- FIX判定は plan_event / close_status により制御

---

## 7. レポート表示パターン

### 7.1 ディメンション → 軸として展開

```
得意先グループ別売上
┌─────────────────────────────────────────────┐
│              │ 予算    │ 実績    │ 差異   │
├─────────────────────────────────────────────┤
│ 大口A        │ 400     │ 420     │ +20   │
│ 大口B        │ 350     │ 340     │ -10   │
│ その他       │ 250     │ 260     │ +10   │
├─────────────────────────────────────────────┤
│ 合計         │ 1,000   │ 1,020   │ +20   │
└─────────────────────────────────────────────┘
```

### 7.2 タグ → ドリルダウン内訳

```
広告宣伝費
┌─────────────────────────────────────────────┐
│              │ 予算    │ 実績    │ 差異   │
│ 広告宣伝費   │ 500     │ 520     │ +20   │
└─────────────────────────────────────────────┘
        │
        ▼ ドリルダウン（タグ内訳）
┌─────────────────────────────────────────────┐
│ 【内訳】     │ 予算    │ 実績    │ 差異   │
├─────────────────────────────────────────────┤
│ Web広告     │ -       │ 200     │ -     │
│ TV-CM       │ -       │ 150     │ -     │
│ 展示会      │ -       │ 120     │ -     │
│ その他      │ -       │ 50      │ -     │
├─────────────────────────────────────────────┤
│ 合計        │ (500)   │ 520     │ -     │
└─────────────────────────────────────────────┘
※ タグは予算入力しないため、予算列は空白
```

---

## 8. 補足・将来拡張

### 8.1 v1 対応範囲

- 1ディメンション1値（排他）
- タグは複数付与可能
- 按分マッピングは非対応

### 8.2 v2 以降検討事項

- 多値ディメンション（按分付き: 30%:A, 70%:B 等）
- 配賦スナップショット保存
- タグの階層構造化
- 連結ファクト（group_fact_amounts）

---

## 9. 本設計の位置づけ

本ファクト設計は、

- 組織改編
- 予算再策定
- 見込更新
- 配賦・調整
- 財務・非財務統合
- 動的な分析軸追加

を**単一ファクトモデル + 縦持ちディメンション + タグ**で成立させることを目的とした、EPM基盤の中核定義である。

---

## 10. ER図（概念）

```
┌─────────────────────────────────────────────────────────────────┐
│                         fact_amounts                            │
│  (ファクト本体: 期間/科目/部門/金額)                              │
└─────────────────────────────────────────────────────────────────┘
          │                                    │
          │ 1:N                                │ 1:N
          │ (1ディメンション1値)                │ (複数タグ可)
          ▼                                    ▼
┌───────────────────────────┐    ┌───────────────────────────────┐
│   fact_dimension_links    │    │         fact_tags             │
│  (ディメンション: 集計軸)  │    │    (タグ: 内訳・フィルタ)      │
└───────────────────────────┘    └───────────────────────────────┘
          │                                    │
          │ N:1                                │ N:1
          ▼                                    ▼
┌───────────────────────────┐    ┌───────────────────────────────┐
│   dimension_values        │    │        tag_values             │
│  (ディメンション値)        │    │       (タグ値)                │
└───────────────────────────┘    └───────────────────────────────┘
          │                                    │
          │ N:1                                │ N:1
          ▼                                    ▼
┌───────────────────────────┐    ┌───────────────────────────────┐
│     dimensions            │    │      tag_categories           │
│  (ディメンション定義)      │    │    (タグカテゴリ定義)          │
└───────────────────────────┘    └───────────────────────────────┘
```
