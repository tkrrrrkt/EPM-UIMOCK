# 承認ワークフロー エンティティ定義

## 1. 概要（Purpose）

本章では、EPMにおける予算・見込の承認ワークフロー機能のエンティティを定義する。

本設計は以下を満たすことを目的とする：

- 部門×バージョン単位の承認状態管理
- MAX 5段階の固定段階承認
- 承認履歴の完全な追跡
- 代理承認・垂直代理承認のサポート

---

## 2. 設計方針（Policy）

### 2.1 基本思想

- **シンプルな固定段階制**: 可変ルートは採用せず、最大5段階の固定承認
- **部門単位の承認**: バージョン全体ではなく、部門×バージョン単位で承認状態を管理
- **履歴の完全保持**: 誰がいつ何をしたかを全て記録
- **EPMはERPではない**: 承認機能は「必要十分」に留める

### 2.2 承認対象

- 予算（BUDGET）: 承認対象
- 見込（FORECAST）: purpose_type = 'CORPORATE' のみ承認対象
- 実績（ACTUAL）: 承認対象外

### 2.3 承認者の設定

- 承認者は departments テーブルに横持ち（10カラム：本人+代理×5段階）
- 組織版（organization_version）ごとに設定
- 詰めて設定（中抜け禁止）

---

## 3. エンティティ一覧

### 3.1 department_approval_status（部門承認状態）

部門×バージョン単位の承認状態を管理する。

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 主キー |
| tenant_id | UUID | ○ | テナントID（RLS境界） |
| plan_version_id | UUID | ○ | 対象バージョン |
| department_stable_id | TEXT | ○ | 対象部門（不変ID） |
| current_step | INT | ○ | 現在の承認段階（0=未提出、1〜5=承認段階） |
| status | VARCHAR(20) | ○ | 承認ステータス |
| submitted_at | TIMESTAMPTZ | △ | 最初の提出日時 |
| submitted_by_employee_id | UUID | △ | 提出者 |
| final_approved_at | TIMESTAMPTZ | △ | 最終承認日時 |
| created_at | TIMESTAMPTZ | ○ | 作成日時 |
| updated_at | TIMESTAMPTZ | ○ | 更新日時 |

**status の値**:

| 値 | 説明 |
|----|------|
| DRAFT | 未提出（入力中） |
| PENDING | 承認待ち |
| APPROVED | 承認完了 |
| REJECTED | 差戻し（承認者から） |
| WITHDRAWN | 取下げ（本人から） |

**制約**:
- UNIQUE(tenant_id, plan_version_id, department_stable_id)
- FK: tenant_id → tenants(id)
- FK: plan_version_id → plan_versions(id)
- FK: submitted_by_employee_id → employees(id)
- CHECK(status IN ('DRAFT', 'PENDING', 'APPROVED', 'REJECTED', 'WITHDRAWN'))
- CHECK(current_step >= 0 AND current_step <= 5)

---

### 3.2 department_approval_histories（部門承認履歴）

承認アクションの履歴を記録する。誰がいつ何をしたか、コメント含めて全て残す。

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 主キー |
| tenant_id | UUID | ○ | テナントID（RLS境界） |
| department_approval_status_id | UUID | ○ | 親テーブル参照 |
| step | INT | ○ | 操作対象の承認段階 |
| action | VARCHAR(20) | ○ | アクション種別 |
| actor_employee_id | UUID | ○ | 操作者 |
| acted_at | TIMESTAMPTZ | ○ | 操作日時 |
| comment | TEXT | △ | コメント（任意） |
| created_at | TIMESTAMPTZ | ○ | 作成日時 |

**action の値**:

| 値 | 説明 |
|----|------|
| SUBMIT | 提出 |
| APPROVE | 承認 |
| REJECT | 差戻し |
| WITHDRAW | 取下げ |
| SKIP | スキップ（垂直代理で飛ばされた段階） |

**制約**:
- FK: tenant_id → tenants(id)
- FK: department_approval_status_id → department_approval_status(id)
- FK: actor_employee_id → employees(id)
- CHECK(action IN ('SUBMIT', 'APPROVE', 'REJECT', 'WITHDRAW', 'SKIP'))

---

## 4. 状態遷移

### 4.1 ステータス遷移図

```
┌─────────┐
│  DRAFT  │
│ (未提出) │
└────┬────┘
     │ 提出 (SUBMIT)
     ▼
┌─────────┐      承認 (APPROVE)           ┌──────────┐
│ PENDING │──────────────────────────────▶│ APPROVED │
│(承認待ち)│    （全段階完了時）             │  (完了)   │
└────┬────┘                               └──────────┘
     │
     ├─────────┬─────────┐
     │         │         │
     │差戻し    │取下げ    │承認（次段階へ）
     │(REJECT) │(WITHDRAW)│(APPROVE)
     ▼         ▼         ▼
┌─────────┐ ┌──────────┐  PENDING
│REJECTED │ │WITHDRAWN │  (current_step+1)
│ (差戻し) │ │ (取下げ)  │
└────┬────┘ └────┬─────┘
     │           │
     └─────┬─────┘
           │ 再提出 (SUBMIT)
           ▼
       PENDING
       (current_step=1)
```

### 4.2 current_step の動き

| current_step | status | 意味 |
|--------------|--------|------|
| 0 | DRAFT | 未提出 |
| 1 | PENDING | 提出済み、第1承認待ち |
| 2 | PENDING | 第1承認済み、第2承認待ち |
| 3 | PENDING | 第2承認済み、第3承認待ち |
| N | APPROVED | 第N承認済み（最終承認者がNの場合） |

---

## 5. 承認権限ルール

### 5.1 承認可能者

| 操作者 | 承認できる範囲 |
|--------|---------------|
| 第1承認者 or 第1代理 | 第1段階のみ |
| 第2承認者 or 第2代理 | 第1〜第2段階 |
| 第3承認者 or 第3代理 | 第1〜第3段階 |
| 第N承認者 or 第N代理 | 第1〜第N段階 |

### 5.2 垂直代理承認

上位承認者は下位段階をスキップして承認可能。

**例**: 第3承認者が承認した場合
- current_step: 1 → 3
- 第1、第2段階は履歴に `SKIP` として記録
- 第3段階は `APPROVE` として記録

### 5.3 禁止事項

- 下位者が上位段階を承認することは禁止
- 差戻し後は第1段階からやり直し

---

## 6. 通知機能

### 6.1 通知タイミングと宛先

| アクション | 通知先 | 内容 |
|-----------|--------|------|
| SUBMIT（提出） | 次の承認者（第1承認者） | 「承認依頼が届きました」 |
| APPROVE（次段階あり） | 次の承認者 | 「承認依頼が届きました」 |
| APPROVE（最終承認） | 申請者 | 「承認されました」 |
| REJECT（差戻し） | 申請者 | 「差し戻されました」 |
| WITHDRAW（取下げ） | 現在の承認待ち者 | 「取り下げられました」 |

### 6.2 メール送信

- 送信先: employees.email
- フォーマット: 固定文言 + 変数埋め込み（カスタマイズ画面は作らない）

---

## 7. 関連エンティティへの影響

### 7.1 plan_events への追加

```sql
-- purpose_type カラム追加（2026-01-15）
purpose_type VARCHAR(20) NOT NULL DEFAULT 'CORPORATE'
  CHECK (purpose_type IN ('CORPORATE', 'DIVISIONAL'))

-- CORPORATE: 全社報告用（承認対象）
-- DIVISIONAL: 事業部ローカル用（承認不要）
```

### 7.2 departments への追加

```sql
-- 承認者カラム追加（2026-01-15）
approver_1_employee_id UUID REFERENCES employees(id)
approver_1_deputy_employee_id UUID REFERENCES employees(id)
approver_2_employee_id UUID REFERENCES employees(id)
approver_2_deputy_employee_id UUID REFERENCES employees(id)
approver_3_employee_id UUID REFERENCES employees(id)
approver_3_deputy_employee_id UUID REFERENCES employees(id)
approver_4_employee_id UUID REFERENCES employees(id)
approver_4_deputy_employee_id UUID REFERENCES employees(id)
approver_5_employee_id UUID REFERENCES employees(id)
approver_5_deputy_employee_id UUID REFERENCES employees(id)
```

---

## 8. ER図（概念）

```
┌─────────────────────────────────────────────────────────────────┐
│                      plan_versions                              │
│  (予算・見込バージョン)                                          │
└─────────────────────────────────────────────────────────────────┘
          │
          │ 1:N
          ▼
┌─────────────────────────────────────────────────────────────────┐
│               department_approval_status                        │
│  (部門×バージョン単位の承認状態)                                 │
│  ├── current_step: 現在の承認段階                               │
│  ├── status: DRAFT/PENDING/APPROVED/REJECTED/WITHDRAWN          │
│  └── submitted_by_employee_id: 提出者                           │
└─────────────────────────────────────────────────────────────────┘
          │
          │ 1:N
          ▼
┌─────────────────────────────────────────────────────────────────┐
│              department_approval_histories                      │
│  (承認履歴)                                                      │
│  ├── step: 操作対象の段階                                       │
│  ├── action: SUBMIT/APPROVE/REJECT/WITHDRAW/SKIP               │
│  ├── actor_employee_id: 操作者                                  │
│  └── comment: コメント（任意）                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      departments                                │
│  (部門マスタ)                                                    │
│  ├── approver_1_employee_id: 第1承認者                          │
│  ├── approver_1_deputy_employee_id: 第1代理承認者               │
│  ├── ...                                                        │
│  ├── approver_5_employee_id: 第5承認者                          │
│  └── approver_5_deputy_employee_id: 第5代理承認者               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. MVP外機能

以下は本設計のスコープ外とし、将来検討とする：

| 機能 | 理由 |
|------|------|
| 一括承認 | 運用頻度が低い。必要に応じてUI機能として追加 |
| 承認期限 | 期限超過時の自動処理が複雑 |
| エスカレーション | 運用でカバー可能 |
| 可変承認ルート | 設定・運用が複雑 |

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-15 | 初版作成 | Claude Code |
