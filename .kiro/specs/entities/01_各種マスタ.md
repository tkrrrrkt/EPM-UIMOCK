# OBEPM マスタ＆定義テーブル 完成版（V2）

**対象範囲（V2）**

- 連結（会社階層・連結COA・マッピング）
- 組織（版管理＋部門stable_id）
- 集計軸（dimensions・values・部門割当/配賦）
- Leaf（大量コードの写し）：dimension_members（IMPORT中心）
- Leaf→Group分類：dimension_member_groups（期間管理）
- 社員・所属履歴（主務/兼務・事前登録）
- ログイン（login_accounts）・ロール最小
- 科目（財務＋非財務KPI共通）＋財務属性
- 集計定義（rollup係数）
- レイアウト（PL/BS）
- 財務指標（metrics：式）
- 会計期間（accounting_period）
- 計画イベント／バージョン（予算・見込・実績の版管理）
- 予算・見込・実績ファクト（集約型Upsert＋可変ディメンションリンク）
- 配賦ルール（イベント／多段階ステップ／配賦先／ドライバ）
- プロジェクト（独立マスタ＋グルーピング）
- 単価マスタ（社員・外注統一＋科目別内訳）
- 人員計画（職種×等級一括管理＋個人別配賦）

（※承認/ワークフロー系は今回は入れない方針）

---

## 0. 設計思想（初見向け）

### 0.1 境界（RLS）

- **tenant_id がデータ分離境界**（全テーブルに tenant_id を持たせる）
- company_id は tenant_id の下位概念（複合FKで整合を強制）

### 0.2 組織：版と不変ID

- 組織は **organization_versions（版）** でスナップショット管理
- 部門は版内の実体 `departments.id` と、版を跨ぐ追跡キー `departments.stable_id` を併用
  - UI操作・入力は department_id（版内実体）
  - 時系列比較・所属履歴・ファクト保持は department_stable_id（版非依存）

### 0.3 連結：会社COAとグループCOA

- 会社ごとの科目（会社COA）と、連結で統一して見る科目（グループCOA）を分離
- **グループCOA : 会社COA = 1 : N** を基本としてマッピングを持つ（初期リリースから必須）
- Factは **会社COA（subjects）** を保持し、連結は group_subject_mappings で集計変換する（確定）

### 0.4 集計：符号は「式」で決める

- 会計の借貸（normal_balance）は保持してよいが、**集計の主役にしない**
- 集計は **rollup（係数 +1/-1）** で明示し、例外（EBITDA/ROEなど）は **metrics（式）** で扱う

### 0.5 KPI

- KPIは基本SUM想定でも、運用で詰まらないように
  - aggregation_method（SUM/EOP/AVG…）
  - direction（増加が良い/減少が良い等）
  - allow_negative
  を科目側に持てる

### 0.6 ディメンション（3レイヤ）と運用方針（確定）

分析軸は **①軸（Dimension）／②まとめ方（Group）／③実物（Leaf）** の3段階で扱う。

- Dimension：軸の定義（製品・得意先・地域…）＝ dimensions
- Group：経営粒度の分類（製品カテゴリ、得意先グループ等）＝ dimension_values
- Leaf：大量コード（SKU、得意先コード等）＝ dimension_members（OBEPMでは正本化しない「写し」）

**確定方針**
- GroupだけをOBEPMの「経営マスタ（正）」として持つ
- LeafはOBEPMに大量に持ち込まず、まずは **IMPORTで参照・検索・分類できる最小写し**
- Factへの付与は **Group（dimension_values）のみ**（Leafはリンクしない：確定）
- IRセグメントは頻出軸として **Fact固定列**、ただし未割当があるため **NULL可（任意）**（確定）

### 0.7 予算・見込・実績（イベント×バージョン：確定）

- **plan_events**：同年度内の枠（当初予算、修正予算、月次見込、実績など）
- **plan_versions**：枠内の試行回数（第1回、第2回、FIXEDなど）
- 予算は **バージョン管理**し、FIXED（確定）以降は更新不可
- 見込もバージョン管理できる（入力の試行錯誤を許容）
- 年度着地（EAC）は「経過月ACTUAL＋将来月FORECAST」をView/集計で合成

### 0.8 Factの持ち方（確定：2026-01-09 再改訂）

- Factは **集約型（同一キー1行）**：Upsertで上書き（確定）
- 主要軸は固定列：
  - company_id / accounting_period_id / subject_id / org_version_id / department_stable_id
  - **project_id**（nullable）：PJ別予算・実績に対応
- **ディメンションは縦持ち**：
  - fact_dimension_links（Groupのみ）
  - IRセグメント等の可変軸はリンクで管理
- **プロジェクトは固定列**：
  - PJ予算・PJ実績を統一的に管理するため fact_amounts.project_id で保持
  - PJ紐付けなしの場合は NULL
  - PJ別データと部門のみデータが混在可能
- 科目ごとのディメンション使用設定：
  - subject_budget_settings（マスタ）で設定
  - scenario_subject_settings（予算イベント作成時のスナップショット）で固定

---

# 1. テナント／会社

## 1.1 tenants（テナント）

### 仕様
- RLS境界となるテナントを定義する
- primary_company_id で連結機能が使用可能な主会社を指定

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|T-ABC|PK|
|tenant_code|varchar(50)|NO|"ABC"|表示/外部連携用|
|tenant_name|varchar(200)|NO|"ABCグループ"||
|primary_company_id|uuid|YES|C-ABC|連結機能が使える主会社（2026-01-13追加）|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_code)
- FK(primary_company_id) → companies(id)

### 補足
- tenant_id は全テーブルに必須（RLS境界）
- primary_company_id は連結機能（is_consolidation=true のメニュー）を使用可能な会社を指定。この会社に所属する社員のみが連結メニューにアクセス可能


---

## 1.2 companies（法人マスタ）

### 仕様
- 法人（会社）を定義し、会社階層（連結）および通貨・期末月等の共通属性を保持

### エンティティ

|カラム|型|NULL|例|補足（設計意図）|
|---|---|---|---|---|
|id|uuid|NO|C-ABC|PK|
|tenant_id|uuid|NO|T-ABC|RLS|
|company_code|varchar(20)|NO|"ABC"|tenant内一意推奨|
|company_name|varchar(200)|NO|"ABC株式会社"||
|company_name_short|varchar(100)|YES|"ABC"||
|parent_company_id|uuid|YES|C-HOLD|会社階層（同一tenant）|
|consolidation_type|varchar(20)|NO|"full"|full/equity/none|
|ownership_ratio|numeric(5,2)|YES|100.00|0-100|
|voting_ratio|numeric(5,2)|YES|100.00|0-100|
|currency_code|char(3)|NO|"JPY"|会社通貨|
|reporting_currency_code|char(3)|YES|"JPY"|表示/レポート通貨（任意）|
|fiscal_year_end_month|int|NO|3|1-12|
|timezone|varchar(50)|YES|"Asia/Tokyo"||
|is_active|boolean|NO|true||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES||監査|
|updated_by|uuid|YES||監査|
|tag1_label|varchar(50)|YES|"顧客名"|タグ1のラベル名|
|tag2_label|varchar(50)|YES|"案件番号"|タグ2のラベル名|
|tag3_label|varchar(50)|YES||タグ3のラベル名|
|tag4_label|varchar(50)|YES||タグ4のラベル名|
|tag5_label|varchar(50)|YES||タグ5のラベル名|
|default_org_dimension_id|uuid|YES|DIM-ORG|デフォルト組織ディメンション|
|cvp_report_layout_id|uuid|YES|L-CVP-PL|CVP損益分岐分析で使用するPLレイアウト|
|roic_pl_layout_id|uuid|YES|L-ROIC-PL|ROIC分析で使用するPLレイアウト|
|roic_bs_layout_id|uuid|YES|L-ROIC-BS|ROIC分析で使用するBSレイアウト|
|indicator_report_layout_id|uuid|YES|L-IND-STD|財務指標分析レポート（定型指標）で使用するレイアウト|
|roic_ebit_subject_id|uuid|YES|SUB-EBIT|ROICのEBIT科目（PL）|
|roic_operating_assets_subject_id|uuid|YES|SUB-OA|ROICの営業資産集計科目|
|roic_operating_liabilities_subject_id|uuid|YES|SUB-OL|ROICの営業負債集計科目|
|effective_tax_rate|numeric(5,2)|YES|30.00|ROIC計算に使用する実効税率（%）|
|wacc_rate|numeric(5,2)|YES|7.50|WACC（%）|
|default_labor_cost_subject_id|uuid|YES|SUBJ-LABOR|人件費デフォルト科目（custom_rate使用時）|
|revenue_subject_id|uuid|YES|SUB-REV|主要科目: 売上高|
|variable_cost_subject_id|uuid|YES|SUB-VC|主要科目: 変動費計（直接原価計算用）|
|marginal_profit_subject_id|uuid|YES|SUB-MP|主要科目: 限界利益（売上-変動費）|
|fixed_cost_subject_id|uuid|YES|SUB-FC|主要科目: 固定費計（直接原価計算用）|
|cogs_subject_id|uuid|YES|SUB-COGS|主要科目: 売上原価（全部原価計算用）|
|gross_profit_subject_id|uuid|YES|SUB-GP|主要科目: 粗利/売上総利益（売上-売上原価）|
|contribution_profit_subject_id|uuid|YES|SUB-CP|主要科目: 貢献利益/事業利益|
|operating_profit_subject_id|uuid|YES|SUB-OP|主要科目: 営業利益|
|enable_budget_approval|boolean|NO|false|予算承認ワークフローを使用するか|
|enable_forecast_approval|boolean|NO|false|見込承認ワークフローを使用するか|

### 制約（必須）
- UNIQUE(tenant_id, company_code)
- UNIQUE(tenant_id, id)（複合FK用）
- CHECK(consolidation_type IN ('full','equity','none'))
- CHECK(ownership_ratio IS NULL OR (0<=ownership_ratio AND ownership_ratio<=100))
- CHECK(voting_ratio IS NULL OR (0<=voting_ratio AND voting_ratio<=100))
- CHECK(fiscal_year_end_month BETWEEN 1 AND 12)
- CHECK(effective_tax_rate IS NULL OR (0<=effective_tax_rate AND effective_tax_rate<=100))
- CHECK(wacc_rate IS NULL OR (0<=wacc_rate AND wacc_rate<=100))
- FK(tenant_id, default_org_dimension_id) → dimensions(tenant_id, id)
- FK(tenant_id, cvp_report_layout_id) → report_layouts(tenant_id, id)
- FK(tenant_id, roic_pl_layout_id) → report_layouts(tenant_id, id)
- FK(tenant_id, roic_bs_layout_id) → report_layouts(tenant_id, id)
- FK(tenant_id, indicator_report_layout_id) → indicator_report_layouts(tenant_id, id)
- FK(tenant_id, company_id, default_labor_cost_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, id, roic_ebit_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, id, roic_operating_assets_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, id, roic_operating_liabilities_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, id, revenue_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, id, variable_cost_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, id, marginal_profit_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, id, fixed_cost_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, id, cogs_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, id, gross_profit_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, id, contribution_profit_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, id, operating_profit_subject_id) → subjects(tenant_id, company_id, id)

### 補足
- parent_company_id の同一tenant制約は初期はUseCaseで担保（将来DB制約化可）
- 端数処理・表示スケール等は v2では「原単位保持＋Viewで制御」を基本とし、必要になれば companies に拡張カラムを追加する方針
- tag1_label〜tag5_label は fact_journal_lines のタグ列に対する会社別ラベル定義（軽量タグ機能）
- roic_pl_layout_id は layout_type='PL' を前提、roic_bs_layout_id は layout_type='BS' を前提
- roic_ebit_subject_id は roic_pl_layout_id に含まれる account 行の科目を指定する
- roic_operating_assets_subject_id / roic_operating_liabilities_subject_id は営業資産・営業負債の集計科目を指定し、入力は配下科目で行う
- default_org_dimension_id は会社作成時のデフォルト組織ディメンション。dimension_category='ORGANIZATION' の軸を指定
- cvp_report_layout_id は CVP損益分岐分析で使用するPLレイアウト。layout_type='PL' を前提とし、未設定の場合はCVP画面を使用不可とする
- indicator_report_layout_id は 財務指標分析レポート（定型指標）で使用するレイアウト。未設定の場合は当該レポート画面を使用不可とする
- default_labor_cost_subject_id は人員計画で custom_rate を使用した場合に適用するデフォルト人件費科目

#### 主要科目（Key Subjects）について
> **追加日**: 2026-01-15

以下の主要科目IDは、レポート・ダッシュボードで使用する集計科目を指定する。すべてNULL許容（会社設定時に任意で指定）。

| 科目 | 用途 |
|------|------|
| revenue_subject_id | PJ採算照会、経営会議KPI、各種レポートのトップライン |
| variable_cost_subject_id | 直接原価計算レポート |
| marginal_profit_subject_id | 直接原価計算レポート（限界利益 = 売上 - 変動費）|
| fixed_cost_subject_id | 直接原価計算レポート |
| cogs_subject_id | 全部原価計算レポート、PJ採算照会 |
| gross_profit_subject_id | PJ採算照会、粗利分析（粗利 = 売上 - 売上原価）|
| contribution_profit_subject_id | 事業部別採算レポート |
| operating_profit_subject_id | 経営会議KPI、予実差異分析 |

#### 承認ワークフロー設定について
> **追加日**: 2026-01-15

- enable_budget_approval: true の場合、予算入力時に承認ワークフローを経由して確定する
- enable_forecast_approval: true の場合、見込入力時に承認ワークフローを経由して確定する
- いずれも false の場合、承認なしで直接確定可能


---

# 2. 会計期間（年月/年度）

## 2.1 accounting_periods（会計期間）

### 仕様
- 月次／調整期の会計期間を管理し、close_statusで入力・取込可否を制御する

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|AP-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies(tenant_id,id) 複合FK|
|fiscal_year|int|NO|2025|FY|
|period_kind|varchar(10)|NO|"MONTH"|MONTH / ADJ|
|period_no|smallint|NO|1|MONTH:1-12, ADJ:13..|
|quarter_no|smallint|YES|1|1-4（任意）|
|start_date|date|NO|2025-04-01||
|end_date|date|NO|2025-04-30|start<=end|
|is_adjustment|boolean|NO|false|period_kind!='MONTH'の冗長|
|close_status|varchar(20)|NO|"OPEN"|OPEN/SOFT_CLOSED/HARD_CLOSED|
|closed_at|timestamptz|YES||本締め日時|
|input_locked|boolean|NO DEFAULT false|false|入力ロック状態（配賦実行時に自動設定）|
|input_locked_at|timestamptz|YES||入力ロック日時|
|input_locked_by|uuid|YES||入力ロック操作者（login_accounts.id）|
|period_code|varchar(32)|NO|"FY2025-P01"|検索/表示キー|
|display_label|varchar(64)|YES|"FY2025 P01 / 2025-04"|表示|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約（必須）
- UNIQUE(tenant_id, company_id, fiscal_year, period_kind, period_no)
- UNIQUE(tenant_id, company_id, period_code)
- FK(tenant_id, company_id) → companies(tenant_id, id)
- CHECK(period_kind IN ('MONTH','ADJ'))
- CHECK(start_date <= end_date)
- CHECK(close_status IN ('OPEN','SOFT_CLOSED','HARD_CLOSED'))

### 補足
- close_statusの意味は運用で固定（OPEN=入力可、SOFT=原則不可、HARD=不可）
- 期首月は companies.fiscal_year_end_month から生成可能（period生成バッチ前提）

## 2.2 period_close_logs（締め操作ログ）

### 仕様
- 締め処理の操作（仮締め/本締め/差し戻し）を監査ログとして記録
- 画面には表示せず、管理者がDBで確認

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|PCL-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies(tenant_id,id) 複合FK|
|accounting_period_id|uuid|NO|AP-...|accounting_periods(tenant_id,company_id,id) 複合FK|
|action|varchar(20)|NO|"SOFT_CLOSE"|SOFT_CLOSE/HARD_CLOSE/REOPEN|
|from_status|varchar(20)|NO|"OPEN"|変更前ステータス|
|to_status|varchar(20)|NO|"SOFT_CLOSED"|変更後ステータス|
|operated_by|uuid|NO|U-...|操作者（login_accounts.id）|
|operated_at|timestamptz|NO|2026-05-10 10:00|操作日時|
|notes|text|YES||理由・メモ（差し戻し時など）|
|created_at|timestamptz|NO|||

### 制約（必須）
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, company_id, accounting_period_id) → accounting_periods(tenant_id, company_id, id)
- CHECK(action IN ('SOFT_CLOSE','HARD_CLOSE','REOPEN'))
- CHECK(from_status IN ('OPEN','SOFT_CLOSED','HARD_CLOSED'))
- CHECK(to_status IN ('OPEN','SOFT_CLOSED','HARD_CLOSED'))

### インデックス
- INDEX idx_period_close_logs_period ON period_close_logs(tenant_id, company_id, accounting_period_id)

### 補足
- 操作履歴のため、UPDATE/DELETEは原則禁止（INSERT-only）
- 監査目的なので、必ず operated_by を記録する


---

# 3. 組織（版＋部門）

## 3.1 organization_versions（組織バージョン）

### 仕様
- 組織をスナップショット（版）として管理（承認ステータス無し方針）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|OV-2025-04|PK|
|tenant_id|uuid|NO|T-ABC|RLS|
|company_id|uuid|NO|C-ABC|複合FK|
|version_code|varchar(20)|NO|"2025-04"|会社内一意|
|version_name|varchar(200)|NO|"2025年4月組織改編"||
|effective_date|date|NO|2025-04-01||
|expiry_date|date|YES|2025-10-01|NULL=無期限|
|base_version_id|uuid|YES|OV-2024-04|コピー元|
|description|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約
- UNIQUE(tenant_id, company_id, version_code)
- FK(tenant_id, company_id) → companies(tenant_id, id)
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)

### 補足
- as-of（対象日）で effective/expiry を検索して使用versionを決定


---

## 3.2 departments（部門マスタ）

### 仕様
- 版内実体（department_id）と版非依存の追跡キー（stable_id）を併用
- ファクト／社員所属／比較用途は stable_id を主に使う
- company_id を保持し、organization_versions との複合FK整合性を担保
- 承認者（本人+代理）を5段階分保持（2026-01-15追加）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|D-...|PK（版内実体）|
|tenant_id|uuid|NO|T-ABC|RLS|
|company_id|uuid|NO|C-ABC|複合FK（冗長保持、整合性担保）|
|version_id|uuid|NO|OV-...|複合FK|
|stable_id|uuid|NO|S-SALES|版非依存の追跡キー|
|department_code|varchar(50)|NO|"SALES_HQ"|版内一意|
|department_name|varchar(200)|NO|"営業本部"|版で変わる|
|department_name_short|varchar(100)|YES|"営業"||
|parent_id|uuid|YES||同版内のみ|
|sort_order|int|NO|10||
|hierarchy_level|int|NO|2|キャッシュ|
|hierarchy_path|varchar(1000)|YES|"/ROOT/SALES_HQ"|キャッシュ|
|headcount|int|NO|0|所属社員数（自動計算）|
|is_active|boolean|NO|true|版内無効|
|org_unit_type|varchar(30)|YES|"dept"|任意|
|responsibility_type|varchar(30)|YES|"profit"|任意|
|external_center_code|varchar(30)|YES|"CC100"|ERP連携|
|manager_id|uuid|YES|E-...|employees想定|
|approver_1_employee_id|uuid|YES|E-...|第1承認者（※2026-01-15追加）|
|approver_1_deputy_employee_id|uuid|YES|E-...|第1代理承認者（※2026-01-15追加）|
|approver_2_employee_id|uuid|YES|E-...|第2承認者（※2026-01-15追加）|
|approver_2_deputy_employee_id|uuid|YES|E-...|第2代理承認者（※2026-01-15追加）|
|approver_3_employee_id|uuid|YES|E-...|第3承認者（※2026-01-15追加）|
|approver_3_deputy_employee_id|uuid|YES|E-...|第3代理承認者（※2026-01-15追加）|
|approver_4_employee_id|uuid|YES|E-...|第4承認者（※2026-01-15追加）|
|approver_4_deputy_employee_id|uuid|YES|E-...|第4代理承認者（※2026-01-15追加）|
|approver_5_employee_id|uuid|YES|E-...|第5承認者（※2026-01-15追加）|
|approver_5_deputy_employee_id|uuid|YES|E-...|第5代理承認者（※2026-01-15追加）|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約（必須）
- UNIQUE(tenant_id, company_id, version_id, department_code)
- UNIQUE(tenant_id, company_id, version_id, id)（複合FK用）
- UNIQUE(tenant_id, stable_id)（テナント内で不変IDは一意）
- FK(tenant_id, company_id, version_id) → organization_versions(tenant_id, company_id, id)
- FK(tenant_id, company_id, version_id, parent_id) → departments(tenant_id, company_id, version_id, id)
- FK(approver_1_employee_id) → employees(id)
- FK(approver_1_deputy_employee_id) → employees(id)
- FK(approver_2_employee_id) → employees(id)
- FK(approver_2_deputy_employee_id) → employees(id)
- FK(approver_3_employee_id) → employees(id)
- FK(approver_3_deputy_employee_id) → employees(id)
- FK(approver_4_employee_id) → employees(id)
- FK(approver_4_deputy_employee_id) → employees(id)
- FK(approver_5_employee_id) → employees(id)
- FK(approver_5_deputy_employee_id) → employees(id)
- cycleチェック（UseCase必須）

### 補足
- hierarchy_path/level はキャッシュ：移動/コード変更後は再計算関数を呼ぶ（仕様固定）
- headcount は社員マスタ（employees / employee_assignments）の登録・変更時に自動更新する（UseCase or トリガー）
- 承認者は詰めて設定する（1, 2, 3の順。中抜け禁止）（2026-01-15追加）
- 組織版ごとに承認者を設定。新版作成時は前版からのコピー機能で運用負荷軽減（2026-01-15追加）


---

# 4. ディメンション（集計軸）と割当/配賦

## 4.1 dimensions（集計ディメンション）

### 仕様
- すべての分析軸を dimensions で定義し、値は dimension_values に統一する
- 組織ディメンション（ORGANIZATION）と分析ディメンション（ANALYSIS）を区分する
- 組織ディメンションは部門マスタ（departments）と紐付け可能

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|DIM-IR|PK|
|tenant_id|uuid|NO|T-ABC|RLS|
|dimension_code|varchar(50)|NO|"SEG_IR"|tenant内一意|
|dimension_name|varchar(200)|NO|"IRセグメント"||
|dimension_category|varchar(20)|NO|"ORGANIZATION"|'ORGANIZATION' / 'ANALYSIS'|
|dimension_type|varchar(30)|NO|"IR_SEGMENT"|予約値（将来enum）|
|org_purpose|varchar(20)|YES|"MTP"|組織DIMの用途: 'MTP' / 'GUIDELINE' / NULL（汎用）|
|is_hierarchical|boolean|NO|true||
|is_required|boolean|NO|true|運用上の必須（DB制約ではない）|
|scope_policy|varchar(20)|NO|"tenant"|値の基本運用方針|
|sort_order|int|NO|10||
|is_active|boolean|NO|true||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約
- UNIQUE(tenant_id, dimension_code)
- UNIQUE(tenant_id, id)
- CHECK(scope_policy IN ('tenant','company'))
- CHECK(dimension_category IN ('ORGANIZATION','ANALYSIS'))
- CHECK(org_purpose IS NULL OR org_purpose IN ('MTP','GUIDELINE'))

### 補足（scope_policy）
- 「この軸の値は原則tenant共通か/会社別か」を示す運用ガイド
- 真の制約は dimension_values.scope_type 側で担保

### 補足（dimension_category）
- **ORGANIZATION**: 組織ディメンション。部門マスタとの紐付け対象
  - 中計用（org_purpose='MTP'）
  - ガイドライン用（org_purpose='GUIDELINE'）
  - 汎用管理会計用（org_purpose=NULL、IR等含む、複数設定可能）
- **ANALYSIS**: 分析ディメンション。得意先グループ、製品カテゴリ等


---

## 4.2 dimension_values（ディメンション値：Group）

### 仕様
- 経営粒度のグループ（カテゴリ、セグメント）を保持する

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|DV-IR-DOM|PK|
|tenant_id|uuid|NO|T-ABC|RLS|
|dimension_id|uuid|NO|DIM-IR||
|scope_type|varchar(20)|NO|"tenant"|tenant/company|
|scope_company_id|uuid|YES|C-ABC|company時必須|
|value_code|varchar(50)|NO|"DOM"|tenant+dimension内一意|
|value_name|varchar(200)|NO|"国内事業"||
|value_name_short|varchar(100)|YES|"国内"||
|parent_id|uuid|YES|DV-IR-ROOT|同dimension内のみ|
|hierarchy_level|int|NO|2|キャッシュ|
|hierarchy_path|varchar(1000)|YES|"/ROOT/DOM"|キャッシュ|
|sort_order|int|NO|10||
|is_active|boolean|NO|true||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約（必須）
- UNIQUE(tenant_id, dimension_id, value_code)
- UNIQUE(tenant_id, dimension_id, id)
- CHECK(scope_type IN ('tenant','company'))
- CHECK(scope_type!='company' OR scope_company_id IS NOT NULL)
- FK(tenant_id, dimension_id) → dimensions(tenant_id, id)
- FK(tenant_id, scope_company_id) → companies(tenant_id, id)
- FK(tenant_id, dimension_id, parent_id) → dimension_values(tenant_id, dimension_id, id)

### 補足
- 大量マスタ（SKU・全得意先）は dimension_values に直接入れない（Groupのみ）


---

## 4.3 department_dimension_mappings（部門→ディメンション割当/配賦）

### 仕様
- 組織版の部門に対し、ディメンション値（Group）を割当する（100% or 分割比率）
- IR/管理会計等「正の組織とは異なる見方」を実現する中核

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|MAP-...|PK|
|tenant_id|uuid|NO|T-ABC|RLS|
|version_id|uuid|NO|OV-...|組織版|
|department_id|uuid|NO|D-...|版内部門|
|dimension_id|uuid|NO|DIM-IR||
|dimension_value_id|uuid|NO|DV-IR-DOM||
|allocation_ratio|numeric(5,2)|NO|70.00|0<x<=100|
|effective_date|date|NO|2025-04-01||
|expiry_date|date|YES|2025-10-01||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)
- CHECK(allocation_ratio > 0 AND allocation_ratio <= 100)
- FK(tenant_id, version_id, department_id) → departments(tenant_id, version_id, id)
- FK(tenant_id, dimension_id, dimension_value_id) → dimension_values(tenant_id, dimension_id, id)
- EXCLUDE（PostgreSQL推奨）：同一(version_id,department_id,dimension_value_id)で期間重複禁止

### 補足（UseCase）
- 同一(version_id,department_id,dimension_id,期間)で **合計100%** 必須
- companyスコープ値の場合、部門の会社と scope_company_id の整合をUseCaseで担保


---

## 4.4 dimension_members（ディメンション・メンバー：Leaf写し）

### 仕様
- 得意先コード／SKUなど「実績・予算・見込に登場する大量コード（Leaf）」を参照・検索・分類できるようにする写し（キャッシュ）
- 正本はERP等（外部）。OBEPMでは正本化しない
- v2は **IMPORT** 運用を標準（将来SYNC/REFERENCEへ拡張可能）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|DM-...|PK|
|tenant_id|uuid|NO|T-ABC|RLS|
|dimension_id|uuid|NO|DIM-CUST|dimensions(tenant_id,id)|
|member_key|varchar(100)|NO|"C0001" / "SKU-123"|外部コード|
|member_name|varchar(200)|YES|"◯◯商事"|表示用（任意）|
|member_name_short|varchar(100)|YES|"◯◯"|任意|
|member_attrs|jsonb|YES|{"pref":"大阪"}|最小属性のみ|
|source_type|varchar(20)|NO|"IMPORT"|IMPORT/SYNC/REFERENCE|
|source_ref|varchar(200)|YES|"ERP_CSV_2025_01"|取込元識別|
|is_active|boolean|NO|true|論理削除|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約（必須）
- UNIQUE(tenant_id, dimension_id, member_key)
- UNIQUE(tenant_id, dimension_id, id)（複合FK用）
- FK(tenant_id, dimension_id) → dimensions(tenant_id, id)
- CHECK(source_type IN ('IMPORT','SYNC','REFERENCE'))

### 補足
- IMPORT運用は Upsert（member_key単位で上書き）を基本
- member_attrs は「何でも箱」にしない（検索/分類に必要な最小限）


---

## 4.5 dimension_member_groups（Leaf→Group分類）

### 仕様
- Leaf（得意先コード/SKU等）を、経営で使うGroup（dimension_values）へ分類する翻訳テーブル
- v2は「期間」で管理（将来、分類版lens_versionを追加可能）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|DMG-...|PK|
|tenant_id|uuid|NO|T-ABC|RLS|
|dimension_id|uuid|NO|DIM-CUST|冗長（整合/検索）|
|member_id|uuid|NO|DM-...|dimension_members参照|
|dimension_value_id|uuid|NO|DV-CUST-KANSAI|dimension_values参照|
|effective_date|date|NO|2025-04-01|有効開始|
|expiry_date|date|YES|2025-10-01|NULL=無期限|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約（必須）
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)
- FK(tenant_id, dimension_id, member_id) → dimension_members(tenant_id, dimension_id, id)
- FK(tenant_id, dimension_id, dimension_value_id) → dimension_values(tenant_id, dimension_id, id)

### 推奨制約（できれば）
- EXCLUDE（PostgreSQL）：同一(tenant_id, dimension_id, member_id)で期間重複禁止
  - 目的：同一期間に複数Groupへ属して二重計上する事故を防止

### 補足
- 実績データにグループが付いてきても「source」として扱い、集計の正は本テーブルの分類で決める


---

## 4.6 department_dimension_links（部門→組織ディメンション紐付け）

> **追加日**: 2026-01-11

### 仕様
- 正の部門マスタ（departments）を組織ディメンション（dimension_values）へ紐付ける
- 中計・ガイドライン等の組織ディメンション単位のデータと、予算・実績の部門単位データを接続する
- 有効期間で管理（組織改編対応）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|DDL-...|PK|
|tenant_id|uuid|NO|T-ABC|RLS|
|company_id|uuid|NO|C-ABC|companies参照|
|dimension_id|uuid|NO|DIM-ORG-MTP|組織ディメンション|
|department_stable_id|varchar(50)|NO|DEPT-SALES1|departments.stable_id|
|dimension_value_id|uuid|NO|DV-DIV-A|紐付け先（A事業部等）|
|effective_date|date|NO|2025-04-01|有効開始|
|expiry_date|date|YES|NULL|有効終了（NULL=無期限）|
|notes|text|YES||備考|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約（必須）
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, dimension_id) → dimensions(tenant_id, id)
- FK(tenant_id, dimension_id, dimension_value_id) → dimension_values(tenant_id, dimension_id, id)
- UNIQUE(tenant_id, dimension_id, department_stable_id, effective_date)

### 推奨制約（できれば）
- EXCLUDE（PostgreSQL）：同一(tenant_id, dimension_id, department_stable_id)で期間重複禁止
  - 目的：同一期間に同じ組織ディメンションへ複数紐付けを防止

### 補足
- 組織ディメンション（dimension_category='ORGANIZATION'）への紐付け専用
- 1つの部門が複数の組織ディメンションに紐付く（例: 営業1課 → 中計用A事業部、IR用セグメント1）
- 予算データを組織ディメンション単位に集計する際に使用

### 使用例

```sql
-- 予算データを中計用事業部別に集計
SELECT
  ddl.dimension_value_id,  -- A事業部
  SUM(fa.amount)
FROM fact_amounts fa
JOIN department_dimension_links ddl
  ON fa.department_stable_id = ddl.department_stable_id
  AND ddl.dimension_id = 'DIM-ORG-MTP'  -- 中計用組織ディメンション
  AND fa.accounting_period_id BETWEEN ddl.effective_date AND COALESCE(ddl.expiry_date, '9999-12-31')
WHERE fa.scenario_type = 'BUDGET'
GROUP BY ddl.dimension_value_id;
```


---

## 4.7 projects（プロジェクトマスタ：独立）

### 仕様
- プロジェクト別の予算・実績・見込を管理するため、プロジェクトを独立した正本マスタとして保持する

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|PJ-...|PK|
|tenant_id|uuid|NO|T-ABC|RLS|
|company_id|uuid|NO|C-ABC|companies(tenant_id,id)|
|project_code|varchar(50)|NO|"PJ-2025-001"|会社内一意推奨|
|project_name|varchar(200)|NO|"基幹刷新PJ"||
|project_name_short|varchar(100)|YES|"基幹刷新"||
|project_type|varchar(30)|YES|"CAPEX"|任意|
|project_status|varchar(20)|NO|"ACTIVE"|PLANNED/ACTIVE/ON_HOLD/CLOSED|
|start_date|date|YES|2025-04-01||
|end_date|date|YES|2026-03-31||
|parent_project_id|uuid|YES|PJ-ROOT|任意|
|owner_department_stable_id|uuid|YES|S-SALES|責任部門（stable）|
|owner_employee_id|uuid|YES|E-...|責任者|
|external_ref|varchar(100)|YES|"SAP-PS-123"|外部キー|
|is_active|boolean|NO|true|論理削除|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約（必須）
- UNIQUE(tenant_id, company_id, project_code)
- FK(tenant_id, company_id) → companies(tenant_id, id)
- CHECK(project_status IN ('PLANNED','ACTIVE','ON_HOLD','CLOSED'))
- CHECK(end_date IS NULL OR start_date IS NULL OR end_date >= start_date)

### 補足
- 部門参照は version内IDではなく stable_id を推奨（組織改編耐性）


---

## 4.7 project_group_mappings（プロジェクト→ディメンション値：グルーピング）

### 仕様
- プロジェクトを dimensions / dimension_values へ接続し、カテゴリ等で集計できるようにする

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|PJM-...|PK|
|tenant_id|uuid|NO|T-ABC|RLS|
|company_id|uuid|NO|C-ABC|複合FK|
|project_id|uuid|NO|PJ-...|projects参照|
|dimension_id|uuid|NO|DIM-PROJECT|原則PROJECT軸（冗長だが整合に効く）|
|dimension_value_id|uuid|NO|DV-PROJ-INVEST|プロジェクトカテゴリ等|
|effective_date|date|NO|2025-04-01||
|expiry_date|date|YES|2026-04-01|NULL=無期限|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約（必須）
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, company_id, project_id) → projects(tenant_id, company_id, id)
- FK(tenant_id, dimension_id, dimension_value_id) → dimension_values(tenant_id, dimension_id, id)

### 推奨制約（できれば）
- EXCLUDE（PostgreSQL）：同一(tenant_id, company_id, project_id, dimension_id)で期間重複禁止

### 補足
- v2はPROJECT軸固定運用でOK（将来拡張余地は残す）


---

## 4.8 labor_cost_rates（単価マスタ：社員・外注統一）

### 仕様
- 労務費・外注費の予算算出のための「計画用単価」を管理
- **社員・外注を統一管理**: resource_type で区分
- 単価の改定を想定し、有効期間を持つ
- **科目別内訳対応**: 単価を科目別に分解して登録可能（給与・賞与・法定福利費・外注費等）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|LCR-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies参照|
|rate_code|varchar(50)|NO|SE_G2_STD|会社内一意推奨|
|resource_type|varchar(20)|NO|EMPLOYEE|EMPLOYEE/CONTRACTOR|
|vendor_name|varchar(100)|YES|○○システム|取引先名（外注の場合）|
|job_category|varchar(50)|NO|SE|職種（例：SE/営業/管理）|
|grade|varchar(50)|YES|G2|等級（任意）|
|employment_type|varchar(50)|YES|REGULAR|雇用区分（社員の場合）|
|rate_type|varchar(20)|NO|MONTHLY|MONTHLY/HOURLY/DAILY|
|total_rate|numeric|NO|800000|人月単価（内訳合計、自動計算）|
|effective_date|date|NO|2025-04-01|開始|
|expiry_date|date|YES|2026-03-31|NULL=無期限|
|is_active|boolean|NO|true|論理削除|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約（必須）
- UNIQUE(tenant_id, company_id, rate_code)
- FK(tenant_id, company_id) → companies(tenant_id, id)
- CHECK(resource_type IN ('EMPLOYEE','CONTRACTOR'))
- CHECK(rate_type IN ('MONTHLY','HOURLY','DAILY'))
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)

### 補足
- 実績給与・手当・社保等は対象外（計画上の標準単価のみ）
- 人数計画や工数計画（別データ）と掛け合わせて予算算出する想定
- total_rate は labor_cost_rate_items の合計として自動計算される
- vendor_name は resource_type='CONTRACTOR' の場合のみ使用
- employment_type は resource_type='EMPLOYEE' の場合のみ使用

---

## 4.9 labor_cost_rate_items（単価内訳：科目別）

### 仕様
- 単価の科目別内訳を管理（社員・外注共通）
- 1つの単価に対して複数の科目を登録可能
- 内訳の合計が labor_cost_rates.total_rate となる

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|LCRI-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|rate_id|uuid|NO|LCR-...|FK labor_cost_rates|
|subject_id|uuid|NO|SUBJ-...|FK subjects（科目マスタ）|
|amount|numeric|NO|600000|金額（円）|
|percentage|numeric(5,2)|YES|75.00|割合（自動計算）|
|display_order|int|NO|1|表示順|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約（必須）
- FK(tenant_id, rate_id) → labor_cost_rates(tenant_id, id)
- FK(tenant_id, subject_id) → subjects(tenant_id, id)
- UNIQUE(rate_id, subject_id) — 同一単価に同一科目は1回のみ
- CHECK(amount > 0)

### 補足
- percentage は amount / SUM(amount) で自動計算
- 科目は科目マスタ（subjects）から選択
- 社員の場合: 給与手当、賞与引当、法定福利費、福利厚生費など複数科目
- 外注の場合: 外注費の単一科目が一般的だが、複数科目も可能

---

## 4.10 resource_plans（人員計画ヘッダー：職種×等級一括管理）

### 仕様
- 部門ごとの人員計画（職種×等級での一括管理）
- 社員・外注の両方を管理可能
- 予算イベント・バージョンに紐付く
- 月別人数は resource_plan_months で管理

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|RP-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies参照|
|plan_event_id|uuid|NO|PE-...|FK plan_events|
|plan_version_id|uuid|NO|PV-...|FK plan_versions|
|source_department_stable_id|uuid|NO|S-DEV1|所属部門stable_id|
|resource_type|varchar(20)|NO|EMPLOYEE|EMPLOYEE/CONTRACTOR|
|job_category|varchar(50)|NO|SE|職種|
|grade|varchar(50)|YES|SENIOR|等級（任意）|
|rate_type|varchar(20)|NO|MONTHLY|MONTHLY/HOURLY/DAILY|
|rate_id|uuid|YES|LCR-...|FK labor_cost_rates|
|custom_rate|numeric|YES|800000|カスタム単価（rate_id未使用時）|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約（必須）
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, plan_event_id) → plan_events(tenant_id, id)
- FK(tenant_id, plan_version_id) → plan_versions(tenant_id, id)
- CHECK(resource_type IN ('EMPLOYEE','CONTRACTOR'))
- CHECK(rate_type IN ('MONTHLY','HOURLY','DAILY'))
- CHECK(rate_id IS NOT NULL OR custom_rate IS NOT NULL)

### 補足
- rate_id は labor_cost_rates を参照（社員・外注とも統一テーブル）
- rate_id で参照する単価の resource_type と一致させる運用
- 月別人数は resource_plan_months で管理
- 配賦先は resource_allocations で管理

---

## 4.11 resource_plan_months（月別人数）

### 仕様
- resource_plans の月別人数を管理
- 中途採用（10月から3人増）などに対応

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|RPM-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|resource_plan_id|uuid|NO|RP-...|FK resource_plans|
|period_month|int|NO|4|月（4〜3 or 1〜12）|
|headcount|numeric(10,2)|NO|10.50|人数（0.01単位）|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約（必須）
- FK(tenant_id, resource_plan_id) → resource_plans(tenant_id, id)
- UNIQUE(resource_plan_id, period_month)
- CHECK(period_month BETWEEN 1 AND 12)
- CHECK(headcount >= 0)

### 補足
- 12行（4月〜3月 or 1月〜12月）で1年分
- headcount=0 の月も登録可能（退職・契約終了など）

---

## 4.12 resource_allocations（人員配賦：部門間振替）

### 仕様
- resource_plans の配賦先・配賦率を管理
- 1つの人員計画を複数部門に振り分け可能

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|RA-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|resource_plan_id|uuid|NO|RP-...|FK resource_plans|
|target_department_stable_id|uuid|NO|S-SALES|配賦先部門stable_id|
|allocation_type|varchar(20)|NO|PERCENTAGE|PERCENTAGE/HEADCOUNT|
|percentage|numeric(5,2)|YES|40.00|配賦率（%）|
|headcount_amount|numeric(8,2)|YES|4.00|人月数（allocation_type=HEADCOUNT時）|
|effective_months|int[]|YES|{4,5,6,...}|適用月（NULL=全期間）|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約（必須）
- FK(tenant_id, resource_plan_id) → resource_plans(tenant_id, id)
- **UNIQUE(resource_plan_id, target_department_stable_id)** — 同一部門への重複配賦禁止
- CHECK(allocation_type IN ('PERCENTAGE','HEADCOUNT'))
- CHECK(
    (allocation_type = 'PERCENTAGE' AND percentage IS NOT NULL) OR
    (allocation_type = 'HEADCOUNT' AND headcount_amount IS NOT NULL)
  )

### 補足
- **同一部門への複数行配賦は禁止**（1部門1行にまとめる）
- PERCENTAGE の場合、同一 resource_plan_id の合計が100%になる運用（会社設定で ERROR/WARN 選択）
- HEADCOUNT の場合、合計が月別人数と整合する運用

---

## 4.13 individual_allocations（個人別配賦：兼務者・役員用）

### 仕様
- 役員・兼務者など個人単位で配賦を管理
- 職種×等級の一括管理ではなく、個人名での管理

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|IA-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies参照|
|plan_event_id|uuid|NO|PE-...|FK plan_events|
|plan_version_id|uuid|NO|PV-...|FK plan_versions|
|employee_stable_id|uuid|YES|E-...|FK employees（任意）|
|individual_name|varchar(100)|NO|田中部長|名前（employee未指定時は必須）|
|source_department_stable_id|uuid|NO|S-JIGYOBU|主幹部門stable_id|
|job_category|varchar(50)|NO|管理職|職種|
|grade|varchar(50)|YES|部長|等級|
|rate_type|varchar(20)|NO|MONTHLY|MONTHLY/HOURLY/DAILY|
|rate_id|uuid|YES|LCR-...|FK labor_cost_rates|
|custom_rate|numeric|YES|1200000|カスタム単価|
|target_department_stable_id|uuid|NO|S-DEV1|配賦先部門stable_id|
|allocation_type|varchar(20)|NO|PERCENTAGE|PERCENTAGE/HEADCOUNT|
|percentage|numeric(5,2)|YES|40.00|配賦率（%）|
|headcount_amount|numeric(8,2)|YES|4.80|人月数|
|effective_months|int[]|YES|{4,5,6,...}|適用月（NULL=全期間）|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約（必須）
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, plan_event_id) → plan_events(tenant_id, id)
- FK(tenant_id, plan_version_id) → plan_versions(tenant_id, id)
- CHECK(rate_type IN ('MONTHLY','HOURLY','DAILY'))
- CHECK(allocation_type IN ('PERCENTAGE','HEADCOUNT'))
- CHECK(rate_id IS NOT NULL OR custom_rate IS NOT NULL)

### 補足
- 同一個人が複数の配賦先を持つ場合、行を分けて登録
- employee_stable_id を指定すれば社員マスタと連携可能
- **配賦率の合計は100%必須**（全稼働時間を部門に配賦する運用）
- 予算イベント設定（plan_events.allocation_check_mode）に従い ERROR/WARN でチェック

---

# 5. 社員・所属・ログイン・ロール（完全版）

> 本章はアップロード済みの「OBEPM 人事・アカウント設計（最新版・完全版）」をV2へ統合したもの :contentReference[oaicite:2]{index=2}

## 5.1 employees（社員マスタ）

### 仕様
- 「社員という人」を表す不変に近い実体
- 異動・兼務・役職・権限は基本的に持たせない（履歴は assignment 側）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|E-...|PK|
|tenant_id|uuid|NO|T-...|RLS境界|
|company_id|uuid|NO|C-...|雇用元会社|
|employee_code|varchar(30)|NO|"A00123"|会社内一意推奨|
|employee_name|varchar(100)|NO|山田 太郎||
|employee_name_kana|varchar(100)|YES|ヤマダ|任意|
|email|varchar(255)|YES|taro@...|連絡用（ログインと分離可）|
|hire_date|date|YES|2020-04-01|入社日|
|leave_date|date|YES|2026-03-31|退職日|
|is_active|boolean|NO|true|論理無効|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES||監査|
|updated_by|uuid|YES||監査|

### 制約
- UNIQUE(tenant_id, company_id, employee_code)
- FK(tenant_id, company_id) → companies(tenant_id, id)

### 補足
- 異動・兼務・役職は employee_assignments 側で管理する


---

## 5.2 employee_assignments（社員所属履歴：主務/兼務・事前登録）

### 仕様
- いつ・どの部門に・どう所属したか（主務/兼務、事前登録、按分）を管理
- 部門は department_id ではなく **department_stable_id** で接続（改編耐性）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|EA-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|employee_id|uuid|NO|E-...|FK employees|
|company_id|uuid|NO|C-...|所属先会社（出向/兼務対応）|
|department_stable_id|uuid|NO|S-SALES|部門stable_id|
|assignment_type|varchar(20)|NO|"primary"|primary/secondary|
|allocation_ratio|numeric(5,2)|YES|70.00|任意（合計100運用も可）|
|title|varchar(100)|YES|"課長"|所属単位の役割|
|effective_date|date|NO|2025-04-01|開始|
|expiry_date|date|YES|2025-10-01|終了（NULL=無期限）|
|is_active|boolean|NO|true|論理無効|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES||監査|
|updated_by|uuid|YES||監査|

### 制約
- CHECK(assignment_type IN ('primary','secondary'))
- CHECK(expiry_date IS NULL OR expiry_date > effective_date)
- FK(tenant_id, employee_id) → employees(tenant_id, id)

### 補足（UseCase）
- department_stable_id の存在チェック（stable_idは departments でテナント内一意）
- 主務（primary）の期間重複禁止は要件に応じてEXCLUDE推奨


---

## 5.3 login_accounts（ログイン・認証）

### 仕様
- ログイン・認証・セキュリティ専用
- employee_code と紐づけたい要件のため冗長保持するが、内部結合は employee_id を使う

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|A-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|employee_id|uuid|NO|E-...|内部結合用安定キー|
|employee_code|varchar(30)|NO|"A00123"|冗長保持（要件）|
|login_id|varchar(100)|NO|"a00123"|ログインID|
|email_login|varchar(255)|YES|taro@...|メールログイン時|
|password_hash|text|YES|...|SSOならNULL可|
|auth_provider|varchar(30)|NO|"local"|local/google/azuread等|
|status|varchar(20)|NO|"active"|active/locked/disabled|
|last_login_at|timestamptz|YES|||
|failed_login_count|int|NO|0||
|locked_until|timestamptz|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, login_id)
- UNIQUE(tenant_id, employee_id)（1社員1アカウント運用なら）
- CHECK(status IN ('active','locked','disabled'))
- CHECK(auth_provider IN ('local','google','azuread','saml','oidc'))

### 補足
- accounts という名称は科目と衝突するため login_accounts に改名（確定）


---

## 5.4 roles / employee_roles（権限：会社単位）

### 仕様
- ロールは会社単位で定義し、社員にロールを割り当てる
- 1社員1ロールの制約（UIで重複割当を防止）
- 画面/機能/データ行レベル権限は role_menu_permissions / role_menu_department_assignments で管理

### roles（ロール定義）

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|R-ADMIN|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|会社単位でロール管理（2026-01-13変更）|
|role_code|varchar(50)|NO|"ADMIN"|company内一意|
|role_name|varchar(200)|NO|"管理者"||
|role_description|text|YES|"システム全体の管理権限"|ロールの説明（2026-01-13追加）|
|is_active|boolean|NO|true||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

**制約**
- UNIQUE(tenant_id, company_id, role_code)
- FK(tenant_id, company_id) → companies(tenant_id, id)

### employee_roles（社員×ロール：2026-01-13変更 login_account_rolesから）

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|ER-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|会社|
|employee_id|uuid|NO|E-...|employees参照|
|role_id|uuid|NO|R-...|roles参照|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

**制約**
- UNIQUE(tenant_id, employee_id)  ← 1社員1ロール制約
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, company_id, employee_id) → employees(tenant_id, company_id, id)
- FK(tenant_id, company_id, role_id) → roles(tenant_id, company_id, id)

**補足**
- login_account_roles は廃止し、employee_roles に置き換え（ログインアカウントは将来対応）
- 1社員に対して複数ロールを割り当てることは不可（UIで制御）


---

## 5.5 menus（機能マスタ：2026-01-13追加）

### 仕様
- 会社単位でメニュー（機能）を定義する
- is_consolidation フラグで連結専用機能を識別
- 連結メニューは tenants.primary_company_id に所属する社員のみアクセス可能

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|M-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|会社単位でメニュー管理|
|menu_code|varchar(50)|NO|"BUDGET_INPUT"|company内一意|
|menu_name|varchar(200)|NO|"予算入力"||
|menu_category|varchar(50)|YES|"予算管理"|カテゴリ（任意、グルーピング用）|
|menu_type|varchar(50)|YES|"transaction"|種別（任意: master/transaction/report/admin）|
|parent_menu_id|uuid|YES|M-PARENT|親メニュー（階層用）|
|url_path|varchar(500)|YES|"/budget/input"|画面パス|
|icon_name|varchar(100)|YES|"file-edit"|アイコン名|
|sort_order|int|NO|10|表示順（デフォルト0）|
|is_consolidation|boolean|NO|false|連結専用機能フラグ|
|is_active|boolean|NO|true||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

**制約**
- UNIQUE(tenant_id, company_id, menu_code)
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(parent_menu_id) → menus(id)

**補足**
- is_consolidation=true のメニューは、tenants.primary_company_id と一致する company_id を持つ社員のみがアクセス可能（BFF層で制御）
- menu_category, menu_type は任意項目でフィルタリング・グルーピング用途


---

## 5.6 role_menu_permissions（ロール×機能 権限設定：2026-01-13追加）

### 仕様
- ロールごとに各機能へのアクセスレベルとデータスコープを設定
- アクセスレベル: A（フル権限）/ B（参照のみ）/ C（アクセス不可）
- データスコープ: ALL（全社）/ HIERARCHY（階層配下）/ ASSIGNED（指定部門）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|RMP-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|会社|
|role_id|uuid|NO|R-...|roles参照|
|menu_id|uuid|NO|M-...|menus参照|
|access_level|char(1)|NO|"A"|A/B/C（CHECK制約）|
|data_scope|varchar(20)|NO|"ALL"|ALL/HIERARCHY/ASSIGNED（CHECK制約）|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

**制約**
- UNIQUE(tenant_id, role_id, menu_id)
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, company_id, role_id) → roles(tenant_id, company_id, id)
- FK(tenant_id, company_id, menu_id) → menus(tenant_id, company_id, id)
- CHECK(access_level IN ('A', 'B', 'C'))
- CHECK(data_scope IN ('ALL', 'HIERARCHY', 'ASSIGNED'))

**補足**
- access_level: A=参照・編集・削除可能、B=参照のみ、C=メニューに表示されない
- data_scope: ALL=会社内全データ、HIERARCHY=所属部門と配下、ASSIGNED=role_menu_department_assignments で指定した部門のみ


---

## 5.7 role_menu_department_assignments（ASSIGNED時の部門指定：2026-01-13追加）

### 仕様
- data_scope=ASSIGNED の場合にアクセス可能な部門を指定
- include_children で配下部門を含めるかを設定可能

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|RMDA-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|会社|
|role_menu_permission_id|uuid|NO|RMP-...|role_menu_permissions参照|
|department_stable_id|varchar(50)|NO|"DEPT-SALES"|departments.stable_id（版非依存）|
|include_children|boolean|NO|false|配下部門を含むか|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

**制約**
- UNIQUE(tenant_id, role_menu_permission_id, department_stable_id)
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(role_menu_permission_id) → role_menu_permissions(id)

**補足**
- department_stable_id を使用（版を跨いで追跡可能）
- include_children=true の場合、指定部門とその配下全ての部門にアクセス可能
- include_children=false の場合、指定部門のみ
- 複数行で複数部門を指定可能


---

# 6. 科目（財務＋非財務）・財務属性・集計（rollup）

## 6.1 subjects（会社科目：通常/集計、財務/非財務統一）

### 仕様
- 財務科目と非財務KPIを同一の「数値項目」として統一管理する
- 集計科目（AGGREGATE）は rollup/metrics の対象（posting禁止を推奨）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|SUB-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|会社COA|
|subject_code|varchar(50)|NO|"4010" / "SALES"|会社内一意|
|subject_name|varchar(200)|NO|"売上高"||
|subject_name_short|varchar(100)|YES|"売上"||
|subject_class|varchar(20)|NO|"BASE"|BASE/AGGREGATE|
|subject_type|varchar(20)|NO|"FIN"|FIN/KPI|
|posting_allowed|boolean|NO|true|AGGREGATEは原則false|
|measure_kind|varchar(20)|NO|"AMOUNT"|AMOUNT/COUNT/WEIGHT…|
|unit|varchar(30)|YES|"JPY"|任意|
|scale|int|NO|0|原単位保持（表示はView/レポート）|
|aggregation_method|varchar(20)|NO|"SUM"|SUM/EOP/AVG/MAX/MIN|
|direction|varchar(30)|YES|"lower_is_better"|任意（KPI向け）|
|allow_negative|boolean|NO|false||
|is_labor_cost_applicable|boolean|NO|false|労務費単価マスタで使用可能か|
|is_active|boolean|NO|true||
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES|||
|updated_by|uuid|YES|||

### 制約
- UNIQUE(tenant_id, company_id, subject_code)
- CHECK(subject_class IN ('BASE','AGGREGATE'))
- CHECK(subject_type IN ('FIN','KPI'))
- CHECK(aggregation_method IN ('SUM','EOP','AVG','MAX','MIN'))
- FK(tenant_id, company_id) → companies(tenant_id, id)

### 補足（UseCase）
- AGGREGATE ⇒ posting_allowed=false を強制（運用事故防止）


---

## 6.2 subject_fin_attrs（財務属性：FINのみ）

### 仕様
- 財務科目（FIN）にPL/BS属性等を付与する（集計主役はrollup/metrics）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|SFA-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...| |
|subject_id|uuid|NO|SUB-SALES|subjects参照|
|fin_stmt_class|varchar(10)|NO|PL/BS||
|gl_element|varchar(20)|NO|REVENUE/EXPENSE/ASSET/LIAB/EQUITY||
|normal_balance|varchar(10)|NO|debit/credit|表示/属性|
|is_contra|boolean|NO|false|控除科目|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, company_id, subject_id)
- CHECK(fin_stmt_class IN ('PL','BS'))
- CHECK(normal_balance IN ('debit','credit'))
- FK(tenant_id, company_id, subject_id) → subjects(tenant_id, company_id, id)

### 補足
- 貸倒引当金や減価償却累計額は is_contra=true 推奨（説明性向上）


---

## 6.3 subject_rollup_items（集計定義：係数）

### 仕様
- 集計科目（AGGREGATE）を、構成科目×係数で定義する（符号は係数で決める）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|RUP-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...| |
|parent_subject_id|uuid|NO|SUB-GP|集計先（親）|
|component_subject_id|uuid|NO|SUB-COGS|構成科目|
|coefficient|numeric(9,4)|NO|-1.0000|+1/-1等|
|valid_from|date|YES|2025-04-01||
|valid_to|date|YES|||
|sort_order|int|NO|10||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- CHECK(valid_to IS NULL OR valid_to > valid_from)
- FK(tenant_id, company_id, parent_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, company_id, component_subject_id) → subjects(tenant_id, company_id, id)

### 補足（UseCase）
- parent_subject は AGGREGATE を強制
- 循環禁止（必須）


---

## 6.4 subject_budget_settings（科目予算設定マスタ）

> **追加日**: 2026-01-09

### 仕様
- 科目×部門単位で、予算作成時のディメンション使用有無を設定する
- 1科目につき最大1ディメンションまで設定可能
- 予算イベント作成時に scenario_subject_settings にスナップショットとしてコピーされる

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|SBS-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|会社|
|subject_id|uuid|NO|SUB-...|科目|
|entity_id|uuid|NO|E-...|部門（department_stable_id）|
|use_dimension|boolean|NO|true|ディメンション使用フラグ|
|dimension_id|uuid|YES|DIM-...|使用するディメンション（1つまで）|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, company_id, subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, dimension_id) → dimensions(tenant_id, id)
- UNIQUE(tenant_id, company_id, subject_id, entity_id)
- CHECK(use_dimension = false OR dimension_id IS NOT NULL)

### 補足
- use_dimension = true の場合、dimension_id は必須
- use_dimension = false の場合、dimension_id は NULL
- 予算入力画面では、この設定に従って科目ごとにディメンション展開を表示


---

## 6.5 scenario_subject_settings（予算イベント別科目設定スナップショット）

> **追加日**: 2026-01-09

### 仕様
- 予算イベント作成時に subject_budget_settings からコピーされるスナップショット
- 予算イベントのバージョンが変わっても、この構成は固定される
- マスタ変更は既存予算イベントに影響しない

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|SSS-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|会社|
|scenario_id|uuid|NO|PE-...|予算イベント（plan_events参照）|
|subject_id|uuid|NO|SUB-...|科目|
|entity_id|uuid|NO|E-...|部門|
|use_dimension|boolean|NO|true|ディメンション使用フラグ|
|dimension_id|uuid|YES|DIM-...|使用するディメンション|
|copied_at|timestamptz|NO||コピー日時|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, company_id, scenario_id) → plan_events(tenant_id, company_id, id)
- FK(tenant_id, company_id, subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, dimension_id) → dimensions(tenant_id, id)
- UNIQUE(tenant_id, company_id, scenario_id, subject_id, entity_id)

### 補足
- 予算イベント作成時のビジネスロジックで subject_budget_settings から一括コピーする
- このテーブルは読み取り専用として運用（直接編集しない）
- 予算入力時はこのテーブルを参照して、科目のディメンション展開を決定


---

# 7. レポートレイアウト（個社）

## 7.1 report_layouts（レイアウトヘッダ）

### 仕様
- PL/BS/KPIの表示レイアウト（ヘッダ）を管理する
- 財務レイアウト（PL/BS）とKPIレイアウトを区別する

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|L-PL-STD|PK|
|tenant_id|uuid|NO|T-...|RLS|
|layout_type|varchar(10)|NO|PL/BS/KPI|財務レイアウト（PL/BS）またはKPIレイアウト|
|layout_code|varchar(50)|NO|PL_STD|tenant内一意|
|layout_name|varchar(200)|NO|管理PL（標準）||
|company_id|uuid|YES|C-...|会社別にしたい場合|
|is_active|boolean|NO|true||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, layout_type, layout_code)
- CHECK(layout_type IN ('PL', 'BS', 'KPI'))

### 補足
- company_id を持たせることで「会社別標準レイアウト」を許容
- layout_type='PL' または 'BS' の場合: 財務科目（subject_type='FIN' かつ subject_fin_attrs が存在）のみを対象
- layout_type='KPI' の場合: KPI科目（subject_type='KPI'）のみを対象


---

## 7.2 report_layout_lines（レイアウト行）

### 仕様
- レイアウトの各行（見出し／科目行／注記等）を管理する

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|LL-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|layout_id|uuid|NO|L-PL-STD|report_layouts参照|
|line_no|int|NO|10|表示順|
|line_type|varchar(20)|NO|account|header/account/note/blank|
|display_name|varchar(200)|YES|売上高|見出し/注記にも使用|
|subject_id|uuid|YES|SUB-SALES|account行のみ|
|indent_level|int|NO|0||
|sign_display_policy|varchar(20)|YES|auto|auto/force_plus/force_minus|
|is_bold|boolean|NO|false||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- CHECK(line_type IN ('header','account','note','blank'))
- FK(tenant_id, layout_id) → report_layouts(tenant_id, id)

### 補足（UseCase）
- subject_id は account 行のみ必須


---

## 7.3 indicator_report_layouts（財務指標レポートレイアウトヘッダ）

### 仕様
- 財務指標分析レポートの表示レイアウトを管理する
- 財務科目・非財務KPI・指標（metrics）を同一レイアウト内に混在可能

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|IRL-STD|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|YES|C-...|会社別にしたい場合|
|layout_code|varchar(50)|NO|IND_STD|tenant内一意|
|layout_name|varchar(200)|NO|財務指標レポート（標準）||
|header_text|text|YES|主要KPIの定型レポート||
|is_active|boolean|NO|true||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, layout_code)
- FK(tenant_id, company_id) → companies(tenant_id, id)

### 補足
- company_id を持たせることで「会社別レイアウト」を許容
- header_text は画面上部の説明文（任意）


---

## 7.4 indicator_report_layout_lines（財務指標レポートレイアウト行）

### 仕様
- レイアウトの各行（見出し／指標行／区切り／注記等）を管理する
- 指標行は「財務科目 / 非財務KPI / 指標（metrics）」のいずれかに紐付く

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|IRL-L-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|layout_id|uuid|NO|IRL-STD|indicator_report_layouts参照|
|line_no|int|NO|10|表示順|
|line_type|varchar(20)|NO|item|header/item/divider/note/blank|
|display_name|varchar(200)|YES|売上高|見出し/注記にも使用|
|ref_subject_id|uuid|YES|SUB-SALES|item行のみ|
|ref_kpi_definition_id|uuid|YES|KPI-CO2|item行のみ|
|ref_metric_id|uuid|YES|M-EBITDA|item行のみ|
|indent_level|int|NO|0||
|sign_display_policy|varchar(20)|YES|auto|auto/force_plus/force_minus|
|is_bold|boolean|NO|false||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- CHECK(line_type IN ('header','item','divider','note','blank'))
- FK(tenant_id, layout_id) → indicator_report_layouts(tenant_id, id)

### 補足（UseCase）
- line_type='item' の場合、ref_subject_id / ref_kpi_definition_id / ref_metric_id のいずれか1つのみ必須
- line_type が item 以外の場合、参照IDは全てNULL（表示専用行）


---

# 8. 財務指標・指標計算（metrics）

## 8.1 metrics（指標定義）

### 仕様
- EBITDA等の例外指標は rollup ではなく metrics（式）として扱えるようにする
- 指標は会社別に管理する（company_id必須）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|M-EBITDA|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies(tenant_id,id) 複合FK|
|metric_code|varchar(50)|NO|EBITDA|会社内一意|
|metric_name|varchar(200)|NO|EBITDA||
|metric_type|varchar(20)|NO|FIN_METRIC|FIN_METRIC/KPI_METRIC|
|result_measure_kind|varchar(20)|NO|AMOUNT||
|unit|varchar(30)|YES|JPY||
|scale|int|NO|0||
|formula_expr|text|NO|SUB(\"OP\") + SUB(\"DA\")|式|
|description|text|YES|||
|is_active|boolean|NO|true||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES||監査|
|updated_by|uuid|YES||監査|

### 制約
- UNIQUE(tenant_id, company_id, metric_code)
- CHECK(metric_type IN ('FIN_METRIC','KPI_METRIC'))
- FK(tenant_id, company_id) → companies(tenant_id, id)

### 補足
- 指標はPL行とは別概念。必要ならレイアウト側で参照できるよう拡張可能


---

# 9. 連結COA（グループ科目）とマッピング

## 9.0 連結COA設計方針

### 運用モデル
- **テナント単位**で連結勘定科目（グループCOA）を管理
- **親会社のみ**が連結勘定科目を編集可能（子会社は参照のみ）
- **各個社**が自社の会社科目→連結勘定科目へのマッピングを設定
- 会社階層は**1階層**（親:子 = 1:N）を前提

### 権限モデル
| 操作 | 親会社 | 子会社 |
|------|--------|--------|
| 連結勘定科目マスタ CRUD | ✅ | ❌（参照のみ） |
| 連結勘定科目 rollup 編集 | ✅ | ❌（参照のみ） |
| 自社マッピング設定 | ✅ | ✅ |
| 他社マッピング参照 | ❌ | ❌ |

### 親会社の判定
- `companies.parent_company_id IS NULL` → 親会社
- `companies.parent_company_id IS NOT NULL` → 子会社

---

## 9.1 group_subjects（連結科目：グループCOA）

### 仕様
- 連結で統一表示するグループ科目を定義する（会社COAとは分離）
- **テナント単位**で管理（company_id を持たない）
- 親会社でログイン時のみ編集可能、子会社は参照のみ

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|GS-SALES|PK|
|tenant_id|uuid|NO|T-...|RLS|
|group_subject_code|varchar(50)|NO|SALES|tenant内一意|
|group_subject_name|varchar(200)|NO|売上高||
|group_subject_name_short|varchar(100)|YES|売上||
|subject_class|varchar(20)|NO|BASE/AGGREGATE|BASE=通常、AGGREGATE=集計|
|subject_type|varchar(20)|NO|FIN/KPI|FIN=財務、KPI=非財務|
|posting_allowed|boolean|NO|true|AGGREGATEは強制false|
|measure_kind|varchar(20)|NO|AMOUNT|AMOUNT/COUNT/RATIO等|
|unit|varchar(30)|YES|JPY|任意|
|scale|int|NO|0|原単位保持|
|aggregation_method|varchar(20)|NO|SUM|SUM/EOP/AVG/MAX/MIN|
|fin_stmt_class|varchar(10)|YES|PL/BS|FIN科目のみ|
|gl_element|varchar(20)|YES|REVENUE/…|FIN科目のみ|
|normal_balance|varchar(10)|YES|credit|FIN科目のみ|
|is_contra|boolean|NO|false|控除科目フラグ|
|is_active|boolean|NO|true|論理削除|
|notes|text|YES||備考|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES||監査|
|updated_by|uuid|YES||監査|

### 制約
- UNIQUE(tenant_id, group_subject_code)
- CHECK(subject_class IN ('BASE','AGGREGATE'))
- CHECK(subject_type IN ('FIN','KPI'))
- CHECK(aggregation_method IN ('SUM','EOP','AVG','MAX','MIN'))
- CHECK(fin_stmt_class IS NULL OR fin_stmt_class IN ('PL','BS'))
- CHECK(normal_balance IS NULL OR normal_balance IN ('debit','credit'))

### 補足
- グループCOAは連結用の"見せ方"として扱い、Factは会社COAを保持
- AGGREGATE科目は posting_allowed = false を強制（UseCase）
- 親会社判定はログイン時の company_id から companies.parent_company_id で判断


---

## 9.2 group_subject_mappings（会社科目→連結科目）

### 仕様
- 会社COA科目をグループCOAへマッピングする
- **1会社科目 = 1連結勘定科目**（シンプルな1:1マッピング）
- 各個社が自社分のマッピングを設定
- 係数は原則+1、控除科目は-1

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|GSM-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-A|会社|
|company_subject_id|uuid|NO|SUB-A-4010|subjects参照|
|group_subject_id|uuid|NO|GS-SALES|group_subjects参照|
|coefficient|numeric(9,4)|NO|1.0000|原則+1、控除は-1|
|mapping_note|text|YES||マッピング理由等|
|is_active|boolean|NO|true|論理削除|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES||監査|
|updated_by|uuid|YES||監査|

### 制約
- **UNIQUE(tenant_id, company_id, company_subject_id)**（1会社科目=1連結科目）
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, company_id, company_subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, group_subject_id) → group_subjects(tenant_id, id)
- CHECK(coefficient IN (1.0000, -1.0000))（Phase 1: +1/-1のみ）

### 補足
- v2は会社COAをFactに持つため、このマッピングは必須（集計レイヤで使用）
- Phase 1 では期間管理（valid_from/valid_to）は使用しない
- 按分マッピング（coefficient=0.5等）は将来拡張で対応


---

## 9.3 group_subject_rollup_items（連結集計定義）

### 仕様
- 連結PL/BSの集計科目（売上総利益、営業利益等）を定義
- subjects の subject_rollup_items と同じ構造
- 親会社でログイン時のみ編集可能

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|GRUP-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|parent_group_subject_id|uuid|NO|GS-GP|親（AGGREGATE）|
|component_group_subject_id|uuid|NO|GS-COGS|子|
|coefficient|numeric(9,4)|NO|-1.0000|+1/-1等|
|sort_order|int|NO|10|表示順|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, parent_group_subject_id, component_group_subject_id)
- FK(tenant_id, parent_group_subject_id) → group_subjects(tenant_id, id)
- FK(tenant_id, component_group_subject_id) → group_subjects(tenant_id, id)

### 補足
- 循環禁止（UseCase必須）
- parent_group_subject は AGGREGATE を強制（UseCase）
- Phase 1 では期間管理（valid_from/valid_to）は使用しない


---

# 10. 重要な整合チェック（V2まとめ）

### 10.1 tenant_idの徹底
- 全テーブルに tenant_id
- 複合FKで同一tenantをDB側で強制できる形に整理

### 10.2 stable_idの使い分け
- 部門stable_id：版非依存参照（社員所属、前年比較、Fact保持）
- department_id：UI入力や版内参照に使用

### 10.3 符号/貸借
- normal_balance は属性（表示・会計属性）
- 集計は rollup coefficient / metrics formula が主役

### 10.4 ディメンション運用
- GroupはOBEPMの正（dimension_values）
- Leafは写し（dimension_members）＋分類（dimension_member_groups）
- FactリンクはGroupのみ（確定）
- IRセグメントは固定列（任意・NULL可：確定）

### 10.5 連結COA
- Factは会社COA
- 連結は group_subject_mappings で変換

---

# 11. 計画イベント／バージョン（予算・見込・実績）

## 11.1 plan_events（計画イベント）

### 仕様
- 年度内の枠（当初予算／修正予算／月次見込／実績など）を定義する
- purpose_type で全社報告用（CORPORATE）と事業部ローカル用（DIVISIONAL）を区分する

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|PE-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies参照|
|event_code|varchar(50)|NO|FY2026_BUDGET_INIT|会社内一意|
|event_name|varchar(200)|NO|FY2026 当初予算||
|scenario_type|varchar(20)|NO|BUDGET|BUDGET/FORECAST/ACTUAL|
|purpose_type|varchar(20)|NO|CORPORATE|CORPORATE/DIVISIONAL（※2026-01-15追加）|
|fiscal_year|int|NO|2026|会計年度|
|is_active|boolean|NO|true||
|allocation_check_mode|varchar(20)|NO|ERROR|人員配賦100%チェック: ERROR/WARN|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, company_id, event_code)
- FK(tenant_id, company_id) → companies(tenant_id, id)
- CHECK(scenario_type IN ('BUDGET','FORECAST','ACTUAL'))
- CHECK(purpose_type IN ('CORPORATE','DIVISIONAL'))
- CHECK(allocation_check_mode IN ('ERROR','WARN'))

### 補足
- 予算ガイドラインは後回し（別管理を想定）
- allocation_check_mode は人員配賦率100%チェックの挙動: ERROR=保存不可、WARN=警告のみ（予算イベントごとに設定可能）
- purpose_type: CORPORATE=全社報告用（承認対象）、DIVISIONAL=事業部ローカル用（承認不要）（2026-01-15追加）


---

## 11.2 plan_versions（計画バージョン）

### 仕様
- plan_event 内の試行回数・確定版を管理する（第1回、調整、第3回、FIXEDなど）
- FIXEDは更新不可（年度予算fix）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|PV-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...| |
|plan_event_id|uuid|NO|PE-...|plan_events参照|
|version_no|int|NO|1|イベント内連番|
|version_code|varchar(50)|NO|V1 / FIXED|イベント内一意推奨|
|version_name|varchar(200)|NO|第1回予算||
|status|varchar(20)|NO|DRAFT|DRAFT/SUBMITTED/APPROVED/FIXED|
|fixed_at|timestamptz|YES||FIXED時|
|is_active|boolean|NO|true||
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, company_id, plan_event_id, version_no)
- UNIQUE(tenant_id, company_id, plan_event_id, version_code)
- FK(tenant_id, company_id, plan_event_id) → plan_events(tenant_id, company_id, id)
- CHECK(status IN ('DRAFT','SUBMITTED','APPROVED','FIXED'))

### 補足
- FIXEDは更新不可（UseCaseまたはDBトリガで制御）


---

# 12. 予算・見込・実績ファクト（確定版）

## 12.1 fact_amounts（数値ファクト：集約型Upsert）

### 仕様（確定：2026-01-09 再改訂）
- 月次粒度。会社×期間×科目×部門（stable）×プロジェクト（任意）を基本
- 組織改編耐性：org_version_id（当時版）＋department_stable_id（追跡）
- 科目：会社COA（subjects）
- 数値：原単位保持
- 区別：scenario_type（BUDGET/FORECAST/ACTUAL）
- 版：plan_event_id × plan_version_id
- 入力/調整/配賦：source_type（INPUT/ADJUST/ALLOC/PROJECT_ROLLUP）
- **プロジェクトは固定列**（project_id、nullable）：PJ別予算・実績に対応
- **その他ディメンションは fact_dimension_links で縦持ち**
- 同一キーは1行（集約型）。更新はUpsertで上書き（確定）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|FA-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies参照|
|accounting_period_id|uuid|NO|AP-...|accounting_periods（月次）|
|scenario_type|varchar(20)|NO|BUDGET|BUDGET/FORECAST/ACTUAL|
|plan_event_id|uuid|NO|PE-...|plan_events参照（scenario_type一致前提）|
|plan_version_id|uuid|NO|PV-...|plan_versions参照|
|source_type|varchar(20)|NO|INPUT|INPUT/ADJUST/ALLOC/PROJECT_ROLLUP|
|data_origin|varchar(30)|YES|ERP_IMPORT|ERP_IMPORT/MANUAL/SYSTEM|
|subject_id|uuid|NO|SUB-...|会社COA|
|org_version_id|uuid|NO|OV-...|当時組織版|
|department_stable_id|uuid|NO|S-...|stable|
|project_id|uuid|YES|PJ-...|プロジェクト（NULLはPJ紐付けなし）|
|amount|numeric|NO|123456.78|原単位|
|currency_code|char(3)|YES|JPY|必要時のみ|
|uom|varchar(20)|YES|JPY/COUNT|必要時のみ|
|trace_id|uuid|YES|TR-...|取込/配賦/調整の追跡|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約（必須）
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, company_id, accounting_period_id) → accounting_periods(tenant_id, company_id, id)
- FK(tenant_id, company_id, plan_event_id) → plan_events(tenant_id, company_id, id)
- FK(tenant_id, company_id, plan_version_id) → plan_versions(tenant_id, company_id, id)
- FK(tenant_id, company_id, subject_id) → subjects(tenant_id, company_id, id)
- FK(tenant_id, company_id, org_version_id) → organization_versions(tenant_id, company_id, id)
- FK(tenant_id, company_id, project_id) → projects(tenant_id, company_id, id)
- CHECK(scenario_type IN ('BUDGET','FORECAST','ACTUAL'))
- CHECK(source_type IN ('INPUT','ADJUST','ALLOC','PROJECT_ROLLUP'))

### 一意制約（必須：集約型）
- UNIQUE(
  tenant_id, company_id,
  accounting_period_id,
  scenario_type, plan_version_id,
  source_type,
  subject_id,
  org_version_id, department_stable_id,
  project_id
)
※ project_id が NULL の場合も一意制約に含まれる（NULLS NOT DISTINCT 推奨）

### 補足
- 年度着地（EAC）は「経過月ACTUAL＋将来月FORECAST」をView/集計で合成
- 配賦前/後、調整前/後も source_type とViewで切替（単一Fact方針）
- 主要軸で先に絞り込み、必要時のみリンクJOINする（性能設計の前提）
- fact_amounts.scenario_type は plan_events.scenario_type と必ず一致する（不一致は登録不可：UseCase制約）
- data_origin の語彙：ERP_IMPORT（基幹／会計システムからの実績取込）、MANUAL（手入力による調整）、SYSTEM（計算生成・将来拡張）
- source_type の語彙：INPUT（直接入力・取込）、ADJUST（調整）、ALLOC（配賦）、PROJECT_ROLLUP（PJ集計からのコピー）
- **project_id について**：
  - PJ別予算・実績の場合: project_id にPJを指定
  - PJ紐付けなしの場合: project_id = NULL
  - 同じ科目・部門でもPJ別とPJなしのデータが混在可能
- **変更履歴（2026-01-09 再改訂）**: project_id を固定列として復活。PJ予算・実績を統一的に管理するため


---

## 12.2 fact_dimension_links（可変ディメンション付与：Groupのみ）

### 仕様（確定）
- 可変の分析軸（得意先グループ、商品グループ、担当者等）を Fact に付与する
- 付与するのは **dimension_values（Group）のみ**
- v2は「1ファクト×1ディメンション＝1値」（多値は将来拡張）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|FDL-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...| |
|fact_amount_id|uuid|NO|FA-...|fact_amounts参照|
|dimension_id|uuid|NO|DIM-CUST|dimensions参照|
|dimension_value_id|uuid|NO|DV-CUST-...|dimension_values参照（Group）|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- FK(tenant_id, company_id, fact_amount_id) → fact_amounts(tenant_id, company_id, id)
- FK(tenant_id, dimension_id) → dimensions(tenant_id, id)
- FK(tenant_id, dimension_id, dimension_value_id) → dimension_values(tenant_id, dimension_id, id)
- UNIQUE(tenant_id, company_id, fact_amount_id, dimension_id)

### 補足
- Leaf（得意先コード等）を直接リンクしないことでデータ爆発を防止
- Leaf→Groupは dimension_member_groups で吸収して集計する


---

## 12.3 budget_import_staging（予算取込ステージング）

> **追加日**: 2026-01-09

### 仕様
- 予算データ取込時の一時領域（パフォーマンス考慮で fact_amounts とは分離）
- CSVインポート → ステージング → バリデーション → fact_amounts へ反映
- バッチ単位で管理（import_batch_id）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|BIS-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies参照|
|import_batch_id|uuid|NO|IB-...|取込バッチID|
|row_no|int|NO|1|元ファイルの行番号|
|accounting_period_code|varchar(32)|NO|"FY2026-P01"|期間コード（文字列）|
|subject_code|varchar(50)|NO|"4010"|科目コード（文字列）|
|department_code|varchar(50)|NO|"SALES_HQ"|部門コード（文字列）|
|plan_event_code|varchar(50)|YES|"FY2026_BUDGET_INIT"|予算イベントコード|
|plan_version_code|varchar(50)|YES|"V1"|バージョンコード|
|dimension_code|varchar(50)|YES|"SEG_IR"|ディメンションコード|
|dimension_value_code|varchar(50)|YES|"DOM"|ディメンション値コード|
|amount|numeric|YES|123456.78|金額|
|currency_code|char(3)|YES|"JPY"|通貨|
|validation_status|varchar(20)|NO|"PENDING"|PENDING/VALID/ERROR|
|validation_errors|jsonb|YES|[]|エラー内容|
|processed_at|timestamptz|YES||処理日時|
|created_at|timestamptz|NO|||

### 制約
- FK(tenant_id, company_id) → companies(tenant_id, id)
- CHECK(validation_status IN ('PENDING','VALID','ERROR'))

### 補足
- コード類は全て文字列で受け取り、バリデーション時にマスタ参照して変換
- validation_errors は [{field: "subject_code", message: "科目が存在しません"}] 形式
- 取込完了後はバッチ単位で削除可能（クリーンアップ）


---

## 12.4 actual_import_staging（実績取込ステージング）

> **追加日**: 2026-01-09

### 仕様
- 実績データ取込時の一時領域（予算と分離）
- ERPからの実績データ（集約後）を受け入れる
- 月次粒度の集約実績（fact_journal_lines の集計結果ではない）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|AIS-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies参照|
|import_batch_id|uuid|NO|IB-...|取込バッチID|
|row_no|int|NO|1|元ファイルの行番号|
|accounting_period_code|varchar(32)|NO|"FY2026-P01"|期間コード（文字列）|
|subject_code|varchar(50)|NO|"4010"|科目コード（文字列）|
|department_code|varchar(50)|NO|"SALES_HQ"|部門コード（文字列）|
|dimension_code|varchar(50)|YES|"SEG_IR"|ディメンションコード|
|dimension_value_code|varchar(50)|YES|"DOM"|ディメンション値コード|
|amount|numeric|YES|123456.78|金額|
|currency_code|char(3)|YES|"JPY"|通貨|
|data_origin|varchar(30)|YES|"ERP_IMPORT"|ERP_IMPORT/MANUAL|
|validation_status|varchar(20)|NO|"PENDING"|PENDING/VALID/ERROR|
|validation_errors|jsonb|YES|[]|エラー内容|
|processed_at|timestamptz|YES||処理日時|
|created_at|timestamptz|NO|||

### 制約
- FK(tenant_id, company_id) → companies(tenant_id, id)
- CHECK(validation_status IN ('PENDING','VALID','ERROR'))
- CHECK(data_origin IN ('ERP_IMPORT','MANUAL'))

### 補足
- 予算取込と分離してパフォーマンスを確保
- 実績は plan_event / plan_version を持たない（scenario_type=ACTUAL のイベント/バージョンは別途特定）


---

## 12.5 fact_journal_lines（仕訳明細ファクト）

> **追加日**: 2026-01-09

### 仕様
- ERPから取り込んだ仕訳レベルの明細データを保持
- fact_amounts（月次集約）とは別に、詳細データとして蓄積
- **2形式対応**: SINGLE（借方/貸方別列）、DOUBLE（借貸フラグ+金額）
- **軽量タグ**: 5つの固定タグ列（値のみ保持、コードなし）
- 検索・ドリルダウン・参照用途が主（集計は fact_amounts を使う）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|FJL-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies参照|
|import_batch_id|uuid|YES|IB-...|取込バッチID（任意）|
|journal_no|varchar(50)|NO|"JE-2026-001234"|仕訳番号|
|journal_line_no|int|NO|1|仕訳内行番号|
|journal_date|date|NO|2026-04-15|仕訳日付|
|posting_date|date|YES|2026-04-30|転記日付|
|accounting_period_id|uuid|NO|AP-...|会計期間|
|subject_id|uuid|NO|SUB-...|科目（会社COA）|
|department_stable_id|uuid|YES|S-...|部門（stable_id、任意）|
|line_format|varchar(10)|NO|"SINGLE"|SINGLE/DOUBLE|
|debit_amount|numeric|YES|10000.00|SINGLE形式: 借方金額|
|credit_amount|numeric|YES|0|SINGLE形式: 貸方金額|
|debit_credit|char(1)|YES|"D"|DOUBLE形式: D=借方/C=貸方|
|amount|numeric|YES|10000.00|DOUBLE形式: 金額|
|currency_code|char(3)|YES|"JPY"|通貨|
|description|varchar(500)|YES|"月次売上計上"|摘要|
|counterpart_subject_code|varchar(50)|YES|"1110"|相手科目コード（参考）|
|external_ref|varchar(100)|YES|"SAP-DOC-123"|外部システム参照|
|tag1|varchar(200)|YES|"株式会社ABC"|タグ1の値|
|tag2|varchar(200)|YES|"PJ-2026-001"|タグ2の値|
|tag3|varchar(200)|YES||タグ3の値|
|tag4|varchar(200)|YES||タグ4の値|
|tag5|varchar(200)|YES||タグ5の値|
|source_system|varchar(50)|YES|"SAP"|取込元システム|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, company_id, accounting_period_id) → accounting_periods(tenant_id, company_id, id)
- FK(tenant_id, company_id, subject_id) → subjects(tenant_id, company_id, id)
- UNIQUE(tenant_id, company_id, journal_no, journal_line_no)
- CHECK(line_format IN ('SINGLE','DOUBLE'))
- CHECK(line_format != 'SINGLE' OR (debit_amount IS NOT NULL AND credit_amount IS NOT NULL))
- CHECK(line_format != 'DOUBLE' OR (debit_credit IN ('D','C') AND amount IS NOT NULL))

### 補足

#### 2形式対応について
- **SINGLE形式**: debit_amount / credit_amount を両方持つ（片方は0または金額）
  - ERPによっては借方・貸方を別列で出力する
- **DOUBLE形式**: debit_credit フラグ（D/C）+ amount（金額）で表現
  - ERPによっては借貸フラグ+金額の1行形式で出力する
- どちらの形式で取り込んでも、集計時は統一的に処理できる

#### 軽量タグ機能について
- tag1〜tag5 は **値のみ保持**（コード・マスタ参照なし）
- 各タグの意味（ラベル）は **companies.tag1_label〜tag5_label** で定義
- 用途例:
  - tag1: 顧客名、取引先名
  - tag2: プロジェクト名、案件番号
  - tag3: 担当者名
  - tag4: 備考1
  - tag5: 備考2
- ディメンション（経営粒度）ではなく、仕訳に付随する補足情報として使用

#### 集計との関係
- fact_journal_lines は **詳細保持** が目的
- 月次集計は fact_amounts が担う
- 仕訳→月次集計は別途バッチ or View で行う（fact_journal_lines → fact_amounts への集約）


---

# 13. 配賦マスタ（V2：ルール定義）

## 13.0 配賦マスタ実装方針（Phase 1）

> **決定日**: 2026-01-06
> **ステータス**: Phase 1 スコープ確定

### 基本設計思想

配賦は **「科目 × 部門」を配賦元として指定し、配賦基準に基づいて配賦先へ按分する** という構造を基本とする。

```
【配賦元】科目 × 部門（from_subject_id × from_department_stable_id）
    ↓ 配賦基準（FIXED/HEADCOUNT/SUBJECT_AMOUNT/MEASURE/KPI）
【配賦先】部門（複数） または ディメンション値（複数）
```

### Phase 1 スコープ

| 機能 | Phase 1 | 備考 |
|------|---------|------|
| allocation_events CRUD | ◯ | 配賦イベント管理 |
| allocation_steps CRUD | ◯ | 多段階ステップ管理 |
| allocation_step_targets CRUD | ◯ | 配賦先定義 |
| allocation_drivers CRUD | ◯ | 配賦ドライバ管理 |
| ステップ順序並べ替え | ◯ | step_no の UI 操作 |
| 配賦設定コピー | ◯ | 既存イベントを複製して新規作成 |
| filter_json / exclude_json | ✕ | カラムは残すがUI非表示、Phase 2 以降 |
| 配賦実行（Fact生成） | ✕ | Phase 2 以降 |
| 配賦結果プレビュー | ✕ | Phase 2 以降 |

### 運用方針

| 項目 | 方針 |
|------|------|
| 権限 | 会社別管理（各社が自社の配賦ルールを管理） |
| 連結 | Phase 1 では対象外 |
| 非財務（KPI） | Phase 1 では対象外 |
| ドライバ運用 | 独立マスタ（事前定義）+ インライン（ステップ内直接指定）の両方をサポート |

### filter_json / exclude_json について

- **Phase 1**: 空（null）で運用。UIには表示しない
- **Phase 2 以降**: PJ別配賦、IRセグメント別配賦等が必要になった際に実装
- 用途:
  - filter_json: 「この条件に合うFactだけを配賦対象にする」（絞り込み）
  - exclude_json: 「この条件に合うFactは配賦対象から除く」（除外）

### UI方針

- モダンで効率的なUI（階層的な一画面構成を基本）
- イベント一覧 → イベント詳細（ステップ一覧埋め込み）→ ステップ詳細ダイアログ
- 配賦ドライバは独立マスタ画面も用意

---

## 13.1 allocation_events（配賦イベント）

### 仕様
- 配賦処理の「束」を定義する（予算・実績・見込すべて対象）
- 楽観的ロック用の version カラムを持つ

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|AE-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...|companies参照|
|event_code|varchar(50)|NO|ALLOC_M_ACTUAL|会社内一意|
|event_name|varchar(200)|NO|月次実績配賦||
|scenario_type|varchar(20)|NO|ACTUAL|ACTUAL/BUDGET/FORECAST|
|execution_order|int|NO DEFAULT 0|1|同一会社内の実行順序（昇順）|
|is_active|boolean|NO|true||
|version|int|NO|1|楽観的ロック用|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, company_id, event_code)
- FK(tenant_id, company_id) → companies(tenant_id, id)
- CHECK(scenario_type IN ('ACTUAL','BUDGET','FORECAST'))

### 補足
- v2は配賦「ルール定義」までをマスタで持つ。実行ログ/結果の詳細分離は後続拡張で対応可能。
- version はステップ順序変更等の競合検知に使用。更新時にインクリメント。


---

## 13.2 allocation_steps（配賦ステップ：多段階）

### 仕様
- 配賦イベント内の多段階配賦の「段」を定義する
- 基本粒度は **部門（stable_id）× 科目**
- 配賦先は **部門（stable_id）** または **ディメンション値（dimension_values）**
- 任意軸はフィルタ（filter_json）として指定可能（Phase 2）

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|AS-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...| |
|event_id|uuid|NO|AE-...|allocation_events参照|
|step_no|int|NO|1|実行順|
|step_name|varchar(200)|NO|本社共通費→事業部||
|from_subject_id|uuid|NO|SUB-...|配賦元科目|
|from_department_stable_id|uuid|NO|S-...|配賦元部門（stable_id、必須）|
|driver_type|varchar(30)|NO|HEADCOUNT|FIXED/HEADCOUNT/SUBJECT_AMOUNT/MEASURE/KPI|
|driver_source_type|varchar(20)|NO|MASTER|MASTER/FACT/KPI|
|driver_ref_id|uuid|YES|AD-...|allocation_drivers参照（任意）|
|filter_json|jsonb|YES|{}|任意軸フィルタ（Phase 2）|
|exclude_json|jsonb|YES|{}|除外条件（Phase 2）|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, company_id, event_id, step_no)
- FK(tenant_id, company_id, event_id) → allocation_events(tenant_id, company_id, id)
- FK(tenant_id, from_department_stable_id) → departments(tenant_id, stable_id)（論理FK）
- CHECK(driver_type IN ('FIXED','HEADCOUNT','SUBJECT_AMOUNT','MEASURE','KPI'))
- CHECK(driver_source_type IN ('MASTER','FACT','KPI'))

### 補足
- from_department_stable_id は必須。配賦元部門を指定しないケースは存在しない
- stable_id を使用することで組織改編後も配賦ルールが維持される
- driver_ref_id が NULL の場合はインライン設定（ステップ内で直接 driver_type 等を指定）


---

## 13.3 allocation_step_targets（配賦先定義）

### 仕様
- 1ステップに対する配賦先（複数）を定義する
- 配賦先は「部門（stable_id）」または「ディメンション値（dimension_values）」を選択可能
- 配賦先科目を指定可能（NULL の場合は配賦元科目と同じ科目に計上）
- 固定配賦比率の場合は fixed_ratio を使用

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|AST-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...| |
|step_id|uuid|NO|AS-...|allocation_steps参照|
|target_type|varchar(30)|NO|DEPARTMENT|DEPARTMENT/DIMENSION_VALUE|
|target_id|uuid|NO|S-... / DV-...|部門はstable_id、DIMENSIONはdimension_values.id|
|to_subject_id|uuid|YES|SUB-...|配賦先科目（NULL=配賦元科目と同じ）|
|fixed_ratio|numeric(5,4)|YES|0.2500|0〜1（固定配賦時）|
|sort_order|int|YES|1|任意|
|is_active|boolean|NO|true||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, company_id, step_id, target_type, target_id)
- FK(tenant_id, company_id, step_id) → allocation_steps(tenant_id, company_id, id)
- CHECK(target_type IN ('DEPARTMENT','DIMENSION_VALUE'))
- CHECK(fixed_ratio IS NULL OR (fixed_ratio >= 0 AND fixed_ratio <= 1))

### 補足（運用）
- target_type=DEPARTMENT の場合、target_id は **departments.stable_id** を使用（版非依存）
- target_type=DIMENSION_VALUE の場合、target_id は **dimension_values.id** を使用
- target_id の参照整合はUseCaseで担保
- to_subject_id が NULL の場合、配賦実行時に from_subject_id を使用（同一科目配賦）
- dimension_values への配賦が「EPMらしい強み」


---

## 13.4 allocation_drivers（配賦ドライバ）

### 仕様
- 配賦の按分根拠（固定、人員、特定科目金額、面積/工数等、KPI）を定義する
- driver_source_type で「マスタ」「Fact」「KPI」等の参照元を切替できる

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|AD-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...| |
|driver_code|varchar(50)|NO|DRV_HEADCOUNT|会社内一意|
|driver_name|varchar(200)|NO|人員比|| 
|driver_type|varchar(30)|NO|HEADCOUNT|FIXED/HEADCOUNT/SUBJECT_AMOUNT/MEASURE/KPI|
|source_type|varchar(20)|NO|MASTER|MASTER/FACT/KPI|
|driver_subject_id|uuid|YES|SUB-...|SUBJECT_AMOUNT用|
|measure_key|varchar(50)|YES|AREA/HOURS|MEASURE用|
|kpi_subject_id|uuid|YES|SUB-KPI-...|KPI用|
|period_rule|varchar(20)|YES|CURRENT|CURRENT/YTD等|
|notes|text|YES|||
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, company_id, driver_code)
- CHECK(driver_type IN ('FIXED','HEADCOUNT','SUBJECT_AMOUNT','MEASURE','KPI'))
- CHECK(source_type IN ('MASTER','FACT','KPI'))

### 補足
- 端数処理・端数付け先は「会社設定 or 配賦実行設定」で後続拡張（v2では方針のみ）

### ドライバタイプ別の設定・計算根拠

| driver_type | 説明 | 必須設定 | データソース（Phase 2） |
|-------------|------|----------|------------------------|
| FIXED | 固定比率配賦 | - | targets.fixed_ratio を使用 |
| HEADCOUNT | 人員比配賦 | - | departments.headcount を使用 |
| SUBJECT_AMOUNT | 科目金額比配賦 | driver_subject_id | 当月の fact_amounts（指定科目）金額 |
| MEASURE | 物量比配賦 | measure_key | 将来：部門別物量マスタを参照 |
| KPI | KPI値比配賦 | kpi_subject_id | 当月の fact_amounts（KPI科目）値 |

### measure_key の想定用途

measure_key は物量ベースの配賦基準を表すキー。Phase 1 では文字列として保存のみ。

| measure_key 例 | 用途 | 将来のデータソース |
|----------------|------|-------------------|
| AREA | 占有面積比 | 部門別面積マスタ（将来追加） |
| HOURS | 工数比 | 部門別工数実績（将来追加） |
| UNITS | 生産数量比 | 部門別生産数量（将来追加） |
| TRANSACTIONS | 取引件数比 | 部門別処理件数（将来追加） |


---

## 13.5 allocation_executions（配賦実行履歴）

### 仕様
- 配賦処理の実行履歴を管理する
- 会計期間×配賦イベント単位で実行履歴を保持
- 再配賦時は前回結果を削除して新規作成

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|AEX-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...||
|event_id|uuid|NO|AE-...|allocation_events参照|
|accounting_period_id|uuid|NO|AP-...|対象会計期間|
|org_version_id|uuid|NO|OV-...|使用した組織バージョン|
|executed_at|timestamptz|NO||実行日時|
|executed_by|uuid|NO|U-...|実行者（login_accounts.id）|
|status|varchar(20)|NO|SUCCESS|RUNNING/SUCCESS/FAILED|
|error_message|text|YES||エラー時メッセージ|
|summary_json|jsonb|YES|{"total_amount":...}|実行サマリ（件数・金額等）|
|created_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, company_id, event_id, accounting_period_id)
- FK(tenant_id, company_id, event_id) → allocation_events(tenant_id, company_id, id)
- FK(tenant_id, company_id, accounting_period_id) → accounting_periods(tenant_id, company_id, id)
- FK(tenant_id, company_id, org_version_id) → organization_versions(tenant_id, company_id, id)
- CHECK(status IN ('RUNNING','SUCCESS','FAILED'))

### 補足
- 再配賦時は既存レコードをDELETEして新規INSERT
- summary_json には { total_steps: N, total_details: N, total_allocated_amount: N } 等を格納


---

## 13.6 allocation_execution_details（配賦実行明細）

### 仕様
- 配賦結果の明細を保存（配賦結果VIEW画面で使用）
- fact_amounts への反映とは別に結果を保持

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|AXD-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|company_id|uuid|NO|C-...||
|execution_id|uuid|NO|AEX-...|allocation_executions参照|
|step_id|uuid|NO|AS-...|実行ステップ|
|step_no|int|NO|1|ステップ番号（実行時スナップショット）|
|from_department_stable_id|uuid|NO|S-...|配賦元部門（stable_id）|
|from_subject_id|uuid|NO|SUB-...|配賦元科目|
|source_amount|numeric(18,2)|NO|10000000.00|配賦元金額|
|to_department_stable_id|uuid|YES|S-...|配賦先部門（DEPARTMENT時）|
|to_dimension_value_id|uuid|YES|DV-...|配賦先ディメンション値（DIMENSION_VALUE時）|
|to_subject_id|uuid|NO|SUB-...|配賦先科目|
|driver_type|varchar(30)|NO|HEADCOUNT|使用ドライバ種別|
|driver_value|numeric(18,6)|YES|25.500000|ドライバ値（比率計算の分子）|
|ratio|numeric(8,6)|NO|0.400000|配賦比率（0〜1）|
|allocated_amount|numeric(18,2)|NO|4000000.00|配賦金額|
|created_at|timestamptz|NO|||

### 制約
- FK(tenant_id, company_id, execution_id) → allocation_executions(tenant_id, company_id, id) ON DELETE CASCADE
- FK(tenant_id, company_id, step_id) → allocation_steps(tenant_id, company_id, id)
- FK(tenant_id, from_department_stable_id) → departments(tenant_id, stable_id)（論理FK）
- CHECK(ratio >= 0 AND ratio <= 1)
- CHECK(to_department_stable_id IS NOT NULL OR to_dimension_value_id IS NOT NULL)

### インデックス
- INDEX idx_allocation_execution_details_exec ON allocation_execution_details(tenant_id, company_id, execution_id)
- INDEX idx_allocation_execution_details_step ON allocation_execution_details(tenant_id, company_id, step_id)

### 補足
- 配賦結果VIEW画面での階層表示用に step_no を保持（ソート用）
- ON DELETE CASCADE により、execution 削除時に明細も自動削除
- fact_amounts への反映は別途実行（source_type = 'ALLOC'）


---

# 14. インデックス推奨（V2：性能の最低ライン）

## 14.1 fact_amounts
- (tenant_id, company_id, scenario_type, plan_version_id, accounting_period_id)
- (tenant_id, company_id, subject_id, accounting_period_id)
- (tenant_id, company_id, department_stable_id, accounting_period_id)
- (tenant_id, company_id, ir_segment_value_id, accounting_period_id)
- (tenant_id, trace_id)

## 14.2 fact_dimension_links
- (tenant_id, company_id, fact_amount_id)
- (tenant_id, company_id, dimension_id, dimension_value_id, fact_amount_id)

> 基本戦略：**fact_amounts（固定列）で絞ってからリンクJOIN**


---

# 15. 付録：V2で確定した主要意思決定（議事録レベル）

- Factは **会社COA** を保持（連結変換は mapping）
- 数値は **原単位保持**
- 組織改編耐性：**org_version_id＋department_stable_id**
- IRセグメント：**固定列、ただし任意（NULL可）**
- 可変ディメンション：**Groupのみリンク（Leafはリンクしない）**
- Factは **集約型（Upsert）**
- 配賦：予算・実績とも対象。配賦先は **部門 or dimension_values**
- 配賦前後・調整前後は **単一Fact＋source_type＋View** で表現



---

# 10. 連結レポートレイアウト

## 10.0 連結レイアウト設計方針

### 概要
連結予算実績レポートの表示レイアウトを管理する。会社別レイアウト（report_layouts）とは別に、連結専用のレイアウト体系を持つ。

### 運用モデル
- **テナント単位**で連結レイアウトを管理（連結COAと同様）
- **親会社のみ**がレイアウトを編集可能（子会社は参照のみ）
- 連結勘定科目（group_subjects）を参照して行を構成
- rollup構造とは別に、**表示順・見出し・インデント**を自由に定義可能

### 会社レイアウトとの違い

| 観点 | 会社レイアウト（report_layouts） | 連結レイアウト（group_report_layouts） |
|------|--------------------------------|--------------------------------------|
| スコープ | company_id（会社別） | tenant_id（テナント共通） |
| 参照科目 | subjects（会社COA） | group_subjects（連結COA） |
| 編集権限 | 各会社で編集可能 | 親会社のみ編集可能 |
| 用途 | 会社別PL/BS/KPI | 連結PL/BS/KPI |

### 指標（Metrics）との関係
- 連結用の計算指標（EBITDA等）は **group_metrics** として別途定義（将来拡張）
- Phase 1 では連結レイアウトに指標行は含めず、科目行のみをサポート

---

## 10.1 group_report_layouts（連結レイアウトヘッダ）

### 仕様
- 連結PL/BS/KPIの表示レイアウト（ヘッダ）を管理する
- テナント単位で管理し、親会社のみ編集可能

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|GL-PL-STD|PK|
|tenant_id|uuid|NO|T-...|RLS|
|layout_type|varchar(10)|NO|PL/BS/KPI|財務レイアウト（PL/BS）またはKPIレイアウト|
|layout_code|varchar(50)|NO|CONSOL_PL_STD|tenant内一意|
|layout_name|varchar(200)|NO|連結PL（標準）||
|layout_name_short|varchar(100)|YES|連結PL||
|description|text|YES|グループ全体の損益計算書レイアウト|用途説明|
|is_default|boolean|NO|false|デフォルトレイアウトフラグ|
|is_active|boolean|NO|true|論理削除|
|sort_order|int|NO|10|一覧表示順|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||
|created_by|uuid|YES||監査|
|updated_by|uuid|YES||監査|

### 制約
- UNIQUE(tenant_id, layout_type, layout_code)
- UNIQUE(tenant_id, id)（複合FK用）
- CHECK(layout_type IN ('PL', 'BS', 'KPI'))

### 補足
- layout_type='PL' または 'BS' の場合: 財務科目（group_subjects.subject_type='FIN'）のみを対象
- layout_type='KPI' の場合: KPI科目（group_subjects.subject_type='KPI'）のみを対象
- is_default=true のレイアウトは layout_type ごとに1つのみ（UseCaseで制御）
- 親会社判定はログイン時の company_id から companies.parent_company_id で判断

---

## 10.2 group_report_layout_lines（連結レイアウト行）

### 仕様
- 連結レイアウトの各行（見出し／科目行／注記等）を管理する
- 科目行は連結勘定科目（group_subjects）を参照
- 個社レイアウト（report_layout_lines）と同じ line_type 体系を採用

### エンティティ

|カラム|型|NULL|例|補足|
|---|---|---|---|---|
|id|uuid|NO|GLL-...|PK|
|tenant_id|uuid|NO|T-...|RLS|
|layout_id|uuid|NO|GL-PL-STD|group_report_layouts参照|
|line_no|int|NO|10|表示順（10刻み推奨）|
|line_type|varchar(20)|NO|account|header/account/note/blank|
|display_name|varchar(200)|YES|売上高|見出し/注記にも使用|
|group_subject_id|uuid|YES|GS-SALES|account行のみ|
|indent_level|int|NO|0|0-5程度|
|sign_display_policy|varchar(20)|NO|auto|auto/force_plus/force_minus/force_paren|
|is_bold|boolean|NO|false|太字表示|
|is_underline|boolean|NO|false|下線表示|
|is_double_underline|boolean|NO|false|二重下線表示（合計行等）|
|bg_highlight|boolean|NO|false|背景ハイライト|
|notes|text|YES||行メモ（管理用）|
|created_at|timestamptz|NO|||
|updated_at|timestamptz|NO|||

### 制約
- UNIQUE(tenant_id, layout_id, line_no)
- CHECK(line_type IN ('header', 'account', 'note', 'blank'))
- CHECK(indent_level >= 0 AND indent_level <= 10)
- CHECK(sign_display_policy IN ('auto', 'force_plus', 'force_minus', 'force_paren'))
- FK(tenant_id, layout_id) → group_report_layouts(tenant_id, id)
- FK(tenant_id, group_subject_id) → group_subjects(tenant_id, id)

### 補足（UseCase）
- group_subject_id は account 行のみ必須
- account 行は BASE 科目も AGGREGATE 科目も表示可能（subject_class で区別）
- header / note / blank 行: 表示名のみで科目参照なし
- line_no は10刻みで採番し、行挿入時の再採番を減らす
- 小計・合計の表示スタイル（太字・下線）は is_bold / is_underline で制御

### line_type の意味

| line_type | 説明 | group_subject_id | 表示例 |
|-----------|------|------------------|--------|
| header | セクション見出し | 不要 | 「営業収益」「営業費用」 |
| account | 科目行（値を表示） | 必須 | 売上高: 1,000,000 / 売上総利益: 300,000 |
| note | 注記行 | 不要 | ※前年同期比... |
| blank | 空行（スペーサー） | 不要 | - |

### 表示スタイルの組み合わせ例

| 用途 | is_bold | is_underline | is_double_underline | bg_highlight |
|------|---------|--------------|---------------------|--------------|
| セクション見出し | true | false | false | false |
| 通常科目行（BASE） | false | false | false | false |
| 集計科目行（AGGREGATE） | true | false | false | false |
| 小計行 | true | true | false | false |
| 中間合計 | true | false | false | true |
| 最終合計（当期純利益等） | true | false | true | false |

---

## 10.3 連結レイアウトの利用シナリオ

### レポート生成フロー
1. ユーザーが連結レイアウトを選択（または layout_type のデフォルトを使用）
2. group_report_layout_lines を line_no 順に取得
3. 各 account/subtotal 行について:
   - group_subject_id から連結科目を特定
   - Fact（fact_amounts）を group_subject_mappings 経由で集計
   - 集計値をレイアウト行に表示
4. header/note/blank 行は display_name のみ表示

### 集計の流れ（概念）
```
fact_amounts (会社COA: subject_id)
    ↓ group_subject_mappings (変換)
group_subjects (連結COA)
    ↓ group_subject_rollup_items (集計)
集計科目 (AGGREGATE)
    ↓ group_report_layout_lines (表示)
連結レポート
```

---

# 14. アクションプラン管理

KPI達成のための施策・タスク管理機能。ガントチャート（WBS）とカンバンボードをサポート。

## 14.0 設計方針

- **KPI科目に紐付け**：アクションプランは subjects (subject_type='KPI') に紐付く
- **3階層構造**：アクションプラン → WBS → タスク
- **ガントチャート**：wbs_items で階層的にスケジュール管理（有償ライブラリ活用前提）
- **カンバンボード**：action_plan_tasks でステータス管理（Trelloライク）
- **ステータスカスタマイズ**：会社ごとにタスクステータスを定義可能

---

## 14.1 action_plans（アクションプラン）

### 仕様
- KPI達成のための施策・取り組みを定義する
- 1つのKPI科目に複数のアクションプランを紐付け可能（1:N）

### エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| company_id | uuid | NO | | FK to companies |
| subject_id | uuid | NO | | FK to subjects (KPI科目) |
| plan_code | varchar(50) | NO | "AP-2026-001" | 会社内一意 |
| plan_name | varchar(200) | NO | "働き方改革の推進" | |
| description | text | YES | | |
| owner_department_stable_id | varchar(50) | YES | | 責任部門 |
| owner_employee_id | uuid | YES | | FK to employees |
| start_date | date | YES | | |
| due_date | date | YES | | |
| status | varchar(20) | NO | "IN_PROGRESS" | NOT_STARTED/IN_PROGRESS/COMPLETED/CANCELLED |
| progress_rate | smallint | YES | 40 | 0-100 |
| priority | varchar(10) | YES | "HIGH" | HIGH/MEDIUM/LOW |
| is_active | boolean | NO | true | |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |
| created_by | uuid | YES | | 監査 |
| updated_by | uuid | YES | | 監査 |

### 制約
- UNIQUE(tenant_id, company_id, plan_code)
- CHECK(status IN ('NOT_STARTED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED'))
- CHECK(progress_rate IS NULL OR (progress_rate >= 0 AND progress_rate <= 100))
- CHECK(priority IS NULL OR priority IN ('HIGH', 'MEDIUM', 'LOW'))
- FK(tenant_id, company_id) → companies(tenant_id, id)
- FK(tenant_id, subject_id) → subjects(tenant_id, id)
- FK(tenant_id, owner_employee_id) → employees(tenant_id, id)

### 補足
- subject_id は subject_type='KPI' の科目のみ許可（UseCase で検証）
- progress_rate は wbs_items の進捗から自動計算することも可能（Phase 2）
- owner_department_stable_id は組織版を跨いで追跡可能

---

## 14.2 wbs_items（WBS項目）

### 仕様
- アクションプラン配下のWBS（Work Breakdown Structure）項目を定義
- ガントチャート表示の単位となる
- 階層構造をサポート（parent_wbs_id で自己参照）

### エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| action_plan_id | uuid | NO | | FK to action_plans |
| parent_wbs_id | uuid | YES | | 自己参照（階層）、NULLはルート |
| wbs_code | varchar(50) | NO | "1.1.1" | WBS番号 |
| wbs_name | varchar(200) | NO | "要件定義" | |
| description | text | YES | | |
| assignee_department_stable_id | varchar(50) | YES | | 担当部門 |
| assignee_employee_id | uuid | YES | | FK to employees |
| start_date | date | YES | | ガントチャート用 |
| due_date | date | YES | | ガントチャート用 |
| actual_start_date | date | YES | | 実績開始日 |
| actual_end_date | date | YES | | 実績終了日 |
| progress_rate | smallint | YES | 0 | 0-100 |
| predecessor_wbs_id | uuid | YES | | 先行WBS（依存関係） |
| sort_order | int | NO | 1 | 表示順 |
| is_milestone | boolean | NO | false | マイルストーンフラグ |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |

### 制約
- UNIQUE(tenant_id, action_plan_id, wbs_code)
- CHECK(progress_rate IS NULL OR (progress_rate >= 0 AND progress_rate <= 100))
- CHECK(start_date IS NULL OR due_date IS NULL OR start_date <= due_date)
- CHECK(actual_start_date IS NULL OR actual_end_date IS NULL OR actual_start_date <= actual_end_date)
- FK(tenant_id, action_plan_id) → action_plans(tenant_id, id)
- FK(tenant_id, parent_wbs_id) → wbs_items(tenant_id, id)
- FK(tenant_id, predecessor_wbs_id) → wbs_items(tenant_id, id)
- FK(tenant_id, assignee_employee_id) → employees(tenant_id, id)

### 補足
- parent_wbs_id が NULL の場合はルートWBS項目
- predecessor_wbs_id はガントチャートの依存関係線表示に使用
- is_milestone が true の場合、ガントチャートでマイルストーン表示（菱形など）
- wbs_code は「1」「1.1」「1.1.1」のような階層番号を想定

---

## 14.3 action_plan_tasks（タスク）

### 仕様
- WBS項目配下のタスクを定義
- カンバンボードで管理する単位

### エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| wbs_item_id | uuid | NO | | FK to wbs_items |
| task_name | varchar(200) | NO | "ヒアリング実施" | |
| description | text | YES | | |
| assignee_employee_id | uuid | YES | | FK to employees |
| status_id | uuid | NO | | FK to task_statuses |
| due_date | date | YES | | |
| sort_order | int | NO | 1 | カンバン内の並び順 |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |

### 制約
- FK(tenant_id, wbs_item_id) → wbs_items(tenant_id, id)
- FK(tenant_id, status_id) → task_statuses(tenant_id, id)
- FK(tenant_id, assignee_employee_id) → employees(tenant_id, id)

### 補足
- sort_order はカンバンボード内でのドラッグ&ドロップ並び替えに使用
- status_id で task_statuses のどのステータスに属するかを管理

---

## 14.4 task_statuses（タスクステータス定義）

> **変更履歴**: 2026-01-09 - `company_id` → `action_plan_id` に変更（Trelloのボード単位ラベルに準拠）

### 仕様
- **アクションプラン単位**でカスタマイズ可能なタスクステータスを定義
- カンバンボードの列（レーン）に対応
- 各アクションプランが独自のステータス定義を持つ（Trelloのボード単位ラベルに準拠）

### エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| action_plan_id | uuid | NO | | FK to action_plans |
| status_code | varchar(30) | NO | "IN_PROGRESS" | |
| status_name | varchar(50) | NO | "進行中" | 表示名 |
| color_code | varchar(7) | YES | "#3B82F6" | カンバン表示色 |
| sort_order | int | NO | 2 | カンバンの左から順 |
| is_default | boolean | NO | false | 新規タスクのデフォルト |
| is_completed | boolean | NO | false | 完了扱いフラグ |
| is_active | boolean | NO | true | |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |

### 制約
- UNIQUE(tenant_id, action_plan_id, status_code)
- FK(tenant_id, action_plan_id) → action_plans(tenant_id, id)

### 補足
- is_default が true のステータスはアクションプラン内で1つのみ（UseCase で検証）
- is_completed が true のステータスは進捗率100%扱い
- color_code は #RRGGBB 形式
- **アクションプラン作成時に初期ステータスを自動生成**：
  - 未着手（NOT_STARTED）: sort_order=1, is_default=true, color=#6B7280
  - 進行中（IN_PROGRESS）: sort_order=2, color=#3B82F6
  - レビュー中（REVIEW）: sort_order=3, color=#F59E0B
  - 完了（COMPLETED）: sort_order=4, is_completed=true, color=#10B981

---

## 14.5 task_labels（タスクラベル定義）

> **追加日**: 2026-01-09
> **変更履歴**: 2026-01-09 - `company_id` → `action_plan_id` に変更（Trelloのボード単位ラベルに準拠）

### 仕様
- **アクションプラン単位**でカスタマイズ可能なタスクラベル（色タグ）を定義
- Trelloのボード単位ラベル機能に準拠
- 各アクションプランが独自のラベル定義を持つ

### エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| action_plan_id | uuid | NO | | FK to action_plans |
| label_name | varchar(50) | NO | "重要" | ラベル名 |
| color_code | varchar(7) | NO | "#EF4444" | 表示色（#RRGGBB） |
| sort_order | int | NO | 1 | 表示順 |
| is_active | boolean | NO | true | |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |

### 制約
- UNIQUE(tenant_id, action_plan_id, label_name)
- FK(tenant_id, action_plan_id) → action_plans(tenant_id, id)

### 補足
- **アクションプラン作成時に初期ラベルを自動生成**：
  - 重要（#EF4444 赤）
  - 急ぎ（#F59E0B オレンジ）
  - 確認待ち（#3B82F6 青）
  - 完了間近（#10B981 緑）

---

## 14.6 task_label_assignments（タスク-ラベル紐付け）

> **追加日**: 2026-01-09

### 仕様
- タスクとラベルの多対多関係を管理
- 1タスクに複数ラベルを付与可能

### エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| task_id | uuid | NO | | FK to action_plan_tasks |
| label_id | uuid | NO | | FK to task_labels |
| created_at | timestamptz | NO | | |

### 制約
- UNIQUE(tenant_id, task_id, label_id)
- FK(tenant_id, task_id) → action_plan_tasks(tenant_id, id)
- FK(tenant_id, label_id) → task_labels(tenant_id, id)

---

## 14.7 task_assignees（タスク担当者：複数アサイン）

> **追加日**: 2026-01-09

### 仕様
- タスクに複数の担当者をアサイン可能
- Trelloの複数メンバーアサイン機能に相当

### エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| task_id | uuid | NO | | FK to action_plan_tasks |
| employee_id | uuid | NO | | FK to employees |
| assigned_at | timestamptz | NO | | アサイン日時 |
| assigned_by | uuid | YES | | アサイン実行者 |

### 制約
- UNIQUE(tenant_id, task_id, employee_id)
- FK(tenant_id, task_id) → action_plan_tasks(tenant_id, id)
- FK(tenant_id, employee_id) → employees(tenant_id, id)

### 補足
- action_plan_tasks.assignee_employee_id は主担当として残す（後方互換）
- task_assignees は追加担当者として利用
- または action_plan_tasks.assignee_employee_id を廃止してこちらに一本化も可（Phase 2 検討）

---

## 14.8 task_checklist_items（タスクチェックリスト）

> **追加日**: 2026-01-09

### 仕様
- タスク内のサブタスク（チェックリスト項目）を管理
- Trelloのチェックリスト機能に相当

### エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| task_id | uuid | NO | | FK to action_plan_tasks |
| item_name | varchar(200) | NO | "設計書レビュー完了" | チェック項目名 |
| is_checked | boolean | NO | false | チェック状態 |
| sort_order | int | NO | 1 | 表示順 |
| checked_at | timestamptz | YES | | チェック日時 |
| checked_by | uuid | YES | | チェック実行者 |
| created_at | timestamptz | NO | | |
| updated_at | timestamptz | NO | | |

### 制約
- FK(tenant_id, task_id) → action_plan_tasks(tenant_id, id)
- FK(tenant_id, checked_by) → employees(tenant_id, id)

### 補足
- WBS/タスクの進捗率自動計算時に使用可能（完了チェック数/全チェック数）
- チェック実行者・日時を記録して監査性を確保

---

## 14.9 task_comments（タスクコメント）

> **追加日**: 2026-01-09

### 仕様
- タスクへのコメント（ディスカッション）を管理
- Trelloのコメント機能に相当

### エンティティ

| カラム | 型 | NULL | 例 | 補足 |
|--------|---|------|-----|------|
| id | uuid | NO | | PK |
| tenant_id | uuid | NO | | RLS |
| task_id | uuid | NO | | FK to action_plan_tasks |
| comment_text | text | NO | "進捗確認しました" | コメント本文 |
| created_by | uuid | NO | | 投稿者 |
| created_at | timestamptz | NO | | 投稿日時 |
| updated_at | timestamptz | NO | | 編集日時 |

### 制約
- FK(tenant_id, task_id) → action_plan_tasks(tenant_id, id)
- FK(tenant_id, created_by) → employees(tenant_id, id)

### 補足
- 編集履歴は Phase 2 で検討（現状は updated_at のみ）
- メンション機能（@ユーザー）は Phase 2

---

# 15. 中期経営計画（MTP: Mid-Term Plan）

## 15.0 設計方針

### 概要

中期経営計画（3〜5年）の目標値と戦略テーマを管理する。

### 基本方針

- **数値は fact_amounts を共用**: scenario_type = 'MTP' として格納
- **中計特有情報は別テーブル**: mtp_events, mtp_strategy_themes で管理
- **戦略テーマはカスケード構造**: 全社テーマ（親）→ 事業部テーマ（子）
- **KPI紐付け**: 既存のKPI機能（subjects.subject_type='KPI'）と連携

### scenario_type 拡張

fact_amounts.scenario_type に 'MTP' を追加:

| 値 | 説明 |
|----|------|
| BUDGET | 予算 |
| FORECAST | 見込 |
| ACTUAL | 実績 |
| **MTP** | 中期経営計画（新規追加） |

---

## 15.1 mtp_events（中期経営計画イベント）

中期経営計画の単位（「2024年中計」「2026年中計」等）を管理する。

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 主キー |
| tenant_id | UUID | ○ | テナントID（RLS境界） |
| company_id | UUID | ○ | 会社ID |
| event_code | VARCHAR(50) | ○ | イベントコード（例: MTP2026） |
| event_name | VARCHAR(200) | ○ | イベント名（例: 2026年中期経営計画） |
| plan_years | INT | ○ | 計画年数（3 or 5） |
| start_fiscal_year | INT | ○ | 開始年度（例: 2026） |
| end_fiscal_year | INT | ○ | 終了年度（例: 2030） |
| status | ENUM | ○ | ステータス（DRAFT / CONFIRMED） |
| description | TEXT | △ | 説明・備考 |
| is_active | BOOLEAN | ○ | 有効フラグ（デフォルト true） |
| created_at | TIMESTAMPTZ | ○ | 作成日時 |
| updated_at | TIMESTAMPTZ | ○ | 更新日時 |
| created_by | UUID | ○ | 作成者 |
| updated_by | UUID | ○ | 更新者 |

### 制約

- `UNIQUE(tenant_id, company_id, event_code)` — 会社内でイベントコード一意
- FK: tenant_id, company_id → companies(tenant_id, id)
- CHECK: plan_years IN (3, 5)
- CHECK: end_fiscal_year = start_fiscal_year + plan_years - 1

### 補足

- fact_amounts.plan_event_id から参照可能（scenario_type = 'MTP' の場合）
- 複数の中計イベントを並存可能（「2024年中計」と「2026年中計」が共存）
- ステータスは初期実装では DRAFT / CONFIRMED のみ（承認フローは別途設計）

---

## 15.2 mtp_strategy_themes（戦略テーマ）

中期経営計画に紐づく戦略テーマを管理する。全社テーマと事業部テーマのカスケード構造を持つ。

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 主キー |
| tenant_id | UUID | ○ | テナントID（RLS境界） |
| mtp_event_id | UUID | ○ | 中計イベントID |
| parent_theme_id | UUID | △ | 親テーマID（NULL=全社テーマ、あり=事業部テーマ） |
| dimension_value_id | UUID | △ | 事業部等のディメンション値（NULL=全社レベル） |
| theme_code | VARCHAR(50) | ○ | テーマコード |
| theme_name | VARCHAR(200) | ○ | テーマ名（例: 海外事業拡大） |
| description | TEXT | △ | テーマ概要（フリーテキスト） |
| strategy_category | VARCHAR(100) | △ | 戦略種別（売上拡大/コスト削減/基盤強化等、自由入力） |
| owner_employee_id | UUID | △ | 責任者（社員ID） |
| target_date | DATE | △ | 目標期限 |
| sort_order | INT | ○ | 表示順 |
| is_active | BOOLEAN | ○ | 有効フラグ（デフォルト true） |
| created_at | TIMESTAMPTZ | ○ | 作成日時 |
| updated_at | TIMESTAMPTZ | ○ | 更新日時 |
| created_by | UUID | ○ | 作成者 |
| updated_by | UUID | ○ | 更新者 |

### 制約

- `UNIQUE(tenant_id, mtp_event_id, theme_code)` — イベント内でテーマコード一意
- FK: mtp_event_id → mtp_events(id)
- FK: parent_theme_id → mtp_strategy_themes(id)
- FK: dimension_value_id → dimension_values(id)
- FK: owner_employee_id → employees(id)

### 補足

- **全社テーマ**: parent_theme_id = NULL, dimension_value_id = NULL
- **事業部テーマ**: parent_theme_id に全社テーマを指定、dimension_value_id に事業部を指定
- strategy_category は自由入力（将来的にマスタ化可能）
- Phase 2 で財務インパクト（科目紐付け）を追加予定

---

## 15.3 mtp_theme_kpis（テーマ-KPI紐付け）

戦略テーマに関連するKPI科目を紐付ける。

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 主キー |
| tenant_id | UUID | ○ | テナントID（RLS境界） |
| strategy_theme_id | UUID | ○ | 戦略テーマID |
| subject_id | UUID | ○ | KPI科目ID（subjects.subject_type = 'KPI'） |
| sort_order | INT | ○ | 表示順 |
| created_at | TIMESTAMPTZ | ○ | 作成日時 |

### 制約

- `UNIQUE(tenant_id, strategy_theme_id, subject_id)` — テーマ内で科目一意
- FK: strategy_theme_id → mtp_strategy_themes(id) ON DELETE CASCADE
- FK: subject_id → subjects(id)

### 補足

- 1つのテーマに複数のKPIを紐付け可能
- KPI科目（subjects.subject_type = 'KPI'）のみ紐付け対象
- 紐付けは参照用途（目標達成状況の可視化）

---

## 15.4 ER図（中期経営計画）

```
┌─────────────────────────────────────────────────────────────────┐
│                        mtp_events                               │
│  (中計イベント: 2024年中計, 2026年中計...)                        │
└─────────────────────────────────────────────────────────────────┘
          │                                    │
          │ 1:N                                │ 1:N
          │                                    │
          ▼                                    ▼
┌───────────────────────────┐    ┌───────────────────────────────┐
│   mtp_strategy_themes     │    │         fact_amounts          │
│  (戦略テーマ: カスケード)  │    │    (scenario_type = 'MTP')    │
└───────────────────────────┘    └───────────────────────────────┘
          │
          │ 1:N
          ▼
┌───────────────────────────┐
│     mtp_theme_kpis        │
│   (テーマ-KPI紐付け)       │
└───────────────────────────┘
          │
          │ N:1
          ▼
┌───────────────────────────┐
│        subjects           │
│   (subject_type='KPI')    │
└───────────────────────────┘
```

---

# 16. 予算ガイドライン

予算ガイドラインは中期経営計画（MTP）と年度予算（BUDGET）の間に位置する指針機能。

### 基本方針

- **数値は fact_amounts を共用**: scenario_type = 'GUIDELINE' として格納
- **イベント管理は専用テーブル**: guideline_events で管理
- **組織ディメンション単位で入力**: dimension_values（事業部等）を使用
- **時間粒度は選択可能**: 年度/半期/四半期

### scenario_type 拡張

fact_amounts.scenario_type に 'GUIDELINE' を追加:

| 値 | 説明 |
|----|------|
| BUDGET | 予算 |
| FORECAST | 見込 |
| ACTUAL | 実績 |
| MTP | 中期経営計画 |
| **GUIDELINE** | 予算ガイドライン（新規追加） |

---

## 16.1 guideline_events（予算ガイドラインイベント）

予算ガイドラインの単位（「FY2026 Q1ガイドライン」等）を管理する。

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | UUID | ○ | 主キー |
| tenant_id | UUID | ○ | テナントID（RLS境界） |
| company_id | UUID | ○ | 会社ID |
| event_code | VARCHAR(50) | ○ | イベントコード（例: FY2026_GL_Q1） |
| event_name | VARCHAR(200) | ○ | イベント名（例: FY2026 Q1ガイドライン） |
| fiscal_year | INT | ○ | 対象年度（例: 2026） |
| period_type | ENUM | ○ | 期間種別（ANNUAL / HALF / QUARTER） |
| period_no | INT | ○ | 期番号（1, 2, 3, 4）ANNUALの場合は1固定 |
| dimension_id | UUID | ○ | 使用する組織ディメンション |
| layout_id | UUID | △ | 使用するレイアウト（layout_type='GUIDELINE'） |
| status | ENUM | ○ | ステータス（DRAFT / CONFIRMED） |
| description | TEXT | △ | 説明・備考 |
| is_active | BOOLEAN | ○ | 有効フラグ（デフォルト true） |
| created_at | TIMESTAMPTZ | ○ | 作成日時 |
| updated_at | TIMESTAMPTZ | ○ | 更新日時 |
| created_by | UUID | ○ | 作成者 |
| updated_by | UUID | ○ | 更新者 |

### 制約

- `UNIQUE(tenant_id, company_id, event_code)` — 会社内でイベントコード一意
- FK: tenant_id, company_id → companies(tenant_id, id)
- FK: dimension_id → dimensions(id)
- FK: layout_id → report_layouts(id)
- CHECK: period_type IN ('ANNUAL', 'HALF', 'QUARTER')
- CHECK: period_no >= 1 AND period_no <= 4
- CHECK: (period_type = 'ANNUAL' AND period_no = 1) OR (period_type = 'HALF' AND period_no <= 2) OR (period_type = 'QUARTER' AND period_no <= 4)

### 補足

- fact_amounts.plan_event_id から参照可能（scenario_type = 'GUIDELINE' の場合）
- 同一年度に複数イベント作成可能（Q1ガイドライン、Q2ガイドライン等）
- CONFIRMED後は編集不可（新イベント作成で対応）
- ステータスは初期実装では DRAFT / CONFIRMED のみ（承認フローは Phase 2）

---

## 16.2 ER図（予算ガイドライン）

```
┌─────────────────────────────────────────────────────────────────┐
│                     guideline_events                            │
│  (ガイドラインイベント: FY2026_Q1, FY2026_Q2...)                 │
└─────────────────────────────────────────────────────────────────┘
          │                                    │
          │ N:1                                │ 1:N
          │                                    │
          ▼                                    ▼
┌───────────────────────────┐    ┌───────────────────────────────┐
│       dimensions          │    │         fact_amounts          │
│  (組織ディメンション)       │    │  (scenario_type = 'GUIDELINE')│
└───────────────────────────┘    └───────────────────────────────┘
          │
          │ 1:N
          ▼
┌───────────────────────────┐
│    dimension_values       │
│   (A事業部, B事業部...)    │
└───────────────────────────┘
```

---

## 16.3 計画階層データフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    中期経営計画（MTP）                           │
│  mtp_events + fact_amounts (scenario_type='MTP')                │
│  入力粒度: dimension_values（組織ディメンション）                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓ 参照
┌─────────────────────────────────────────────────────────────────┐
│                  予算ガイドライン（GUIDELINE）                    │
│  guideline_events + fact_amounts (scenario_type='GUIDELINE')    │
│  入力粒度: dimension_values（組織ディメンション）                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓ 参照
┌─────────────────────────────────────────────────────────────────┐
│                      年度予算（BUDGET）                          │
│  plan_events + fact_amounts (scenario_type='BUDGET')            │
│  入力粒度: departments（部門）                                   │
│  集計: department_dimension_links 経由で組織ディメンションに集計  │
└─────────────────────────────────────────────────────────────────┘
```

---

# 変更履歴

| 日付 | エンティティ | 変更種別 | 変更内容 | 影響 Feature | 理由 | 担当 |
|------|-------------|---------|---------|-------------|------|------|
| 2026-01-04 | - | INIT | 初版作成（V2） | - | プロジェクト開始 | - |
| 2026-01-04 | departments | ADD_COL | company_id カラム追加、複合FK制約更新 | master-data/organization-master | organization_versions との複合FK整合性担保 | - |
| 2026-01-04 | report_layouts | ALTER | layout_type を 'PL'\|'BS' から 'PL'\|'BS'\|'KPI' に拡張、CHECK制約追加 | master-data/report-layout | 財務レイアウトとKPIレイアウトを区別するため | - |
| 2026-01-04 | metrics | ADD_COL | company_id, created_by, updated_by カラム追加、UNIQUE制約を (tenant_id, company_id, metric_code) に変更、FK制約追加 | master-data/metrics-master | 会社別運用のため、監査ログ対応のため | - |
| 2026-01-05 | group_subjects | ALTER | posting_allowed, unit, scale, aggregation_method, notes, created_by, updated_by カラム追加。subjects と同等の属性を持たせる | master-data/group-subject-master | 連結勘定科目マスタ機能の詳細設計に伴う拡張 | - |
| 2026-01-05 | group_subject_mappings | ALTER | UNIQUE制約を (tenant_id, company_id, company_subject_id) に変更（期間なしで1:1マッピング）。valid_from/valid_to 削除、created_by/updated_by 追加。coefficient を +1/-1 のみに制限 | master-data/group-subject-mapping | シンプルな1:1マッピング運用、Phase 1 では期間管理不要 | - |
| 2026-01-05 | group_subject_rollup_items | ALTER | UNIQUE制約追加、valid_from/valid_to 削除（Phase 1 では期間管理不要） | master-data/group-subject-master | 連結集計構造のシンプル化 | - |
| 2026-01-05 | セクション9 | RULE | 連結COA設計方針（9.0）を追加。親会社のみ編集可能、子会社は参照のみ、1階層（親:子=1:N）、各個社が自社マッピング設定 | master-data/group-subject-master, group-subject-mapping | 連結予実管理の運用モデル確定 | - |
| 2026-01-05 | group_report_layouts | ADD | 連結レポートレイアウトヘッダ新規追加（セクション10.1）。テナント単位で連結PL/BS/KPIレイアウトを管理 | master-data/group-report-layout | 連結予実レポートの表示レイアウト管理のため | - |
| 2026-01-05 | group_report_layout_lines | ADD | 連結レポートレイアウト行新規追加（セクション10.2）。header/account/subtotal/note/blank行をサポート | master-data/group-report-layout | 連結レイアウトの行定義・表示スタイル管理のため | - |
| 2026-01-06 | group_report_layout_lines | ALTER | subtotal を削除し line_type を header/account/note/blank に変更。個社レイアウト（report_layout_lines）と同期 | master-data/group-report-layout | 個社/連結で line_type 体系を統一。集計科目も account 行で表示（subject_class で判断） | - |
| 2026-01-06 | セクション13 | RULE | 配賦マスタ実装方針（13.0）を追加。Phase 1 スコープ確定：CRUD + コピー機能、filter/exclude は後続、会社別管理、UI方針（階層的一画面） | master-data/allocation-master | 配賦マスタ Feature 開始前の方針確定 | - |
| 2026-01-06 | departments | ADD_COL | headcount カラム追加（所属社員数、自動計算） | master-data/allocation-master | 配賦ドライバ HEADCOUNT のデータソースとして使用 | - |
| 2026-01-06 | allocation_events | ADD_COL | version カラム追加（楽観的ロック用） | master-data/allocation-master | ステップ順序変更時の競合検知のため | - |
| 2026-01-06 | allocation_steps | ALTER | from_department_id を削除、from_department_stable_id を必須（NOT NULL）に変更 | master-data/allocation-master | 配賦元部門は必須、stable_id で組織改編耐性を持たせる | - |
| 2026-01-06 | allocation_step_targets | ADD_COL | to_subject_id カラム追加（配賦先科目、任意）。target_id は部門の場合 stable_id を使用することを明記 | master-data/allocation-master | 配賦先科目を選択可能に（NULL=配賦元科目と同じ） | - |
| 2026-01-06 | allocation_step_targets | ALTER | fixed_ratio の型を numeric(5,4) に明確化、UNIQUE制約追加 | master-data/allocation-master | 精度明確化、重複登録防止 | - |
| 2026-01-06 | allocation_drivers | RULE | ドライバタイプ別の設定・計算根拠、measure_key の想定用途を補足に追加 | master-data/allocation-master | 仕様明確化（HEADCOUNT は departments.headcount を参照等） | - |
| 2026-01-09 | companies | ADD_COL | tag1_label〜tag5_label カラム追加（軽量タグのラベル定義） | data-import | 仕訳明細の軽量タグ機能対応 | Claude Code |
| 2026-01-09 | budget_import_staging | ADD | 予算取込ステージング新規追加（12.3） | data-import | 予算取込パフォーマンス確保のため分離 | Claude Code |
| 2026-01-09 | actual_import_staging | ADD | 実績取込ステージング新規追加（12.4） | data-import | 実績取込パフォーマンス確保のため分離 | Claude Code |
| 2026-01-09 | fact_journal_lines | ADD | 仕訳明細ファクト新規追加（12.5）。2形式対応（SINGLE/DOUBLE）、軽量タグ（tag1〜tag5）対応 | data-import | ERP仕訳詳細の蓄積・参照用 | Claude Code |
| 2026-01-09 | fact_amounts | ADD_COL | project_id カラム追加（nullable、FK to projects）。PJ別予算・実績を統一管理 | planning/project-budget | PJ予算・実績をfact_amountsで統一管理するため | Claude Code |
| 2026-01-09 | fact_amounts | ALTER | 一意制約に project_id を追加。source_type に PROJECT_ROLLUP を追加 | planning/project-budget | PJ別データの一意性担保、PJ集計からのコピー識別 | Claude Code |
| 2026-01-09 | セクション0.8 | RULE | Factの持ち方を再改訂。プロジェクトは固定列（project_id）で保持する方針に変更 | planning/project-budget | PJ予算・実績の混在対応、シンプルな設計 | Claude Code |
| 2026-01-09 | action_plans | ADD | アクションプラン新規追加（14.1）。KPI科目に紐付く施策・取り組みを管理 | kpi/action-plan | KPI達成のための施策管理機能 | Claude Code |
| 2026-01-09 | wbs_items | ADD | WBS項目新規追加（14.2）。ガントチャート用の階層構造、依存関係、マイルストーン対応 | kpi/action-plan | ガントチャート表示の単位 | Claude Code |
| 2026-01-09 | action_plan_tasks | ADD | タスク新規追加（14.3）。カンバンボード用のタスク管理 | kpi/action-plan | Trelloライクなタスク管理 | Claude Code |
| 2026-01-09 | task_statuses | ADD | タスクステータス定義新規追加（14.4）。**アクションプラン単位**でカスタマイズ可能（Trelloボード単位に準拠） | kpi/action-plan | カンバンボードのステータス列定義 | Claude Code |
| 2026-01-09 | task_labels | ADD | タスクラベル定義新規追加（14.5）。**アクションプラン単位**でカスタマイズ可能（Trelloボード単位に準拠） | kpi/action-plan | タスクへのラベル付け機能 | Claude Code |
| 2026-01-09 | task_label_assignments | ADD | タスク-ラベル紐付け新規追加（14.6）。多対多関係 | kpi/action-plan | 1タスクに複数ラベル付与可能 | Claude Code |
| 2026-01-09 | task_assignees | ADD | タスク担当者新規追加（14.7）。複数アサイン対応 | kpi/action-plan | Trelloの複数メンバーアサイン機能 | Claude Code |
| 2026-01-09 | task_checklist_items | ADD | タスクチェックリスト新規追加（14.8）。サブタスク管理 | kpi/action-plan | Trelloのチェックリスト機能 | Claude Code |
| 2026-01-09 | task_comments | ADD | タスクコメント新規追加（14.9）。ディスカッション機能 | kpi/action-plan | Trelloのコメント機能 | Claude Code |
| 2026-01-11 | fact_amounts | ALTER | scenario_type に 'MTP' を追加（中期経営計画） | mtp/mid-term-plan | 中計数値をfact_amountsで統一管理 | Claude Code |
| 2026-01-11 | mtp_events | ADD | 中期経営計画イベント新規追加（15.1）。計画年数（3/5年）、ステータス管理 | mtp/mid-term-plan | 中計イベント単位の管理 | Claude Code |
| 2026-01-11 | mtp_strategy_themes | ADD | 戦略テーマ新規追加（15.2）。全社↔事業部カスケード構造、戦略種別（自由入力） | mtp/mid-term-plan | 中計の戦略テーマ管理 | Claude Code |
| 2026-01-11 | mtp_theme_kpis | ADD | テーマ-KPI紐付け新規追加（15.3）。戦略テーマとKPI科目の関連付け | mtp/mid-term-plan | 戦略テーマの進捗可視化 | Claude Code |
| 2026-01-11 | fact_amounts | ALTER | scenario_type に 'GUIDELINE' を追加（予算ガイドライン） | planning/budget-guideline | ガイドライン数値をfact_amountsで統一管理 | Claude Code |
| 2026-01-11 | guideline_events | ADD | 予算ガイドラインイベント新規追加（16.1）。年度/半期/四半期対応、ステータス管理 | planning/budget-guideline | ガイドラインイベント単位の管理 | Claude Code |
| 2026-02-01 | companies | ADD_COL | roic_pl_layout_id, roic_bs_layout_id, roic_ebit_subject_id, roic_operating_assets_subject_id, roic_operating_liabilities_subject_id, effective_tax_rate, wacc_rate カラム追加 | reporting/roic-analysis | ROIC分析の設定情報を保持するため | Codex |
| 2026-02-02 | companies | ADD_COL | indicator_report_layout_id カラム追加 | reporting/indicator-report | 財務指標分析レポートのレイアウト指定を保持するため | Codex |
| 2026-02-02 | indicator_report_layouts | ADD | 財務指標レポートレイアウトヘッダ新規追加（セクション7.3） | reporting/indicator-report | 財務指標分析レポートの表示定義を管理するため | Codex |
| 2026-02-02 | indicator_report_layout_lines | ADD | 財務指標レポートレイアウト行新規追加（セクション7.4） | reporting/indicator-report | 財務/非財務/指標の混在レイアウトを定義するため | Codex |
| 2026-01-12 | period_close_logs | ADD | 締め操作ログ新規追加（2.2）。仮締め/本締め/差し戻しの監査ログ | admin/period-close-status | 締め処理の監査証跡 | Claude Code |
| 2026-01-15 | companies | ADD_COL | 主要科目ID 8カラム追加（revenue/variable_cost/marginal_profit/fixed_cost/cogs/gross_profit/contribution_profit/operating_profit）、承認フラグ2カラム追加（enable_budget_approval/enable_forecast_approval） | report/project-profitability, workflow/approval | PJ採算照会・直接原価レポート・経営会議KPIで使用する主要科目の指定、予算/見込の承認ワークフロー使用有無設定 | Claude Code |
| 2026-02-05 | accounting_periods | ADD_COL | input_locked, input_locked_at, input_locked_by カラム追加（入力ロック機能） | admin/period-close-allocation | 配賦実行時の入力ロック連動のため | Claude Code |
| 2026-02-05 | allocation_events | ADD_COL | execution_order カラム追加（同一会社内の実行順序） | admin/period-close-allocation | 複数配賦イベントの実行順序制御のため | Claude Code |
| 2026-02-05 | allocation_executions | ADD | 配賦実行履歴新規追加（13.5）。実行日時・実行者・ステータス・サマリを管理 | admin/period-close-allocation | 配賦処理の実行履歴管理のため | Claude Code |
| 2026-02-05 | allocation_execution_details | ADD | 配賦実行明細新規追加（13.6）。配賦元/先・ドライバ・比率・金額を保持 | admin/period-close-allocation | 配賦結果VIEW画面での階層表示のため | Claude Code |

<!--
変更種別:
- ADD: 新規エンティティ追加
- ALTER: 既存カラムの型・制約変更
- ADD_COL: カラム追加
- DROP_COL: カラム削除
- RENAME: 名称変更
- RULE: ビジネスルール変更
-->
